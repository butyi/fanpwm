File prg.a08      * By ASM8 v9.93 Linux [Wednesday, June 29, 2022  12:29 pm]

    1                                     ; ==============================================================================
    2                                     ;                          HEATER MOTOR CONTROL
    3                                     ; ==============================================================================
    4                                     ; Hardware: https://github.com/butyi/sci2can/
    5                                     ; Software: https://github.com/butyi/heaterpwm/
    6                                     ; ==============================================================================
    7                003D0900             XTAL            def     4000000 ; Quarz in Hz
    8                0001                 BDIV            def     1
    9                0080                 RDIV            def     128
   10                                     #include "dz60.inc"             ; Include microcontroller specific definitions
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/dz60.inc ***
    1                                     ;*******************************************************************************
    2                                     ;*            MC9S08DZ60 FRAMEWORK INCLUDE FILE FOR ASM8 ASSEMBLER             *
    3                                     ;*******************************************************************************
    4                                     ; FREEWARE, Copyright (c) Tony G. Papadimitriou <tonyp@acm.org>
    5                                     ;*******************************************************************************
    6                                     
    7                                                         #Uses     macros.inc
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/macros.inc ***
    1                                     ;*******************************************************************************
    2                                     ;* Include   : MACROS.INC
    3                                     ;* Programmer: Tony Papadimitriou <tonyp@acm.org>
    4                                     ;* Purpose   : Sample macro definitions for ASM8 (Win32 & Linux versions, only)
    5                                     ;* Language  : Motorola/Freescale/NXP HC08/9S08 Assembly Language (aspisys.com/ASM8)
    6                                     ;* Status    : FREEWARE Copyright (c) 2018 by Tony Papadimitriou <tonyp@acm.org>
    7                                     ;* Original  : http://www.aspisys.com/code/hc08/macros.html
    8                                     ;* Note(s)   : Use: #Include macros.inc
    9                                     ;*           : All macros are written so that they are compatible with all
   10                                     ;*           : macro modes (#@Macro, #Macro, and #MCF) and their @@ submode.
   11                                     ;*           : Wherever a variable address is expected as parameter, you can use
   12                                     ;*           : a simple variable, an expression pointing to variable, or indexed
   13                                     ;*           : mode.  Wherever a pointer value is expected you can use immediate
   14                                     ;*           : mode, simple variable or related expression, or indexed mode to
   15                                     ;*           : specify from where to get that pointer.  This makes it possible
   16                                     ;*           : to use the same macros in a variety of situations and regardless
   17                                     ;*           : of addressing mode.  (Of course, when an indexed mode is used,
   18                                     ;*           : macro call parameter separator must be overridden to anything but
   19                                     ;*           : the default comma, to properly recognize the comma inside the
   20                                     ;*           : indexed parameter.)
   21                                     ;*           : Some macros may call themselves with extra parameters so that
   22                                     ;*           : they may control the loop without having the user provide those
   23                                     ;*           : control values.
   24                                     ;* History   : 10.07.26 v1.00 First (non-beta) release
   25                                     ;*           : 10.07.29 v1.01 Added #SPADD in PushV macro for #SPAUTO mode
   26                                     ;*           : 10.07.31 v1.02 Removed now redundant push-related macros with
   27                                     ;*           :                optional label as the latest version of ASM8 has
   28                                     ;*           :                this capability built-in (when in -X mode).
   29                                     ;*           : 10.08.01 v1.03 PIN macro now allows for pin-name in label column
   30                                     ;*           : 10.08.06 v1.04 ADD.B third parm made optional
   31                                     ;*           : 10.08.08 v1.05 Added #SPAUTO in Pull macro (for ,SP parms)
   32                                     ;*           : 10.08.09 v1.06 Added AND.B/W/L, ORA.B/W/L and EOR.B/W/L macros
   33                                     ;*           : 10.08.12 v1.07 LDH & STH now see index even w/o comma override
   34                                     ;*           : 10.08.17 v1.08 Fixed Pull macro to work with ,SP variable case
   35                                     ;*           : 10.08.19 v1.09 Optimized CMP.W for HCS and added #PUSH/SPAUTO/PULL
   36                                     ;*           : 10.08.20 v1.10 Log2 now uses :loop (latest ASM8)
   37                                     ;*           : 10.08.21 v1.11 Added PROC, ENDPROC, and ClrRange macros
   38                                     ;*           : 10.08.29 v1.12 CMP.W now works with ,X indexed 2nd operand (HCS)
   39                                     ;*           : 10.08.31 v1.13 Added sema macro for OS8 semaphore definition
   40                                     ;*           : 10.09.01 v1.14 Improved LDH by loading full HX while protecting X
   41                                     ;*           : 10.09.04 v1.15 Adapted to latest ASM8 enhancements
   42                                     ;*           : 10.09.06 v1.16 Improved LDXA & STXA (no parm override needed)
   43                                     ;*           : 10.09.10 v1.17 Added IncByHX and DecByHX macros
   44                                     ;*           : 10.09.16 v1.18 Macro _PUSH_ moved to COMMON.INC
   45                                     ;*           : 10.09.19 v1.19 Improved PushV and PullV
   46                                     ;*           : 10.09.22 v1.20 Made use of MTOP found in latest ASM8
   47                                     ;*           :                Improved DefBaud to display baud defs in any order
   48                                     ;*           : 10.09.23 v1.21 Improved FillROM macro
   49                                     ;*           : 10.09.24 v1.22 Replaced double-@ string delimiter with \@
   50                                     ;*           : 10.09.25 v1.23 Improved Align2 macro to not use ?$$$
   51                                     ;*           : 10.10.20 v1.24 Adapted to latest ASM8 (eg., use of MSET)
   52                                     ;*           : 10.10.25 v1.25 Made use of MSWAP (latest ASM8 build)
   53                                     ;*           : 10.10.30 v1.26 Single operand macros use index w/o override
   54                                     ;*           : 10.11.01 v1.27 RePin macro defined (AND UNDEFINED IN v1.28)
   55                                     ;*           : 10.11.03 v1.28 Pin macro redefines if label appears on right side
   56                                     ;*           : 10.11.05 v1.29 Replaced :loop with MSWAP in DefBaud, sema macros
   57                                     ;*           : 10.11.08 v1.30 Added 'X-index not allowed' error in DIVs
   58                                     ;*           : 10.11.09 v1.31 Macro DEFAULT removed. Use built-in DEF instead.
   59                                     ;*           :                FillROM moved to MACROS2.INC
   60                                     ;*           : 10.11.19 v1.32 Renamed Align2 to Align, and allowed for label
   61                                     ;*           : 10.11.20 v1.33 Add optional shift left parameter to Log2
   62                                     ;*           : 10.11.25 v1.34 Input, Output, On, Off now accept multiple PinNames
   63                                     ;*           : 10.11.26 v1.35 Added ABS (abs.b, abs.w, abs.l) for absolute value
   64                                     ;*           : 10.11.28 v1.36 Align macro improved to also align label values
   65                                     ;*           : 10.12.01 v1.37 Adapted to latest ASM8 => shorter/faster macros
   66                                     ;*           : 10.12.03 v1.38 Adapted to latest ASM8 => macros OK in @@ sub-mode
   67                                     ;*           : 10.12.28 v1.39 Added ReadPin to set the CCR[C] based on pin status
   68                                     ;*           : 11.02.03 v1.40 Improved fNextTask to behave similarly if no MTOS
   69                                     ;*           : 11.02.06 v1.41 ReadPin improved to accept regular BRSET syntax
   70                                     ;*           : 11.02.11 v1.42 Renamed Align back to Align2 (because power of 2)
   71                                     ;*           :                Added Align to align based on multiple (not power)
   72                                     ;*           : 11.02.28 v1.43 Added #SPADD in ReVector (in case it is under SPAUTO)
   73                                     ;*           : 11.03.04 v1.44 Added TST.B TST.W and TST.L macros
   74                                     ;*           :                Log2 macro now also returns answer in :MEXIT
   75                                     ;*           : 11.03.16 v1.45 Made use of #EXIT directive to speedup assembly
   76                                     ;*           : 11.03.20 v1.46 Optimized Pull and fixed for SPAUTO mode use
   77                                     ;*           : 11.03.27 v1.47 Improved RSP/LDS allows for index without override
   78                                     ;*           : 11.03.31 v1.48 Improved DefADKey to also accept ~label~ format
   79                                     ;*           : 11.04.20 v1.49 Changed ,X to ,AX in some macros (in case we use #X)
   80                                     ;*           : 11.04.26 v1.50 Added CopyRange macro
   81                                     ;*           : 11.08.17 v1.51 Added Pullup macro to set pull-up for given PIN(s)
   82                                     ;*           : 11.08.30 v1.52 Improved ClrRange for empty immediate range
   83                                     ;*           : 11.09.06 v1.53 Added XA2HX and HX2XA
   84                                     ;*           : 11.10.17 v1.54 Allowed multiple parameters for CheckPin
   85                                     ;*           : 11.10.26 v1.55 Added REP (repeat) macro
   86                                     ;*           : 11.11.11 v1.56 PIN macro now gives warning if pin number over 7
   87                                     ;*           : 11.11.24 v1.57 Updated PULLUP macro to use BSET when possible
   88                                     ;*           : 11.12.01 v1.58 Corrected PULLUP macro for BSET case
   89                                     ;*           : 12.03.17 v1.59 Shortened DIV.W and DIV.L by use of DIV.B
   90                                     ;*           :                AIS & AIX no longer allow non-immediate operand
   91                                     ;*           :                Macro ALIGN commented out, use built-in ALIGN
   92                                     ;*           : 12.06.13 v1.60 Improved PIN macro for sequential auto-assignment
   93                                     ;*           : 12.06.25 v1.61 Improved DefBaud macro to not redefine for same values
   94                                     ;*           : 12.08.06 v1.62 Added EndStats macro (for showing final statistics)
   95                                     ;*           : 12.09.28 v1.63 DIV.B improved to allow X-index mode for divisor
   96                                     ;*           : 12.10.22 v1.64 BugFix: cmp.w and ClrRange macros X-index mode detection
   97                                     ;*           : 12.11.19 v1.65 Improved EndStats macro, and better support for MMU mode
   98                                     ;*           : 12.12.05 v1.66 Added CAX & CXA (Cmp A to X and vice-versa) macros
   99                                     ;*           :                REP macro improved to also allow macro(s) as parameter
  100                                     ;*           : 13.01.21 v1.67 Added ADC.B and SBC.B macros. Changed certain .L
  101                                     ;*           :                macros to use .W, and .W to use .B internally
  102                                     ;*           : 13.02.03 v1.68 Improved PIN macro
  103                                     ;*           : 13.02.11 v2.00 Made use ~[n.p]~ macro placeholder. May produce
  104                                     ;*           :                different object code.
  105                                     ;*           :                Made ADD.B and ADC.B smarter for #0 parm cases
  106                                     ;*           :                Added ADC.W, ADC.L, SBC.W and SBC.L macros
  107                                     ;*           :                Several macros improved.
  108                                     ;*           : W A R N I N G  Because of the new ~[n.p]~ capability the six
  109                                     ;*           :                macros SUB.[BWL] and CMP.[BWL] now 'subtract' 2nd
  110                                     ;*           :                from 1st for immediate mode operand(s).  These
  111                                     ;*           :                macros now also work with X-indexed mode in all
  112                                     ;*           :                cases.  IMPORTANT: Source code in apps that use
  113                                     ;*           :                any of these macros may need revision to correct
  114                                     ;*           :                the 1st/2nd parameter order when immediate mode is
  115                                     ;*           :                involved.
  116                                     ;*           : 13.03.03 v2.01 Added calls to _#_ and _not_#_ in some macros
  117                                     ;*           :                Improved ReVector, tst.w, and tst.l macros
  118                                     ;*           :                Moved some frequently used macros to COMMON.INC
  119                                     ;*           :                ClrRange no longer destroys registers
  120                                     ;*           : 13.03.13 v2.02 Added _FindStr_ macro (Find String)
  121                                     ;*           : 13.04.05 v2.03 Optimized PushV macro
  122                                     ;*           : 13.04.12 v2.04 PushV / PullV macros moved to COMMON.INC
  123                                     ;*           : 13.04.23 v2.05 BugFix: _ldacmp_ macro (in COMMON.INC) now compares
  124                                     ;*           :                even with #0 to adjust the Carry like the real CMP
  125                                     ;*           :                instruction.  This corrects all CMP.x macros in here.
  126                                     ;*           : 13.05.07 v2.06 BugFix: EndStats macro for MMU case
  127                                     ;*           : 13.05.07 v2.07 ADD.B and ADC.B moved to COMMON.INC as they are
  128                                     ;*           :                also used by ADD.S
  129                                     ;*           : 13.05.14 v2.08 Added PORT macro for single line port bit(s) definition
  130                                     ;*           :                (eg., FSTAT @port $1825,,,FBLANK,,FACCERR,FPVIOL,FCCF,FCBEF)
  131                                     ;*           : 13.08.08 v2.09 CopyRange now shows error if size is not word
  132                                     ;*           : 13.08.13 v2.10 Improved CopyRange to accept either byte or word size
  133                                     ;*           : 13.09.29 v2.11 Improved EndStats macro to use ?_OBJECT_? by default
  134                                     ;*           : 13.10.12 v2.12 Renamed "copy" macro to "copy.b"
  135                                     ;*           : 13.10.24 v2.13 Rewrote AddOS to use #ROM (moved to COMMON.INC)
  136                                     ;*           : 13.11.01 v2.14 Moved (improved version of) AIX into COMMON.INC
  137                                     ;*           : 13.11.07 v2.15 Improved Pullup macro
  138                                     ;*           : 14.10.11 v2.16 Added MarkModuleVars & ClrModuleVars macros
  139                                     ;*           : 15.04.03 v2.17 Added sema #SAVE# option to create Lock/Unlock code
  140                                     ;*           : 15.05.15 v2.18 Adapted to latest sema lock/unlock parameter passing scheme
  141                                     ;*           :                Added fLock, fLockAttempt, fUnlock, fUnlockOnly
  142                                     ;*           :                global macros to deal with compatibility issues
  143                                     ;*           :                between old and new semaphore schemes
  144                                     ;*           : 15.05.27 v2.19 Removed deprecated fUnlockOnly macro
  145                                     ;*           : 15.09.17 v2.20 Added is8bit & is16bit helper macros
  146                                     ;*           :                Incorporated is8bit into mov.b & is16bit into mov.w
  147                                     ;*           : 17.10.01 v2.21 Moved PROC and ENDPROC macros into their own file (proc.inc)
  148                                     ;*           : 17.10.13 v2.22 MarkModuleVars adds #push-#pull to protect user segment use
  149                                     ;*******************************************************************************
  150                                     
  151                                                         #Exit     _MACROS_
  152                C000                 _MACROS_
  153                                     
  154                                     ;*******************************************************************************
  155                                     ; My personal preferences for most situations (adjust to suit your needs)
  156                                     
  157                                     MyDefaultDirectives macro
  158                                                         #CaseOn                       ;Case-sensitive labels
  159                                                         #OptRelOn                     ;Jump->Branch warnings
  160                                                         #OptRtsOff                    ;No redundant RTS warnings
  161                                                         #SpacesOff                    ;No non-string spaces in operands
  162                                                         #ExtraOn                      ;Extra mnemonics enabled
  163                                                         #MapOn                        ;Source-level mapping enabled
  164                                                         #TraceOff                     ;No source-level macro mapping
  165                                                         #HcsOn                        ;Enable HCS08 instructions
  166                                                         #S1                           ;S1/S2 auto-selection
  167                                                         #Jump                         ;Auto CALL->JSR & RTC->RTS conversion
  168                                                         #@Macro                       ;Macro syntax is @macro
  169                                                         #Parms                        ;Default macro parameter delimiter
  170                                                         endm
  171                                     
  172                                     ;*******************************************************************************
  173                                     ;*******************************************************************************
  174  M                                                      @MyDefaultDirectives          ;this one called at inclusion
  174  M                                                      #CaseOn                       ;Case-sensitive labels
  174  M                                                      #OptRelOn                     ;Jump->Branch warnings
  174  M                                                      #OptRtsOff                    ;No redundant RTS warnings
  174  M                                                      #SpacesOff                    ;No non-string spaces in operands
  174  M                                                      #ExtraOn                      ;Extra mnemonics enabled
  174  M                                                      #MapOn                        ;Source-level mapping enabled
  174  M                                                      #TraceOff                     ;No source-level macro mapping
  174  M                                                      #HcsOn                        ;Enable HCS08 instructions
  174  M                                                      #S1                           ;S1/S2 auto-selection
  174  M                                                      #Jump                         ;Auto CALL->JSR & RTC->RTS conversion
  174  M                                                      #@Macro                       ;Macro syntax is @macro
  174  M                                                      #Parms                        ;Default macro parameter delimiter
  174                                                         endm
  175                                     ;*******************************************************************************
  176                                     ;*******************************************************************************
  177                                     
  178                                     COP                 macro                         ;kick the COP watchdog
  179                                               #ifparm ~1~ = #SAVE#                    ;to be compatible with special COP macro versions
  180                                                         mexit
  181                                               #endif
  182                                               #ifdef COP
  183                                                         sta       COP
  184                                               #endif
  185                                                         endm
  186                                     
  187                                     ;*******************************************************************************
  188                                     ; Test if any immediate value in list is greater than 8-bit
  189                                     
  190                                     is8bit              macro
  191                                                         mreq      1
  192                                                         mswap     1,:loop
  193                                               #ifnb ~#~
  194                                                 #if ~#1~&$FFFFFF00 > 0
  195                                                         #Warning  Value {:loop} ({~#1~}) is bigger than 8-bit
  196                                                 #endif
  197                                               #endif
  198                                                         mtop      :n
  199                                                         endm
  200                                     
  201                                     ;*******************************************************************************
  202                                     ; Test if any immediate value in list is greater than 16-bit
  203                                     
  204                                     is16bit             macro
  205                                                         mreq      1
  206                                                         mswap     1,:loop
  207                                               #ifnb ~#~
  208                                                 #if ~#1~&$FFFF0000 > 0
  209                                                         #Warning  Value {:loop} ({~#1~}) is bigger than 16-bit
  210                                                 #endif
  211                                               #endif
  212                                                         mtop      :n
  213                                                         endm
  214                                     
  215                                     ;*******************************************************************************
  216                                     ; Simulate 68HC11's LDS instruction (HX is destroyed, however)
  217                                     
  218                                     lds                 macro     [#]StackTop
  219                                                         ldhx      ~@~
  220                                                         txs
  221                                                         endm
  222                                     
  223                                     ;*******************************************************************************
  224                                     
  225                                     rsp                 macro     [[#]StackTop]       ;does LDS with most-used value
  226                                                         mdef      1,#STACKTOP
  227                                                         @lds      ~@~
  228                                                         endm
  229                                     
  230                                     ;*******************************************************************************
  231                                     ; Mark the beginning and end of variables for either RAM or XRAM
  232                                     
  233                                     MarkModuleVars      macro
  234                                                         #push
  235                                     ?RAM_BEGIN          equ       :RAM
  236                                     ?XRAM_BEGIN         equ       :XRAM
  237                                     
  238                                                         msuspend                      ;;here, code adds variables
  239                                     
  240                                     ?RAM_END            equ       :RAM
  241                                     ?XRAM_END           equ       :XRAM
  242                                                         #pull
  243                                                         endm
  244                                     
  245                                     ;*******************************************************************************
  246                                     ; Clear variables marked by the MarkModuleVars macro
  247                                     
  248                                     ClrModuleVars       macro
  249                                                         @@ClrRange #?RAM_BEGIN,#?RAM_END
  250                                                         @ClrRange #?XRAM_BEGIN,#?XRAM_END
  251                                                         endm
  252                                     
  253                                     ;*******************************************************************************
  254                                     ; Clear a range to zero (or given value)
  255                                     
  256                                     ClrRange            macro     [#]FromAddressPtr,[#]ToAddressPtr[,[#]WithValue]
  257                                                         mreq      1,2:[#]FromAddressPtr,[#]ToAddressPtr[,[#]WithValue]
  258                                                         mdef      3,#0                ;;default value is zero
  259                                                         @@_not_x_ ~2~
  260                                               #ifparm ~#~
  261                                                 #ifnoparm ~#2~ = ~2~
  262                                                   #if ~#1~ = ~#2~
  263                                                         mexit                         ;;nothing to do
  264                                                   #endif
  265                                                 #endif
  266                                               #endif
  267                                                         #push
  268                                                         #spauto   :sp
  269                                                         push
  270                                                         @@_lda_   ~3~
  271                                                         ldhx      ~1~
  272                                     Loop$$$
  273                                                         sta       ,ax
  274                                                         aix       #1
  275                                                         cphx      ~2~
  276                                                         blo       Loop$$$
  277                                                         pull
  278                                                         #pull
  279                                                         endm
  280                                     
  281                                     ;*******************************************************************************
  282                                     ; Copy a range of bytes between fixed addresses - no registers destroyed
  283                                     
  284                                     CopyRange           macro     #Source,#Destination,[#]Size
  285                                                         mreq      1,2,3:#Source,#Destination,[#]Size
  286                                               #ifparm ~,1~~,2~
  287                                                         merror    Source/Destination is indexed
  288                                               #endif
  289                                                         @@_#_     ~1~
  290                                                         @@_#_     ~2~
  291                                                         @@_not_x_ ~3~
  292                                                         mset      0,cphx              ;;default comparison is word
  293                                               #ifnb ~3~ = ~#3~                        ;except for immediate mode
  294                                                 #if ::~3,~ <> 2                       ;if size is not word
  295                                                   #if ::~3,~ <> 1                     ;and byte is not byte
  296                                                         merror    Non-byte or non-word size (~3~)
  297                                                   #endif
  298                                                 #endif
  299                                                 #if ::~3,~ = 1
  300                                                         mset      0,cmpx
  301                                                 #endif
  302                                               #endif
  303                                                         #push
  304                                                         #spauto   :sp
  305                                                         push
  306                                                         clrhx                         ;;HX to be used as counter
  307                                     Loop$$$             lda       ~#1~,ax             ;;copy source byte
  308                                                         sta       ~#2~,ax             ;;to destination byte
  309                                                         aix       #1                  ;;advance index
  310                                                         ~text~    ~3~                 ;;are we done?
  311                                                         blo       Loop$$$             ;;repeat while not done
  312                                                         pull
  313                                                         #pull
  314                                                         endm
  315                                     
  316                                     ;*******************************************************************************
  317                                     ; LDXA (Load XA) in one step
  318                                     
  319                                     ldxa                macro     [#]Operand
  320                                                         mset      #
  321                                                         lda       ~[1.-2]~
  322                                                         ldx       ~[1.-1]~
  323                                                         endm
  324                                     
  325                                     ;*******************************************************************************
  326                                     ; STXA (Store XA) in one step
  327                                     
  328                                     stxa                macro     Address
  329                                                         mset      #
  330                                                         stx       ~1~
  331                                                         sta       ~1,~+1~,1~
  332                                                         endm
  333                                     
  334                                     ;*******************************************************************************
  335                                     ; CAX - Compare A to X
  336                                     
  337                                     cax                 macro
  338                                                         pshx
  339                                                         cmpa      1,asp
  340                                                         pulx
  341                                                         endm
  342                                     
  343                                     ;*******************************************************************************
  344                                     ; CXA - Compare X to A
  345                                     
  346                                     cxa                 macro
  347                                                         psha
  348                                                         cmpx      1,asp
  349                                                         pula
  350                                                         endm
  351                                     
  352                                     ;*******************************************************************************
  353                                     ; LDH (Load H register)
  354                                     
  355                                     ldh                 macro     [#]Operand
  356                                               #ifparm ~#~
  357                                                         pshx
  358                                                         ldhx      ~1~<8
  359                                                         pulx
  360                                                         mexit
  361                                               #endif
  362                                                         #push
  363                                                         #spauto   :sp
  364                                               #ifhcs
  365                                                         pshx
  366                                                         ldhx      ~@~
  367                                                         pulx
  368                                               #else
  369                                                         psha
  370                                                         lda       ~@~
  371                                                         tah
  372                                                         pula
  373                                               #endif
  374                                                         #pull
  375                                                         endm
  376                                     
  377                                     ;*******************************************************************************
  378                                     ; STH (Store H register)
  379                                     
  380                                     sth                 macro     Operand
  381                                                         #push
  382                                                         #spauto   :sp
  383                                                         psha
  384                                                         tha
  385                                                         sta       ~@~
  386                                                         pula
  387                                                         #pull
  388                                                         endm
  389                                     
  390                                     ;*******************************************************************************
  391                                     ; Copy XA to HX
  392                                     
  393                                     XA2HX               macro
  394                                                         txh
  395                                                         tax
  396                                                         endm
  397                                     
  398                                     ;*******************************************************************************
  399                                     ; Copy HX to XA
  400                                     
  401                                     HX2XA               macro
  402                                                         txa
  403                                                         thx
  404                                                         endm
  405                                     
  406                                     ;*******************************************************************************
  407                                     ; Swap the values of two symbols (using old XOR technique, and no temp symbol)
  408                                     
  409                                     SwapSymbols         macro     Symbol1,Symbol2
  410                                     ~1~                 set       {~1~}^{~2~}
  411                                     ~2~                 set       {~1~}^{~2~}
  412                                     ~1~                 set       {~1~}^{~2~}
  413                                                         endm
  414                                     
  415                                     ;*******************************************************************************
  416                                     ; Swap two byte-size variables (does not destroy any registers)
  417                                     
  418                                     swap.b              macro     Variable1 Variable2
  419                                                         mset      #' '
  420                                                         mreq      1,2:Variable1 Variable2
  421                                                         #push
  422                                                         #spauto   :sp
  423                                                         psha
  424                                                         @@_swap_  ~@~
  425                                                         pula
  426                                                         #pull
  427                                                         endm
  428                                     
  429                                     ;*******************************************************************************
  430                                     ; Swap two word-size variables (does not destroy any registers)
  431                                     
  432                                     swap.w              macro     Variable1 Variable2
  433                                                         mset      #' '
  434                                                         mreq      1,2:Variable1 Variable2
  435                                                         #push
  436                                                         #spauto   :sp
  437                                                         psha
  438                                                         @@_swap_  ~[1.-1]~ ~[2.-1]~
  439                                                         @@_swap_  ~[1.-2]~ ~[2.-2]~
  440                                                         pula
  441                                                         #pull
  442                                                         endm
  443                                     
  444                                     ;*******************************************************************************
  445                                     ; Swap two long variables (does not destroy any registers)
  446                                     
  447                                     swap.l              macro     Variable1 Variable2
  448                                                         mset      #' '
  449                                                         mreq      1,2:Variable1 Variable2
  450                                                         #push
  451                                                         #spauto   :sp
  452                                                         psha
  453                                                         @@_swap_  ~[1.1]~ ~[2.1]~
  454                                                         @@_swap_  ~[1.2]~ ~[2.2]~
  455                                                         @@_swap_  ~[1.3]~ ~[2.3]~
  456                                                         @@_swap_  ~[1.4]~ ~[2.4]~
  457                                                         pula
  458                                                         #pull
  459                                                         endm
  460                                     
  461                                     ;*******************************************************************************
  462                                     ; Align the current segment (e.g, #ROM) to specific power-of-two block size.
  463                                     ; If a label is present on the same line as the macro call, set the label to the
  464                                     ; value after the alignment occurs.  Default power is 0, byte alignment.
  465                                     ; If the "UnalignedValue" expression is present (and its value is other than
  466                                     ; :PC, then instead of aligning the current segment, it only sets the label to
  467                                     ; aligned value.  This way, it can be used to align just a label without the
  468                                     ; segment.
  469                                     
  470                                     Align2              macro     Power[,UnalignedValue]
  471                                                         mdef      1,0
  472                                                         mdef      2,:PC
  473                                                         mset      1,{1<{~1~}+{~2~}-1(h)}&{1<{~1~}-1^$FFFFFF(h)}
  474                                               #ifparm ~2~ = :PC
  475                                                         org       ~1~
  476                                               #endif
  477                                               #ifparm ~label~
  478                                     ~label~             set       ~1~
  479                                               #endif
  480                                                         mexit     ~1~
  481                                                         endm
  482                                     
  483                                     ;*******************************************************************************
  484                                     ; CLR for bytes (differs from built-in CLR in that it works for any address)
  485                                     
  486                                     clr.b               macro     Variable
  487                                               #ifparm ~,1~~2~
  488                                                         clr       ~@~
  489                                                         mexit
  490                                               #endif
  491                                               #ifz ~1~&$FFFFFF00
  492                                                         clr       ~@~
  493                                                         mexit
  494                                               #endif
  495                                                         psha
  496                                                         clra
  497                                                         sta       ~@~
  498                                                         pula
  499                                                         endm
  500                                     
  501                                     ;*******************************************************************************
  502                                     ; CLR for words
  503                                     
  504                                     clr.w               macro     Variable
  505                                               #ifparm ~,1~~2~
  506                                                         clr       ~@~
  507                                                         clr       ~1,~+1~,1~,~2~
  508                                                         mexit
  509                                               #endif
  510                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  511                                                         clr       ~@~
  512                                                         clr       ~1~+1
  513                                                         mexit
  514                                               #endif
  515                                                         psha
  516                                                         clra
  517                                                         sta       ~@~
  518                                                         sta       ~1~+1
  519                                                         pula
  520                                                         endm
  521                                     
  522                                     ;*******************************************************************************
  523                                     ; CLR for longs
  524                                     
  525                                     clr.l               macro     Variable
  526                                               #ifparm ~,1~~2~
  527                                                         clr       ~@~
  528                                                         clr       ~1,~+1~,1~,~2~
  529                                                         clr       ~1,~+2~,1~,~2~
  530                                                         clr       ~1,~+3~,1~,~2~
  531                                                         mexit
  532                                               #endif
  533                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  534                                                         clr       ~1~
  535                                                         clr       ~1~+1
  536                                                         clr       ~1~+2
  537                                                         clr       ~1~+3
  538                                                         mexit
  539                                               #endif
  540                                               #ifhcs
  541                                                         pshhx
  542                                                         clrhx
  543                                                         sthx      ~1~
  544                                                         sthx      ~1~+2
  545                                                         pulhx
  546                                                         mexit
  547                                               #endif
  548                                                         psha
  549                                                         clra
  550                                                         sta       ~1~
  551                                                         sta       ~1~+1
  552                                                         sta       ~1~+2
  553                                                         sta       ~1~+3
  554                                                         pula
  555                                                         endm
  556                                     
  557                                     ;*******************************************************************************
  558                                     ; INC for bytes (differs from built-in INC in that it works for any address)
  559                                     
  560                                     inc.b               macro     Variable
  561                                               #ifparm ~,1~~2~
  562                                                         inc       ~@~
  563                                                         mexit
  564                                               #endif
  565                                               #ifz ~1~&$FFFFFF00
  566                                                         inc       ~@~
  567                                                         mexit
  568                                               #endif
  569                                                         psha
  570                                                         lda       ~@~
  571                                                         inca
  572                                                         sta       ~@~
  573                                                         pula
  574                                                         endm
  575                                     
  576                                     ;*******************************************************************************
  577                                     ; INC for words
  578                                     
  579                                     inc.w               macro     Variable
  580                                               #ifparm ~,1~~2~
  581                                                         inc       ~1,~+1~,1~,~2~
  582                                                         bne       Done$$$
  583                                                         inc       ~@~
  584                                     Done$$$
  585                                                         mexit
  586                                               #endif
  587                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  588                                                         inc       ~1~+1
  589                                                         bne       Done$$$
  590                                                         inc       ~1~
  591                                     Done$$$
  592                                                         mexit
  593                                               #endif
  594                                               #ifhcs
  595                                                         pshhx
  596                                                         ldhx      ~1~
  597                                                         aix       #1
  598                                                         sthx      ~1~
  599                                                         pulhx
  600                                                         mexit
  601                                               #endif
  602                                                         pshhx
  603                                                         ldhx      #~1~
  604                                                         inc       1,ax
  605                                                         bne       Done$$$
  606                                                         inc       ,ax
  607                                     Done$$$
  608                                                         pulhx
  609                                                         endm
  610                                     
  611                                     ;*******************************************************************************
  612                                     ; INC for longs
  613                                     
  614                                     inc.l               macro     Variable
  615                                               #ifparm ~,1~~2~
  616                                                         inc       ~1,~+3~,1~,~2~
  617                                                         bne       Done$$$
  618                                                         inc       ~1,~+2~,1~,~2~
  619                                                         bne       Done$$$
  620                                                         inc       ~1,~+1~,1~,~2~
  621                                                         bne       Done$$$
  622                                                         inc       ~@~
  623                                     Done$$$
  624                                                         mexit
  625                                               #endif
  626                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  627                                                         inc       ~1~+3
  628                                                         bne       Done$$$
  629                                                         inc       ~1~+2
  630                                                         bne       Done$$$
  631                                                         inc       ~1~+1
  632                                                         bne       Done$$$
  633                                                         inc       ~1~
  634                                     Done$$$
  635                                                         mexit
  636                                               #endif
  637                                                         pshhx
  638                                                         ldhx      #~1~
  639                                                         inc       3,ax
  640                                                         bne       Done$$$
  641                                                         inc       2,ax
  642                                                         bne       Done$$$
  643                                                         inc       1,ax
  644                                                         bne       Done$$$
  645                                                         inc       ,ax
  646                                     Done$$$
  647                                                         pulhx
  648                                                         endm
  649                                     
  650                                     ;*******************************************************************************
  651                                     ; (In/De)crement word using HX without protecting its original value (quicker)
  652                                     ; User is responsible for saving/restoring HX as needed by application
  653                                     
  654                                     IncByHX             macro     Variable
  655                                                         mset      #
  656                                               #ifnhcs
  657                                                         mstop     Macro works with 9S08 only
  658                                               #endif
  659                                                         @@_not_x_ ~1~
  660                                                         @@_size_, ~1~ 2
  661                                                         ldhx      ~1~
  662                                                         aix       #1
  663                                                         sthx      ~1~
  664                                                         endm
  665                                     
  666                                     ;-------------------------------------------------------------------------------
  667                                     
  668                                     DecByHX             macro     Variable
  669                                                         mset      #
  670                                               #ifnhcs
  671                                                         mstop     Macro works with 9S08 only
  672                                               #endif
  673                                                         @@_not_x_ ~1~
  674                                                         @@_size_, ~1~ 2
  675                                                         ldhx      ~1~
  676                                                         aix       #-1
  677                                                         sthx      ~1~
  678                                                         endm
  679                                     
  680                                     ;*******************************************************************************
  681                                     ; COM for bytes (differs from built-in COM in that it works for any address)
  682                                     
  683                                     com.b               macro     Variable
  684                                               #ifparm ~,1~~2~
  685                                                         com       ~@~
  686                                                         mexit
  687                                               #endif
  688                                               #ifz ~1~&$FFFFFF00
  689                                                         com       ~@~
  690                                                         mexit
  691                                               #endif
  692                                                         psha
  693                                                         lda       ~@~
  694                                                         coma
  695                                                         sta       ~@~
  696                                                         pula
  697                                                         endm
  698                                     
  699                                     ;*******************************************************************************
  700                                     ; COM for words
  701                                     
  702                                     com.w               macro     Variable
  703                                               #ifparm ~,1~~2~
  704                                                         com       ~@~
  705                                                         com       ~1,~+1~,1~,~2~
  706                                                         mexit
  707                                               #endif
  708                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  709                                                         com       ~1~
  710                                                         com       ~1~+1
  711                                                         mexit
  712                                               #endif
  713                                                         pshhx
  714                                                         ldhx      #~1~
  715                                                         com       ,ax
  716                                                         com       1,ax
  717                                                         pulhx
  718                                                         endm
  719                                     
  720                                     ;*******************************************************************************
  721                                     ; COM for longs
  722                                     
  723                                     com.l               macro     Variable
  724                                               #ifparm ~,1~~2~
  725                                                         com       ~@~
  726                                                         com       ~1,~+1~,1~,~2~
  727                                                         com       ~1,~+2~,1~,~2~
  728                                                         com       ~1,~+3~,1~,~2~
  729                                                         mexit
  730                                               #endif
  731                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  732                                                         com       ~1~
  733                                                         com       ~1~+1
  734                                                         com       ~1~+2
  735                                                         com       ~1~+3
  736                                                         mexit
  737                                               #endif
  738                                                         pshhx
  739                                                         ldhx      #~1~
  740                                                         com       ,ax
  741                                                         com       1,ax
  742                                                         com       2,ax
  743                                                         com       3,ax
  744                                                         pulhx
  745                                                         endm
  746                                     
  747                                     ;*******************************************************************************
  748                                     ; NEG for bytes (differs from built-in NEG in that it works for any address)
  749                                     
  750                                     neg.b               macro     Variable
  751                                               #ifparm ~,1~~2~
  752                                                         neg       ~@~
  753                                                         mexit
  754                                               #endif
  755                                               #ifz ~1~&$FFFFFF00
  756                                                         neg       ~@~
  757                                                         mexit
  758                                               #endif
  759                                                         psha
  760                                                         lda       ~@~
  761                                                         nega
  762                                                         sta       ~@~
  763                                                         pula
  764                                                         endm
  765                                     
  766                                     ;*******************************************************************************
  767                                     ; NEG for words
  768                                     
  769                                     neg.w               macro     Variable
  770                                               #ifparm ~,1~~2~
  771                                                         com       ~@~
  772                                                         neg       ~1,~+1~,1~,~2~
  773                                                         bne       Done$$$
  774                                                         inc       ~@~
  775                                     Done$$$
  776                                                         mexit
  777                                               #endif
  778                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  779                                                         com       ~1~
  780                                                         neg       ~1~+1
  781                                                         bne       Done$$$
  782                                                         inc       ~1~
  783                                     Done$$$
  784                                                         mexit
  785                                               #endif
  786                                                         pshhx
  787                                                         ldhx      #~1~
  788                                                         com       ,ax
  789                                                         neg       1,ax
  790                                                         bne       Done$$$
  791                                                         inc       ,ax
  792                                     Done$$$
  793                                                         pulhx
  794                                                         endm
  795                                     
  796                                     ;*******************************************************************************
  797                                     ; NEG for longs
  798                                     
  799                                     neg.l               macro     Variable
  800                                               #ifparm ~,1~~2~
  801                                                         com       ~@~
  802                                                         com       ~1,~+1~,1~,~2~
  803                                                         com       ~1,~+2~,1~,~2~
  804                                                         neg       ~1,~+3~,1~,~2~
  805                                                         bne       Done$$$
  806                                                         inc       ~1,~+2~,1~,~2~
  807                                                         bne       Done$$$
  808                                                         inc       ~1,~+1~,1~,~2~
  809                                                         bne       Done$$$
  810                                                         inc       ~@~
  811                                     Done$$$
  812                                                         mexit
  813                                               #endif
  814                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  815                                                         com       ~1~
  816                                                         com       ~1~+1
  817                                                         com       ~1~+2
  818                                                         neg       ~1~+3
  819                                                         bne       Done$$$
  820                                                         inc       ~1~+2
  821                                                         bne       Done$$$
  822                                                         inc       ~1~+1
  823                                                         bne       Done$$$
  824                                                         inc       ~1~
  825                                     Done$$$
  826                                                         mexit
  827                                               #endif
  828                                                         pshhx
  829                                                         ldhx      #~1~
  830                                                         com       ,ax
  831                                                         com       1,ax
  832                                                         com       2,ax
  833                                                         neg       3,ax
  834                                                         bne       Done$$$
  835                                                         inc       2,ax
  836                                                         bne       Done$$$
  837                                                         inc       1,ax
  838                                                         bne       Done$$$
  839                                                         inc       ,ax
  840                                     Done$$$
  841                                                         pulhx
  842                                                         endm
  843                                     
  844                                     ;*******************************************************************************
  845                                     ; (ABS) Make operand positive
  846                                     
  847                                     abs.b               macro     ByteVariable
  848                                                         mreq      1:ByteVariable
  849                                                         @@tst.b   ~@~
  850                                                         bpl       Done$$$
  851                                                         @@neg.b   ~@~
  852                                     Done$$$
  853                                                         endm
  854                                     
  855                                     ;-------------------------------------------------------------------------------
  856                                     
  857                                     abs.w               macro     WordVariable
  858                                                         mreq      1:WordVariable
  859                                                         @@tst.b   ~@~
  860                                                         bpl       Done$$$
  861                                                         @@neg.w   ~@~
  862                                     Done$$$
  863                                                         endm
  864                                     
  865                                     ;-------------------------------------------------------------------------------
  866                                     
  867                                     abs.l               macro     LongVariable
  868                                                         mreq      1:LongVariable
  869                                                         @@tst.b   ~@~
  870                                                         bpl       Done$$$
  871                                                         @@neg.l   ~@~
  872                                     Done$$$
  873                                                         endm
  874                                     
  875                                     ;*******************************************************************************
  876                                     ; MOV for bytes (differs from built-in MOV in that it works for any address)
  877                                     ;               (uses COPY if MOV not possible)
  878                                     
  879                                     mov.b               macro     [#]Source,Destination
  880                                                         @@is8bit  ~1~
  881                                         #ifparm ~#~
  882                                               #ifz ~2~&$FFFFFF00
  883                                                         mov       ~@~
  884                                                         mexit
  885                                               #endif
  886                                                         @Copy.b   ~@~
  887                                                         mexit
  888                                         #endif
  889                                               #ifz ~1~&$FFFFFF00
  890                                                   #ifz ~2~&$FFFFFF00
  891                                                         mov       ~@~
  892                                                         mexit
  893                                                   #endif
  894                                               #endif
  895                                                         @Copy.b   ~@~
  896                                                         endm
  897                                     
  898                                     ;*******************************************************************************
  899                                     ; MOV for words (uses COPY if MOV not possible)
  900                                     ; MSB moved last to correctly adjust the N flag.
  901                                     
  902                                     mov.w               macro     [#]Source,Destination
  903                                                         @@is16bit ~1~
  904                                               #ifnz ~2~&$FFFFFF00
  905                                                         @Copy.w   ~@~
  906                                                         mexit
  907                                               #endif
  908                                               #ifb ~#~
  909                                                   #ifnz ~1~&$FFFFFF00
  910                                                         @Copy.w   ~@~
  911                                                         mexit
  912                                                   #endif
  913                                               #endif
  914                                                         mov       ~[1.-2]~,~[2.-2]~
  915                                                         mov       ~[1.-1]~,~[2.-1]~
  916                                                         endm
  917                                     
  918                                     ;*******************************************************************************
  919                                     ; MOV for longs (uses COPY if MOV not possible)
  920                                     ; MSB moved last to correctly adjust the N flag.
  921                                     
  922                                     mov.l               macro     [#]Source,Destination
  923                                               #ifnz ~2~&$FFFFFF00
  924                                                         @Copy.l   ~@~
  925                                                         mexit
  926                                               #endif
  927                                               #ifb ~#~
  928                                                   #ifnz ~1~&$FFFFFF00
  929                                                         @Copy.l   ~@~
  930                                                         mexit
  931                                                   #endif
  932                                               #endif
  933                                                         mov       ~[1.4]~,~[2.4]~
  934                                                         mov       ~[1.3]~,~[2.3]~
  935                                                         mov       ~[1.2]~,~[2.2]~
  936                                                         mov       ~[1.1]~,~[2.1]~
  937                                                         endm
  938                                     
  939                                     ;*******************************************************************************
  940                                     ; LSL for bytes (differs from built-in LSL in that it works for any address)
  941                                     
  942                                     lsl.b               macro     Variable
  943                                               #ifparm ~,1~~2~
  944                                                         lsl       ~@~
  945                                                         mexit
  946                                               #endif
  947                                               #ifz ~1~&$FFFFFF00
  948                                                         lsl       ~@~
  949                                                         mexit
  950                                               #endif
  951                                                         psha
  952                                                         lda       ~@~
  953                                                         lsla
  954                                                         sta       ~@~
  955                                                         pula
  956                                                         endm
  957                                     
  958                                     ;*******************************************************************************
  959                                     ; LSL for words
  960                                     
  961                                     lsl.w               macro     Variable
  962                                               #ifparm ~,1~~2~
  963                                                         lsl       ~1,~+1~,1~,~2~
  964                                                         rol       ~@~
  965                                                         mexit
  966                                               #endif
  967                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  968                                                         lsl       ~1~+1
  969                                                         rol       ~1~
  970                                                         mexit
  971                                               #endif
  972                                                         pshhx
  973                                                         ldhx      #~1~
  974                                                         lsl       1,ax
  975                                                         rol       ,ax
  976                                                         pulhx
  977                                                         endm
  978                                     
  979                                     ;*******************************************************************************
  980                                     ; LSL for longs
  981                                     
  982                                     lsl.l               macro     Variable
  983                                               #ifparm ~,1~~2~
  984                                                         lsl       ~1,~+3~,1~,~2~
  985                                                         rol       ~1,~+2~,1~,~2~
  986                                                         rol       ~1,~+1~,1~,~2~
  987                                                         rol       ~@~
  988                                                         mexit
  989                                               #endif
  990                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
  991                                                         lsl       ~1~+3
  992                                                         rol       ~1~+2
  993                                                         rol       ~1~+1
  994                                                         rol       ~1~
  995                                                         mexit
  996                                               #endif
  997                                                         pshhx
  998                                                         ldhx      #~1~
  999                                                         lsl       3,ax
 1000                                                         rol       2,ax
 1001                                                         rol       1,ax
 1002                                                         rol       ,ax
 1003                                                         pulhx
 1004                                                         endm
 1005                                     
 1006                                     ;*******************************************************************************
 1007                                     ; LSR for bytes (differs from built-in LSR in that it works for any address)
 1008                                     
 1009                                     lsr.b               macro     Variable
 1010                                               #ifparm ~,1~~2~
 1011                                                         lsr       ~@~
 1012                                                         mexit
 1013                                               #endif
 1014                                               #ifz ~1~&$FFFFFF00
 1015                                                         lsr       ~@~
 1016                                                         mexit
 1017                                               #endif
 1018                                                         psha
 1019                                                         lda       ~@~
 1020                                                         lsra
 1021                                                         sta       ~@~
 1022                                                         pula
 1023                                                         endm
 1024                                     
 1025                                     ;*******************************************************************************
 1026                                     ; LSR for words
 1027                                     
 1028                                     lsr.w               macro     Variable
 1029                                               #ifparm ~,1~~2~
 1030                                                         lsr       ~@~
 1031                                                         ror       ~1,~+1~,1~,~2~
 1032                                                         mexit
 1033                                               #endif
 1034                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
 1035                                                         lsr       ~1~
 1036                                                         ror       ~1~+1
 1037                                                         mexit
 1038                                               #endif
 1039                                                         pshhx
 1040                                                         ldhx      #~1~
 1041                                                         lsr       ,ax
 1042                                                         ror       1,ax
 1043                                                         pulhx
 1044                                                         endm
 1045                                     
 1046                                     ;*******************************************************************************
 1047                                     ; LSR for longs
 1048                                     
 1049                                     lsr.l               macro     Variable
 1050                                               #ifparm ~,1~~2~
 1051                                                         lsr       ~@~
 1052                                                         ror       ~1,~+1~,1~,~2~
 1053                                                         ror       ~1,~+2~,1~,~2~
 1054                                                         ror       ~1,~+3~,1~,~2~
 1055                                                         mexit
 1056                                               #endif
 1057                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
 1058                                                         lsr       ~1~
 1059                                                         ror       ~1~+1
 1060                                                         ror       ~1~+2
 1061                                                         ror       ~1~+3
 1062                                                         mexit
 1063                                               #endif
 1064                                                         pshhx
 1065                                                         ldhx      #~1~
 1066                                                         lsr       ,ax
 1067                                                         ror       1,ax
 1068                                                         ror       2,ax
 1069                                                         ror       3,ax
 1070                                                         pulhx
 1071                                                         endm
 1072                                     
 1073                                     ;*******************************************************************************
 1074                                     ; ASR for bytes (differs from built-in ASR in that it works for any address)
 1075                                     
 1076                                     asr.b               macro     Variable
 1077                                               #ifparm ~,1~~2~
 1078                                                         asr       ~@~
 1079                                                         mexit
 1080                                               #endif
 1081                                               #ifz ~1~&$FFFFFF00
 1082                                                         asr       ~@~
 1083                                                         mexit
 1084                                               #endif
 1085                                                         psha
 1086                                                         lda       ~@~
 1087                                                         asra
 1088                                                         sta       ~@~
 1089                                                         pula
 1090                                                         endm
 1091                                     
 1092                                     ;*******************************************************************************
 1093                                     ; ASR for words
 1094                                     
 1095                                     asr.w               macro     Variable
 1096                                               #ifparm ~,1~~2~
 1097                                                         asr       ~@~
 1098                                                         ror       ~1,~+1~,1~,~2~
 1099                                                         mexit
 1100                                               #endif
 1101                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
 1102                                                         asr       ~1~
 1103                                                         ror       ~1~+1
 1104                                                         mexit
 1105                                               #endif
 1106                                                         pshhx
 1107                                                         ldhx      #~1~
 1108                                                         asr       ,ax
 1109                                                         ror       1,ax
 1110                                                         pulhx
 1111                                                         endm
 1112                                     
 1113                                     ;*******************************************************************************
 1114                                     ; ASR for longs
 1115                                     
 1116                                     asr.l               macro     Variable
 1117                                               #ifparm ~,1~~2~
 1118                                                         asr       ~@~
 1119                                                         ror       ~1,~+1~,1~,~2~
 1120                                                         ror       ~1,~+2~,1~,~2~
 1121                                                         ror       ~1,~+3~,1~,~2~
 1122                                                         mexit
 1123                                               #endif
 1124                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
 1125                                                         asr       ~1~
 1126                                                         ror       ~1~+1
 1127                                                         ror       ~1~+2
 1128                                                         ror       ~1~+3
 1129                                                         mexit
 1130                                               #endif
 1131                                                         pshhx
 1132                                                         ldhx      #~1~
 1133                                                         asr       ,ax
 1134                                                         ror       1,ax
 1135                                                         ror       2,ax
 1136                                                         ror       3,ax
 1137                                                         pulhx
 1138                                                         endm
 1139                                     
 1140                                     ;*******************************************************************************
 1141                                     ; ROR for bytes (differs from built-in ROR in that it works for any address)
 1142                                     
 1143                                     ror.b               macro     Variable
 1144                                               #ifparm ~,1~~2~
 1145                                                         ror       ~@~
 1146                                                         mexit
 1147                                               #endif
 1148                                               #ifz ~1~&$FFFFFF00
 1149                                                         ror       ~@~
 1150                                                         mexit
 1151                                               #endif
 1152                                                         psha
 1153                                                         lda       ~@~
 1154                                                         rora
 1155                                                         sta       ~@~
 1156                                                         pula
 1157                                                         endm
 1158                                     
 1159                                     ;*******************************************************************************
 1160                                     ; ROR for words
 1161                                     
 1162                                     ror.w               macro     Variable
 1163                                               #ifparm ~,1~~2~
 1164                                                         ror       ~@~
 1165                                                         ror       ~1,~+1~,1~,~2~
 1166                                                         mexit
 1167                                               #endif
 1168                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
 1169                                                         ror       ~1~
 1170                                                         ror       ~1~+1
 1171                                                         mexit
 1172                                               #endif
 1173                                                         pshhx
 1174                                                         ldhx      #~1~
 1175                                                         ror       ,ax
 1176                                                         ror       1,ax
 1177                                                         pulhx
 1178                                                         endm
 1179                                     
 1180                                     ;*******************************************************************************
 1181                                     ; ROR for longs
 1182                                     
 1183                                     ror.l               macro     Variable
 1184                                               #ifparm ~,1~~2~
 1185                                                         ror       ~@~
 1186                                                         ror       ~1,~+1~,1~,~2~
 1187                                                         ror       ~1,~+2~,1~,~2~
 1188                                                         ror       ~1,~+3~,1~,~2~
 1189                                                         mexit
 1190                                               #endif
 1191                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
 1192                                                         ror       ~1~
 1193                                                         ror       ~1~+1
 1194                                                         ror       ~1~+2
 1195                                                         ror       ~1~+3
 1196                                                         mexit
 1197                                               #endif
 1198                                                         pshhx
 1199                                                         ldhx      #~1~
 1200                                                         ror       ,ax
 1201                                                         ror       1,ax
 1202                                                         ror       2,ax
 1203                                                         ror       3,ax
 1204                                                         pulhx
 1205                                                         endm
 1206                                     
 1207                                     ;*******************************************************************************
 1208                                     ; ROL for bytes (differs from built-in ROL in that it works for any address)
 1209                                     
 1210                                     rol.b               macro     Variable
 1211                                               #ifparm ~,1~~2~
 1212                                                         rol       ~@~
 1213                                                         mexit
 1214                                               #endif
 1215                                               #ifz ~1~&$FFFFFF00
 1216                                                         rol       ~@~
 1217                                                         mexit
 1218                                               #endif
 1219                                                         psha
 1220                                                         lda       ~@~
 1221                                                         rola
 1222                                                         sta       ~@~
 1223                                                         pula
 1224                                                         endm
 1225                                     
 1226                                     ;*******************************************************************************
 1227                                     ; ROL for words
 1228                                     
 1229                                     rol.w               macro     Variable
 1230                                               #ifparm ~,1~~2~
 1231                                                         rol       ~1,~+1~,1~,~2~
 1232                                                         rol       ~@~
 1233                                                         mexit
 1234                                               #endif
 1235                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
 1236                                                         rol       ~1~+1
 1237                                                         rol       ~1~
 1238                                                         mexit
 1239                                               #endif
 1240                                                         pshhx
 1241                                                         ldhx      #~1~
 1242                                                         rol       1,ax
 1243                                                         rol       ,ax
 1244                                                         pulhx
 1245                                                         endm
 1246                                     
 1247                                     ;*******************************************************************************
 1248                                     ; ROL for longs
 1249                                     
 1250                                     rol.l               macro     Variable
 1251                                               #ifparm ~,1~~2~
 1252                                                         rol       ~1,~+3~,1~,~2~
 1253                                                         rol       ~1,~+2~,1~,~2~
 1254                                                         rol       ~1,~+1~,1~,~2~
 1255                                                         rol       ~@~
 1256                                                         mexit
 1257                                               #endif
 1258                                               #ifz ~1~&$FFFFFF00                      ;assumes whole word in zero page
 1259                                                         rol       ~1~+3
 1260                                                         rol       ~1~+2
 1261                                                         rol       ~1~+1
 1262                                                         rol       ~1~
 1263                                                         mexit
 1264                                               #endif
 1265                                                         pshhx
 1266                                                         ldhx      #~1~
 1267                                                         rol       3,ax
 1268                                                         rol       2,ax
 1269                                                         rol       1,ax
 1270                                                         rol       ,ax
 1271                                                         pulhx
 1272                                                         endm
 1273                                     
 1274                                     ;*******************************************************************************
 1275                                     ; Copy bytes using RegA (shorter code than Copy but it does not protect RegA)
 1276                                     
 1277                                     mova                macro     [#]Source,Destination
 1278                                                         @@is8bit  ~1~
 1279                                                         lda       ~1~
 1280                                                         sta       ~2~
 1281                                                         endm
 1282                                     
 1283                                     ;*******************************************************************************
 1284                                     
 1285                                     mova.w              macro     [#]Source,Destination
 1286                                                         @@is16bit ~1~
 1287                                                         lda       ~[1.-2]~
 1288                                                         sta       ~[2.-2]~
 1289                                                         lda       ~[1.-1]~
 1290                                                         sta       ~[2.-1]~
 1291                                                         endm
 1292                                     
 1293                                     ;*******************************************************************************
 1294                                     
 1295                                     mova.l              macro     [#]Source,Destination
 1296                                                         lda       ~[1.4]~
 1297                                                         sta       ~[2.4]~
 1298                                                         lda       ~[1.3]~
 1299                                                         sta       ~[2.3]~
 1300                                                         lda       ~[1.2]~
 1301                                                         sta       ~[2.2]~
 1302                                                         lda       ~[1.1]~
 1303                                                         sta       ~[2.1]~
 1304                                                         endm
 1305                                     
 1306                                     ;*******************************************************************************
 1307                                     ; Copy bytes - no registers destroyed
 1308                                     
 1309                                     Copy.b              macro     [#]Source,Destination
 1310                                                         #push
 1311                                                         #spauto   :sp
 1312                                                         psha
 1313                                                         lda       ~1~
 1314                                                         sta       ~2~
 1315                                                         pula
 1316                                                         #pull
 1317                                                         endm
 1318                                     
 1319                                     ;*******************************************************************************
 1320                                     ; Copy words - no registers destroyed
 1321                                     
 1322                                     Copy.w              macro     [#]Source,Destination
 1323                                                         #push
 1324                                                         #spauto   :sp
 1325                                                         psha
 1326                                                         @@mova.w  ~@~
 1327                                                         pula
 1328                                                         #pull
 1329                                                         endm
 1330                                     
 1331                                     ;*******************************************************************************
 1332                                     ; Copy longs - no registers destroyed
 1333                                     
 1334                                     Copy.l              macro     [#]Source,Destination
 1335                                                         #push
 1336                                                         #spauto   :sp
 1337                                                         psha
 1338                                                         @@mova.l  ~@~
 1339                                                         pula
 1340                                                         #pull
 1341                                                         endm
 1342                                     
 1343                                     ;*******************************************************************************
 1344                                     ; ADD bytes (see COMMON.INC)
 1345                                     ; Note: No destination required if you only need to add in RegA
 1346                                     
 1347                                     ;*******************************************************************************
 1348                                     ; ADD words
 1349                                     
 1350                                     add.w               macro     [#]Operand1,[#]Operand2,Destination
 1351                                                         mreq      1,2,3
 1352                                                         @@add.b   ~[1.-2]~\,~[2.-2]~\,~[3.-2]~
 1353                                                         @adc.b    ~[1.-1]~\,~[2.-1]~\,~[3.-1]~
 1354                                                         endm
 1355                                     
 1356                                     ;*******************************************************************************
 1357                                     ; ADD longs
 1358                                     
 1359                                     add.l               macro     [#]Operand1,[#]Operand2,Destination
 1360                                                         mreq      1,2,3
 1361                                                         @@add.b   ~[1.4]~\,~[2.4]~\,~[3.4]~
 1362                                                         @@adc.b   ~[1.3]~\,~[2.3]~\,~[3.3]~
 1363                                                         @@adc.b   ~[1.2]~\,~[2.2]~\,~[3.2]~
 1364                                                         @adc.b    ~[1.1]~\,~[2.1]~\,~[3.1]~
 1365                                                         endm
 1366                                     
 1367                                     ;*******************************************************************************
 1368                                     ; ADD bytes with Carry (see COMMON.INC)
 1369                                     ; Note: No destination required if you only interested in the Carry flag
 1370                                     
 1371                                     ;*******************************************************************************
 1372                                     ; ADD words with Carry
 1373                                     ; Note: No destination required if you only interested in the Carry flag
 1374                                     
 1375                                     adc.w               macro     [#]Operand1,[#]Operand2[,Destination]
 1376                                                         mreq      1,2:[#]Operand1,[#]Operand2[,Destination]
 1377                                                         @@adc.b   ~[1.-2]~\,~[2.-2]~\,~[3.-2]~
 1378                                                         @adc.b    ~[1.-1]~\,~[2.-1]~\,~[3.-1]~
 1379                                                         endm
 1380                                     
 1381                                     ;*******************************************************************************
 1382                                     ; ADD longs with Carry
 1383                                     ; Note: No destination required if you only interested in the Carry flag
 1384                                     
 1385                                     adc.l               macro     [#]Operand1,[#]Operand2[,Destination]
 1386                                                         mreq      1,2:[#]Operand1,[#]Operand2[,Destination]
 1387                                                         @@adc.b   ~[1.4]~\,~[2.4]~\,~[3.4]~
 1388                                                         @@adc.b   ~[1.3]~\,~[2.3]~\,~[3.3]~
 1389                                                         @@adc.b   ~[1.2]~\,~[2.2]~\,~[3.2]~
 1390                                                         @adc.b    ~[1.1]~\,~[2.1]~\,~[3.1]~
 1391                                                         endm
 1392                                     
 1393                                     ;*******************************************************************************
 1394                                     ; SUB bytes
 1395                                     ; Note: No destination required if you only need to compare
 1396                                     
 1397                                     sub.b               macro     [#]Operand1,[#]Operand2[,Destination]
 1398                                                         lda       ~1~
 1399                                                         sub       ~2~
 1400                                                         @_sta_    ~3~
 1401                                                         endm
 1402                                     
 1403                                     ;*******************************************************************************
 1404                                     ; SUB words
 1405                                     ; Note: No destination required if you only need to compare
 1406                                     
 1407                                     sub.w               macro     [#]Operand1,[#]Operand2[,Destination]
 1408                                                         mreq      1,2:[#]Operand1,[#]Operand2[,Destination]
 1409                                                         @@sub.b   ~[1.-2]~\,~[2.-2]~\,~[3.-2]~
 1410                                                         @sbc.b    ~[1.-1]~\,~[2.-1]~\,~[3.-1]~
 1411                                                         endm
 1412                                     
 1413                                     ;*******************************************************************************
 1414                                     ; SUB longs
 1415                                     ; (With immediate mode, it subtracts first operand from second -- more natural)
 1416                                     ; Note: No destination required if you only need to compare
 1417                                     
 1418                                     sub.l               macro     [#]Operand1,[#]Operand2[,Destination]
 1419                                                         mreq      1,2:[#]Operand1,[#]Operand2[,Destination]
 1420                                                         @@sub.b   ~[1.4]~\,~[2.4]~\,~[3.4]~
 1421                                                         @@sbc.b   ~[1.3]~\,~[2.3]~\,~[3.3]~
 1422                                                         @@sbc.b   ~[1.2]~\,~[2.2]~\,~[3.2]~
 1423                                                         @sbc.b    ~[1.1]~\,~[2.1]~\,~[3.1]~
 1424                                                         endm
 1425                                     
 1426                                     ;*******************************************************************************
 1427                                     ; SUB bytes with Borrow
 1428                                     ; Note: No destination required if you only need to compare
 1429                                     
 1430                                     sbc.b               macro     [#]Operand1,[#]Operand2[,Destination]
 1431                                                         lda       ~1~
 1432                                                         sbc       ~2~
 1433                                                         @_sta_    ~3~
 1434                                                         endm
 1435                                     
 1436                                     ;*******************************************************************************
 1437                                     ; SUB words with Borrow
 1438                                     ; Note: No destination required if you only need to compare
 1439                                     
 1440                                     sbc.w               macro     [#]Operand1,[#]Operand2[,Destination]
 1441                                                         mreq      1,2:[#]Operand1,[#]Operand2[,Destination]
 1442                                                         @@sbc.b   ~[1.-2]~\,~[2.-2]~\,~[3.-2]~
 1443                                                         @sbc.b    ~[1.-1]~\,~[2.-1]~\,~[3.-1]~
 1444                                                         endm
 1445                                     
 1446                                     ;*******************************************************************************
 1447                                     ; SUB longs with Borrow
 1448                                     ; Note: No destination required if you only need to compare
 1449                                     
 1450                                     sbc.l               macro     [#]Operand1,[#]Operand2[,Destination]
 1451                                                         mreq      1,2:[#]Operand1,[#]Operand2[,Destination]
 1452                                                         @@sbc.b   ~[1.4]~\,~[2.4]~\,~[3.4]~
 1453                                                         @@sbc.b   ~[1.3]~\,~[2.3]~\,~[3.3]~
 1454                                                         @@sbc.b   ~[1.2]~\,~[2.2]~\,~[3.2]~
 1455                                                         @sbc.b    ~[1.1]~\,~[2.1]~\,~[3.1]~
 1456                                                         endm
 1457                                     
 1458                                     ;*******************************************************************************
 1459                                     ; AND bytes
 1460                                     
 1461                                     and.b               macro     [#]Operand1,Operand2[,Destination]
 1462                                                         lda       ~1~
 1463                                                         and       ~2~
 1464                                                         @_sta_    ~3~
 1465                                                         endm
 1466                                     
 1467                                     ;*******************************************************************************
 1468                                     ; AND words
 1469                                     
 1470                                     and.w               macro     [#]Operand1,[#]Operand2,Destination
 1471                                                         mreq      1,2,3
 1472                                                         @@and.b   ~[1.-1]~\,~[2.-1]~\,~[3.-1]~
 1473                                                         @and.b    ~[1.-2]~\,~[2.-2]~\,~[3.-2]~
 1474                                                         endm
 1475                                     
 1476                                     ;*******************************************************************************
 1477                                     ; AND longs
 1478                                     
 1479                                     and.l               macro     [#]Operand1,[#]Operand2,Destination
 1480                                                         mreq      1,2,3
 1481                                                         @@and.b   ~[1.1]~\,~[2.1]~\,~[3.1]~
 1482                                                         @@and.b   ~[1.2]~\,~[2.2]~\,~[3.2]~
 1483                                                         @@and.b   ~[1.3]~\,~[2.3]~\,~[3.3]~
 1484                                                         @and.b    ~[1.4]~\,~[2.4]~\,~[3.4]~
 1485                                                         endm
 1486                                     
 1487                                     ;*******************************************************************************
 1488                                     ; OR bytes
 1489                                     
 1490                                     ora.b               macro     [#]Operand1,Operand2[,Destination]
 1491                                                         lda       ~1~
 1492                                                         ora       ~2~
 1493                                                         @_sta_    ~3~
 1494                                                         endm
 1495                                     
 1496                                     ;*******************************************************************************
 1497                                     ; OR words
 1498                                     
 1499                                     ora.w               macro     [#]Operand1,[#]Operand2,Destination
 1500                                                         mreq      1,2,3
 1501                                                         @@ora.b   ~[1.-1]~\,~[2.-1]~\,~[3.-1]~
 1502                                                         @ora.b    ~[1.-2]~\,~[2.-2]~\,~[3.-2]~
 1503                                                         endm
 1504                                     
 1505                                     ;*******************************************************************************
 1506                                     ; OR longs
 1507                                     
 1508                                     ora.l               macro     [#]Operand1,[#]Operand2,Destination
 1509                                                         mreq      1,2,3
 1510                                                         @@ora.b   ~[1.1]~\,~[2.1]~\,~[3.1]~
 1511                                                         @@ora.b   ~[1.2]~\,~[2.2]~\,~[3.2]~
 1512                                                         @@ora.b   ~[1.3]~\,~[2.3]~\,~[3.3]~
 1513                                                         @ora.b    ~[1.4]~\,~[2.4]~\,~[3.4]~
 1514                                                         endm
 1515                                     
 1516                                     ;*******************************************************************************
 1517                                     ; XOR bytes
 1518                                     ; Note: No destination required if you only need result in RegA
 1519                                     
 1520                                     eor.b               macro     [#]Operand1,Operand2[,Destination]
 1521                                                         lda       ~1~
 1522                                                         eor       ~2~
 1523                                                         @_sta_    ~3~
 1524                                                         endm
 1525                                     
 1526                                     ;*******************************************************************************
 1527                                     ; XOR words
 1528                                     
 1529                                     eor.w               macro     [#]Operand1,[#]Operand2,Destination
 1530                                                         mreq      1,2,3
 1531                                                         @@eor.b   ~[1.-1]~\,~[2.-1]~\,~[3.-1]~
 1532                                                         @eor.b    ~[1.-2]~\,~[2.-2]~\,~[3.-2]~
 1533                                                         endm
 1534                                     
 1535                                     ;*******************************************************************************
 1536                                     ; XOR longs
 1537                                     
 1538                                     eor.l               macro     [#]Operand1,[#]Operand2,Destination
 1539                                                         mreq      1,2,3
 1540                                                         @@eor.b   ~[1.1]~\,~[2.1]~\,~[3.1]~
 1541                                                         @@eor.b   ~[1.2]~\,~[2.2]~\,~[3.2]~
 1542                                                         @@eor.b   ~[1.3]~\,~[2.3]~\,~[3.3]~
 1543                                                         @eor.b    ~[1.4]~\,~[2.4]~\,~[3.4]~
 1544                                                         endm
 1545                                     
 1546                                     ;*******************************************************************************
 1547                                     ; CMP for bytes
 1548                                     
 1549                                     cmp.b               macro     [#]Operand1,[#]Operand2
 1550                                                         #push
 1551                                                         #spauto   :sp
 1552                                                         psha
 1553                                                         @@_ldacmp_ ~@~
 1554                                                         pula
 1555                                                         #pull
 1556                                                         endm
 1557                                     
 1558                                     ;*******************************************************************************
 1559                                     ; CMP for words
 1560                                     
 1561                                     cmp.w               macro     [#]Operand1,[#]Operand2
 1562                                                         #push
 1563                                                         #spauto   :sp
 1564                                                         psha
 1565                                                         @@_ldacmp_ ~[1.-1]~\,~[2.-1]~
 1566                                                         bne       Done$$$
 1567                                                         @@_ldacmp_ ~[1.-2]~\,~[2.-2]~
 1568                                     Done$$$
 1569                                                         pula
 1570                                                         #pull
 1571                                                         endm
 1572                                     
 1573                                     ;*******************************************************************************
 1574                                     ; CMP for longs
 1575                                     
 1576                                     cmp.l               macro     [#]Operand1,[#]Operand2
 1577                                                         #push
 1578                                                         #spauto   :sp
 1579                                                         psha
 1580                                                         @@_ldacmp_ ~[1.1]~\,~[2.1]~
 1581                                                         bne       Done$$$
 1582                                                         @@_ldacmp_ ~[1.2]~\,~[2.2]~
 1583                                                         bne       Done$$$
 1584                                                         @@_ldacmp_ ~[1.3]~\,~[2.3]~
 1585                                                         bne       Done$$$
 1586                                                         @@_ldacmp_ ~[1.4]~\,~[2.4]~
 1587                                     Done$$$
 1588                                                         pula
 1589                                                         #pull
 1590                                                         endm
 1591                                     
 1592                                     ;*******************************************************************************
 1593                                     ; DIV byte
 1594                                     
 1595                                     div.b               macro     Variable[,[#]Divisor]
 1596                                                         @@_not_x_ ~1~
 1597                                               #ifparm ~2~
 1598                                                         ldx       ~2~
 1599                                                         clrh
 1600                                               #endif
 1601                                               #ifparm ~'~,1~'.1.3~ = ,sp
 1602                                               #iftos ~1,~
 1603                                                         pula
 1604                                                         div
 1605                                                         psha
 1606                                                         mexit
 1607                                               #endif
 1608                                               #endif
 1609                                                         lda       ~1~
 1610                                                         div
 1611                                                         sta       ~1~
 1612                                                         endm
 1613                                     
 1614                                     ;*******************************************************************************
 1615                                     ; DIV word
 1616                                     
 1617                                     div.w               macro     Variable[,[#]Divisor]
 1618                                                         @@div.b   ~@~
 1619                                                         @div.b    ~1,~+1~,1~
 1620                                                         endm
 1621                                     
 1622                                     ;*******************************************************************************
 1623                                     ; DIV long
 1624                                     
 1625                                     div.l               macro     Variable[,[#]Divisor]
 1626                                                         @@div.w   ~@~
 1627                                                         @div.w    ~1,~+2~,1~
 1628                                                         endm
 1629                                     
 1630                                     ;*******************************************************************************
 1631                                     ; TST bytes (differs from built-in TST in that it works for any address)
 1632                                     
 1633                                     tst.b               macro     Operand
 1634                                                         #push
 1635                                                         #spauto   :sp
 1636                                                         #ppc
 1637                                               #ifb ~,1~~2~
 1638                                               #ifnz ]~1~
 1639                                                         psha
 1640                                                         lda       ~@~
 1641                                                         pula
 1642                                               #endif
 1643                                               #endif
 1644                                               #if :pc = :ppc
 1645                                                         tst       ~@~
 1646                                               #endif
 1647                                                         #pull
 1648                                                         endm
 1649                                     
 1650                                     ;*******************************************************************************
 1651                                     ; TST words (current non-HCS version leaves CCR[N] invalid)
 1652                                     
 1653                                     tst.w               macro     Operand
 1654                                                         mset      #
 1655                                                         #push
 1656                                                         #spauto   :sp
 1657                                               #ifhcs
 1658                                                         pshhx
 1659                                                         ldhx      ~1~
 1660                                                         pulhx
 1661                                               #else
 1662                                                         psha
 1663                                                         lda       ~[1.-1]~
 1664                                                         ora       ~[1.-2]~
 1665                                                         pula
 1666                                               #endif
 1667                                                         #pull
 1668                                                         endm
 1669                                     
 1670                                     ;*******************************************************************************
 1671                                     ; TST longs (current version leaves CCR[N] invalid)
 1672                                     
 1673                                     tst.l               macro     Operand
 1674                                                         mset      #
 1675                                                         #push
 1676                                                         #spauto   :sp
 1677                                                         psha
 1678                                                         lda       ~[1.1]~
 1679                                                         ora       ~[1.2]~
 1680                                                         ora       ~[1.3]~
 1681                                                         ora       ~[1.4]~
 1682                                                         pula
 1683                                                         #pull
 1684                                                         endm
 1685                                     
 1686                                     ;*******************************************************************************
 1687                                     ; AIS but only for non-zero values.  Especially useful with automatic offsets
 1688                                     ; such as :PSP which may assume any value, even zero.  Transparent in #MCF mode.
 1689                                     
 1690                                     ais                 macro     Size
 1691                                               #ifnz ~#1~
 1692                                                         !ais      ~1~
 1693                                               #endif
 1694                                                         endm
 1695                                     
 1696                                     ;*******************************************************************************
 1697                                     ; Find the Nth occurrence of a character/string inside given parameter text
 1698                                     ; (Positive number means search forward from start of text)
 1699                                     ; (Negative number means search backward from end of text)
 1700                                     
 1701                                     _FindStr_           macro     StrToFind,[-]Occurrence,Any text
 1702                                                         mreq      1:StrToFind,[-]Occurrence,Any text
 1703                                                         mdef      2,1
 1704                                                         mset      0,~1~
 1705                                               #ifnonum ~2~
 1706                                                         merror    Occurence has to be numeric
 1707                                               #endif
 1708                                                         #temp     ~2~
 1709                                                         mdel      1
 1710                                                         mdel      1
 1711                                                         mset      #
 1712                                               #if :text > :1
 1713                                                         mexit                         ;;string to find is larger than text
 1714                                               #endif
 1715                                     #if :temp > 0                                     ;;search from the start
 1716                                                         mdo
 1717                                               #ifparm \@~text~\@ == \@~1.{:mloop}.{:text}~\@
 1718                                                         #temp     :temp-1
 1719                                                 #ifz :temp
 1720                                                         mexit     :mloop
 1721                                                 #endif
 1722                                               #endif
 1723                                                         mloop     :1-:text+1
 1724                                                         mexit
 1725                                     #endif
 1726                                     #if :temp < 0                                     ;;search from the end
 1727                                                         #temp     -:temp
 1728                                                         mdo
 1729                                               #ifparm \@~text~\@ == \@~1.{:1-:mloop-:text+2}.{:text}~\@
 1730                                                         #temp     :temp-1
 1731                                                 #ifz :temp
 1732                                                         mexit     :1-:mloop-:text+2
 1733                                                 #endif
 1734                                               #endif
 1735                                                         mloop     :1-:text+1
 1736                                                         mexit
 1737                                     #endif
 1738                                                         merror    Occurrence must be positive or negative
 1739                                                         endm
 1740                                     
 1741                                     ;*******************************************************************************
 1742                                     ; Vector redirection for MCUs (like the QE128) which don't have it in hardware
 1743                                     ; This should be placed first (and only) thing inside any hard ISR handler.
 1744                                     
 1745                                     ReVector            macro     [#]SoftVectorAddress
 1746                                                         #push
 1747                                                         #spauto   :sp
 1748                                                         lda       ~[1.-2]~
 1749                                                         psha
 1750                                                         lda       ~[1.-1]~
 1751                                                         psha
 1752                                                         RTS                           ;;JUMP to stacked vector
 1753                                                         #pull
 1754                                                         endm
 1755                                     
 1756                                     ;*******************************************************************************
 1757                                     ; Define port bits by position (Similar functionality to PIN and BITNUM macros)
 1758                                     ; If label is present, first parameter is the address for the label
 1759                                     ; (Address may be followed by " size" for the label. Default size is one.)
 1760                                     ; If the label is missing only the bits need to be specified.
 1761                                     ; Bits should be given in least significant order (from Bit0 to BitN)
 1762                                     ; leaving blank those bits that are undefined/don't care.
 1763                                     
 1764                                     Port                macro     Address [Size][,Bit0,...,BitN]
 1765                                                         #temp     32                  ;;max 32-bit if no label is given
 1766                                               #ifnb ~label~
 1767                                                         mreq      1:Address [Size][,Bit0,...,BitN]
 1768                                                         mset      1,~1~ 1             ;;default size is one
 1769                                     ~label~             set       ~' '~,~' '2~
 1770                                                         mdel      1
 1771                                               #endif
 1772                                               #ifnz ::~label~
 1773                                                         #temp     ::~label~*8         ;;max bits if label is sized
 1774                                               #endif
 1775                                               #if :temp > 32
 1776                                                         merror    Max length is 32-bit (not {:temp}-bit)
 1777                                               #endif
 1778                                               #if :nn > :temp
 1779                                                         merror    More than {:temp} bits specified ({:nn})
 1780                                               #endif
 1781                                               #ifnz :nn
 1782                                                         #Message  --------------------------------------------------
 1783                                                 #ifnb ~label
 1784                                                         #Message  ~label~ [{~label~(h)}]
 1785                                                         #Message  --------------------------------------------------
 1786                                                 #endif
 1787                                               #endif
 1788                                                         mdo
 1789                                                         #temp     :mloop-1
 1790                                               #ifnb ~{:mloop}.~
 1791                                                         mset      0
 1792                                                 #ifparm ~{:mloop}.1.1~ = _            ;;if _ 1st, use LABEL_BIT format
 1793                                                         mset      0,~label~
 1794                                                 #endif
 1795                                                         #Message  ~label~~'....................'.1.{20-:label}~ Bit{:temp} ~{:mloop}.~
 1796                                     ~text~~{:mloop}.~.  equ       :temp
 1797                                     ~text~~{:mloop}.~_  equ       1<:temp
 1798                                               #endif
 1799                                                         mloop     :nn
 1800                                                         endm
 1801                                     
 1802                                     ;*******************************************************************************
 1803                                     ; Define PIN names (PIN for port, PIN. for pin number, and PIN_ for mask)
 1804                                     ; (It can also be used for bit-mapped registers or variables)
 1805                                     ; PinName can be either the 1st parameter (when three parameters are present),
 1806                                     ; or the label on the left side of the macro (when two parameters are present)
 1807                                     
 1808                                     Pin                 macro     [[PinName,]PORT[,BitNumber]]
 1809                                               #ifb ~@~
 1810                                                   #ifb ~label~
 1811                                                         merror    A label for the pin is required
 1812                                                   #endif
 1813                                                   #ifb ~text~
 1814                                                         merror    PORT parm required on first use
 1815                                                   #endif
 1816                                                         #temp     ~text~.+1
 1817                                     ~label~             set       ~text~
 1818                                     ~label~.            equ       {:temp}
 1819                                     ~label~_            equ       1<~label~.
 1820                                                         mset      0,~label~
 1821                                               #endif
 1822                                               #ifb ~label~
 1823                                                         mreq      1,2:PinName,PORT[,BitNumber]
 1824                                                         mdef      3,0
 1825                                                         mset      0,~1~
 1826                                                         #temp     ~3~
 1827                                     ~1~                 set       ~2~
 1828                                     ~1~.                set       ~3~
 1829                                     ~1~_                set       1<~1~.
 1830                                               #else ifnb ~@~
 1831                                                         mreq      1:PORT[,BitNumber]
 1832                                                         mdef      2,0
 1833                                                         mset      0,~label~
 1834                                                         #temp     ~2~
 1835                                     ~label~             set       ~1~
 1836                                     ~label~.            equ       ~2~
 1837                                     ~label~_            equ       1<~label~.
 1838                                               #endif
 1839                                               #if :temp > 7
 1840                                                         #Warning  BitNumber ({:temp}) > 7
 1841                                               #endif
 1842                                                         endm
 1843                                     
 1844                                     ;*******************************************************************************
 1845                                     ; Check if a pin has been defined (normally via @PIN macro), else issue error.
 1846                                     ; (It can also be used for bit-mapped registers or variables.)
 1847                                     ; Place it inside a general-purpose module to warn the user including the module
 1848                                     ; about missing but required pin definitions.  The user then simply needs to add
 1849                                     ; the correct @pin definitions for each missing pin before including the module.
 1850                                     ; (Note: MSET allows us to do a simple trick; use parameter 0 as an 'embedded
 1851                                     ; macro' to define the error directive once, even though we use it three times.)
 1852                                     
 1853                                     CheckPin            macro     PinName[,PinName]*
 1854                                                         mset      0,#Fatal Pin \@~{:loop}.~\@ not defined with @pin
 1855                                               #ifndef ~{:loop}.~
 1856                                                         ~text~
 1857                                                         mtop      :n
 1858                                                         mexit
 1859                                               #endif
 1860                                               #ifndef ~{:loop}.~.
 1861                                                         ~text~
 1862                                                         mtop      :n
 1863                                                         mexit
 1864                                               #endif
 1865                                               #ifndef ~{:loop}.~_
 1866                                                         ~text~
 1867                                               #endif
 1868                                                         mtop      :n
 1869                                                         endm
 1870                                     
 1871                                     ;*******************************************************************************
 1872                                     ; Export pin(s)
 1873                                     
 1874                                     ExpPin              macro     PinName[,PinName]*
 1875                                                         mreq      1:PinName[,PinName]*
 1876                                                         mdo
 1877                                               #ifdef ~{:mloop}.~
 1878                                                         @@CheckPin ~{:mloop}.~
 1879                                                         #Export   ~{:mloop}.~,~{:mloop}.~.,~{:mloop}.~_
 1880                                               #endif
 1881                                                         mloop     :n
 1882                                                         endm
 1883                                     
 1884                                     ;*******************************************************************************
 1885                                     ; Read the status of a PIN into the CCR[C]
 1886                                     
 1887                                     ReadPin             macro     PinName
 1888                                               #ifb ~2~
 1889                                                         !brset    ~1~.,~1~,:pc+3
 1890                                               #else
 1891                                                         !brset    ~1~,~2~,:pc+3
 1892                                               #endif
 1893                                                         endm
 1894                                     
 1895                                     ;*******************************************************************************
 1896                                     ; Set pull-up for given PIN(s)
 1897                                     
 1898                                     Pullup              macro     PIN[,PIN]*[,,NoSaveRegAflag]
 1899                                                         mset      0,ABCDEFGHIJK       ;;ports to check (adjust as needed)
 1900                                               #if :loop = 1
 1901                                                         #temp
 1902                                               #endif
 1903                                                         mdo
 1904                                               #ifdef PT~text.{:mloop}.1~PUE
 1905                                               #if ~{:loop}.~ = PORT~text.{:mloop}.1~
 1906                                               #ifz ]PT~text.{:mloop}.1~PUE
 1907                                                         bset      ~{:loop}.~.,PT~text.{:mloop}.1~PUE
 1908                                               #else
 1909                                                   #if :n = :nn
 1910                                                     #ifz :temp
 1911                                                         psha
 1912                                                         #temp     1
 1913                                                     #endif
 1914                                                   #endif
 1915                                                         lda       PT~text.{:mloop}.1~PUE
 1916                                                         ora       #~{:loop}.~_
 1917                                                         sta       PT~text.{:mloop}.1~PUE
 1918                                               #endif
 1919                                               #endif
 1920                                               #endif
 1921                                                         mloop     :text
 1922                                                         mtop      :n
 1923                                                   #ifnz :temp
 1924                                                         pula
 1925                                                   #endif
 1926                                                         endm
 1927                                     
 1928                                     ;*******************************************************************************
 1929                                     ; Define Bit names using "Bit." for bit number, and "Bit_" for mask
 1930                                     
 1931                                     BitNum              macro     BinName,BitNumber
 1932                                     ~1~.                equ       ~2~
 1933                                     ~1~_                equ       1<~1~.
 1934                                                         endm
 1935                                     
 1936                                     ;*******************************************************************************
 1937                                     ; Define all BitName bits from MinNumber to MaxNumber
 1938                                     
 1939                                     Bits                macro     BitName,MinNumber,MaxNumber[,FirstBit]
 1940                                                         mreq      1,2,3:BitName,MinNumber,MaxNumber[,FirstBit]
 1941                                                         mdef      4,0
 1942                                                         mdo
 1943                                     ~1~{~2~+:mloop-1}.  equ       {~4~+:mloop-1}
 1944                                     ~1~{~2~+:mloop-1}_  equ       1<{~4~+:mloop-1}
 1945                                                         mloop     {~3~-~2~+1}
 1946                                                         endm
 1947                                     
 1948                                     ;*******************************************************************************
 1949                                     ; Make PIN an input or output, accordingly
 1950                                     
 1951                                     Input               macro     PinName[,PinName]*
 1952                                                         mreq      1:PinName[,PinName]*
 1953                                                         mswap     1,:loop
 1954                                               #ifdef DDR
 1955                                                         !bclr     ~1~.,~1~+DDR
 1956                                               #else
 1957                                                         @@bclr    ~1~.,~1~+DDRO
 1958                                                         @@bset    ~1~.,~1~+DDRI
 1959                                               #endif
 1960                                                         mtop      :n
 1961                                                         endm
 1962                                     
 1963                                     ;-------------------------------------------------------------------------------
 1964                                     
 1965                                     Output              macro     PinName[,PinName]*
 1966                                                         mreq      1:PinName[,PinName]*
 1967                                                         mswap     1,:loop
 1968                                               #ifdef DDR
 1969                                                         !bset     ~1~.,~1~+DDR
 1970                                               #else
 1971                                                         @@bclr    ~1~.,~1~+DDRI
 1972                                                         @@bset    ~1~.,~1~+DDRO
 1973                                               #endif
 1974                                                         mtop      :n
 1975                                                         endm
 1976                                     
 1977                                     ;*******************************************************************************
 1978                                     ; Skip one byte. For example, makes it easy to have a common routine exit with
 1979                                     ; CLC (for success) and SEC (for failure), one of them falling thru to the other
 1980                                     ; using @Skip1 to jump over the single-byte opposite effect instruction.
 1981                                     
 1982                                     Skip1               macro
 1983                                                         fcb       $21                 ;BRN xxx
 1984                                                         endm
 1985                                     
 1986                                     ;*******************************************************************************
 1987                                     ; Turn PIN On or Off, accordingly, and make sure it's an output.
 1988                                     
 1989                                     On                  macro     PinName[,PinName]*
 1990                                                         mreq      1:PinName[,PinName]*
 1991                                                         mswap     1,:loop
 1992                                                         !bset     ~1~.,~1~
 1993                                               #ifdef DDR
 1994                                                         !bset     ~1~.,~1~+DDR
 1995                                               #else
 1996                                                         @@bclr    ~1~.,~1~+DDRI
 1997                                                         @@bset    ~1~.,~1~+DDRO
 1998                                               #endif
 1999                                                         mtop      :n
 2000                                                         endm
 2001                                     
 2002                                     ;-------------------------------------------------------------------------------
 2003                                     
 2004                                     Off                 macro     PinName[,PinName]*
 2005                                                         mreq      1:PinName[,PinName]*
 2006                                                         mswap     1,:loop
 2007                                                         !bclr     ~1~.,~1~
 2008                                               #ifdef DDR
 2009                                                         !bset     ~1~.,~1~+DDR
 2010                                               #else
 2011                                                         @@bclr    ~1~.,~1~+DDRI
 2012                                                         @@bset    ~1~.,~1~+DDRO
 2013                                               #endif
 2014                                                         mtop      :n
 2015                                                         endm
 2016                                     
 2017                                     ;*******************************************************************************
 2018                                     ; Toggle Pin name
 2019                                     
 2020                                     Toggle              macro     PinName[,PinName]*
 2021                                                         mreq      1:PinName[,PinName]*
 2022                                                         psha
 2023                                                         mdo
 2024                                                         mswap     1,:mloop
 2025                                                         lda       ~1~
 2026                                                         eor       #~1~_               ;toggle pin
 2027                                                         sta       ~1~
 2028                                                         mloop     :n
 2029                                                         pula
 2030                                                         endm
 2031                                     
 2032                                     ;*******************************************************************************
 2033                                     ; CBEQ for any address (not quite as true as it may affect the CCR)
 2034                                     
 2035                                     cbeq                macro     CompareVariable[,Index],Address
 2036                                               #ifparm ~3~
 2037                                                         !cbeq     ~@~
 2038                                                         mexit
 2039                                               #endif
 2040                                               #ifparm ~1~ = x+
 2041                                                         !cbeq     ~@~
 2042                                                         mexit
 2043                                               #endif
 2044                                               #ifz ~1~&$FFFFFF00
 2045                                                         !cbeq     ~@~
 2046                                                         mexit
 2047                                               #endif
 2048                                               #ifparm ~2~ = *
 2049                                                         mset      2,{*}
 2050                                               #endif
 2051                                                         cmpa      ~1~
 2052                                                         beq       ~2~
 2053                                                         endm
 2054                                     
 2055                                     ;*******************************************************************************
 2056                                     ; CBEQA complement (not quite as true as it affects the CCR)
 2057                                     
 2058                                     cbnea               macro     CompareTarget,Address
 2059                                               #ifparm ~2~ = *
 2060                                                         mset      2,{*}
 2061                                               #endif
 2062                                                         cmpa      ~1~
 2063                                                         bne       ~2~
 2064                                                         endm
 2065                                     
 2066                                     ;*******************************************************************************
 2067                                     ; CBEQX complement (not quite as true as it affects the CCR)
 2068                                     
 2069                                     cbnex               macro     CompareTarget,Address
 2070                                               #ifparm ~2~ = *
 2071                                                         mset      2,{*}
 2072                                               #endif
 2073                                                         cmpx      ~1~
 2074                                                         bne       ~2~
 2075                                                         endm
 2076                                     
 2077                                     ;*******************************************************************************
 2078                                     
 2079                                     Copyright           macro     [SinceYear]
 2080                                                         mdef      1,{:year}
 2081                                               #ifparm ~1~ = {:year}
 2082                                                         mset      1
 2083                                               #else
 2084                                                         mset      1,~1~-
 2085                                               #endif
 2086                                                         #Message  Copyright (c) ASPiSYS ~1~{:year}
 2087                                                         fcs       'Copyright (c) ASPiSYS ~1~{:year}'
 2088                                                         endm
 2089                                     
 2090                                     ;*******************************************************************************
 2091                                     ; Some commonly-used OS8-related macros
 2092                                     ;*******************************************************************************
 2093                                     
 2094                                     ;*******************************************************************************
 2095                                     ; Give up current task's remaining timeslice if running under OS8
 2096                                     
 2097                                     fNextTask           macro
 2098                                               #ifdef _MTOS_
 2099                                                         os        fNextTask
 2100                                               #else
 2101                                                         cli
 2102                                                         nop
 2103                                               #endif
 2104                                                         endm
 2105                                     
 2106                                     ;*******************************************************************************
 2107                                     ; Semaphore Lock/Unlock
 2108                                     
 2109                                     fLock               macro     sema
 2110                                               #ifndef _MTOS_
 2111                                                         mexit
 2112                                               #endif
 2113                                               #if _MTOS_ < 124
 2114                                                         psha
 2115                                                         lda       #~#1~
 2116                                                         os        ~0~
 2117                                                         pula
 2118                                               #else
 2119                                                         os        ~0~
 2120                                                         fcb       ~#1~
 2121                                               #endif
 2122                                                         endm
 2123                                     
 2124                                     ;*******************************************************************************
 2125                                     
 2126                                     fLockAttempt        macro     sema
 2127                                               #ifndef _MTOS_
 2128                                                         mexit
 2129                                               #endif
 2130                                               #if _MTOS_ < 124
 2131                                                         psha
 2132                                                         lda       #~#1~
 2133                                                         os        ~0~
 2134                                                         pula
 2135                                               #else
 2136                                                         os        ~0~
 2137                                                         fcb       ~#1~
 2138                                               #endif
 2139                                                         endm
 2140                                     
 2141                                     
 2142                                     ;*******************************************************************************
 2143                                     
 2144                                     fUnlock             macro
 2145                                               #ifndef _MTOS_
 2146                                                         mexit
 2147                                               #endif
 2148                                               #if _MTOS_ < 124
 2149                                                         psha
 2150                                                         lda       #~#1~
 2151                                                         os        ~0~
 2152                                                         pula
 2153                                               #else
 2154                                                         os        ~0~
 2155                                                         fcb       ~#1~
 2156                                               #endif
 2157                                                         endm
 2158                                     
 2159                                     ;*******************************************************************************
 2160                                     ; Define one (or more) semaphore(s).  Skip already defined ones.
 2161                                     ; Create Lock/Unlock calls for each defined semaphore when using keyword #SAVE#
 2162                                     
 2163                                     sema                macro     Sema1[,Sema2]*
 2164                                     #ifparm ~1~ = #SAVE#
 2165                                                         mdo
 2166                                                         mset      2,~text','{:mloop}~
 2167                                               #ifb ~2~
 2168                                                         mexit
 2169                                               #endif
 2170                                               #ifdef sema~2~
 2171                                                         #Message  Defined Lock~2~ & Unlock~2~ calls
 2172                                     Lock~2~             proc
 2173                                                         psha
 2174                                                         tpa
 2175                                                         @@fLock   sema~2~
 2176                                                         tap
 2177                                                         pula
 2178                                                         rtc
 2179                                     
 2180                                     Unlock~2~           proc
 2181                                                         psha
 2182                                                         tpa
 2183                                                         @@fUnlock sema~2~
 2184                                                         tap
 2185                                                         pula
 2186                                                         rtc
 2187                                               #endif
 2188                                                         mloop
 2189                                                         mexit
 2190                                     #endif
 2191                                                         mdo
 2192                                                         mswap     1,:mloop
 2193                                               #ifndef sema~1~
 2194                                     sema~1~             exp       :index
 2195                                     MAXSEMAS            set       sema~1~
 2196                                                         mset      0,~1~,~text~
 2197                                               #endif
 2198                                                         mloop     :n
 2199                                                         endm
 2200                                     
 2201                                     ;*******************************************************************************
 2202                                     ; Define keys for ADKEYS.MOD based on actual voltage measured
 2203                                     ; Two possible call formats:
 2204                                     ; 1.                @DefADKey KEY,mVolts
 2205                                     ; 2. KEY_VALUE_KEY  @DefADKey mVolts
 2206                                     
 2207                                     DefADKey            macro     (KEY_VALUE_)NAME,mV
 2208                                               #ifb ~label~
 2209                                                         mreq      1,2:(KEY_VALUE_)NAME,mV
 2210                                                         mset      1,KEY_VALUE_~1~
 2211                                               #else
 2212                                                         mreq      1:mV
 2213                                                         mset      2,~1~               ;;move mV to parm 2
 2214                                                         mset      1,~label~           ;;move label to parm 1
 2215                                               #endif
 2216                                                         #temp     ~2~*255/VDD-10
 2217                                               #if :temp < 0
 2218                                                         #temp
 2219                                               #endif
 2220                                     ~1~                 set       :temp
 2221                                                         endm
 2222                                     
 2223                                     ;*******************************************************************************
 2224                                     ; Drop macros without warnings (Can't drop itself)
 2225                                     
 2226                                     Drop                macro     Macro1[,Macro2]*
 2227                                                         mreq      1:Macro1[,Macro2]*
 2228                                                         #push
 2229                                                         #NoWarn
 2230                                                         mdo
 2231                                                         mswap     1,:mloop
 2232                                               #ifnoparm ~1~ = ~0~                     ;;skip self
 2233                                                         #Drop     ~1~
 2234                                               #endif
 2235                                                         mloop     :n
 2236                                                         #pull
 2237                                                         endm
 2238                                     
 2239                                     ;*******************************************************************************
 2240                                     ; FCB (Form Constant Byte) with BCD value of the parameter constant (upto 99)
 2241                                     
 2242                                     BCD                 macro     Constant[,Constant]*
 2243                                                         mreq      1:Constant[,Constant]*
 2244                                                         mswap     1,:loop
 2245                                                         fcb       ~1~\10|{~1~\100/10<4}  ;;\100 to truncate high byte
 2246                                                         mtop      :n
 2247                                                         endm
 2248                                     
 2249                                     ;*******************************************************************************
 2250                                     ; Define a Pascal-style string
 2251                                     
 2252                                     StrPas              macro     'string text'
 2253                                                         mset      #
 2254                                                         mreq      1:'string text'
 2255                                                         mstr      1
 2256                                                         fcc       :1-2,~1~            ;length, string text
 2257                                                         endm
 2258                                     
 2259                                     ;*******************************************************************************
 2260                                     ; Define a string for the current LCD and warn if the string is too long to fit
 2261                                     
 2262                                     lcdfcs              macro
 2263                                                         mreq      1:At least one parameter is required
 2264                                                         #temp
 2265                                                         mdo
 2266                                                         mswap     1,:mloop            ;;put it in 1 for easier access
 2267                                               #ifstr ~1~
 2268                                                         mset      1,~1.2.{:1-2}~
 2269                                                         mset      1,~1~               ;;needed to expand possible expressions
 2270                                                         #temp     :temp+:1            ;;string
 2271                                                         mstr      1
 2272                                               #else ifnb ~1~
 2273                                                         #temp     :temp+1             ;;constant expression assumed
 2274                                               #endif
 2275                                                         mswap     1,:mloop            ;;return to actual parm spot
 2276                                                         mloop     :n
 2277                                                         mset      #
 2278                                               #if :temp > LCD_COLS
 2279                                                         #Warning  String too long ({:temp}) for {LCD_ROWS}x{LCD_COLS} LCD
 2280                                               #endif
 2281                                                         fcs       ~1~
 2282                                                         mexit     :temp               ;;return the total length
 2283                                                         endm
 2284                                     
 2285                                     ;*******************************************************************************
 2286                                     ; Define usable bps rates (based on BUS) from the given list and define related
 2287                                     ; labels formatted as bps_nnn where nnn is the baud rate, and also define
 2288                                     ; bps_max to be the same as the highest possible bps rate.
 2289                                     
 2290                                     DefBaud             macro     DesiredBaud1[,DesiredBaud2[,...]]
 2291                                               #ifnhcs
 2292                                                         merror    For use with 9S08 MCUs only
 2293                                               #endif
 2294                                                         mswap     1,:loop
 2295                                               #ifb ~1~
 2296                                                         mexit
 2297                                               #endif
 2298                                               #if :loop = 1                           ;;[2012.06.25] avoid redefinition
 2299                                                  #ifb ~text~
 2300                                                         mset      0,{BUS_HZ}
 2301                                                  #else if ~text~ = BUS_HZ
 2302                                                         mexit
 2303                                                  #else
 2304                                                         mset      0,{BUS_HZ}
 2305                                                  #endif
 2306                                               #endif
 2307                                     bps_$$$             set       BUS_HZ/16/~1~
 2308                                               #if bps_$$$ > 1<13-1
 2309                                                         #Message  bps_~1~ too slow (baud rate register overflow)
 2310                                                         mtop
 2311                                               #else ifz bps_$$$
 2312                                                         #Message  bps_~1~ too fast (baud rate register underflow)
 2313                                                         mtop
 2314                                               #endif
 2315                                                         #temp     BUS_HZ/{BUS_HZ/~1~/16*16}
 2316                                           #if :temp < 100+2*~1~/100
 2317                                           #if :temp > 100-2*~1~/100
 2318                                                         ;^ 2% allowed baud tolerance as percent (change as needed)
 2319                                               #ifdef bps_~1~
 2320                                     bps_~1~             set       bps_$$$
 2321                                               #else
 2322                                     bps_~1~             exp       bps_$$$
 2323                                               #endif
 2324                                     bps_max             def       bps_$$$             ;first time max bps rate
 2325                                               #if ~1~ >= BUS_HZ/16/bps_max
 2326                                     bps_max             set       bps_$$$             ;make this the new max bps rate
 2327                                               #endif
 2328                                                         #temp     BUS_HZ/16/bps_$$$-~1~*10000/~1~
 2329                                                         #Message  bps_~1~ = {BUS_HZ/16/bps_$$$} bps, {:temp(2)}% off
 2330                                           #endif
 2331                                           #endif
 2332                                               #ifndef bps_~1~
 2333                                                         #Message  bps_~1~ inaccurate at {BUS_KHZ(3)} MHz bus, not defined
 2334                                               #endif
 2335                                     ;-------------------------------------------------------------------------------
 2336                                                         mtop
 2337                                                         endm
 2338                                     
 2339                                     ;*******************************************************************************
 2340                                     ; Quickly define all usable standard baud rates in one go, plus any extra ones
 2341                                     
 2342                                     StandardBaudRates   macro     [AnyExtraBaudRates]
 2343                                                         @DefBaud  300,1200,2400,4800,9600,19200,38400,57600,115200,~@~
 2344                                                         endm
 2345                                     
 2346                                     ;*******************************************************************************
 2347                                     ; Symbol to the left of macro call (if present) and :MEXIT internal variable
 2348                                     ; are SET to the integer Log2 (log base two) of the given expression.
 2349                                     ; Quick-n-dirty calculation of integer part of log2(n) for values upto 2^31-1
 2350                                     ; Useful to get power from value (e.g., as when used with various prescalers.)
 2351                                     ; With the optional ShiftLeftBits parameter, one can shift the result into the
 2352                                     ; expected bit positions (e.g., within a larger bitmap).
 2353                                     
 2354                                     #ifnomdef Log2
 2355                                     Log2                macro     Expr[,ShiftLeftBits]
 2356                                                         mreq      1:Usage: Label @~0~ Expression[,ShiftLeftBits]
 2357                                                         mdef      2,0
 2358                                                         #temp     :loop-2
 2359                                     #ifz ~1~
 2360                                                         #temp     :temp<{~2~}
 2361                                               #ifparm ~label~
 2362                                     ~label~             set       :temp
 2363                                               #endif
 2364                                                         mexit     :temp
 2365                                     #endif
 2366                                                         mset      1,{~1~>1}
 2367                                                         mtop
 2368                                                         endm
 2369                                     #endif
 2370                                     
 2371                                     ;*******************************************************************************
 2372                                     ; Macro for showing end-of-program statistics (to be updated as needed)
 2373                                     
 2374                                     EndStats            macro     [Module Start Label]
 2375                                               #ifincluded
 2376                                                         mexit
 2377                                               #endif
 2378                                                         #Message  +-------------------------------------------------
 2379                                                         #Message  | Statistics (from \@~mfilename~/~0~\@ macro)
 2380                                                         #Message  +-------------------------------------------------
 2381                                               #ifdef ?_OBJECT_?
 2382                                                         mdef      1,?_OBJECT_?
 2383                                               #endif
 2384                                               #ifnb ~1~
 2385                                                         #Message  | Module size...: {*-~1~} bytes
 2386                                               #endif
 2387                                                         #temp                         ;;initialize total to zero
 2388                                                         mset      0
 2389                                               #ifdef XRAM
 2390                                                         #temp     XRAM_END-:XRAM+1    ;;count XRAM if available
 2391                                                         mset      0,[includes XRAM]
 2392                                               #endif
 2393                                                         #temp     RAM_END-:RAM+1+:temp ;;add RAM
 2394                                                         #Message  | Available RAM : {:temp} byte(s) ~text~
 2395                                               #if :temp-REQUIRED_STACK < 0
 2396                                                         mset      0,[WARNING] ~text~
 2397                                               #endif
 2398                                               #ifdef _MTOS_
 2399                                                         #temp     :temp-{REQUIRED_STACK*MAXTASKS}
 2400                                               #else
 2401                                                         #temp     :temp-REQUIRED_STACK
 2402                                               #endif
 2403                                                         #Message  | Non-stack RAM : {:temp} byte(s) ~text~
 2404                                               #if ROM_END-:ROM+1 >= 0
 2405                                                         #Message  | Available ROM : {ROM_END-:ROM+1} byte(s)
 2406                                               #endif
 2407                                                         mset      0
 2408                                               #ifdef XROM
 2409                                                         #Message  | Available XROM: {XROM_END-:XROM+1} byte(s)
 2410                                               #endif
 2411                                               #ifmmu
 2412                                                         #temp     :SEG0-PPAGE0
 2413                                                         #temp     :SEG2-PPAGE2+:temp
 2414                                                         #temp     :SEG4-PPAGE4+:temp
 2415                                                         #temp     :SEG5-PPAGE5+:temp
 2416                                                         #temp     :SEG6-PPAGE6+:temp
 2417                                                         #temp     :SEG7-PPAGE7+:temp
 2418                                                         #Message  | Available Seg0: {{:PAGE_END-:PAGE_START}-{:SEG0-PPAGE0}} byte(s)
 2419                                                         #Message  | Available Seg2: {{:PAGE_END-:PAGE_START}-{:SEG2-PPAGE2}} byte(s)
 2420                                                         #Message  | Available Seg4: {{:PAGE_END-:PAGE_START}-{:SEG4-PPAGE4}} byte(s)
 2421                                                         #Message  | Available Seg5: {{:PAGE_END-:PAGE_START}-{:SEG5-PPAGE5}} byte(s)
 2422                                                         #Message  | Available Seg6: {{:PAGE_END-:PAGE_START}-{:SEG6-PPAGE6}} byte(s)
 2423                                                         #Message  | Available Seg7: {{:PAGE_END-:PAGE_START}-{:SEG7-PPAGE7}} byte(s)
 2424                                                         #Message  | Available MMU : {:PAGE_END-:PAGE_START*6-:temp} byte(s) [total]
 2425                                               #endif
 2426                                               #ifdef NUMBER_OF_OS_CALLS
 2427                                                         #Message  | Total OS calls: {NUMBER_OF_OS_CALLS} (of {MAX_OS_CALLS})
 2428                                               #endif
 2429                                               #ifdef TASK_STACK_SIZE
 2430                                                         #Message  | Stack per task: {TASK_STACK_SIZE} bytes [TASK_STACK_SIZE]
 2431                                               #endif
 2432                                                         #Message  | Macros called : {:totalmacrocalls}
 2433                                                         #Message  | [#]PROCs used : {:proc}
 2434                                                         #Message  | Max stack used: {:spmax}
 2435                                                         #Message  +-------------------------------------------------
 2436                                                         endm
 2437                                     
 2438                                     ;*******************************************************************************
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/macros.inc *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/dz60.inc)
    7                                                         #Exit
    8                                                         #Uses     mymacros.inc
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/mymacros.inc ***
    1                                     
    2                                     ; inc max
    3                                     ; if(nearvar<maxvar)nearvar++;
    4                                     incm   macro   nearvar maxvar
    5                                             lda     ~1~
    6                                             cmp     #~2~
    7                                             bhs     Lab$$$          ;; Do not inc maxvar reached
    8                                             inc     ~1~
    9                                     Lab$$$
   10                                             endm
   11                                     
   12                                     ; dec min
   13                                     ; if(minvar<nearvar)nearvar--;
   14                                     decm   macro   nearvar minvar
   15                                             lda     ~1~
   16                                             cmp     #~2~
   17                                             bls     Lab$$$          ;; Do not dec minvar reached
   18                                             dec     ~1~
   19                                     Lab$$$
   20                                             endm
   21                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/mymacros.inc *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/dz60.inc)
    9                                                         #Message  **********************
   10                                                         #Message  * Target: MC9S08DZ60 *
   11                                                         #Message  **********************
   12                                     
   13                                                         #HcsOn
   14                                                         #NoMMU                        ;MMU not available
   15                                     #ifdef BOOT
   23                                     #endif
   24                                     
   25                003C                 _DZ_                def       60
   26                C000                 _DZ60_              def       *
   27                                     
   28                                     ;*******************************************************************************
   29                                     ;* Author: Tony Papadimitriou - <tonyp@acm.org>
   30                                     ;*         Freescale (Original version)
   31                                     ;*
   32                                     ;* Description: Register and bit name definitions for 9S08DZ60
   33                                     ;*
   34                                     ;* Documentation: 9S08DZ60 family Data Sheet for register and bit explanations
   35                                     ;* HCS08 Family Reference Manual (HCS08RM1/D) appendix B for explanation of
   36                                     ;* equate files
   37                                     ;*
   38                                     ;* Modified by <tonyp@acm.org> as follows:
   39                                     ;*
   40                                     ;* 1. All bit names for use with BSET/BCLR/BRSET/BRCLR end with a dot (.)
   41                                     ;* 2. All bit names for use as masks end with an underscore (_)
   42                                     ;* 3. ASM8's segments RAM, ROM, XROM, SEG9 (OS8), EEPROM and VECTORS
   43                                     ;*    initialized with appropriate values for immediate use.
   44                                     ;* 4. The assembly-time symbol FLASH_DATA_SIZE optionally defines the protected Flash
   45                                     ;*    as the difference between total flash and FLASH_DATA_SIZE
   46                                     ;*    Based on MC9S08DZ60's architecture, FLASH_DATA_SIZE can only take specific
   47                                     ;*    values.  An invalid value will cause an informative assembler error message.
   48                                     ;* 5. ASM8's #MEMORY directive used to define actual Flash space for user code/data
   49                                     ;*
   50                                     ;* Include Files: COMMON.INC
   51                                     ;*
   52                                     ;* Assembler:  ASM8 by Tony G. Papadimitriou <tonyp@acm.org>
   53                                     ;*
   54                                     ;* Revision History: not yet released
   55                                     ;* Rev #     Date          Who                       Comments
   56                                     ;* -----  -----------  -------------  ------------------------------------------
   57                                     ;*  1.1    07-Jun-11   tonyp@acm.org  Adapted to ASM8 by <tonyp@acm.org>
   58                                     ;*  1.0    31-Mar-08   Freescale      Release version for 9S08DZ60
   59                                     ;*******************************************************************************
   60                                     
   61                                     ; Based on CPU DB MC9S08DZ60_64, version 3.00.001 (RegistersPrg V2.23)
   62                                     
   63                                     ; This header implements the mapping of I/O devices.
   64                                     
   65                                     ; (c) Copyright UNIS, spol. s r.o. 1997-2008
   66                                     ; UNIS, spol. s r.o.
   67                                     ; Jundrovska 33
   68                                     ; 624 00 Brno
   69                                     ; Czech Republic
   70                                     
   71                                     ; CPU Registers Revisions
   72                                     ; - 21.04.2006, V2.87.015
   73                                     ; - Removed bits MCGSC_IREFST, MCGSC_PLLST, FCNFG_ECCDIS, SDIDH_REV0..SDIDH_REV3.
   74                                     ; - Added registers NVFTRIM, NVMCGTRM. Removed register NVECC.
   75                                     ; - Renamed registers ADx ==> ADCx.
   76                                     ; -   REASON  Changes in the data sheet (from rev 0.05 8/5/2005 to rev 1.0 Draft A 04/2006)
   77                                     ; - 16.05.2006, V2.87.023
   78                                     ; - Renamed registers ADCVH ==> ADCCVH, ADCVL ==> ADCCVL, ADCV ==> ADCCV, ADCFG ==> ADCCFG,
   79                                     ; - IICC1 ==> IICC, Added bit CANCTL1_BORM.
   80                                     ; -   REASON  Changes in the data sheet (from rev 1.0 Draft A to rev 1.0 Draft B)
   81                                     ; - 08.09.2006, V2.87.027
   82                                     ; - Added registers CANxIDR2, CANxIDR3, corrected CANxIDR0, CANxIDR1 bits (Standard ID ==> Extended ID).
   83                                     ; -   REASON  Bug-fix (#3723 from the UNIS Issue Manager)
   84                                     ; - 28.06.2007, V2.87.128
   85                                     ; - Removed register FTSTMOD.
   86                                     ; -   REASON  Bug-fix (#4466 from the UNIS Issue Manager)
   87                                     ; - 20.12.2007, V2.87.141
   88                                     ; - Added bits to the ADC registers to use the ADC 12-bit module.
   89                                     ; -   REASON  Changes in the data sheet (from rev 1 6/2006 to rev 3 10/2007).
   90                                     ; - 28.03.2008, V3.00.0
   91                                     ; - Added registers IICC, DBGCA, DBGCB.
   92                                     ; -   REASON  Bug-fix (#5795 from the UNIS Issue Manager)
   93                                     
   94                                     ; File-Format-Revisions
   95                                     ; - 08.03.2006, V2.04
   96                                     ; - Support for bit(s) names duplicated with any register name in .h header files
   97                                     ; - 24.03.2006, V2.05
   98                                     ; -  Changes have not affected this file (because they are related to another family)
   99                                     ; - 26.04.2006, V2.06
  100                                     ; - Absolute assembly supported (depreciated symbols are not defined)
  101                                     ; - 27.04.2006, V2.07
  102                                     ; - Fixed macro __RESET_WATCHDOG for HCS12, HCS12X ,HCS08 DZ and HCS08 EN derivatives (write 0x55,0xAA).
  103                                     ; - 07.06.2006, V2.08
  104                                     ; - For .inc files added constants "RAMStart" and "RAMEnd" even there is only Z_RAM.
  105                                     ; - 03.07.2006, V2.09
  106                                     ; - Flash commands constants supported
  107                                     ; - 27.10.2006, V2.10
  108                                     ; - __RESET_WATCHDOG improved formating and re-definition
  109                                     ; - 23.11.2006, V2.11
  110                                     ; -  Changes have not affected this file (because they are related to another family)
  111                                     ; - 22.01.2007, V2.12
  112                                     ; -  Changes have not affected this file (because they are related to another family)
  113                                     ; - 01.03.2007, V2.13
  114                                     ; - Flash commands constants values converted to HEX format
  115                                     ; - 02.03.2007, V2.14
  116                                     ; - Interrupt vector numbers added into .H, see VectorNumber_*
  117                                     ; - 26.03.2007, V2.15
  118                                     ; -  Changes have not affected this file (because they are related to another family)
  119                                     ; - 10.05.2007, V2.16
  120                                     ; - Fixed flash commands definition for ColdFireV1 assembler (equ -> .equ)
  121                                     ; - 05.06.2007, V2.17
  122                                     ; -  Changes have not affected this file (because they are related to another family)
  123                                     ; - 19.07.2007, V2.18
  124                                     ; - Improved number of blanked lines inside register structures
  125                                     ; - 06.08.2007, V2.19
  126                                     ; - CPUDB revisions generated ahead of the file-format revisions.
  127                                     ; - 11.09.2007, V2.20
  128                                     ; - Added comment about initialization of unbonded pins.
  129                                     ; - 02.01.2008, V2.21
  130                                     ; -  Changes have not affected this file (because they are related to another family)
  131                                     ; - 13.02.2008, V2.22
  132                                     ; -  Changes have not affected this file (because they are related to another family)
  133                                     ; - 20.02.2008, V2.23
  134                                     ; -  Changes have not affected this file (because they are related to another family)
  135                                     
  136                                     ; Not all general-purpose I/O pins are available on all packages or on all mask sets of a specific
  137                                     ; derivative device. To avoid extra current drain from floating input pins, the users reset
  138                                     ; initialization routine in the application program must either enable on-chip pull-up devices
  139                                     ; or change the direction of unconnected pins to outputs so the pins do not float.
  140                                     ; ###################################################################
  141                                     
  142                                     ; **** Memory Map and Interrupt Vectors ****************************************
  143                                     
  144                1800                 HighRegs            equ       $1800               ;start of high page registers
  145                18FF                 HighRegs_End        equ       $18FF               ;end of high page registers
  146                                     
  147                                     ; **** Input/Output (I/O) Ports ************************************************
  148                                     
  149                0000                 PTA                 equ       $0000,1             ;Port A Data Register
  150                0001                 DDRA                equ       $0001,1             ;Port A Data Direction Register
  151                                     
  152  M                                                      @bitnum   PIN0,0
  152  M             0000                 PIN0.                equ       0
  152  M             0001                 PIN0_                equ       1<PIN0.
  152                                                         endm
  153  M                                                      @bitnum   PIN1,1
  153  M             0001                 PIN1.                equ       1
  153  M             0002                 PIN1_                equ       1<PIN1.
  153                                                         endm
  154  M                                                      @bitnum   PIN2,2
  154  M             0002                 PIN2.                equ       2
  154  M             0004                 PIN2_                equ       1<PIN2.
  154                                                         endm
  155  M                                                      @bitnum   PIN3,3
  155  M             0003                 PIN3.                equ       3
  155  M             0008                 PIN3_                equ       1<PIN3.
  155                                                         endm
  156  M                                                      @bitnum   PIN4,4
  156  M             0004                 PIN4.                equ       4
  156  M             0010                 PIN4_                equ       1<PIN4.
  156                                                         endm
  157  M                                                      @bitnum   PIN5,5
  157  M             0005                 PIN5.                equ       5
  157  M             0020                 PIN5_                equ       1<PIN5.
  157                                                         endm
  158  M                                                      @bitnum   PIN6,6
  158  M             0006                 PIN6.                equ       6
  158  M             0040                 PIN6_                equ       1<PIN6.
  158                                                         endm
  159  M                                                      @bitnum   PIN7,7
  159  M             0007                 PIN7.                equ       7
  159  M             0080                 PIN7_                equ       1<PIN7.
  159                                                         endm
  160                                     
  161                                     
  162                0002                 PTB                 equ       $0002,1             ;Port B Data Register
  163                0003                 DDRB                equ       $0003,1             ;Port B Data Direction Register
  164                                     
  165                0004                 PTC                 equ       $0004,1             ;Port C Data Register
  166                0005                 DDRC                equ       $0005,1             ;Port C Data Direction Register
  167                                     
  168                0006                 PTD                 equ       $0006,1             ;Port D Data Register
  169                0007                 DDRD                equ       $0007,1             ;Port D Data Direction Register
  170                                     
  171                0008                 PTE                 equ       $0008,1             ;Port E Data Register
  172                0009                 DDRE                equ       $0009,1             ;Port E Data Direction Register
  173                                     
  174                000A                 PTF                 equ       $000A,1             ;Port F Data Register
  175                000B                 DDRF                equ       $000B,1             ;Port F Data Direction Register
  176                                     
  177                000C                 PTG                 equ       $000C,1             ;Port G Data Register
  178                000D                 DDRG                equ       $000D,1             ;Port G Data Direction Register
  179                                     
  180                000E                 ACMP1SC             equ       $000E,1             ;ACMP1 Status and Control Register
  181                000F                 ACMP2SC             equ       $000F,1             ;ACMP2 Status and Control Register
  182                                     
  183  M                                                      @bitnum   ACMOD0,0            ;Analog Comparator Mode Bit 0
  183  M             0000                 ACMOD0.                equ       0
  183  M             0001                 ACMOD0_                equ       1<ACMOD0.
  183                                                         endm
  184  M                                                      @bitnum   ACMOD1,1            ;Analog Comparator Mode Bit 1
  184  M             0001                 ACMOD1.                equ       1
  184  M             0002                 ACMOD1_                equ       1<ACMOD1.
  184                                                         endm
  185  M                                                      @bitnum   ACOPE,2             ;Analog Comparator Output Pin Enable
  185  M             0002                 ACOPE.                equ       2
  185  M             0004                 ACOPE_                equ       1<ACOPE.
  185                                                         endm
  186  M                                                      @bitnum   ACO,3               ;Analog Comparator Output
  186  M             0003                 ACO.                equ       3
  186  M             0008                 ACO_                equ       1<ACO.
  186                                                         endm
  187  M                                                      @bitnum   ACIE,4              ;Analog Comparator Interrupt Enable
  187  M             0004                 ACIE.                equ       4
  187  M             0010                 ACIE_                equ       1<ACIE.
  187                                                         endm
  188  M                                                      @bitnum   ACF,5               ;Analog Comparator Flag
  188  M             0005                 ACF.                equ       5
  188  M             0020                 ACF_                equ       1<ACF.
  188                                                         endm
  189  M                                                      @bitnum   ACBGS,6             ;Analog Comparator Bandgap Select
  189  M             0006                 ACBGS.                equ       6
  189  M             0040                 ACBGS_                equ       1<ACBGS.
  189                                                         endm
  190  M                                                      @bitnum   ACME,7              ;Analog Comparator Module Enable
  190  M             0007                 ACME.                equ       7
  190  M             0080                 ACME_                equ       1<ACME.
  190                                                         endm
  191                                     
  192                0010                 ADCSC1              equ       $0010,1             ;Status and Control Register 1
  193                                     
  194  M                                                      @bitnum   ADCO,5              ;Continuous Conversion Enable - ADCO is used to enable continuous conversions
  194  M             0005                 ADCO.                equ       5
  194  M             0020                 ADCO_                equ       1<ADCO.
  194                                                         endm
  195  M                                                      @bitnum   AIEN,6              ;Interrupt Enable - AIEN is used to enable conversion complete interrupts. When COCO becomes set while AIEN is high, an interrupt is asserted
  195  M             0006                 AIEN.                equ       6
  195  M             0040                 AIEN_                equ       1<AIEN.
  195                                                         endm
  196  M                                                      @bitnum   COCO,7              ;Conversion Complete Flag
  196  M             0007                 COCO.                equ       7
  196  M             0080                 COCO_                equ       1<COCO.
  196                                                         endm
  197                                     
  198                0011                 ADCSC2              equ       $0011,1             ;Status and Control Register 2
  199                                     
  200  M                                                      @bitnum   ACFGT,4             ;Compare Function Greater Than Enable
  200  M             0004                 ACFGT.                equ       4
  200  M             0010                 ACFGT_                equ       1<ACFGT.
  200                                                         endm
  201  M                                                      @bitnum   ACFE,5              ;Compare Function Enable - ACFE is used to enable the compare function
  201  M             0005                 ACFE.                equ       5
  201  M             0020                 ACFE_                equ       1<ACFE.
  201                                                         endm
  202  M                                                      @bitnum   ADTRG,6             ;Conversion Trigger Select-ADTRG is used to select the type of trigger to be used for initiating a conversion
  202  M             0006                 ADTRG.                equ       6
  202  M             0040                 ADTRG_                equ       1<ADTRG.
  202                                                         endm
  203  M                                                      @bitnum   ADACT,7             ;Conversion Active - ADACT indicates that a conversion is in progress. ADACT is set when a conversion is initiated and cleared when a conversion is completed or aborted
  203  M             0007                 ADACT.                equ       7
  203  M             0080                 ADACT_                equ       1<ADACT.
  203                                                         endm
  204                                     
  205                0012                 ADCR                equ       $0012,2             ;Data Result Register
  206                0012                 ADCRH               equ       $0012,1             ;Data Result High Register
  207                0013                 ADCRL               equ       $0013,1             ;Data Result Low Register
  208                                     
  209                0014                 ADCCV               equ       $0014,2             ;Compare Value Register
  210                0014                 ADCCVH              equ       $0014,1             ;Compare Value High Register
  211                0015                 ADCCVL              equ       $0015,1             ;Compare Value Low Register
  212                                     
  213                0016                 ADCCFG              equ       $0016,1             ;Configuration Register
  214                                     
  215  M                                                      @bitnum   ADICLK0,0           ;Input Clock Select Bit 0
  215  M             0000                 ADICLK0.                equ       0
  215  M             0001                 ADICLK0_                equ       1<ADICLK0.
  215                                                         endm
  216  M                                                      @bitnum   ADICLK1,1           ;Input Clock Select Bit 1
  216  M             0001                 ADICLK1.                equ       1
  216  M             0002                 ADICLK1_                equ       1<ADICLK1.
  216                                                         endm
  217  M                                                      @bitnum   MODE0,2             ;Conversion Mode Selection Bit 0
  217  M             0002                 MODE0.                equ       2
  217  M             0004                 MODE0_                equ       1<MODE0.
  217                                                         endm
  218  M                                                      @bitnum   MODE1,3             ;Conversion Mode Selection Bit 1
  218  M             0003                 MODE1.                equ       3
  218  M             0008                 MODE1_                equ       1<MODE1.
  218                                                         endm
  219  M                                                      @bitnum   ADLSMP,4            ;Long Sample Time Configuration
  219  M             0004                 ADLSMP.                equ       4
  219  M             0010                 ADLSMP_                equ       1<ADLSMP.
  219                                                         endm
  220  M                                                      @bitnum   ADIV0,5             ;Clock Divide Select Bit 0
  220  M             0005                 ADIV0.                equ       5
  220  M             0020                 ADIV0_                equ       1<ADIV0.
  220                                                         endm
  221  M                                                      @bitnum   ADIV1,6             ;Clock Divide Select Bit 1
  221  M             0006                 ADIV1.                equ       6
  221  M             0040                 ADIV1_                equ       1<ADIV1.
  221                                                         endm
  222  M                                                      @bitnum   ADLPC,7             ;Low Power Configuration
  222  M             0007                 ADLPC.                equ       7
  222  M             0080                 ADLPC_                equ       1<ADLPC.
  222                                                         endm
  223                                     
  224                0017                 APCTL1              equ       $0017,1             ;Pin Control 1 Register
  225                0018                 APCTL2              equ       $0018,1             ;Pin Control 2 Register
  226                0019                 APCTL3              equ       $0019,1             ;Pin Control 3 Register
  227                                     
  228                001C                 IRQSC               equ       $001C,1             ;Interrupt request status and control register
  229                                     
  230  M                                                      @bitnum   IRQMOD,0            ;IRQ Detection Mode
  230  M             0000                 IRQMOD.                equ       0
  230  M             0001                 IRQMOD_                equ       1<IRQMOD.
  230                                                         endm
  231  M                                                      @bitnum   IRQIE,1             ;IRQ Interrupt Enable
  231  M             0001                 IRQIE.                equ       1
  231  M             0002                 IRQIE_                equ       1<IRQIE.
  231                                                         endm
  232  M                                                      @bitnum   IRQACK,2            ;IRQ Acknowledge
  232  M             0002                 IRQACK.                equ       2
  232  M             0004                 IRQACK_                equ       1<IRQACK.
  232                                                         endm
  233  M                                                      @bitnum   IRQF,3              ;IRQ Flag
  233  M             0003                 IRQF.                equ       3
  233  M             0008                 IRQF_                equ       1<IRQF.
  233                                                         endm
  234  M                                                      @bitnum   IRQPE,4             ;IRQ Pin Enable
  234  M             0004                 IRQPE.                equ       4
  234  M             0010                 IRQPE_                equ       1<IRQPE.
  234                                                         endm
  235  M                                                      @bitnum   IRQEDG,5            ;IRQ Edge Select
  235  M             0005                 IRQEDG.                equ       5
  235  M             0020                 IRQEDG_                equ       1<IRQEDG.
  235                                                         endm
  236  M                                                      @bitnum   IRQPDD,6            ;IRQ Pull Device Disable
  236  M             0006                 IRQPDD.                equ       6
  236  M             0040                 IRQPDD_                equ       1<IRQPDD.
  236                                                         endm
  237                                     
  238                0020                 TPM1SC              equ       $0020,1             ;TPM1 Status and Control Register
  239                                     
  240  M                                                      @bitnum   PS0,0               ;Prescale Divisor Select Bit 0
  240  M             0000                 PS0.                equ       0
  240  M             0001                 PS0_                equ       1<PS0.
  240                                                         endm
  241  M                                                      @bitnum   PS1,1               ;Prescale Divisor Select Bit 1
  241  M             0001                 PS1.                equ       1
  241  M             0002                 PS1_                equ       1<PS1.
  241                                                         endm
  242  M                                                      @bitnum   PS2,2               ;Prescale Divisor Select Bit 2
  242  M             0002                 PS2.                equ       2
  242  M             0004                 PS2_                equ       1<PS2.
  242                                                         endm
  243  M                                                      @bitnum   CLKSA,3             ;Clock Source Select A
  243  M             0003                 CLKSA.                equ       3
  243  M             0008                 CLKSA_                equ       1<CLKSA.
  243                                                         endm
  244  M                                                      @bitnum   CLKSB,4             ;Clock Source Select B
  244  M             0004                 CLKSB.                equ       4
  244  M             0010                 CLKSB_                equ       1<CLKSB.
  244                                                         endm
  245  M                                                      @bitnum   CPWMS,5             ;Center-Aligned PWM Select
  245  M             0005                 CPWMS.                equ       5
  245  M             0020                 CPWMS_                equ       1<CPWMS.
  245                                                         endm
  246  M                                                      @bitnum   TOIE,6              ;Timer Overflow Interrupt Enable
  246  M             0006                 TOIE.                equ       6
  246  M             0040                 TOIE_                equ       1<TOIE.
  246                                                         endm
  247  M                                                      @bitnum   TOF,7               ;Timer Overflow Flag
  247  M             0007                 TOF.                equ       7
  247  M             0080                 TOF_                equ       1<TOF.
  247                                                         endm
  248                                     
  249                0021                 TPM1CNT             equ       $0021,2             ;TPM1 Timer Counter Register
  250                0021                 TPM1CNTH            equ       $0021,1             ;TPM1 Timer Counter Register High
  251                0022                 TPM1CNTL            equ       $0022,1             ;TPM1 Timer Counter Register Low
  252                0023                 TPM1MOD             equ       $0023,2             ;TPM1 Timer Counter Modulo Register
  253                0023                 TPM1MODH            equ       $0023,1             ;TPM1 Timer Counter Modulo Register High
  254                0024                 TPM1MODL            equ       $0024,1             ;TPM1 Timer Counter Modulo Register Low
  255                                     
  256                0025                 TPM1C0SC            equ       $0025,1             ;TPM1 Timer Channel 0 Status and Control Register
  257                0026                 TPM1C0V             equ       $0026,2             ;TPM1 Timer Channel 0 Value Register
  258                0026                 TPM1C0VH            equ       $0026,1             ;TPM1 Timer Channel 0 Value Register High
  259                0027                 TPM1C0VL            equ       $0027,1             ;TPM1 Timer Channel 0 Value Register Low
  260                0028                 TPM1C1SC            equ       $0028,1             ;TPM1 Timer Channel 1 Status and Control Register
  261                0029                 TPM1C1V             equ       $0029,2             ;TPM1 Timer Channel 1 Value Register
  262                0029                 TPM1C1VH            equ       $0029,1             ;TPM1 Timer Channel 1 Value Register High
  263                002A                 TPM1C1VL            equ       $002A,1             ;TPM1 Timer Channel 1 Value Register Low
  264                002B                 TPM1C2SC            equ       $002B,1             ;TPM1 Timer Channel 2 Status and Control Register
  265                002C                 TPM1C2V             equ       $002C,2             ;TPM1 Timer Channel 2 Value Register
  266                002C                 TPM1C2VH            equ       $002C,1             ;TPM1 Timer Channel 2 Value Register High
  267                002D                 TPM1C2VL            equ       $002D,1             ;TPM1 Timer Channel 2 Value Register Low
  268                002E                 TPM1C3SC            equ       $002E,1             ;TPM1 Timer Channel 3 Status and Control Register
  269                002F                 TPM1C3V             equ       $002F,2             ;TPM1 Timer Channel 3 Value Register
  270                002F                 TPM1C3VH            equ       $002F,1             ;TPM1 Timer Channel 3 Value Register High
  271                0030                 TPM1C3VL            equ       $0030,1             ;TPM1 Timer Channel 3 Value Register Low
  272                0031                 TPM1C4SC            equ       $0031,1             ;TPM1 Timer Channel 4 Status and Control Register
  273                0032                 TPM1C4V             equ       $0032,2             ;TPM1 Timer Channel 4 Value Register
  274                0032                 TPM1C4VH            equ       $0032,1             ;TPM1 Timer Channel 4 Value Register High
  275                0033                 TPM1C4VL            equ       $0033,1             ;TPM1 Timer Channel 4 Value Register Low
  276                0034                 TPM1C5SC            equ       $0034,1             ;TPM1 Timer Channel 5 Status and Control Register
  277                0035                 TPM1C5V             equ       $0035,2             ;TPM1 Timer Channel 5 Value Register
  278                0035                 TPM1C5VH            equ       $0035,1             ;TPM1 Timer Channel 5 Value Register High
  279                0036                 TPM1C5VL            equ       $0036,1             ;TPM1 Timer Channel 5 Value Register Low
  280                                     
  281  M                                                      @bitnum   ELSxA,2             ;Edge/Level Select Bit A
  281  M             0002                 ELSxA.                equ       2
  281  M             0004                 ELSxA_                equ       1<ELSxA.
  281                                                         endm
  282  M                                                      @bitnum   ELSxB,3             ;Edge/Level Select Bit B
  282  M             0003                 ELSxB.                equ       3
  282  M             0008                 ELSxB_                equ       1<ELSxB.
  282                                                         endm
  283  M                                                      @bitnum   MSxA,4              ;Mode Select A for TPM Channel 0
  283  M             0004                 MSxA.                equ       4
  283  M             0010                 MSxA_                equ       1<MSxA.
  283                                                         endm
  284  M                                                      @bitnum   MSxB,5              ;Mode Select B for TPM Channel 0
  284  M             0005                 MSxB.                equ       5
  284  M             0020                 MSxB_                equ       1<MSxB.
  284                                                         endm
  285  M                                                      @bitnum   CHxIE,6             ;Channel 0 Interrupt Enable
  285  M             0006                 CHxIE.                equ       6
  285  M             0040                 CHxIE_                equ       1<CHxIE.
  285                                                         endm
  286  M                                                      @bitnum   CHxF,7              ;Channel 0 Flag
  286  M             0007                 CHxF.                equ       7
  286  M             0080                 CHxF_                equ       1<CHxF.
  286                                                         endm
  287                                     
  288                0038                 SCI1BD              equ       $0038,2             ;SCI1 Baud Rate Register
  289                0038                 SCI1BDH             equ       $0038,1             ;SCI1 Baud Rate Register High
  290                                     
  291  M                                                      @bitnum   RXEDGIE,6           ;RxD Input Active Edge Interrupt Enable (for RXEDGIF)
  291  M             0006                 RXEDGIE.                equ       6
  291  M             0040                 RXEDGIE_                equ       1<RXEDGIE.
  291                                                         endm
  292  M                                                      @bitnum   LBKDIE,7            ;LIN Break Detect Interrupt Enable (for LBKDIF)
  292  M             0007                 LBKDIE.                equ       7
  292  M             0080                 LBKDIE_                equ       1<LBKDIE.
  292                                                         endm
  293                                     
  294                0039                 SCI1BDL             equ       $0039,1             ;SCI1 Baud Rate Register Low
  295                003A                 SCI1C1              equ       $003A,1             ;SCI1 Control Register 1
  296                                     
  297  M                                                      @bitnum   PT,0                ;Parity Type
  297  M             0000                 PT.                equ       0
  297  M             0001                 PT_                equ       1<PT.
  297                                                         endm
  298  M                                                      @bitnum   PE,1                ;Parity Enable
  298  M             0001                 PE.                equ       1
  298  M             0002                 PE_                equ       1<PE.
  298                                                         endm
  299  M                                                      @bitnum   ILT,2               ;Idle Line Type Select
  299  M             0002                 ILT.                equ       2
  299  M             0004                 ILT_                equ       1<ILT.
  299                                                         endm
  300  M                                                      @bitnum   WAKE,3              ;Receiver Wakeup Method Select
  300  M             0003                 WAKE.                equ       3
  300  M             0008                 WAKE_                equ       1<WAKE.
  300                                                         endm
  301  M                                                      @bitnum   M,4                 ;9-Bit or 8-Bit Mode Select
  301  M             0004                 M.                equ       4
  301  M             0010                 M_                equ       1<M.
  301                                                         endm
  302  M                                                      @bitnum   RSRC,5              ;Receiver Source Select
  302  M             0005                 RSRC.                equ       5
  302  M             0020                 RSRC_                equ       1<RSRC.
  302                                                         endm
  303  M                                                      @bitnum   SCISWAI,6           ;SCI Stops in Wait Mode
  303  M             0006                 SCISWAI.                equ       6
  303  M             0040                 SCISWAI_                equ       1<SCISWAI.
  303                                                         endm
  304  M                                                      @bitnum   LOOPS,7             ;Loop Mode Select
  304  M             0007                 LOOPS.                equ       7
  304  M             0080                 LOOPS_                equ       1<LOOPS.
  304                                                         endm
  305                                     
  306                003B                 SCI1C2              equ       $003B,1             ;SCI1 Control Register 2
  307                                     
  308  M                                                      @bitnum   SBK,0               ;Send Break
  308  M             0000                 SBK.                equ       0
  308  M             0001                 SBK_                equ       1<SBK.
  308                                                         endm
  309  M                                                      @bitnum   RWU,1               ;Receiver Wakeup Control
  309  M             0001                 RWU.                equ       1
  309  M             0002                 RWU_                equ       1<RWU.
  309                                                         endm
  310  M                                                      @bitnum   RE,2                ;Receiver Enable
  310  M             0002                 RE.                equ       2
  310  M             0004                 RE_                equ       1<RE.
  310                                                         endm
  311  M                                                      @bitnum   TE,3                ;Transmitter Enable
  311  M             0003                 TE.                equ       3
  311  M             0008                 TE_                equ       1<TE.
  311                                                         endm
  312  M                                                      @bitnum   ILIE,4              ;Idle Line Interrupt Enable (for IDLE)
  312  M             0004                 ILIE.                equ       4
  312  M             0010                 ILIE_                equ       1<ILIE.
  312                                                         endm
  313  M                                                      @bitnum   RIE,5               ;Receiver Interrupt Enable (for RDRF)
  313  M             0005                 RIE.                equ       5
  313  M             0020                 RIE_                equ       1<RIE.
  313                                                         endm
  314  M                                                      @bitnum   TCIE,6              ;Transmission Complete Interrupt Enable (for TC)
  314  M             0006                 TCIE.                equ       6
  314  M             0040                 TCIE_                equ       1<TCIE.
  314                                                         endm
  315  M                                                      @bitnum   TIE,7               ;Transmit Interrupt Enable (for TDRE)
  315  M             0007                 TIE.                equ       7
  315  M             0080                 TIE_                equ       1<TIE.
  315                                                         endm
  316                                     
  317                003C                 SCI1S1              equ       $003C,1             ;SCI1 Status Register 1
  318                                     
  319  M                                                      @bitnum   PF,0                ;Parity Error Flag
  319  M             0000                 PF.                equ       0
  319  M             0001                 PF_                equ       1<PF.
  319                                                         endm
  320  M                                                      @bitnum   FE,1                ;Framing Error Flag
  320  M             0001                 FE.                equ       1
  320  M             0002                 FE_                equ       1<FE.
  320                                                         endm
  321  M                                                      @bitnum   NF,2                ;Noise Flag
  321  M             0002                 NF.                equ       2
  321  M             0004                 NF_                equ       1<NF.
  321                                                         endm
  322  M                                                      @bitnum   OR,3                ;Receiver Overrun Flag
  322  M             0003                 OR.                equ       3
  322  M             0008                 OR_                equ       1<OR.
  322                                                         endm
  323  M                                                      @bitnum   IDLE,4              ;Idle Line Flag
  323  M             0004                 IDLE.                equ       4
  323  M             0010                 IDLE_                equ       1<IDLE.
  323                                                         endm
  324  M                                                      @bitnum   RDRF,5              ;Receive Data Register Full Flag
  324  M             0005                 RDRF.                equ       5
  324  M             0020                 RDRF_                equ       1<RDRF.
  324                                                         endm
  325  M                                                      @bitnum   TC,6                ;Transmission Complete Flag
  325  M             0006                 TC.                equ       6
  325  M             0040                 TC_                equ       1<TC.
  325                                                         endm
  326  M                                                      @bitnum   TDRE,7              ;Transmit Data Register Empty Flag
  326  M             0007                 TDRE.                equ       7
  326  M             0080                 TDRE_                equ       1<TDRE.
  326                                                         endm
  327                                     
  328                003D                 SCI1S2              equ       $003D,1             ;SCI1 Status Register 2
  329                                     
  330  M                                                      @bitnum   RAF,0               ;Receiver Active Flag
  330  M             0000                 RAF.                equ       0
  330  M             0001                 RAF_                equ       1<RAF.
  330                                                         endm
  331  M                                                      @bitnum   LBKDE,1             ;LIN Break Detection Enable
  331  M             0001                 LBKDE.                equ       1
  331  M             0002                 LBKDE_                equ       1<LBKDE.
  331                                                         endm
  332  M                                                      @bitnum   BRK13,2             ;Break Character Generation Length
  332  M             0002                 BRK13.                equ       2
  332  M             0004                 BRK13_                equ       1<BRK13.
  332                                                         endm
  333  M                                                      @bitnum   RWUID,3             ;Receive Wake Up Idle Detect
  333  M             0003                 RWUID.                equ       3
  333  M             0008                 RWUID_                equ       1<RWUID.
  333                                                         endm
  334  M                                                      @bitnum   RXINV,4             ;Receive Data Inversion
  334  M             0004                 RXINV.                equ       4
  334  M             0010                 RXINV_                equ       1<RXINV.
  334                                                         endm
  335  M                                                      @bitnum   RXEDGIF,6           ;RxD Pin Active Edge Interrupt Flag
  335  M             0006                 RXEDGIF.                equ       6
  335  M             0040                 RXEDGIF_                equ       1<RXEDGIF.
  335                                                         endm
  336  M                                                      @bitnum   LBKDIF,7            ;LIN Break Detect Interrupt Flag
  336  M             0007                 LBKDIF.                equ       7
  336  M             0080                 LBKDIF_                equ       1<LBKDIF.
  336                                                         endm
  337                                     
  338                003E                 SCI1C3              equ       $003E,1             ;SCI1 Control Register 3
  339                                     
  340  M                                                      @bitnum   PEIE,0              ;Parity Error Interrupt Enable
  340  M             0000                 PEIE.                equ       0
  340  M             0001                 PEIE_                equ       1<PEIE.
  340                                                         endm
  341  M                                                      @bitnum   FEIE,1              ;Framing Error Interrupt Enable
  341  M             0001                 FEIE.                equ       1
  341  M             0002                 FEIE_                equ       1<FEIE.
  341                                                         endm
  342  M                                                      @bitnum   NEIE,2              ;Noise Error Interrupt Enable
  342  M             0002                 NEIE.                equ       2
  342  M             0004                 NEIE_                equ       1<NEIE.
  342                                                         endm
  343  M                                                      @bitnum   ORIE,3              ;Overrun Interrupt Enable
  343  M             0003                 ORIE.                equ       3
  343  M             0008                 ORIE_                equ       1<ORIE.
  343                                                         endm
  344  M                                                      @bitnum   TXINV,4             ;Transmit Data Inversion
  344  M             0004                 TXINV.                equ       4
  344  M             0010                 TXINV_                equ       1<TXINV.
  344                                                         endm
  345  M                                                      @bitnum   TXDIR,5             ;TxD Pin Direction in Single-Wire Mode
  345  M             0005                 TXDIR.                equ       5
  345  M             0020                 TXDIR_                equ       1<TXDIR.
  345                                                         endm
  346  M                                                      @bitnum   T8,6                ;Ninth Data Bit for Transmitter
  346  M             0006                 T8.                equ       6
  346  M             0040                 T8_                equ       1<T8.
  346                                                         endm
  347  M                                                      @bitnum   R8,7                ;Ninth Data Bit for Receiver
  347  M             0007                 R8.                equ       7
  347  M             0080                 R8_                equ       1<R8.
  347                                                         endm
  348                                     
  349                003F                 SCI1D               equ       $003F,1             ;SCI1 Data Register
  350                                     
  351                0040                 SCI2BD              equ       $0040,2             ;SCI2 Baud Rate Register
  352                0040                 SCI2BDH             equ       $0040,1             ;SCI2 Baud Rate Register High
  353                0041                 SCI2BDL             equ       $0041,1             ;SCI2 Baud Rate Register Low
  354                0042                 SCI2C1              equ       $0042,1             ;SCI2 Control Register 1
  355                0043                 SCI2C2              equ       $0043,1             ;SCI2 Control Register 2
  356                0044                 SCI2S1              equ       $0044,1             ;SCI2 Status Register 1
  357                0045                 SCI2S2              equ       $0045,1             ;SCI2 Status Register 2
  358                0046                 SCI2C3              equ       $0046,1             ;SCI2 Control Register 3
  359                0047                 SCI2D               equ       $0047,1             ;SCI2 Data Register
  360                                     
  361                0048                 MCGC1               equ       $0048,1             ;MCG Control Register 1
  362                0048                 ICSC1               def       MCGC1,1             ;functionally equivalent to the ICSC1 of other MCUs
  363                                     
  364  M                                                      @bitnum   IREFSTEN,0          ;Internal Reference Stop Enable
  364  M             0000                 IREFSTEN.                equ       0
  364  M             0001                 IREFSTEN_                equ       1<IREFSTEN.
  364                                                         endm
  365  M                                                      @bitnum   IRCLKEN,1           ;Internal Reference Clock Enable
  365  M             0001                 IRCLKEN.                equ       1
  365  M             0002                 IRCLKEN_                equ       1<IRCLKEN.
  365                                                         endm
  366  M                                                      @bitnum   IREFS,2             ;Internal Reference Select
  366  M             0002                 IREFS.                equ       2
  366  M             0004                 IREFS_                equ       1<IREFS.
  366                                                         endm
  367  M                                                      @bitnum   RDIV0,3             ;Reference Divider, bit 0
  367  M             0003                 RDIV0.                equ       3
  367  M             0008                 RDIV0_                equ       1<RDIV0.
  367                                                         endm
  368  M                                                      @bitnum   RDIV1,4             ;Reference Divider, bit 1
  368  M             0004                 RDIV1.                equ       4
  368  M             0010                 RDIV1_                equ       1<RDIV1.
  368                                                         endm
  369  M                                                      @bitnum   RDIV2,5             ;Reference Divider, bit 2
  369  M             0005                 RDIV2.                equ       5
  369  M             0020                 RDIV2_                equ       1<RDIV2.
  369                                                         endm
  370  M                                                      @bitnum   CLKS0,6             ;Clock Source Select, bit 0
  370  M             0006                 CLKS0.                equ       6
  370  M             0040                 CLKS0_                equ       1<CLKS0.
  370                                                         endm
  371  M                                                      @bitnum   CLKS1,7             ;Clock Source Select, bit 1
  371  M             0007                 CLKS1.                equ       7
  371  M             0080                 CLKS1_                equ       1<CLKS1.
  371                                                         endm
  372                                     
  373                0049                 MCGC2               equ       $0049,1             ;MCG Control Register 2
  374                0049                 ICSC2               def       MCGC2,1             ;functionally equivalent to the ICSC2 of other MCUs
  375                                     
  376  M                                                      @bitnum   EREFSTEN,0          ;External Reference Stop Enable
  376  M             0000                 EREFSTEN.                equ       0
  376  M             0001                 EREFSTEN_                equ       1<EREFSTEN.
  376                                                         endm
  377  M                                                      @bitnum   ERCLKEN,1           ;External Reference Enable
  377  M             0001                 ERCLKEN.                equ       1
  377  M             0002                 ERCLKEN_                equ       1<ERCLKEN.
  377                                                         endm
  378  M                                                      @bitnum   EREFS,2             ;External Reference Select
  378  M             0002                 EREFS.                equ       2
  378  M             0004                 EREFS_                equ       1<EREFS.
  378                                                         endm
  379  M                                                      @bitnum   LP,3                ;Low Power Select
  379  M             0003                 LP.                equ       3
  379  M             0008                 LP_                equ       1<LP.
  379                                                         endm
  380  M                                                      @bitnum   HGO,4               ;High Gain Oscillator Select
  380  M             0004                 HGO.                equ       4
  380  M             0010                 HGO_                equ       1<HGO.
  380                                                         endm
  381  M                                                      @bitnum   RANGE_SEL,5         ;Frequency Range Select
  381  M             0005                 RANGE_SEL.                equ       5
  381  M             0020                 RANGE_SEL_                equ       1<RANGE_SEL.
  381                                                         endm
  382  M                                                      @bitnum   BDIV0,6             ;Bus Frequency Divider, bit 0
  382  M             0006                 BDIV0.                equ       6
  382  M             0040                 BDIV0_                equ       1<BDIV0.
  382                                                         endm
  383  M                                                      @bitnum   BDIV1,7             ;Bus Frequency Divider, bit 1
  383  M             0007                 BDIV1.                equ       7
  383  M             0080                 BDIV1_                equ       1<BDIV1.
  383                                                         endm
  384                                     
  385                004A                 MCGTRM              equ       $004A,1             ;MCG Trim Register
  386                004A                 ICSTRM              def       MCGTRM,1            ;functionally equivalent to the ICSTRM of other MCUs
  387                004B                 MCGSC               equ       $004B,1             ;MCG Status and Control Register
  388                004B                 ICSSC               def       MCGSC,1             ;functionally equivalent to the ICSSC of other MCUs
  389                                     
  390  M                                                      @bitnum   FTRIM,0             ;MCG Fine Trim
  390  M             0000                 FTRIM.                equ       0
  390  M             0001                 FTRIM_                equ       1<FTRIM.
  390                                                         endm
  391  M                                                      @bitnum   OSCINIT,1           ;OSC Initialization
  391  M             0001                 OSCINIT.                equ       1
  391  M             0002                 OSCINIT_                equ       1<OSCINIT.
  391                                                         endm
  392  M                                                      @bitnum   CLKST0,2            ;Clock Mode Status, bit 0
  392  M             0002                 CLKST0.                equ       2
  392  M             0004                 CLKST0_                equ       1<CLKST0.
  392                                                         endm
  393  M                                                      @bitnum   CLKST1,3            ;Clock Mode Status, bit 1
  393  M             0003                 CLKST1.                equ       3
  393  M             0008                 CLKST1_                equ       1<CLKST1.
  393                                                         endm
  394  M                                                      @bitnum   IREFST,4            ;Internal Reference Status
  394  M             0004                 IREFST.                equ       4
  394  M             0010                 IREFST_                equ       1<IREFST.
  394                                                         endm
  395  M                                                      @bitnum   PLLST,5             ;PLL Select Status
  395  M             0005                 PLLST.                equ       5
  395  M             0020                 PLLST_                equ       1<PLLST.
  395                                                         endm
  396  M                                                      @bitnum   LOCK,6              ;Lock Status
  396  M             0006                 LOCK.                equ       6
  396  M             0040                 LOCK_                equ       1<LOCK.
  396                                                         endm
  397  M                                                      @bitnum   LOLS,7              ;Loss of Lock Status
  397  M             0007                 LOLS.                equ       7
  397  M             0080                 LOLS_                equ       1<LOLS.
  397                                                         endm
  398                                     
  399                004C                 MCGC3               equ       $004C,1             ;MCG Control Register 3
  400                                     
  401  M                                                      @bitnum   CME,5               ;Clock Monitor Enable
  401  M             0005                 CME.                equ       5
  401  M             0020                 CME_                equ       1<CME.
  401                                                         endm
  402  M                                                      @bitnum   PLLS,6              ;PLL Select
  402  M             0006                 PLLS.                equ       6
  402  M             0040                 PLLS_                equ       1<PLLS.
  402                                                         endm
  403  M                                                      @bitnum   LOLIE,7             ;Loss of Lock Interrupt Enable
  403  M             0007                 LOLIE.                equ       7
  403  M             0080                 LOLIE_                equ       1<LOLIE.
  403                                                         endm
  404                                     
  405                0050                 SPIC1               equ       $0050,1             ;SPI Control Register 1
  406                                     
  407  M                                                      @bitnum   LSBFE,0             ;LSB First (Shifter Direction)
  407  M             0000                 LSBFE.                equ       0
  407  M             0001                 LSBFE_                equ       1<LSBFE.
  407                                                         endm
  408  M                                                      @bitnum   SSOE,1              ;Slave Select Output Enable
  408  M             0001                 SSOE.                equ       1
  408  M             0002                 SSOE_                equ       1<SSOE.
  408                                                         endm
  409  M                                                      @bitnum   CPHA,2              ;Clock Phase
  409  M             0002                 CPHA.                equ       2
  409  M             0004                 CPHA_                equ       1<CPHA.
  409                                                         endm
  410  M                                                      @bitnum   CPOL,3              ;Clock Polarity
  410  M             0003                 CPOL.                equ       3
  410  M             0008                 CPOL_                equ       1<CPOL.
  410                                                         endm
  411  M                                                      @bitnum   MSTR,4              ;Master/Slave Mode Select
  411  M             0004                 MSTR.                equ       4
  411  M             0010                 MSTR_                equ       1<MSTR.
  411                                                         endm
  412  M                                                      @bitnum   SPTIE,5             ;SPI Transmit Interrupt Enable
  412  M             0005                 SPTIE.                equ       5
  412  M             0020                 SPTIE_                equ       1<SPTIE.
  412                                                         endm
  413  M                                                      @bitnum   SPE,6               ;SPI System Enable
  413  M             0006                 SPE.                equ       6
  413  M             0040                 SPE_                equ       1<SPE.
  413                                                         endm
  414  M                                                      @bitnum   SPIE,7              ;SPI Interrupt Enable (for SPRF and MODF)
  414  M             0007                 SPIE.                equ       7
  414  M             0080                 SPIE_                equ       1<SPIE.
  414                                                         endm
  415                                     
  416                0051                 SPIC2               equ       $0051,1             ;SPI Control Register 2
  417                                     
  418  M                                                      @bitnum   SPC0,0              ;SPI Pin Control 0
  418  M             0000                 SPC0.                equ       0
  418  M             0001                 SPC0_                equ       1<SPC0.
  418                                                         endm
  419  M                                                      @bitnum   SPISWAI,1           ;SPI Stop in Wait Mode
  419  M             0001                 SPISWAI.                equ       1
  419  M             0002                 SPISWAI_                equ       1<SPISWAI.
  419                                                         endm
  420  M                                                      @bitnum   BIDIROE,3           ;Bidirectional Mode Output Enable
  420  M             0003                 BIDIROE.                equ       3
  420  M             0008                 BIDIROE_                equ       1<BIDIROE.
  420                                                         endm
  421  M                                                      @bitnum   MODFEN,4            ;Master Mode-Fault Function Enable
  421  M             0004                 MODFEN.                equ       4
  421  M             0010                 MODFEN_                equ       1<MODFEN.
  421                                                         endm
  422                                     
  423                0052                 SPIBR               equ       $0052,1             ;SPI Baud Rate Register
  424                0053                 SPIS                equ       $0053,1             ;SPI Status Register
  425                                     
  426  M                                                      @bitnum   MODF,4              ;Master Mode Fault Flag
  426  M             0004                 MODF.                equ       4
  426  M             0010                 MODF_                equ       1<MODF.
  426                                                         endm
  427  M                                                      @bitnum   SPTEF,5             ;SPI Transmit Buffer Empty Flag
  427  M             0005                 SPTEF.                equ       5
  427  M             0020                 SPTEF_                equ       1<SPTEF.
  427                                                         endm
  428  M                                                      @bitnum   SPRF,7              ;SPI Read Buffer Full Flag
  428  M             0007                 SPRF.                equ       7
  428  M             0080                 SPRF_                equ       1<SPRF.
  428                                                         endm
  429                                     
  430                0055                 SPID                equ       $0055,1             ;SPI Data Register
  431                                     
  432                0058                 IICA                equ       $0058               ;IIC Address Register
  433                0059                 IICF                equ       $0059               ;IIC Frequency Divider Register
  434                                     
  435                0000                 MULTBY1             equ       $00                 ;0 = multiply by 1
  436                0040                 MULTBY2             equ       $40                 ;1 = multiply by 2
  437                0080                 MULTBY4             equ       $80                 ;2 = multiply by 4
  438                                     
  439  M                                                      @bitnum   MULT0,6             ;Multiplier Factor Bit 0
  439  M             0006                 MULT0.                equ       6
  439  M             0040                 MULT0_                equ       1<MULT0.
  439                                                         endm
  440  M                                                      @bitnum   MULT1,7             ;Multiplier Factor Bit 1
  440  M             0007                 MULT1.                equ       7
  440  M             0080                 MULT1_                equ       1<MULT1.
  440                                                         endm
  441                                     
  442                005A                 IICC1               equ       $005A,1             ;IIC Control Register 1
  443                005A                 IICC                equ       $005A,1             ;IIC Control Register
  444                                     
  445  M                                                      @bitnum   RSTA,2              ;Repeat START
  445  M             0002                 RSTA.                equ       2
  445  M             0004                 RSTA_                equ       1<RSTA.
  445                                                         endm
  446  M                                                      @bitnum   TXAK,3              ;Transmit Acknowledge Enable
  446  M             0003                 TXAK.                equ       3
  446  M             0008                 TXAK_                equ       1<TXAK.
  446                                                         endm
  447  M                                                      @bitnum   TX,4                ;Transmit Mode Select
  447  M             0004                 TX.                equ       4
  447  M             0010                 TX_                equ       1<TX.
  447                                                         endm
  448  M                                                      @bitnum   MST,5               ;Master Mode Select
  448  M             0005                 MST.                equ       5
  448  M             0020                 MST_                equ       1<MST.
  448                                                         endm
  449  M                                                      @bitnum   IICIE,6             ;IIC Interrupt Enable
  449  M             0006                 IICIE.                equ       6
  449  M             0040                 IICIE_                equ       1<IICIE.
  449                                                         endm
  450  M                                                      @bitnum   IICEN,7             ;IIC Enable
  450  M             0007                 IICEN.                equ       7
  450  M             0080                 IICEN_                equ       1<IICEN.
  450                                                         endm
  451                                     
  452                005B                 IICS                equ       $005B,1             ;IIC Status Register
  453                                     
  454  M                                                      @bitnum   RXAK,0              ;Receive Acknowledge
  454  M             0000                 RXAK.                equ       0
  454  M             0001                 RXAK_                equ       1<RXAK.
  454                                                         endm
  455  M                                                      @bitnum   IICIF,1             ;IIC Interrupt Flag
  455  M             0001                 IICIF.                equ       1
  455  M             0002                 IICIF_                equ       1<IICIF.
  455                                                         endm
  456  M                                                      @bitnum   SRW,2               ;Slave Read/Write
  456  M             0002                 SRW.                equ       2
  456  M             0004                 SRW_                equ       1<SRW.
  456                                                         endm
  457  M                                                      @bitnum   ARBL,4              ;Arbitration Lost
  457  M             0004                 ARBL.                equ       4
  457  M             0010                 ARBL_                equ       1<ARBL.
  457                                                         endm
  458  M                                                      @bitnum   BUSY,5              ;Bus Busy
  458  M             0005                 BUSY.                equ       5
  458  M             0020                 BUSY_                equ       1<BUSY.
  458                                                         endm
  459  M                                                      @bitnum   IAAS,6              ;Addressed as a Slave
  459  M             0006                 IAAS.                equ       6
  459  M             0040                 IAAS_                equ       1<IAAS.
  459                                                         endm
  460  M                                                      @bitnum   TCF,7               ;Transfer Complete Flag
  460  M             0007                 TCF.                equ       7
  460  M             0080                 TCF_                equ       1<TCF.
  460                                                         endm
  461                                     
  462                005C                 IICD                equ       $005C,1             ;IIC Data I/O Register
  463                005D                 IICC2               equ       $005D,1             ;IIC Control Register 2
  464                                     
  465  M                                                      @bitnum   ADEXT,6             ;Address Extension
  465  M             0006                 ADEXT.                equ       6
  465  M             0040                 ADEXT_                equ       1<ADEXT.
  465                                                         endm
  466  M                                                      @bitnum   GCAEN,7             ;General Call Address Enable
  466  M             0007                 GCAEN.                equ       7
  466  M             0080                 GCAEN_                equ       1<GCAEN.
  466                                                         endm
  467                                     
  468                0060                 TPM2SC              equ       $0060,1             ;TPM2 Status and Control Register
  469                0061                 TPM2CNT             equ       $0061,2             ;TPM2 Timer Counter Register
  470                0061                 TPM2CNTH            equ       $0061,1             ;TPM2 Timer Counter Register High
  471                0062                 TPM2CNTL            equ       $0062,1             ;TPM2 Timer Counter Register Low
  472                0063                 TPM2MOD             equ       $0063,2             ;TPM2 Timer Counter Modulo Register
  473                0063                 TPM2MODH            equ       $0063,1             ;TPM2 Timer Counter Modulo Register High
  474                0064                 TPM2MODL            equ       $0064,1             ;TPM2 Timer Counter Modulo Register Low
  475                0065                 TPM2C0SC            equ       $0065,1             ;TPM2 Timer Channel 0 Status and Control Register
  476                0066                 TPM2C0V             equ       $0066,2             ;TPM2 Timer Channel 0 Value Register
  477                0066                 TPM2C0VH            equ       $0066,1             ;TPM2 Timer Channel 0 Value Register High
  478                0067                 TPM2C0VL            equ       $0067,1             ;TPM2 Timer Channel 0 Value Register Low
  479                0068                 TPM2C1SC            equ       $0068,1             ;TPM2 Timer Channel 1 Status and Control Register
  480                0069                 TPM2C1V             equ       $0069,2             ;TPM2 Timer Channel 1 Value Register
  481                0069                 TPM2C1VH            equ       $0069,1             ;TPM2 Timer Channel 1 Value Register High
  482                006A                 TPM2C1VL            equ       $006A,1             ;TPM2 Timer Channel 1 Value Register Low
  483                                     
  484                006C                 RTCSC               equ       $006C,1             ;RTC Status and Control Register
  485                                     
  486  M                                                      @bitnum   RTIE,4              ;Real-Time Interrupt Enable
  486  M             0004                 RTIE.                equ       4
  486  M             0010                 RTIE_                equ       1<RTIE.
  486                                                         endm
  487  M                                                      @bitnum   RTCLKS0,5           ;Real-Time Clock Source Select, bit 0
  487  M             0005                 RTCLKS0.                equ       5
  487  M             0020                 RTCLKS0_                equ       1<RTCLKS0.
  487                                                         endm
  488  M                                                      @bitnum   RTCLKS1,6           ;Real-Time Clock Source Select, bit 1
  488  M             0006                 RTCLKS1.                equ       6
  488  M             0040                 RTCLKS1_                equ       1<RTCLKS1.
  488                                                         endm
  489  M                                                      @bitnum   RTIF,7              ;Real-Time Interrupt Flag
  489  M             0007                 RTIF.                equ       7
  489  M             0080                 RTIF_                equ       1<RTIF.
  489                                                         endm
  490                                     
  491                006D                 RTCCNT              equ       $006D,1             ;RTC Counter Register
  492                006E                 RTCMOD              equ       $006E,1             ;RTC Modulo Register
  493                                     
  494                1800                 SRS                 equ       $1800,1             ;System Reset Status Register
  495                1800                 COP                 equ       SRS,1               ;for "STA COP"
  496                                     
  497  M                                                      @bitnum   LVD,1               ;Low Voltage Detect
  497  M             0001                 LVD.                equ       1
  497  M             0002                 LVD_                equ       1<LVD.
  497                                                         endm
  498  M                                                      @bitnum   LOC,2               ;Loss-of-Clock Reset
  498  M             0002                 LOC.                equ       2
  498  M             0004                 LOC_                equ       1<LOC.
  498                                                         endm
  499  M                                                      @bitnum   ILAD,3              ;Illegal Address
  499  M             0003                 ILAD.                equ       3
  499  M             0008                 ILAD_                equ       1<ILAD.
  499                                                         endm
  500  M                                                      @bitnum   ILOP,4              ;Illegal Opcode
  500  M             0004                 ILOP.                equ       4
  500  M             0010                 ILOP_                equ       1<ILOP.
  500                                                         endm
  501  M                                                      @bitnum   COP,5               ;Computer Operating Properly (COP) Watchdog
  501  M             0005                 COP.                equ       5
  501  M             0020                 COP_                equ       1<COP.
  501                                                         endm
  502  M                                                      @bitnum   PIN,6               ;External Reset Pin
  502  M             0006                 PIN.                equ       6
  502  M             0040                 PIN_                equ       1<PIN.
  502                                                         endm
  503  M                                                      @bitnum   POR,7               ;Power-On Reset
  503  M             0007                 POR.                equ       7
  503  M             0080                 POR_                equ       1<POR.
  503                                                         endm
  504                                     
  505                1801                 SBDFR               equ       $1801,1             ;System Background Debug Force Reset Register
  506                                     
  507  M                                                      @bitnum   BDFR,0              ;Background Debug Force Reset
  507  M             0000                 BDFR.                equ       0
  507  M             0001                 BDFR_                equ       1<BDFR.
  507                                                         endm
  508                                     
  509                1802                 SOPT1               equ       $1802,1             ;System Options Register 1
  510                1802                 SOPT                equ       SOPT1,1
  511                                     
  512  M                                                      @bitnum   IICPS,3             ;IIC Pin Select
  512  M             0003                 IICPS.                equ       3
  512  M             0008                 IICPS_                equ       1<IICPS.
  512                                                         endm
  513  M                                                      @bitnum   SCI2PS,4            ;SCI2 Pin Select
  513  M             0004                 SCI2PS.                equ       4
  513  M             0010                 SCI2PS_                equ       1<SCI2PS.
  513                                                         endm
  514  M                                                      @bitnum   STOPE,5             ;Stop Mode Enable
  514  M             0005                 STOPE.                equ       5
  514  M             0020                 STOPE_                equ       1<STOPE.
  514                                                         endm
  515  M                                                      @bitnum   COPT0,6             ;COP Watchdog Timeout, bit 0
  515  M             0006                 COPT0.                equ       6
  515  M             0040                 COPT0_                equ       1<COPT0.
  515                                                         endm
  516  M                                                      @bitnum   COPT1,7             ;COP Watchdog Timeout, bit 1
  516  M             0007                 COPT1.                equ       7
  516  M             0080                 COPT1_                equ       1<COPT1.
  516                                                         endm
  517                                     
  518                1803                 SOPT2               equ       $1803,1             ;System Options Register 2
  519                                     
  520  M                                                      @bitnum   MCSEL0,0            ;MCLK Divide Select, bit 0
  520  M             0000                 MCSEL0.                equ       0
  520  M             0001                 MCSEL0_                equ       1<MCSEL0.
  520                                                         endm
  521  M                                                      @bitnum   MCSEL1,1            ;MCLK Divide Select, bit 1
  521  M             0001                 MCSEL1.                equ       1
  521  M             0002                 MCSEL1_                equ       1<MCSEL1.
  521                                                         endm
  522  M                                                      @bitnum   MCSEL2,2            ;MCLK Divide Select, bit 2
  522  M             0002                 MCSEL2.                equ       2
  522  M             0004                 MCSEL2_                equ       1<MCSEL2.
  522                                                         endm
  523  M                                                      @bitnum   ADHTS,4             ;ADC Hardware Trigger Select
  523  M             0004                 ADHTS.                equ       4
  523  M             0010                 ADHTS_                equ       1<ADHTS.
  523                                                         endm
  524  M                                                      @bitnum   COPW,6              ;COP Window
  524  M             0006                 COPW.                equ       6
  524  M             0040                 COPW_                equ       1<COPW.
  524                                                         endm
  525  M                                                      @bitnum   COPCLKS,7           ;COP Watchdog Clock Select
  525  M             0007                 COPCLKS.                equ       7
  525  M             0080                 COPCLKS_                equ       1<COPCLKS.
  525                                                         endm
  526                                     
  527                1806                 SDID                equ       $1806,2             ;System Device Identification Register
  528                1806                 SDIDH               equ       $1806,1             ;System Device Identification Register High
  529                1807                 SDIDL               equ       $1807,1             ;System Device Identification Register Low
  530                                     
  531                1809                 SPMSC1              equ       $1809,1             ;System Power Management Status and Control 1 Register
  532                                     
  533  M                                                      @bitnum   BGBE,0              ;Bandgap Buffer Enable
  533  M             0000                 BGBE.                equ       0
  533  M             0001                 BGBE_                equ       1<BGBE.
  533                                                         endm
  534  M                                                      @bitnum   LVDE,2              ;Low-Voltage Detect Enable
  534  M             0002                 LVDE.                equ       2
  534  M             0004                 LVDE_                equ       1<LVDE.
  534                                                         endm
  535  M                                                      @bitnum   LVDSE,3             ;Low-Voltage Detect Stop Enable
  535  M             0003                 LVDSE.                equ       3
  535  M             0008                 LVDSE_                equ       1<LVDSE.
  535                                                         endm
  536  M                                                      @bitnum   LVDRE,4             ;Low-Voltage Detect Reset Enable
  536  M             0004                 LVDRE.                equ       4
  536  M             0010                 LVDRE_                equ       1<LVDRE.
  536                                                         endm
  537  M                                                      @bitnum   LVWIE,5             ;Low-Voltage Warning Interrupt Enable
  537  M             0005                 LVWIE.                equ       5
  537  M             0020                 LVWIE_                equ       1<LVWIE.
  537                                                         endm
  538  M                                                      @bitnum   LVWACK,6            ;Low-Voltage Warning Acknowledge
  538  M             0006                 LVWACK.                equ       6
  538  M             0040                 LVWACK_                equ       1<LVWACK.
  538                                                         endm
  539  M                                                      @bitnum   LVWF,7              ;Low-Voltage Warning status
  539  M             0007                 LVWF.                equ       7
  539  M             0080                 LVWF_                equ       1<LVWF.
  539                                                         endm
  540                                     
  541                180A                 SPMSC2              equ       $180A,1             ;System Power Management Status and Control 2 Register
  542                                     
  543  M                                                      @bitnum   PPDC,0              ;Partial Power Down Control
  543  M             0000                 PPDC.                equ       0
  543  M             0001                 PPDC_                equ       1<PPDC.
  543                                                         endm
  544  M                                                      @bitnum   PPDACK,2            ;Partial Power Down Acknowledge
  544  M             0002                 PPDACK.                equ       2
  544  M             0004                 PPDACK_                equ       1<PPDACK.
  544                                                         endm
  545  M                                                      @bitnum   PPDF,3              ;Partial Power Down Flag
  545  M             0003                 PPDF.                equ       3
  545  M             0008                 PPDF_                equ       1<PPDF.
  545                                                         endm
  546  M                                                      @bitnum   LVWV,4              ;Low-Voltage Warning Voltage Select
  546  M             0004                 LVWV.                equ       4
  546  M             0010                 LVWV_                equ       1<LVWV.
  546                                                         endm
  547  M                                                      @bitnum   LVDV,5              ;Low-Voltage Detect Voltage Select
  547  M             0005                 LVDV.                equ       5
  547  M             0020                 LVDV_                equ       1<LVDV.
  547                                                         endm
  548                                     
  549                1810                 DBGCA               equ       $1810,2             ;Debug Comparator A Register
  550                1810                 DBGCAH              equ       $1810,1             ;Debug Comparator A High Register
  551                1811                 DBGCAL              equ       $1811,1             ;Debug Comparator A Low Register
  552                1812                 DBGCB               equ       $1812,2             ;Debug Comparator B Register
  553                1812                 DBGCBH              equ       $1812,1             ;Debug Comparator B High Register
  554                1813                 DBGCBL              equ       $1813,1             ;Debug Comparator B Low Register
  555                1814                 DBGF                equ       $1814,2             ;Debug FIFO Register
  556                1814                 DBGFH               equ       $1814,1             ;Debug FIFO High Register
  557                1815                 DBGFL               equ       $1815,1             ;Debug FIFO Low Register
  558                1816                 DBGC                equ       $1816,1             ;Debug Control Register
  559                                     
  560  M                                                      @bitnum   RWBEN,0             ;Enable R/W for Comparator B
  560  M             0000                 RWBEN.                equ       0
  560  M             0001                 RWBEN_                equ       1<RWBEN.
  560                                                         endm
  561  M                                                      @bitnum   RWB,1               ;R/W Comparison Value for Comparator B
  561  M             0001                 RWB.                equ       1
  561  M             0002                 RWB_                equ       1<RWB.
  561                                                         endm
  562  M                                                      @bitnum   RWAEN,2             ;Enable R/W for Comparator A
  562  M             0002                 RWAEN.                equ       2
  562  M             0004                 RWAEN_                equ       1<RWAEN.
  562                                                         endm
  563  M                                                      @bitnum   RWA,3               ;R/W Comparison Value for Comparator A
  563  M             0003                 RWA.                equ       3
  563  M             0008                 RWA_                equ       1<RWA.
  563                                                         endm
  564  M                                                      @bitnum   BRKEN,4             ;Break Enable
  564  M             0004                 BRKEN.                equ       4
  564  M             0010                 BRKEN_                equ       1<BRKEN.
  564                                                         endm
  565  M                                                      @bitnum   TAG,5               ;Tag/Force Select
  565  M             0005                 TAG.                equ       5
  565  M             0020                 TAG_                equ       1<TAG.
  565                                                         endm
  566  M                                                      @bitnum   ARM,6               ;Arm Control
  566  M             0006                 ARM.                equ       6
  566  M             0040                 ARM_                equ       1<ARM.
  566                                                         endm
  567  M                                                      @bitnum   DBGEN,7             ;Debug Module Enable
  567  M             0007                 DBGEN.                equ       7
  567  M             0080                 DBGEN_                equ       1<DBGEN.
  567                                                         endm
  568                                     
  569                1817                 DBGT                equ       $1817,1             ;Debug Trigger Register
  570                                     
  571  M                                                      @bitnum   BEGIN,6             ;Begin/End Trigger Select
  571  M             0006                 BEGIN.                equ       6
  571  M             0040                 BEGIN_                equ       1<BEGIN.
  571                                                         endm
  572  M                                                      @bitnum   TRGSEL,7            ;Trigger Type
  572  M             0007                 TRGSEL.                equ       7
  572  M             0080                 TRGSEL_                equ       1<TRGSEL.
  572                                                         endm
  573                                     
  574                1818                 DBGS                equ       $1818,1             ;Debug Status Register
  575                                     
  576  M                                                      @bitnum   ARMF,5              ;Arm Flag
  576  M             0005                 ARMF.                equ       5
  576  M             0020                 ARMF_                equ       1<ARMF.
  576                                                         endm
  577  M                                                      @bitnum   BF,6                ;Trigger Match B Flag
  577  M             0006                 BF.                equ       6
  577  M             0040                 BF_                equ       1<BF.
  577                                                         endm
  578  M                                                      @bitnum   AF,7                ;Trigger Match A Flag
  578  M             0007                 AF.                equ       7
  578  M             0080                 AF_                equ       1<AF.
  578                                                         endm
  579                                     
  580                1820                 FCDIV               equ       $1820,1             ;EEPROM and FLASH Clock Divider Register
  581                                     
  582  M                                                      @bitnum   PRDIV8,6            ;Enable Prescaler by 8
  582  M             0006                 PRDIV8.                equ       6
  582  M             0040                 PRDIV8_                equ       1<PRDIV8.
  582                                                         endm
  583  M                                                      @bitnum   DIVLD,7             ;Clock Divider Load Control
  583  M             0007                 DIVLD.                equ       7
  583  M             0080                 DIVLD_                equ       1<DIVLD.
  583                                                         endm
  584                                     
  585                1821                 FOPT                equ       $1821,1             ;EEPROM and FLASH Options Register
  586                                     
  587  M                                                      @bitnum   SEC0,0              ;Flash Security Bit 0
  587  M             0000                 SEC0.                equ       0
  587  M             0001                 SEC0_                equ       1<SEC0.
  587                                                         endm
  588  M                                                      @bitnum   SEC1,1              ;Flash Security Bit 1
  588  M             0001                 SEC1.                equ       1
  588  M             0002                 SEC1_                equ       1<SEC1.
  588                                                         endm
  589  M                                                      @bitnum   EPGMOD,5            ;EEPROM Sector Mode Bit
  589  M             0005                 EPGMOD.                equ       5
  589  M             0020                 EPGMOD_                equ       1<EPGMOD.
  589                                                         endm
  590  M                                                      @bitnum   FNORED,6            ;Vector Redirection Disable Bit
  590  M             0006                 FNORED.                equ       6
  590  M             0040                 FNORED_                equ       1<FNORED.
  590                                                         endm
  591  M                                                      @bitnum   KEYEN,7             ;Backdoor Key Security Enable Bit
  591  M             0007                 KEYEN.                equ       7
  591  M             0080                 KEYEN_                equ       1<KEYEN.
  591                                                         endm
  592                                     
  593                1823                 FCNFG               equ       $1823,1             ;EEPROM and FLASH Configuration Register
  594                                     
  595  M                                                      @bitnum   KEYACC,5            ;Enable Security Key Writing
  595  M             0005                 KEYACC.                equ       5
  595  M             0020                 KEYACC_                equ       1<KEYACC.
  595                                                         endm
  596  M                                                      @bitnum   EPGSEL,6            ;EEPROM Page Select Bit
  596  M             0006                 EPGSEL.                equ       6
  596  M             0040                 EPGSEL_                equ       1<EPGSEL.
  596                                                         endm
  597                                     
  598                1824                 FPROT               equ       $1824,1             ;EEPROM and FLASH Protection Register
  599                1825                 FSTAT               equ       $1825,1             ;EEPROM and FLASH Status Register
  600                                     
  601  M                                                      @bitnum   FBLANK,2            ;FLASH Flag Indicating the Erase Verify Operation Status
  601  M             0002                 FBLANK.                equ       2
  601  M             0004                 FBLANK_                equ       1<FBLANK.
  601                                                         endm
  602  M                                                      @bitnum   FACCERR,4           ;FLASH Access Error Flag
  602  M             0004                 FACCERR.                equ       4
  602  M             0010                 FACCERR_                equ       1<FACCERR.
  602                                                         endm
  603  M                                                      @bitnum   FPVIOL,5            ;FLASH Protection Violation Flag
  603  M             0005                 FPVIOL.                equ       5
  603  M             0020                 FPVIOL_                equ       1<FPVIOL.
  603                                                         endm
  604  M                                                      @bitnum   FCCF,6              ;FLASH Command Complete Interrupt Flag
  604  M             0006                 FCCF.                equ       6
  604  M             0040                 FCCF_                equ       1<FCCF.
  604                                                         endm
  605  M                                                      @bitnum   FCBEF,7             ;FLASH Command Buffer Empty Flag
  605  M             0007                 FCBEF.                equ       7
  605  M             0080                 FCBEF_                equ       1<FCBEF.
  605                                                         endm
  606                                     
  607                1826                 FCMD                equ       $1826,1             ;EEPROM and FLASH Command Register
  608                                     
  609                1840                 PTAPE               equ       $1840,1             ;Port A Pull Enable Register
  610                1840                 PTAPUE              equ       PTAPE,1
  611                1841                 PTASE               equ       $1841,1             ;Port A Slew Rate Enable Register
  612                1842                 PTADS               equ       $1842,1             ;Port A Drive Strength Selection Register
  613                                     
  614                1844                 PTASC               equ       $1844,1             ;Port A Interrupt Status and Control Register
  615                                     
  616  M                                                      @bitnum   PTAMOD,0            ;Port A Detection Mode
  616  M             0000                 PTAMOD.                equ       0
  616  M             0001                 PTAMOD_                equ       1<PTAMOD.
  616                                                         endm
  617  M                                                      @bitnum   PTAIE,1             ;Port A Interrupt Enable
  617  M             0001                 PTAIE.                equ       1
  617  M             0002                 PTAIE_                equ       1<PTAIE.
  617                                                         endm
  618  M                                                      @bitnum   PTAACK,2            ;Port A Interrupt Acknowledge
  618  M             0002                 PTAACK.                equ       2
  618  M             0004                 PTAACK_                equ       1<PTAACK.
  618                                                         endm
  619  M                                                      @bitnum   PTAIF,3             ;Port A Interrupt Flag
  619  M             0003                 PTAIF.                equ       3
  619  M             0008                 PTAIF_                equ       1<PTAIF.
  619                                                         endm
  620                                     
  621                1845                 PTAPS               equ       $1845,1             ;Port A Interrupt Pin Select Register
  622                1846                 PTAES               equ       $1846,1             ;Port A Interrupt Edge Select Register
  623                                     
  624                1848                 PTBPE               equ       $1848,1             ;Port B Pull Enable Register
  625                1848                 PTBPUE              equ       PTBPE,1
  626                1849                 PTBSE               equ       $1849,1             ;Port B Slew Rate Enable Register
  627                184A                 PTBDS               equ       $184A,1             ;Port B Drive Strength Selection Register
  628                                     
  629                184C                 PTBSC               equ       $184C,1             ;Port B Interrupt Status and Control Register
  630                                     
  631  M                                                      @bitnum   PTBMOD,0            ;Port B Detection Mode
  631  M             0000                 PTBMOD.                equ       0
  631  M             0001                 PTBMOD_                equ       1<PTBMOD.
  631                                                         endm
  632  M                                                      @bitnum   PTBIE,1             ;Port B Interrupt Enable
  632  M             0001                 PTBIE.                equ       1
  632  M             0002                 PTBIE_                equ       1<PTBIE.
  632                                                         endm
  633  M                                                      @bitnum   PTBACK,2            ;Port B Interrupt Acknowledge
  633  M             0002                 PTBACK.                equ       2
  633  M             0004                 PTBACK_                equ       1<PTBACK.
  633                                                         endm
  634  M                                                      @bitnum   PTBIF,3             ;Port B Interrupt Flag
  634  M             0003                 PTBIF.                equ       3
  634  M             0008                 PTBIF_                equ       1<PTBIF.
  634                                                         endm
  635                                     
  636                184D                 PTBPS               equ       $184D,1             ;Port B Interrupt Pin Select Register
  637                184E                 PTBES               equ       $184E,1             ;Port B Interrupt Edge Select Register
  638                                     
  639                1850                 PTCPE               equ       $1850,1             ;Port C Pull Enable Register
  640                1850                 PTCPUE              equ       PTCPE,1
  641                1851                 PTCSE               equ       $1851,1             ;Port C Slew Rate Enable Register
  642                1852                 PTCDS               equ       $1852,1             ;Port C Drive Strength Selection Register
  643                                     
  644                1858                 PTDPE               equ       $1858,1             ;Port D Pull Enable Register
  645                1858                 PTDPUE              equ       PTDPE,1
  646                1859                 PTDSE               equ       $1859,1             ;Port D Slew Rate Enable Register
  647                185A                 PTDDS               equ       $185A,1             ;Port D Drive Strength Selection Register
  648                                     
  649                185C                 PTDSC               equ       $185C,1             ;Port D Interrupt Status and Control Register
  650                                     
  651  M                                                      @bitnum   PTDMOD,0            ;Port D Detection Mode
  651  M             0000                 PTDMOD.                equ       0
  651  M             0001                 PTDMOD_                equ       1<PTDMOD.
  651                                                         endm
  652  M                                                      @bitnum   PTDIE,1             ;Port D Interrupt Enable
  652  M             0001                 PTDIE.                equ       1
  652  M             0002                 PTDIE_                equ       1<PTDIE.
  652                                                         endm
  653  M                                                      @bitnum   PTDACK,2            ;Port D Interrupt Acknowledge
  653  M             0002                 PTDACK.                equ       2
  653  M             0004                 PTDACK_                equ       1<PTDACK.
  653                                                         endm
  654  M                                                      @bitnum   PTDIF,3             ;Port D Interrupt Flag
  654  M             0003                 PTDIF.                equ       3
  654  M             0008                 PTDIF_                equ       1<PTDIF.
  654                                                         endm
  655                                     
  656                185D                 PTDPS               equ       $185D,1             ;Port D Interrupt Pin Select Register
  657                185E                 PTDES               equ       $185E,1             ;Port D Interrupt Edge Select Register
  658                                     
  659                1860                 PTEPE               equ       $1860,1             ;Port E Pull Enable Register
  660                1860                 PTEPUE              equ       PTEPE,1
  661                1861                 PTESE               equ       $1861,1             ;Port E Slew Rate Enable Register
  662                1862                 PTEDS               equ       $1862,1             ;Port E Drive Strength Selection Register
  663                                     
  664                1868                 PTFPE               equ       $1868,1             ;Port F Pull Enable Register
  665                1868                 PTFPUE              equ       PTFPE,1
  666                1869                 PTFSE               equ       $1869,1             ;Port F Slew Rate Enable Register
  667                186A                 PTFDS               equ       $186A,1             ;Port F Drive Strength Selection Register
  668                                     
  669                1870                 PTGPE               equ       $1870,1             ;Port G Pull Enable Register
  670                1870                 PTGPUE              equ       PTGPE,1
  671                1871                 PTGSE               equ       $1871,1             ;Port G Slew Rate Enable Register
  672                1872                 PTGDS               equ       $1872,1             ;Port G Drive Strength Selection Register
  673                                     
  674                                     ;*******************************************************************************
  675                                     ; MSCAN CAN
  676                                     ;*******************************************************************************
  677                                     
  678                1880                 CAN_BASE            def       $1880
  679                                     
  680                1880                 CANCTL0             equ       CAN_BASE+$00,1      ;MSCAN Control 0 Register
  681                                     
  682  M                                  CAN_INITRQ          @pin      CANCTL0,0           ;Initialization Mode Request
  682  M                                            #ifb CANCTL0,0
  682  M                                            #endif
  682  M                                            #ifb CAN_INITRQ
  682  M                                            #else ifnb CANCTL0,0
  682  M                                                      mreq      1:PORT[,BitNumber]
  682  M                                                      mdef      2,0
  682  M                                                      mset      0,CAN_INITRQ
  682  M                                                      #temp     0
  682  M             1880                 CAN_INITRQ             set       CANCTL0
  682  M             0000                 CAN_INITRQ.            equ       0
  682  M             0001                 CAN_INITRQ_            equ       1<CAN_INITRQ.
  682  M                                            #endif
  682  M                                            #if :temp > 7
  682  M                                            #endif
  682                                                         endm
  683  M                                  CAN_SLPRQ           @pin      CANCTL0,1           ;Sleep Mode Request
  683  M                                            #ifb CANCTL0,1
  683  M                                            #endif
  683  M                                            #ifb CAN_SLPRQ
  683  M                                            #else ifnb CANCTL0,1
  683  M                                                      mreq      1:PORT[,BitNumber]
  683  M                                                      mdef      2,0
  683  M                                                      mset      0,CAN_SLPRQ
  683  M                                                      #temp     1
  683  M             1880                 CAN_SLPRQ             set       CANCTL0
  683  M             0001                 CAN_SLPRQ.            equ       1
  683  M             0002                 CAN_SLPRQ_            equ       1<CAN_SLPRQ.
  683  M                                            #endif
  683  M                                            #if :temp > 7
  683  M                                            #endif
  683                                                         endm
  684  M                                  CAN_WUPE            @pin      CANCTL0,2           ;Wake-Up Enable
  684  M                                            #ifb CANCTL0,2
  684  M                                            #endif
  684  M                                            #ifb CAN_WUPE
  684  M                                            #else ifnb CANCTL0,2
  684  M                                                      mreq      1:PORT[,BitNumber]
  684  M                                                      mdef      2,0
  684  M                                                      mset      0,CAN_WUPE
  684  M                                                      #temp     2
  684  M             1880                 CAN_WUPE             set       CANCTL0
  684  M             0002                 CAN_WUPE.            equ       2
  684  M             0004                 CAN_WUPE_            equ       1<CAN_WUPE.
  684  M                                            #endif
  684  M                                            #if :temp > 7
  684  M                                            #endif
  684                                                         endm
  685  M                                  CAN_TIME            @pin      CANCTL0,3           ;Timer Enable
  685  M                                            #ifb CANCTL0,3
  685  M                                            #endif
  685  M                                            #ifb CAN_TIME
  685  M                                            #else ifnb CANCTL0,3
  685  M                                                      mreq      1:PORT[,BitNumber]
  685  M                                                      mdef      2,0
  685  M                                                      mset      0,CAN_TIME
  685  M                                                      #temp     3
  685  M             1880                 CAN_TIME             set       CANCTL0
  685  M             0003                 CAN_TIME.            equ       3
  685  M             0008                 CAN_TIME_            equ       1<CAN_TIME.
  685  M                                            #endif
  685  M                                            #if :temp > 7
  685  M                                            #endif
  685                                                         endm
  686  M                                  CAN_SYNCH           @pin      CANCTL0,4           ;Synchronized Status
  686  M                                            #ifb CANCTL0,4
  686  M                                            #endif
  686  M                                            #ifb CAN_SYNCH
  686  M                                            #else ifnb CANCTL0,4
  686  M                                                      mreq      1:PORT[,BitNumber]
  686  M                                                      mdef      2,0
  686  M                                                      mset      0,CAN_SYNCH
  686  M                                                      #temp     4
  686  M             1880                 CAN_SYNCH             set       CANCTL0
  686  M             0004                 CAN_SYNCH.            equ       4
  686  M             0010                 CAN_SYNCH_            equ       1<CAN_SYNCH.
  686  M                                            #endif
  686  M                                            #if :temp > 7
  686  M                                            #endif
  686                                                         endm
  687  M                                  CAN_CSWAI           @pin      CANCTL0,5           ;CAN Stops in Wait Mode
  687  M                                            #ifb CANCTL0,5
  687  M                                            #endif
  687  M                                            #ifb CAN_CSWAI
  687  M                                            #else ifnb CANCTL0,5
  687  M                                                      mreq      1:PORT[,BitNumber]
  687  M                                                      mdef      2,0
  687  M                                                      mset      0,CAN_CSWAI
  687  M                                                      #temp     5
  687  M             1880                 CAN_CSWAI             set       CANCTL0
  687  M             0005                 CAN_CSWAI.            equ       5
  687  M             0020                 CAN_CSWAI_            equ       1<CAN_CSWAI.
  687  M                                            #endif
  687  M                                            #if :temp > 7
  687  M                                            #endif
  687                                                         endm
  688  M                                  CAN_RXACT           @pin      CANCTL0,6           ;Receiver Active Status
  688  M                                            #ifb CANCTL0,6
  688  M                                            #endif
  688  M                                            #ifb CAN_RXACT
  688  M                                            #else ifnb CANCTL0,6
  688  M                                                      mreq      1:PORT[,BitNumber]
  688  M                                                      mdef      2,0
  688  M                                                      mset      0,CAN_RXACT
  688  M                                                      #temp     6
  688  M             1880                 CAN_RXACT             set       CANCTL0
  688  M             0006                 CAN_RXACT.            equ       6
  688  M             0040                 CAN_RXACT_            equ       1<CAN_RXACT.
  688  M                                            #endif
  688  M                                            #if :temp > 7
  688  M                                            #endif
  688                                                         endm
  689  M                                  CAN_RXFRM           @pin      CANCTL0,7           ;Received Frame Flag
  689  M                                            #ifb CANCTL0,7
  689  M                                            #endif
  689  M                                            #ifb CAN_RXFRM
  689  M                                            #else ifnb CANCTL0,7
  689  M                                                      mreq      1:PORT[,BitNumber]
  689  M                                                      mdef      2,0
  689  M                                                      mset      0,CAN_RXFRM
  689  M                                                      #temp     7
  689  M             1880                 CAN_RXFRM             set       CANCTL0
  689  M             0007                 CAN_RXFRM.            equ       7
  689  M             0080                 CAN_RXFRM_            equ       1<CAN_RXFRM.
  689  M                                            #endif
  689  M                                            #if :temp > 7
  689  M                                            #endif
  689                                                         endm
  690                                     
  691                1881                 CANCTL1             equ       CAN_BASE+$01,1      ;MSCAN Control 1 Register
  692                                     
  693  M                                  CAN_INITAK          @pin      CANCTL1,0           ;Initialization Mode Acknowledge
  693  M                                            #ifb CANCTL1,0
  693  M                                            #endif
  693  M                                            #ifb CAN_INITAK
  693  M                                            #else ifnb CANCTL1,0
  693  M                                                      mreq      1:PORT[,BitNumber]
  693  M                                                      mdef      2,0
  693  M                                                      mset      0,CAN_INITAK
  693  M                                                      #temp     0
  693  M             1881                 CAN_INITAK             set       CANCTL1
  693  M             0000                 CAN_INITAK.            equ       0
  693  M             0001                 CAN_INITAK_            equ       1<CAN_INITAK.
  693  M                                            #endif
  693  M                                            #if :temp > 7
  693  M                                            #endif
  693                                                         endm
  694  M                                  CAN_SLPAK           @pin      CANCTL1,1           ;Sleep Mode Acknowledge
  694  M                                            #ifb CANCTL1,1
  694  M                                            #endif
  694  M                                            #ifb CAN_SLPAK
  694  M                                            #else ifnb CANCTL1,1
  694  M                                                      mreq      1:PORT[,BitNumber]
  694  M                                                      mdef      2,0
  694  M                                                      mset      0,CAN_SLPAK
  694  M                                                      #temp     1
  694  M             1881                 CAN_SLPAK             set       CANCTL1
  694  M             0001                 CAN_SLPAK.            equ       1
  694  M             0002                 CAN_SLPAK_            equ       1<CAN_SLPAK.
  694  M                                            #endif
  694  M                                            #if :temp > 7
  694  M                                            #endif
  694                                                         endm
  695  M                                  CAN_WUPM            @pin      CANCTL1,2           ;Wake-Up Mode
  695  M                                            #ifb CANCTL1,2
  695  M                                            #endif
  695  M                                            #ifb CAN_WUPM
  695  M                                            #else ifnb CANCTL1,2
  695  M                                                      mreq      1:PORT[,BitNumber]
  695  M                                                      mdef      2,0
  695  M                                                      mset      0,CAN_WUPM
  695  M                                                      #temp     2
  695  M             1881                 CAN_WUPM             set       CANCTL1
  695  M             0002                 CAN_WUPM.            equ       2
  695  M             0004                 CAN_WUPM_            equ       1<CAN_WUPM.
  695  M                                            #endif
  695  M                                            #if :temp > 7
  695  M                                            #endif
  695                                                         endm
  696  M                                  CAN_BORM            @pin      CANCTL1,3           ;Bus-Off Recovery Mode
  696  M                                            #ifb CANCTL1,3
  696  M                                            #endif
  696  M                                            #ifb CAN_BORM
  696  M                                            #else ifnb CANCTL1,3
  696  M                                                      mreq      1:PORT[,BitNumber]
  696  M                                                      mdef      2,0
  696  M                                                      mset      0,CAN_BORM
  696  M                                                      #temp     3
  696  M             1881                 CAN_BORM             set       CANCTL1
  696  M             0003                 CAN_BORM.            equ       3
  696  M             0008                 CAN_BORM_            equ       1<CAN_BORM.
  696  M                                            #endif
  696  M                                            #if :temp > 7
  696  M                                            #endif
  696                                                         endm
  697  M                                  CAN_LISTEN          @pin      CANCTL1,4           ;Listen Only Mode
  697  M                                            #ifb CANCTL1,4
  697  M                                            #endif
  697  M                                            #ifb CAN_LISTEN
  697  M                                            #else ifnb CANCTL1,4
  697  M                                                      mreq      1:PORT[,BitNumber]
  697  M                                                      mdef      2,0
  697  M                                                      mset      0,CAN_LISTEN
  697  M                                                      #temp     4
  697  M             1881                 CAN_LISTEN             set       CANCTL1
  697  M             0004                 CAN_LISTEN.            equ       4
  697  M             0010                 CAN_LISTEN_            equ       1<CAN_LISTEN.
  697  M                                            #endif
  697  M                                            #if :temp > 7
  697  M                                            #endif
  697                                                         endm
  698  M                                  CAN_LOOPB           @pin      CANCTL1,5           ;Loop Back Self Test Mode
  698  M                                            #ifb CANCTL1,5
  698  M                                            #endif
  698  M                                            #ifb CAN_LOOPB
  698  M                                            #else ifnb CANCTL1,5
  698  M                                                      mreq      1:PORT[,BitNumber]
  698  M                                                      mdef      2,0
  698  M                                                      mset      0,CAN_LOOPB
  698  M                                                      #temp     5
  698  M             1881                 CAN_LOOPB             set       CANCTL1
  698  M             0005                 CAN_LOOPB.            equ       5
  698  M             0020                 CAN_LOOPB_            equ       1<CAN_LOOPB.
  698  M                                            #endif
  698  M                                            #if :temp > 7
  698  M                                            #endif
  698                                                         endm
  699  M                                  CAN_CLKSRC          @pin      CANCTL1,6           ;MSCAN Clock Source
  699  M                                            #ifb CANCTL1,6
  699  M                                            #endif
  699  M                                            #ifb CAN_CLKSRC
  699  M                                            #else ifnb CANCTL1,6
  699  M                                                      mreq      1:PORT[,BitNumber]
  699  M                                                      mdef      2,0
  699  M                                                      mset      0,CAN_CLKSRC
  699  M                                                      #temp     6
  699  M             1881                 CAN_CLKSRC             set       CANCTL1
  699  M             0006                 CAN_CLKSRC.            equ       6
  699  M             0040                 CAN_CLKSRC_            equ       1<CAN_CLKSRC.
  699  M                                            #endif
  699  M                                            #if :temp > 7
  699  M                                            #endif
  699                                                         endm
  700  M                                  CAN_CANE            @pin      CANCTL1,7           ;MSCAN Enable
  700  M                                            #ifb CANCTL1,7
  700  M                                            #endif
  700  M                                            #ifb CAN_CANE
  700  M                                            #else ifnb CANCTL1,7
  700  M                                                      mreq      1:PORT[,BitNumber]
  700  M                                                      mdef      2,0
  700  M                                                      mset      0,CAN_CANE
  700  M                                                      #temp     7
  700  M             1881                 CAN_CANE             set       CANCTL1
  700  M             0007                 CAN_CANE.            equ       7
  700  M             0080                 CAN_CANE_            equ       1<CAN_CANE.
  700  M                                            #endif
  700  M                                            #if :temp > 7
  700  M                                            #endif
  700                                                         endm
  701                                     
  702                1882                 CANBTR0             equ       CAN_BASE+$02,1      ;MSCAN Bus Timing Register 0
  703                                     
  704  M                                  CAN_SJW0            @pin      CANBTR0,6           ;Synchronization Jump Width 0
  704  M                                            #ifb CANBTR0,6
  704  M                                            #endif
  704  M                                            #ifb CAN_SJW0
  704  M                                            #else ifnb CANBTR0,6
  704  M                                                      mreq      1:PORT[,BitNumber]
  704  M                                                      mdef      2,0
  704  M                                                      mset      0,CAN_SJW0
  704  M                                                      #temp     6
  704  M             1882                 CAN_SJW0             set       CANBTR0
  704  M             0006                 CAN_SJW0.            equ       6
  704  M             0040                 CAN_SJW0_            equ       1<CAN_SJW0.
  704  M                                            #endif
  704  M                                            #if :temp > 7
  704  M                                            #endif
  704                                                         endm
  705  M                                  CAN_SJW1            @pin      CANBTR0,7           ;Synchronization Jump Width 1
  705  M                                            #ifb CANBTR0,7
  705  M                                            #endif
  705  M                                            #ifb CAN_SJW1
  705  M                                            #else ifnb CANBTR0,7
  705  M                                                      mreq      1:PORT[,BitNumber]
  705  M                                                      mdef      2,0
  705  M                                                      mset      0,CAN_SJW1
  705  M                                                      #temp     7
  705  M             1882                 CAN_SJW1             set       CANBTR0
  705  M             0007                 CAN_SJW1.            equ       7
  705  M             0080                 CAN_SJW1_            equ       1<CAN_SJW1.
  705  M                                            #endif
  705  M                                            #if :temp > 7
  705  M                                            #endif
  705                                                         endm
  706                                     
  707                1883                 CANBTR1             equ       CAN_BASE+$03,1      ;MSCAN Bus Timing Register 1
  708                                     
  709  M                                  CAN_SAMP            @pin      CANBTR1,7           ;Sampling
  709  M                                            #ifb CANBTR1,7
  709  M                                            #endif
  709  M                                            #ifb CAN_SAMP
  709  M                                            #else ifnb CANBTR1,7
  709  M                                                      mreq      1:PORT[,BitNumber]
  709  M                                                      mdef      2,0
  709  M                                                      mset      0,CAN_SAMP
  709  M                                                      #temp     7
  709  M             1883                 CAN_SAMP             set       CANBTR1
  709  M             0007                 CAN_SAMP.            equ       7
  709  M             0080                 CAN_SAMP_            equ       1<CAN_SAMP.
  709  M                                            #endif
  709  M                                            #if :temp > 7
  709  M                                            #endif
  709                                                         endm
  710                                     
  711                1884                 CANRFLG             equ       CAN_BASE+$04,1      ;MSCAN Receiver Flag Register
  712                                     
  713  M                                  CAN_RXF             @pin      CANRFLG,0           ;Receive Buffer Full
  713  M                                            #ifb CANRFLG,0
  713  M                                            #endif
  713  M                                            #ifb CAN_RXF
  713  M                                            #else ifnb CANRFLG,0
  713  M                                                      mreq      1:PORT[,BitNumber]
  713  M                                                      mdef      2,0
  713  M                                                      mset      0,CAN_RXF
  713  M                                                      #temp     0
  713  M             1884                 CAN_RXF             set       CANRFLG
  713  M             0000                 CAN_RXF.            equ       0
  713  M             0001                 CAN_RXF_            equ       1<CAN_RXF.
  713  M                                            #endif
  713  M                                            #if :temp > 7
  713  M                                            #endif
  713                                                         endm
  714  M                                  CAN_OVRIF           @pin      CANRFLG,1           ;Overrun Interrupt Flag
  714  M                                            #ifb CANRFLG,1
  714  M                                            #endif
  714  M                                            #ifb CAN_OVRIF
  714  M                                            #else ifnb CANRFLG,1
  714  M                                                      mreq      1:PORT[,BitNumber]
  714  M                                                      mdef      2,0
  714  M                                                      mset      0,CAN_OVRIF
  714  M                                                      #temp     1
  714  M             1884                 CAN_OVRIF             set       CANRFLG
  714  M             0001                 CAN_OVRIF.            equ       1
  714  M             0002                 CAN_OVRIF_            equ       1<CAN_OVRIF.
  714  M                                            #endif
  714  M                                            #if :temp > 7
  714  M                                            #endif
  714                                                         endm
  715  M                                  CAN_TSTAT0          @pin      CANRFLG,2           ;Transmitter Status Bit 0
  715  M                                            #ifb CANRFLG,2
  715  M                                            #endif
  715  M                                            #ifb CAN_TSTAT0
  715  M                                            #else ifnb CANRFLG,2
  715  M                                                      mreq      1:PORT[,BitNumber]
  715  M                                                      mdef      2,0
  715  M                                                      mset      0,CAN_TSTAT0
  715  M                                                      #temp     2
  715  M             1884                 CAN_TSTAT0             set       CANRFLG
  715  M             0002                 CAN_TSTAT0.            equ       2
  715  M             0004                 CAN_TSTAT0_            equ       1<CAN_TSTAT0.
  715  M                                            #endif
  715  M                                            #if :temp > 7
  715  M                                            #endif
  715                                                         endm
  716  M                                  CAN_TSTAT1          @pin      CANRFLG,3           ;Transmitter Status Bit 1
  716  M                                            #ifb CANRFLG,3
  716  M                                            #endif
  716  M                                            #ifb CAN_TSTAT1
  716  M                                            #else ifnb CANRFLG,3
  716  M                                                      mreq      1:PORT[,BitNumber]
  716  M                                                      mdef      2,0
  716  M                                                      mset      0,CAN_TSTAT1
  716  M                                                      #temp     3
  716  M             1884                 CAN_TSTAT1             set       CANRFLG
  716  M             0003                 CAN_TSTAT1.            equ       3
  716  M             0008                 CAN_TSTAT1_            equ       1<CAN_TSTAT1.
  716  M                                            #endif
  716  M                                            #if :temp > 7
  716  M                                            #endif
  716                                                         endm
  717  M                                  CAN_RSTAT0          @pin      CANRFLG,4           ;Receiver Status Bit 0
  717  M                                            #ifb CANRFLG,4
  717  M                                            #endif
  717  M                                            #ifb CAN_RSTAT0
  717  M                                            #else ifnb CANRFLG,4
  717  M                                                      mreq      1:PORT[,BitNumber]
  717  M                                                      mdef      2,0
  717  M                                                      mset      0,CAN_RSTAT0
  717  M                                                      #temp     4
  717  M             1884                 CAN_RSTAT0             set       CANRFLG
  717  M             0004                 CAN_RSTAT0.            equ       4
  717  M             0010                 CAN_RSTAT0_            equ       1<CAN_RSTAT0.
  717  M                                            #endif
  717  M                                            #if :temp > 7
  717  M                                            #endif
  717                                                         endm
  718  M                                  CAN_RSTAT1          @pin      CANRFLG,5           ;Receiver Status Bit 1
  718  M                                            #ifb CANRFLG,5
  718  M                                            #endif
  718  M                                            #ifb CAN_RSTAT1
  718  M                                            #else ifnb CANRFLG,5
  718  M                                                      mreq      1:PORT[,BitNumber]
  718  M                                                      mdef      2,0
  718  M                                                      mset      0,CAN_RSTAT1
  718  M                                                      #temp     5
  718  M             1884                 CAN_RSTAT1             set       CANRFLG
  718  M             0005                 CAN_RSTAT1.            equ       5
  718  M             0020                 CAN_RSTAT1_            equ       1<CAN_RSTAT1.
  718  M                                            #endif
  718  M                                            #if :temp > 7
  718  M                                            #endif
  718                                                         endm
  719  M                                  CAN_CSCIF           @pin      CANRFLG,6           ;CAN Status Change Interrupt Flag
  719  M                                            #ifb CANRFLG,6
  719  M                                            #endif
  719  M                                            #ifb CAN_CSCIF
  719  M                                            #else ifnb CANRFLG,6
  719  M                                                      mreq      1:PORT[,BitNumber]
  719  M                                                      mdef      2,0
  719  M                                                      mset      0,CAN_CSCIF
  719  M                                                      #temp     6
  719  M             1884                 CAN_CSCIF             set       CANRFLG
  719  M             0006                 CAN_CSCIF.            equ       6
  719  M             0040                 CAN_CSCIF_            equ       1<CAN_CSCIF.
  719  M                                            #endif
  719  M                                            #if :temp > 7
  719  M                                            #endif
  719                                                         endm
  720  M                                  CAN_WUPIF           @pin      CANRFLG,7           ;Wake-up Interrupt Flag
  720  M                                            #ifb CANRFLG,7
  720  M                                            #endif
  720  M                                            #ifb CAN_WUPIF
  720  M                                            #else ifnb CANRFLG,7
  720  M                                                      mreq      1:PORT[,BitNumber]
  720  M                                                      mdef      2,0
  720  M                                                      mset      0,CAN_WUPIF
  720  M                                                      #temp     7
  720  M             1884                 CAN_WUPIF             set       CANRFLG
  720  M             0007                 CAN_WUPIF.            equ       7
  720  M             0080                 CAN_WUPIF_            equ       1<CAN_WUPIF.
  720  M                                            #endif
  720  M                                            #if :temp > 7
  720  M                                            #endif
  720                                                         endm
  721                                     
  722                1885                 CANRIER             equ       CAN_BASE+$05,1      ;MSCAN Receiver Interrupt Enable Register
  723                                     
  724  M                                  CAN_RXFIE           @pin      CANRIER,0           ;Receiver Full Interrupt Enable
  724  M                                            #ifb CANRIER,0
  724  M                                            #endif
  724  M                                            #ifb CAN_RXFIE
  724  M                                            #else ifnb CANRIER,0
  724  M                                                      mreq      1:PORT[,BitNumber]
  724  M                                                      mdef      2,0
  724  M                                                      mset      0,CAN_RXFIE
  724  M                                                      #temp     0
  724  M             1885                 CAN_RXFIE             set       CANRIER
  724  M             0000                 CAN_RXFIE.            equ       0
  724  M             0001                 CAN_RXFIE_            equ       1<CAN_RXFIE.
  724  M                                            #endif
  724  M                                            #if :temp > 7
  724  M                                            #endif
  724                                                         endm
  725  M                                  CAN_OVRIE           @pin      CANRIER,1           ;Overrun Interrupt Enable
  725  M                                            #ifb CANRIER,1
  725  M                                            #endif
  725  M                                            #ifb CAN_OVRIE
  725  M                                            #else ifnb CANRIER,1
  725  M                                                      mreq      1:PORT[,BitNumber]
  725  M                                                      mdef      2,0
  725  M                                                      mset      0,CAN_OVRIE
  725  M                                                      #temp     1
  725  M             1885                 CAN_OVRIE             set       CANRIER
  725  M             0001                 CAN_OVRIE.            equ       1
  725  M             0002                 CAN_OVRIE_            equ       1<CAN_OVRIE.
  725  M                                            #endif
  725  M                                            #if :temp > 7
  725  M                                            #endif
  725                                                         endm
  726  M                                  CAN_TSTATE0         @pin      CANRIER,2           ;Transmitter Status Change Enable 0
  726  M                                            #ifb CANRIER,2
  726  M                                            #endif
  726  M                                            #ifb CAN_TSTATE0
  726  M                                            #else ifnb CANRIER,2
  726  M                                                      mreq      1:PORT[,BitNumber]
  726  M                                                      mdef      2,0
  726  M                                                      mset      0,CAN_TSTATE0
  726  M                                                      #temp     2
  726  M             1885                 CAN_TSTATE0             set       CANRIER
  726  M             0002                 CAN_TSTATE0.            equ       2
  726  M             0004                 CAN_TSTATE0_            equ       1<CAN_TSTATE0.
  726  M                                            #endif
  726  M                                            #if :temp > 7
  726  M                                            #endif
  726                                                         endm
  727  M                                  CAN_TSTATE1         @pin      CANRIER,3           ;Transmitter Status Change Enable 1
  727  M                                            #ifb CANRIER,3
  727  M                                            #endif
  727  M                                            #ifb CAN_TSTATE1
  727  M                                            #else ifnb CANRIER,3
  727  M                                                      mreq      1:PORT[,BitNumber]
  727  M                                                      mdef      2,0
  727  M                                                      mset      0,CAN_TSTATE1
  727  M                                                      #temp     3
  727  M             1885                 CAN_TSTATE1             set       CANRIER
  727  M             0003                 CAN_TSTATE1.            equ       3
  727  M             0008                 CAN_TSTATE1_            equ       1<CAN_TSTATE1.
  727  M                                            #endif
  727  M                                            #if :temp > 7
  727  M                                            #endif
  727                                                         endm
  728  M                                  CAN_RSTATE0         @pin      CANRIER,4           ;Receiver Status Change Enable 0
  728  M                                            #ifb CANRIER,4
  728  M                                            #endif
  728  M                                            #ifb CAN_RSTATE0
  728  M                                            #else ifnb CANRIER,4
  728  M                                                      mreq      1:PORT[,BitNumber]
  728  M                                                      mdef      2,0
  728  M                                                      mset      0,CAN_RSTATE0
  728  M                                                      #temp     4
  728  M             1885                 CAN_RSTATE0             set       CANRIER
  728  M             0004                 CAN_RSTATE0.            equ       4
  728  M             0010                 CAN_RSTATE0_            equ       1<CAN_RSTATE0.
  728  M                                            #endif
  728  M                                            #if :temp > 7
  728  M                                            #endif
  728                                                         endm
  729  M                                  CAN_RSTATE1         @pin      CANRIER,5           ;Receiver Status Change Enable 1
  729  M                                            #ifb CANRIER,5
  729  M                                            #endif
  729  M                                            #ifb CAN_RSTATE1
  729  M                                            #else ifnb CANRIER,5
  729  M                                                      mreq      1:PORT[,BitNumber]
  729  M                                                      mdef      2,0
  729  M                                                      mset      0,CAN_RSTATE1
  729  M                                                      #temp     5
  729  M             1885                 CAN_RSTATE1             set       CANRIER
  729  M             0005                 CAN_RSTATE1.            equ       5
  729  M             0020                 CAN_RSTATE1_            equ       1<CAN_RSTATE1.
  729  M                                            #endif
  729  M                                            #if :temp > 7
  729  M                                            #endif
  729                                                         endm
  730  M                                  CAN_CSCIE           @pin      CANRIER,6           ;CAN Status Change Interrupt Enable
  730  M                                            #ifb CANRIER,6
  730  M                                            #endif
  730  M                                            #ifb CAN_CSCIE
  730  M                                            #else ifnb CANRIER,6
  730  M                                                      mreq      1:PORT[,BitNumber]
  730  M                                                      mdef      2,0
  730  M                                                      mset      0,CAN_CSCIE
  730  M                                                      #temp     6
  730  M             1885                 CAN_CSCIE             set       CANRIER
  730  M             0006                 CAN_CSCIE.            equ       6
  730  M             0040                 CAN_CSCIE_            equ       1<CAN_CSCIE.
  730  M                                            #endif
  730  M                                            #if :temp > 7
  730  M                                            #endif
  730                                                         endm
  731  M                                  CAN_WUPIE           @pin      CANRIER,7           ;Wake-up Interrupt Enable
  731  M                                            #ifb CANRIER,7
  731  M                                            #endif
  731  M                                            #ifb CAN_WUPIE
  731  M                                            #else ifnb CANRIER,7
  731  M                                                      mreq      1:PORT[,BitNumber]
  731  M                                                      mdef      2,0
  731  M                                                      mset      0,CAN_WUPIE
  731  M                                                      #temp     7
  731  M             1885                 CAN_WUPIE             set       CANRIER
  731  M             0007                 CAN_WUPIE.            equ       7
  731  M             0080                 CAN_WUPIE_            equ       1<CAN_WUPIE.
  731  M                                            #endif
  731  M                                            #if :temp > 7
  731  M                                            #endif
  731                                                         endm
  732                                     
  733                1886                 CANTFLG             equ       CAN_BASE+$06,1      ;MSCAN Transmitter Flag Register
  734                                     
  735  M                                  CAN_TXE0            @pin      CANTFLG,0           ;Transmitter Buffer Empty 0
  735  M                                            #ifb CANTFLG,0
  735  M                                            #endif
  735  M                                            #ifb CAN_TXE0
  735  M                                            #else ifnb CANTFLG,0
  735  M                                                      mreq      1:PORT[,BitNumber]
  735  M                                                      mdef      2,0
  735  M                                                      mset      0,CAN_TXE0
  735  M                                                      #temp     0
  735  M             1886                 CAN_TXE0             set       CANTFLG
  735  M             0000                 CAN_TXE0.            equ       0
  735  M             0001                 CAN_TXE0_            equ       1<CAN_TXE0.
  735  M                                            #endif
  735  M                                            #if :temp > 7
  735  M                                            #endif
  735                                                         endm
  736  M                                  CAN_TXE1            @pin      CANTFLG,1           ;Transmitter Buffer Empty 1
  736  M                                            #ifb CANTFLG,1
  736  M                                            #endif
  736  M                                            #ifb CAN_TXE1
  736  M                                            #else ifnb CANTFLG,1
  736  M                                                      mreq      1:PORT[,BitNumber]
  736  M                                                      mdef      2,0
  736  M                                                      mset      0,CAN_TXE1
  736  M                                                      #temp     1
  736  M             1886                 CAN_TXE1             set       CANTFLG
  736  M             0001                 CAN_TXE1.            equ       1
  736  M             0002                 CAN_TXE1_            equ       1<CAN_TXE1.
  736  M                                            #endif
  736  M                                            #if :temp > 7
  736  M                                            #endif
  736                                                         endm
  737  M                                  CAN_TXE2            @pin      CANTFLG,2           ;Transmitter Buffer Empty 2
  737  M                                            #ifb CANTFLG,2
  737  M                                            #endif
  737  M                                            #ifb CAN_TXE2
  737  M                                            #else ifnb CANTFLG,2
  737  M                                                      mreq      1:PORT[,BitNumber]
  737  M                                                      mdef      2,0
  737  M                                                      mset      0,CAN_TXE2
  737  M                                                      #temp     2
  737  M             1886                 CAN_TXE2             set       CANTFLG
  737  M             0002                 CAN_TXE2.            equ       2
  737  M             0004                 CAN_TXE2_            equ       1<CAN_TXE2.
  737  M                                            #endif
  737  M                                            #if :temp > 7
  737  M                                            #endif
  737                                                         endm
  738                                     
  739                1887                 CANTIER             equ       CAN_BASE+$07,1      ;MSCAN Transmitter Interrupt Enable Register
  740                                     
  741  M                                  CAN_TXEIE0          @pin      CANTIER,0           ;Transmitter Empty Interrupt Enable 0
  741  M                                            #ifb CANTIER,0
  741  M                                            #endif
  741  M                                            #ifb CAN_TXEIE0
  741  M                                            #else ifnb CANTIER,0
  741  M                                                      mreq      1:PORT[,BitNumber]
  741  M                                                      mdef      2,0
  741  M                                                      mset      0,CAN_TXEIE0
  741  M                                                      #temp     0
  741  M             1887                 CAN_TXEIE0             set       CANTIER
  741  M             0000                 CAN_TXEIE0.            equ       0
  741  M             0001                 CAN_TXEIE0_            equ       1<CAN_TXEIE0.
  741  M                                            #endif
  741  M                                            #if :temp > 7
  741  M                                            #endif
  741                                                         endm
  742  M                                  CAN_TXEIE1          @pin      CANTIER,1           ;Transmitter Empty Interrupt Enable 1
  742  M                                            #ifb CANTIER,1
  742  M                                            #endif
  742  M                                            #ifb CAN_TXEIE1
  742  M                                            #else ifnb CANTIER,1
  742  M                                                      mreq      1:PORT[,BitNumber]
  742  M                                                      mdef      2,0
  742  M                                                      mset      0,CAN_TXEIE1
  742  M                                                      #temp     1
  742  M             1887                 CAN_TXEIE1             set       CANTIER
  742  M             0001                 CAN_TXEIE1.            equ       1
  742  M             0002                 CAN_TXEIE1_            equ       1<CAN_TXEIE1.
  742  M                                            #endif
  742  M                                            #if :temp > 7
  742  M                                            #endif
  742                                                         endm
  743  M                                  CAN_TXEIE2          @pin      CANTIER,2           ;Transmitter Empty Interrupt Enable 2
  743  M                                            #ifb CANTIER,2
  743  M                                            #endif
  743  M                                            #ifb CAN_TXEIE2
  743  M                                            #else ifnb CANTIER,2
  743  M                                                      mreq      1:PORT[,BitNumber]
  743  M                                                      mdef      2,0
  743  M                                                      mset      0,CAN_TXEIE2
  743  M                                                      #temp     2
  743  M             1887                 CAN_TXEIE2             set       CANTIER
  743  M             0002                 CAN_TXEIE2.            equ       2
  743  M             0004                 CAN_TXEIE2_            equ       1<CAN_TXEIE2.
  743  M                                            #endif
  743  M                                            #if :temp > 7
  743  M                                            #endif
  743                                                         endm
  744                                     
  745                1888                 CANTARQ             equ       CAN_BASE+$08,1      ;MSCAN Transmitter Message Abort Request
  746                                     
  747  M                                  CAN_ABTRQ0          @pin      CANTARQ,0           ;Abort Request 0
  747  M                                            #ifb CANTARQ,0
  747  M                                            #endif
  747  M                                            #ifb CAN_ABTRQ0
  747  M                                            #else ifnb CANTARQ,0
  747  M                                                      mreq      1:PORT[,BitNumber]
  747  M                                                      mdef      2,0
  747  M                                                      mset      0,CAN_ABTRQ0
  747  M                                                      #temp     0
  747  M             1888                 CAN_ABTRQ0             set       CANTARQ
  747  M             0000                 CAN_ABTRQ0.            equ       0
  747  M             0001                 CAN_ABTRQ0_            equ       1<CAN_ABTRQ0.
  747  M                                            #endif
  747  M                                            #if :temp > 7
  747  M                                            #endif
  747                                                         endm
  748  M                                  CAN_ABTRQ1          @pin      CANTARQ,1           ;Abort Request 1
  748  M                                            #ifb CANTARQ,1
  748  M                                            #endif
  748  M                                            #ifb CAN_ABTRQ1
  748  M                                            #else ifnb CANTARQ,1
  748  M                                                      mreq      1:PORT[,BitNumber]
  748  M                                                      mdef      2,0
  748  M                                                      mset      0,CAN_ABTRQ1
  748  M                                                      #temp     1
  748  M             1888                 CAN_ABTRQ1             set       CANTARQ
  748  M             0001                 CAN_ABTRQ1.            equ       1
  748  M             0002                 CAN_ABTRQ1_            equ       1<CAN_ABTRQ1.
  748  M                                            #endif
  748  M                                            #if :temp > 7
  748  M                                            #endif
  748                                                         endm
  749  M                                  CAN_ABTRQ2          @pin      CANTARQ,2           ;Abort Request 2
  749  M                                            #ifb CANTARQ,2
  749  M                                            #endif
  749  M                                            #ifb CAN_ABTRQ2
  749  M                                            #else ifnb CANTARQ,2
  749  M                                                      mreq      1:PORT[,BitNumber]
  749  M                                                      mdef      2,0
  749  M                                                      mset      0,CAN_ABTRQ2
  749  M                                                      #temp     2
  749  M             1888                 CAN_ABTRQ2             set       CANTARQ
  749  M             0002                 CAN_ABTRQ2.            equ       2
  749  M             0004                 CAN_ABTRQ2_            equ       1<CAN_ABTRQ2.
  749  M                                            #endif
  749  M                                            #if :temp > 7
  749  M                                            #endif
  749                                                         endm
  750                                     
  751                1889                 CANTAAK             equ       CAN_BASE+$09,1      ;MSCAN Transmitter Message Abort Control
  752                                     
  753  M                                  CAN_ABTAK0          @pin      CANTAAK,0           ;Abort Acknowledge 0
  753  M                                            #ifb CANTAAK,0
  753  M                                            #endif
  753  M                                            #ifb CAN_ABTAK0
  753  M                                            #else ifnb CANTAAK,0
  753  M                                                      mreq      1:PORT[,BitNumber]
  753  M                                                      mdef      2,0
  753  M                                                      mset      0,CAN_ABTAK0
  753  M                                                      #temp     0
  753  M             1889                 CAN_ABTAK0             set       CANTAAK
  753  M             0000                 CAN_ABTAK0.            equ       0
  753  M             0001                 CAN_ABTAK0_            equ       1<CAN_ABTAK0.
  753  M                                            #endif
  753  M                                            #if :temp > 7
  753  M                                            #endif
  753                                                         endm
  754  M                                  CAN_ABTAK1          @pin      CANTAAK,1           ;Abort Acknowledge 1
  754  M                                            #ifb CANTAAK,1
  754  M                                            #endif
  754  M                                            #ifb CAN_ABTAK1
  754  M                                            #else ifnb CANTAAK,1
  754  M                                                      mreq      1:PORT[,BitNumber]
  754  M                                                      mdef      2,0
  754  M                                                      mset      0,CAN_ABTAK1
  754  M                                                      #temp     1
  754  M             1889                 CAN_ABTAK1             set       CANTAAK
  754  M             0001                 CAN_ABTAK1.            equ       1
  754  M             0002                 CAN_ABTAK1_            equ       1<CAN_ABTAK1.
  754  M                                            #endif
  754  M                                            #if :temp > 7
  754  M                                            #endif
  754                                                         endm
  755  M                                  CAN_ABTAK2          @pin      CANTAAK,2           ;Abort Acknowledge 2
  755  M                                            #ifb CANTAAK,2
  755  M                                            #endif
  755  M                                            #ifb CAN_ABTAK2
  755  M                                            #else ifnb CANTAAK,2
  755  M                                                      mreq      1:PORT[,BitNumber]
  755  M                                                      mdef      2,0
  755  M                                                      mset      0,CAN_ABTAK2
  755  M                                                      #temp     2
  755  M             1889                 CAN_ABTAK2             set       CANTAAK
  755  M             0002                 CAN_ABTAK2.            equ       2
  755  M             0004                 CAN_ABTAK2_            equ       1<CAN_ABTAK2.
  755  M                                            #endif
  755  M                                            #if :temp > 7
  755  M                                            #endif
  755                                                         endm
  756                                     
  757                188A                 CANTBSEL            equ       CAN_BASE+$0A,1      ;MSCAN Transmit Buffer Selection
  758                                     
  759  M                                  CAN_TX0             @pin      CANTBSEL,0          ;Transmit Buffer Select 0
  759  M                                            #ifb CANTBSEL,0
  759  M                                            #endif
  759  M                                            #ifb CAN_TX0
  759  M                                            #else ifnb CANTBSEL,0
  759  M                                                      mreq      1:PORT[,BitNumber]
  759  M                                                      mdef      2,0
  759  M                                                      mset      0,CAN_TX0
  759  M                                                      #temp     0
  759  M             188A                 CAN_TX0             set       CANTBSEL
  759  M             0000                 CAN_TX0.            equ       0
  759  M             0001                 CAN_TX0_            equ       1<CAN_TX0.
  759  M                                            #endif
  759  M                                            #if :temp > 7
  759  M                                            #endif
  759                                                         endm
  760  M                                  CAN_TX1             @pin      CANTBSEL,1          ;Transmit Buffer Select 1
  760  M                                            #ifb CANTBSEL,1
  760  M                                            #endif
  760  M                                            #ifb CAN_TX1
  760  M                                            #else ifnb CANTBSEL,1
  760  M                                                      mreq      1:PORT[,BitNumber]
  760  M                                                      mdef      2,0
  760  M                                                      mset      0,CAN_TX1
  760  M                                                      #temp     1
  760  M             188A                 CAN_TX1             set       CANTBSEL
  760  M             0001                 CAN_TX1.            equ       1
  760  M             0002                 CAN_TX1_            equ       1<CAN_TX1.
  760  M                                            #endif
  760  M                                            #if :temp > 7
  760  M                                            #endif
  760                                                         endm
  761  M                                  CAN_TX2             @pin      CANTBSEL,2          ;Transmit Buffer Select 2
  761  M                                            #ifb CANTBSEL,2
  761  M                                            #endif
  761  M                                            #ifb CAN_TX2
  761  M                                            #else ifnb CANTBSEL,2
  761  M                                                      mreq      1:PORT[,BitNumber]
  761  M                                                      mdef      2,0
  761  M                                                      mset      0,CAN_TX2
  761  M                                                      #temp     2
  761  M             188A                 CAN_TX2             set       CANTBSEL
  761  M             0002                 CAN_TX2.            equ       2
  761  M             0004                 CAN_TX2_            equ       1<CAN_TX2.
  761  M                                            #endif
  761  M                                            #if :temp > 7
  761  M                                            #endif
  761                                                         endm
  762                                     
  763                188B                 CANIDAC             equ       CAN_BASE+$0B,1      ;MSCAN Identifier Acceptance Control Register
  764                                     
  765  M                                  CAN_IDHIT0          @pin      CANIDAC,0           ;Identifier Acceptance Hit Indicator 0
  765  M                                            #ifb CANIDAC,0
  765  M                                            #endif
  765  M                                            #ifb CAN_IDHIT0
  765  M                                            #else ifnb CANIDAC,0
  765  M                                                      mreq      1:PORT[,BitNumber]
  765  M                                                      mdef      2,0
  765  M                                                      mset      0,CAN_IDHIT0
  765  M                                                      #temp     0
  765  M             188B                 CAN_IDHIT0             set       CANIDAC
  765  M             0000                 CAN_IDHIT0.            equ       0
  765  M             0001                 CAN_IDHIT0_            equ       1<CAN_IDHIT0.
  765  M                                            #endif
  765  M                                            #if :temp > 7
  765  M                                            #endif
  765                                                         endm
  766  M                                  CAN_IDHIT1          @pin      CANIDAC,1           ;Identifier Acceptance Hit Indicator 1
  766  M                                            #ifb CANIDAC,1
  766  M                                            #endif
  766  M                                            #ifb CAN_IDHIT1
  766  M                                            #else ifnb CANIDAC,1
  766  M                                                      mreq      1:PORT[,BitNumber]
  766  M                                                      mdef      2,0
  766  M                                                      mset      0,CAN_IDHIT1
  766  M                                                      #temp     1
  766  M             188B                 CAN_IDHIT1             set       CANIDAC
  766  M             0001                 CAN_IDHIT1.            equ       1
  766  M             0002                 CAN_IDHIT1_            equ       1<CAN_IDHIT1.
  766  M                                            #endif
  766  M                                            #if :temp > 7
  766  M                                            #endif
  766                                                         endm
  767  M                                  CAN_IDHIT2          @pin      CANIDAC,2           ;Identifier Acceptance Hit Indicator 2
  767  M                                            #ifb CANIDAC,2
  767  M                                            #endif
  767  M                                            #ifb CAN_IDHIT2
  767  M                                            #else ifnb CANIDAC,2
  767  M                                                      mreq      1:PORT[,BitNumber]
  767  M                                                      mdef      2,0
  767  M                                                      mset      0,CAN_IDHIT2
  767  M                                                      #temp     2
  767  M             188B                 CAN_IDHIT2             set       CANIDAC
  767  M             0002                 CAN_IDHIT2.            equ       2
  767  M             0004                 CAN_IDHIT2_            equ       1<CAN_IDHIT2.
  767  M                                            #endif
  767  M                                            #if :temp > 7
  767  M                                            #endif
  767                                                         endm
  768  M                                  CAN_IDAM0           @pin      CANIDAC,4           ;Identifier Acceptance Mode 0
  768  M                                            #ifb CANIDAC,4
  768  M                                            #endif
  768  M                                            #ifb CAN_IDAM0
  768  M                                            #else ifnb CANIDAC,4
  768  M                                                      mreq      1:PORT[,BitNumber]
  768  M                                                      mdef      2,0
  768  M                                                      mset      0,CAN_IDAM0
  768  M                                                      #temp     4
  768  M             188B                 CAN_IDAM0             set       CANIDAC
  768  M             0004                 CAN_IDAM0.            equ       4
  768  M             0010                 CAN_IDAM0_            equ       1<CAN_IDAM0.
  768  M                                            #endif
  768  M                                            #if :temp > 7
  768  M                                            #endif
  768                                                         endm
  769  M                                  CAN_IDAM1           @pin      CANIDAC,5           ;Identifier Acceptance Mode 1
  769  M                                            #ifb CANIDAC,5
  769  M                                            #endif
  769  M                                            #ifb CAN_IDAM1
  769  M                                            #else ifnb CANIDAC,5
  769  M                                                      mreq      1:PORT[,BitNumber]
  769  M                                                      mdef      2,0
  769  M                                                      mset      0,CAN_IDAM1
  769  M                                                      #temp     5
  769  M             188B                 CAN_IDAM1             set       CANIDAC
  769  M             0005                 CAN_IDAM1.            equ       5
  769  M             0020                 CAN_IDAM1_            equ       1<CAN_IDAM1.
  769  M                                            #endif
  769  M                                            #if :temp > 7
  769  M                                            #endif
  769                                                         endm
  770                                     
  771                188D                 CANMISC             equ       CAN_BASE+$0D,1      ;MSCAN Miscellaneous Register
  772                                     
  773  M                                  CAN_BOHOLD          @pin      CANMISC,0           ;Bus-off State Hold Until User Request - If BORM is set
  773  M                                            #ifb CANMISC,0
  773  M                                            #endif
  773  M                                            #ifb CAN_BOHOLD
  773  M                                            #else ifnb CANMISC,0
  773  M                                                      mreq      1:PORT[,BitNumber]
  773  M                                                      mdef      2,0
  773  M                                                      mset      0,CAN_BOHOLD
  773  M                                                      #temp     0
  773  M             188D                 CAN_BOHOLD             set       CANMISC
  773  M             0000                 CAN_BOHOLD.            equ       0
  773  M             0001                 CAN_BOHOLD_            equ       1<CAN_BOHOLD.
  773  M                                            #endif
  773  M                                            #if :temp > 7
  773  M                                            #endif
  773                                                         endm
  774                                     
  775                188E                 CANRXERR            equ       CAN_BASE+$0E,1      ;MSCAN Receive Error Counter Register
  776                188F                 CANTXERR            equ       CAN_BASE+$0F,1      ;MSCAN Transmit Error Counter Register
  777                                     
  778                1890                 CANIDAR0            equ       CAN_BASE+$10,1      ;MSCAN Identifier Acceptance Register 0
  779                1891                 CANIDAR1            equ       CAN_BASE+$11,1      ;MSCAN Identifier Acceptance Register 1
  780                1892                 CANIDAR2            equ       CAN_BASE+$12,1      ;MSCAN Identifier Acceptance Register 2
  781                1893                 CANIDAR3            equ       CAN_BASE+$13,1      ;MSCAN Identifier Acceptance Register 3
  782                                     
  783                1894                 CANIDMR0            equ       CAN_BASE+$14,1      ;MSCAN Identifier Mask Register 0
  784                1895                 CANIDMR1            equ       CAN_BASE+$15,1      ;MSCAN Identifier Mask Register 1
  785                1896                 CANIDMR2            equ       CAN_BASE+$16,1      ;MSCAN Identifier Mask Register 2
  786                1897                 CANIDMR3            equ       CAN_BASE+$17,1      ;MSCAN Identifier Mask Register 3
  787                                     
  788                1898                 CANIDAR4            equ       CAN_BASE+$18,1      ;MSCAN Identifier Acceptance Register 4
  789                1899                 CANIDAR5            equ       CAN_BASE+$19,1      ;MSCAN Identifier Acceptance Register 5
  790                189A                 CANIDAR6            equ       CAN_BASE+$1A,1      ;MSCAN Identifier Acceptance Register 6
  791                189B                 CANIDAR7            equ       CAN_BASE+$1B,1      ;MSCAN Identifier Acceptance Register 7
  792                                     
  793                189C                 CANIDMR4            equ       CAN_BASE+$1C,1      ;MSCAN Identifier Mask Register 4
  794                189D                 CANIDMR5            equ       CAN_BASE+$1D,1      ;MSCAN Identifier Mask Register 5
  795                189E                 CANIDMR6            equ       CAN_BASE+$1E,1      ;MSCAN Identifier Mask Register 6
  796                189F                 CANIDMR7            equ       CAN_BASE+$1F,1      ;MSCAN Identifier Mask Register 7
  797                                     
  798                18A0                 CANRIDR0            equ       CAN_BASE+$20,1      ;MSCAN 0 Receive Identifier Register 0
  799                18A1                 CANRIDR1            equ       CAN_BASE+$21,1      ;MSCAN 0 Receive Identifier Register 1
  800                                     
  801  M                                  CANR_IDE            @pin      CANRIDR1,3          ;ID Extended
  801  M                                            #ifb CANRIDR1,3
  801  M                                            #endif
  801  M                                            #ifb CANR_IDE
  801  M                                            #else ifnb CANRIDR1,3
  801  M                                                      mreq      1:PORT[,BitNumber]
  801  M                                                      mdef      2,0
  801  M                                                      mset      0,CANR_IDE
  801  M                                                      #temp     3
  801  M             18A1                 CANR_IDE             set       CANRIDR1
  801  M             0003                 CANR_IDE.            equ       3
  801  M             0008                 CANR_IDE_            equ       1<CANR_IDE.
  801  M                                            #endif
  801  M                                            #if :temp > 7
  801  M                                            #endif
  801                                                         endm
  802  M                                  CANR_SRR            @pin      CANRIDR1,4          ;Substitute Remote Request
  802  M                                            #ifb CANRIDR1,4
  802  M                                            #endif
  802  M                                            #ifb CANR_SRR
  802  M                                            #else ifnb CANRIDR1,4
  802  M                                                      mreq      1:PORT[,BitNumber]
  802  M                                                      mdef      2,0
  802  M                                                      mset      0,CANR_SRR
  802  M                                                      #temp     4
  802  M             18A1                 CANR_SRR             set       CANRIDR1
  802  M             0004                 CANR_SRR.            equ       4
  802  M             0010                 CANR_SRR_            equ       1<CANR_SRR.
  802  M                                            #endif
  802  M                                            #if :temp > 7
  802  M                                            #endif
  802                                                         endm
  803                                     
  804                18A2                 CANRIDR2            equ       CAN_BASE+$22,1      ;MSCAN 0 Receive Identifier Register 2
  805                18A3                 CANRIDR3            equ       CAN_BASE+$23,1      ;MSCAN 0 Receive Identifier Register 3
  806                                     
  807  M                                  CANR_RTR            @pin      CANRIDR3,0          ;Remote Transmission Request
  807  M                                            #ifb CANRIDR3,0
  807  M                                            #endif
  807  M                                            #ifb CANR_RTR
  807  M                                            #else ifnb CANRIDR3,0
  807  M                                                      mreq      1:PORT[,BitNumber]
  807  M                                                      mdef      2,0
  807  M                                                      mset      0,CANR_RTR
  807  M                                                      #temp     0
  807  M             18A3                 CANR_RTR             set       CANRIDR3
  807  M             0000                 CANR_RTR.            equ       0
  807  M             0001                 CANR_RTR_            equ       1<CANR_RTR.
  807  M                                            #endif
  807  M                                            #if :temp > 7
  807  M                                            #endif
  807                                                         endm
  808                                     
  809                18A4                 CANRDSR             equ       CAN_BASE+$24,8      ;MSCAN Receive Data Segment Registers
  810                18A4                 CANRDSR0            equ       CAN_BASE+$24,1      ;MSCAN Receive Data Segment Register 0
  811                18A5                 CANRDSR1            equ       CAN_BASE+$25,1      ;MSCAN Receive Data Segment Register 1
  812                18A6                 CANRDSR2            equ       CAN_BASE+$26,1      ;MSCAN Receive Data Segment Register 2
  813                18A7                 CANRDSR3            equ       CAN_BASE+$27,1      ;MSCAN Receive Data Segment Register 3
  814                18A8                 CANRDSR4            equ       CAN_BASE+$28,1      ;MSCAN Receive Data Segment Register 4
  815                18A9                 CANRDSR5            equ       CAN_BASE+$29,1      ;MSCAN Receive Data Segment Register 5
  816                18AA                 CANRDSR6            equ       CAN_BASE+$2A,1      ;MSCAN Receive Data Segment Register 6
  817                18AB                 CANRDSR7            equ       CAN_BASE+$2B,1      ;MSCAN Receive Data Segment Register 7
  818                                     
  819                18AC                 CANRDLR             equ       CAN_BASE+$2C,1      ;MSCAN Receive Data Length Register
  820                                     
  821  M                                  CANR_DLC0           @pin      CANRDLR,0           ;Data Length Code Bit 0
  821  M                                            #ifb CANRDLR,0
  821  M                                            #endif
  821  M                                            #ifb CANR_DLC0
  821  M                                            #else ifnb CANRDLR,0
  821  M                                                      mreq      1:PORT[,BitNumber]
  821  M                                                      mdef      2,0
  821  M                                                      mset      0,CANR_DLC0
  821  M                                                      #temp     0
  821  M             18AC                 CANR_DLC0             set       CANRDLR
  821  M             0000                 CANR_DLC0.            equ       0
  821  M             0001                 CANR_DLC0_            equ       1<CANR_DLC0.
  821  M                                            #endif
  821  M                                            #if :temp > 7
  821  M                                            #endif
  821                                                         endm
  822  M                                  CANR_DLC1           @pin      CANRDLR,1           ;Data Length Code Bit 1
  822  M                                            #ifb CANRDLR,1
  822  M                                            #endif
  822  M                                            #ifb CANR_DLC1
  822  M                                            #else ifnb CANRDLR,1
  822  M                                                      mreq      1:PORT[,BitNumber]
  822  M                                                      mdef      2,0
  822  M                                                      mset      0,CANR_DLC1
  822  M                                                      #temp     1
  822  M             18AC                 CANR_DLC1             set       CANRDLR
  822  M             0001                 CANR_DLC1.            equ       1
  822  M             0002                 CANR_DLC1_            equ       1<CANR_DLC1.
  822  M                                            #endif
  822  M                                            #if :temp > 7
  822  M                                            #endif
  822                                                         endm
  823  M                                  CANR_DLC2           @pin      CANRDLR,2           ;Data Length Code Bit 2
  823  M                                            #ifb CANRDLR,2
  823  M                                            #endif
  823  M                                            #ifb CANR_DLC2
  823  M                                            #else ifnb CANRDLR,2
  823  M                                                      mreq      1:PORT[,BitNumber]
  823  M                                                      mdef      2,0
  823  M                                                      mset      0,CANR_DLC2
  823  M                                                      #temp     2
  823  M             18AC                 CANR_DLC2             set       CANRDLR
  823  M             0002                 CANR_DLC2.            equ       2
  823  M             0004                 CANR_DLC2_            equ       1<CANR_DLC2.
  823  M                                            #endif
  823  M                                            #if :temp > 7
  823  M                                            #endif
  823                                                         endm
  824  M                                  CANR_DLC3           @pin      CANRDLR,3           ;Data Length Code Bit 3
  824  M                                            #ifb CANRDLR,3
  824  M                                            #endif
  824  M                                            #ifb CANR_DLC3
  824  M                                            #else ifnb CANRDLR,3
  824  M                                                      mreq      1:PORT[,BitNumber]
  824  M                                                      mdef      2,0
  824  M                                                      mset      0,CANR_DLC3
  824  M                                                      #temp     3
  824  M             18AC                 CANR_DLC3             set       CANRDLR
  824  M             0003                 CANR_DLC3.            equ       3
  824  M             0008                 CANR_DLC3_            equ       1<CANR_DLC3.
  824  M                                            #endif
  824  M                                            #if :temp > 7
  824  M                                            #endif
  824                                                         endm
  825                                     
  826                18AE                 CANRTSR             equ       CAN_BASE+$2E,2      ;MSCAN Receive Time Stamp Register
  827                18AE                 CANRTSRH            equ       CAN_BASE+$2E,1      ;MSCAN Receive Time Stamp Register High
  828                18AF                 CANRTSRL            equ       CAN_BASE+$2F,1      ;MSCAN Receive Time Stamp Register Low
  829                                     
  830                18B0                 CANTIDR0            equ       CAN_BASE+$30,1      ;MSCAN 0 Transmit Identifier Register 0
  831                18B1                 CANTIDR1            equ       CAN_BASE+$31,1      ;MSCAN 0 Transmit Identifier Register 1
  832                                     
  833  M                                  CANT_IDE            @pin      CANTIDR1,3          ;ID Extended
  833  M                                            #ifb CANTIDR1,3
  833  M                                            #endif
  833  M                                            #ifb CANT_IDE
  833  M                                            #else ifnb CANTIDR1,3
  833  M                                                      mreq      1:PORT[,BitNumber]
  833  M                                                      mdef      2,0
  833  M                                                      mset      0,CANT_IDE
  833  M                                                      #temp     3
  833  M             18B1                 CANT_IDE             set       CANTIDR1
  833  M             0003                 CANT_IDE.            equ       3
  833  M             0008                 CANT_IDE_            equ       1<CANT_IDE.
  833  M                                            #endif
  833  M                                            #if :temp > 7
  833  M                                            #endif
  833                                                         endm
  834  M                                  CANT_SRR            @pin      CANTIDR1,4          ;Substitute Remote Request
  834  M                                            #ifb CANTIDR1,4
  834  M                                            #endif
  834  M                                            #ifb CANT_SRR
  834  M                                            #else ifnb CANTIDR1,4
  834  M                                                      mreq      1:PORT[,BitNumber]
  834  M                                                      mdef      2,0
  834  M                                                      mset      0,CANT_SRR
  834  M                                                      #temp     4
  834  M             18B1                 CANT_SRR             set       CANTIDR1
  834  M             0004                 CANT_SRR.            equ       4
  834  M             0010                 CANT_SRR_            equ       1<CANT_SRR.
  834  M                                            #endif
  834  M                                            #if :temp > 7
  834  M                                            #endif
  834                                                         endm
  835                                     
  836                18B2                 CANTIDR2            equ       CAN_BASE+$32,1      ;MSCAN 0 Transmit Identifier Register 2
  837                18B3                 CANTIDR3            equ       CAN_BASE+$33,1      ;MSCAN 0 Transmit Identifier Register 3
  838                                     
  839  M                                  CANT_RTR            @pin      CANTIDR3,0          ;Remote Transmission Request
  839  M                                            #ifb CANTIDR3,0
  839  M                                            #endif
  839  M                                            #ifb CANT_RTR
  839  M                                            #else ifnb CANTIDR3,0
  839  M                                                      mreq      1:PORT[,BitNumber]
  839  M                                                      mdef      2,0
  839  M                                                      mset      0,CANT_RTR
  839  M                                                      #temp     0
  839  M             18B3                 CANT_RTR             set       CANTIDR3
  839  M             0000                 CANT_RTR.            equ       0
  839  M             0001                 CANT_RTR_            equ       1<CANT_RTR.
  839  M                                            #endif
  839  M                                            #if :temp > 7
  839  M                                            #endif
  839                                                         endm
  840                                     
  841                18B4                 CANTDSR             equ       CAN_BASE+$34,8      ;MSCAN Transmit Data Segment Registers
  842                18B4                 CANTDSR0            equ       CAN_BASE+$34,1      ;MSCAN Transmit Data Segment Register 0
  843                18B5                 CANTDSR1            equ       CAN_BASE+$35,1      ;MSCAN Transmit Data Segment Register 1
  844                18B6                 CANTDSR2            equ       CAN_BASE+$36,1      ;MSCAN Transmit Data Segment Register 2
  845                18B7                 CANTDSR3            equ       CAN_BASE+$37,1      ;MSCAN Transmit Data Segment Register 3
  846                18B8                 CANTDSR4            equ       CAN_BASE+$38,1      ;MSCAN Transmit Data Segment Register 4
  847                18B9                 CANTDSR5            equ       CAN_BASE+$39,1      ;MSCAN Transmit Data Segment Register 5
  848                18BA                 CANTDSR6            equ       CAN_BASE+$3A,1      ;MSCAN Transmit Data Segment Register 6
  849                18BB                 CANTDSR7            equ       CAN_BASE+$3B,1      ;MSCAN Transmit Data Segment Register 7
  850                                     
  851                18BC                 CANTDLR             equ       CAN_BASE+$3C,1      ;MSCAN Transmit Data Length Register
  852                                     
  853  M                                  CANT_DLC0           @pin      CANTDLR,0           ;Data Length Code Bit 0
  853  M                                            #ifb CANTDLR,0
  853  M                                            #endif
  853  M                                            #ifb CANT_DLC0
  853  M                                            #else ifnb CANTDLR,0
  853  M                                                      mreq      1:PORT[,BitNumber]
  853  M                                                      mdef      2,0
  853  M                                                      mset      0,CANT_DLC0
  853  M                                                      #temp     0
  853  M             18BC                 CANT_DLC0             set       CANTDLR
  853  M             0000                 CANT_DLC0.            equ       0
  853  M             0001                 CANT_DLC0_            equ       1<CANT_DLC0.
  853  M                                            #endif
  853  M                                            #if :temp > 7
  853  M                                            #endif
  853                                                         endm
  854  M                                  CANT_DLC1           @pin      CANTDLR,1           ;Data Length Code Bit 1
  854  M                                            #ifb CANTDLR,1
  854  M                                            #endif
  854  M                                            #ifb CANT_DLC1
  854  M                                            #else ifnb CANTDLR,1
  854  M                                                      mreq      1:PORT[,BitNumber]
  854  M                                                      mdef      2,0
  854  M                                                      mset      0,CANT_DLC1
  854  M                                                      #temp     1
  854  M             18BC                 CANT_DLC1             set       CANTDLR
  854  M             0001                 CANT_DLC1.            equ       1
  854  M             0002                 CANT_DLC1_            equ       1<CANT_DLC1.
  854  M                                            #endif
  854  M                                            #if :temp > 7
  854  M                                            #endif
  854                                                         endm
  855  M                                  CANT_DLC2           @pin      CANTDLR,2           ;Data Length Code Bit 2
  855  M                                            #ifb CANTDLR,2
  855  M                                            #endif
  855  M                                            #ifb CANT_DLC2
  855  M                                            #else ifnb CANTDLR,2
  855  M                                                      mreq      1:PORT[,BitNumber]
  855  M                                                      mdef      2,0
  855  M                                                      mset      0,CANT_DLC2
  855  M                                                      #temp     2
  855  M             18BC                 CANT_DLC2             set       CANTDLR
  855  M             0002                 CANT_DLC2.            equ       2
  855  M             0004                 CANT_DLC2_            equ       1<CANT_DLC2.
  855  M                                            #endif
  855  M                                            #if :temp > 7
  855  M                                            #endif
  855                                                         endm
  856  M                                  CANT_DLC3           @pin      CANTDLR,3           ;Data Length Code Bit 3
  856  M                                            #ifb CANTDLR,3
  856  M                                            #endif
  856  M                                            #ifb CANT_DLC3
  856  M                                            #else ifnb CANTDLR,3
  856  M                                                      mreq      1:PORT[,BitNumber]
  856  M                                                      mdef      2,0
  856  M                                                      mset      0,CANT_DLC3
  856  M                                                      #temp     3
  856  M             18BC                 CANT_DLC3             set       CANTDLR
  856  M             0003                 CANT_DLC3.            equ       3
  856  M             0008                 CANT_DLC3_            equ       1<CANT_DLC3.
  856  M                                            #endif
  856  M                                            #if :temp > 7
  856  M                                            #endif
  856                                                         endm
  857                                     
  858                18BD                 CANTTBPR            equ       CAN_BASE+$3D,1      ;MSCAN Transmit Buffer Priority
  859                18BE                 CANTTSR             equ       CAN_BASE+$3E,2      ;MSCAN Transmit Time Stamp Register
  860                18BE                 CANTTSRH            equ       CAN_BASE+$3E,1      ;MSCAN Transmit Time Stamp Register High
  861                18BF                 CANTTSRL            equ       CAN_BASE+$3F,1      ;MSCAN Transmit Time Stamp Register Low
  862                                     
  863                                     ;*******************************************************************************
  864                                     
  865                FFAE                 NVFTRIM             equ       $FFAE,1             ;Non-volatile MCG Fine Trim
  866                FFAF                 NVMCGTRM            equ       $FFAF,1             ;Non-volatile MCG Trim Register
  867                FFAF                 NVICSTRM            def       NVMCGTRM,1          ;functionally equivalent to the NVICSTRM of other MCUs
  868                FFBD                 NVPROT              equ       $FFBD,1             ;Non-volatile FLASH Protection Register
  869                FFBF                 NVOPT               equ       $FFBF,1             ;Non-volatile FLASH Options Register
  870                                     
  871  M                                  NVOPT_EPGMOD        @pin      NVOPT,5             ;EEPROM Sector Mode Bit
  871  M                                            #ifb NVOPT,5
  871  M                                            #endif
  871  M                                            #ifb NVOPT_EPGMOD
  871  M                                            #else ifnb NVOPT,5
  871  M                                                      mreq      1:PORT[,BitNumber]
  871  M                                                      mdef      2,0
  871  M                                                      mset      0,NVOPT_EPGMOD
  871  M                                                      #temp     5
  871  M             FFBF                 NVOPT_EPGMOD             set       NVOPT
  871  M             0005                 NVOPT_EPGMOD.            equ       5
  871  M             0020                 NVOPT_EPGMOD_            equ       1<NVOPT_EPGMOD.
  871  M                                            #endif
  871  M                                            #if :temp > 7
  871  M                                            #endif
  871                                                         endm
  872  M                                  NVOPT_FNORED        @pin      NVOPT,6             ;Vector Redirection Disable Bit
  872  M                                            #ifb NVOPT,6
  872  M                                            #endif
  872  M                                            #ifb NVOPT_FNORED
  872  M                                            #else ifnb NVOPT,6
  872  M                                                      mreq      1:PORT[,BitNumber]
  872  M                                                      mdef      2,0
  872  M                                                      mset      0,NVOPT_FNORED
  872  M                                                      #temp     6
  872  M             FFBF                 NVOPT_FNORED             set       NVOPT
  872  M             0006                 NVOPT_FNORED.            equ       6
  872  M             0040                 NVOPT_FNORED_            equ       1<NVOPT_FNORED.
  872  M                                            #endif
  872  M                                            #if :temp > 7
  872  M                                            #endif
  872                                                         endm
  873  M                                  NVOPT_KEYEN         @pin      NVOPT,7             ;Backdoor Key Security Enable Bit
  873  M                                            #ifb NVOPT,7
  873  M                                            #endif
  873  M                                            #ifb NVOPT_KEYEN
  873  M                                            #else ifnb NVOPT,7
  873  M                                                      mreq      1:PORT[,BitNumber]
  873  M                                                      mdef      2,0
  873  M                                                      mset      0,NVOPT_KEYEN
  873  M                                                      #temp     7
  873  M             FFBF                 NVOPT_KEYEN             set       NVOPT
  873  M             0007                 NVOPT_KEYEN.            equ       7
  873  M             0080                 NVOPT_KEYEN_            equ       1<NVOPT_KEYEN.
  873  M                                            #endif
  873  M                                            #if :temp > 7
  873  M                                            #endif
  873                                                         endm
  874                                     
  875                                     ; Flash commands
  876                                     
  877                0005                 Blank_              equ       $05                 ;Blank Check command
  878                0020                 ByteProg_           equ       $20                 ;Byte Program command
  879                0025                 BurstProg_          equ       $25                 ;Burst Program command
  880                0040                 PageErase_          equ       $40                 ;Page Erase command
  881                0041                 MassErase_          equ       $41                 ;Mass Erase command
  882                0047                 EraseAbort_         equ       $47
  883                                     
  884                                     ; **** END OF ORIGINAL DEFINITIONS *********************************************
  885                                     
  886                C000                 _9S08DZ60_          def       *                   ;Tells us this INCLUDE has been used
  887                                     
  888                001A                 TEMPERATURE_CHANNEL equ       26                  ;Channel for internal temperature
  889                001B                 BANDGAP_CHANNEL     equ       27                  ;Channel for internal bandgap
  890                04B0                 BANDGAP_VOLTAGE     def       1200                ;typical bandgap voltage in mV
  891                                     
  892                FFB0                 NVBACKKEY           equ       $FFB0,8             ;8-byte backdoor comparison key ($FFB0..$FFB7)
  893                                     
  894                0300                 FLASH_PAGE_SIZE     equ       768                 ;minimum that must be erased at once
  895                                     
  896                                               #if FLASH_PAGE_SIZE <> 768
  898                                               #endif
  899                                     
  900                0000                 FLASH_DATA_SIZE     def       0                   ;default: no runtime flash storage
  901                                     
  902                FFC0                 VECTORS             equ       $FFC0               ;start of fixed vectors
  903                                     
  904                                               #ifdef RVECTORS
  906                                               #endif
  907                                     
  908                                     ; Vectors
  909                                                         #temp     VECTORS
  910                FFC0                 Vacmp2              next      :temp,2             ;ACMP2 vector
  911                FFC2                 Vacmp1              next      :temp,2             ;ACMP1 vector
  912                FFC4                 Vcantx              next      :temp,2
  913                FFC6                 Vcanrx              next      :temp,2
  914                FFC8                 Vcanerr             next      :temp,2
  915                FFCA                 Vcanwu              next      :temp,2
  916                FFCC                 Vrtc                next      :temp,2             ;Real-Time Clock
  917                FFCE                 Viic                next      :temp,2             ;IIC vector
  918                FFD0                 Vadc                next      :temp,2             ;A/D vector
  919                FFD2                 Vport               next      :temp,2             ;Pin-interrupt
  920                FFD4                 Vsci2tx             next      :temp,2             ;SCI2 transmit vector
  921                FFD6                 Vsci2rx             next      :temp,2             ;SCI2 receive vector
  922                FFD8                 Vsci2err            next      :temp,2             ;SCI2 error vector
  923                FFDA                 Vsci1tx             next      :temp,2             ;SCI1 transmit vector
  924                FFDC                 Vsci1rx             next      :temp,2             ;SCI1 receive vector
  925                FFDE                 Vsci1err            next      :temp,2             ;SCI1 error vector
  926                FFE0                 Vspi                next      :temp,2             ;SPI vector
  927                FFE2                 Vtpm2ovf            next      :temp,2             ;TPM2 overflow
  928                FFE4                 Vtpm2ch1            next      :temp,2             ;TPM1 Channel 1
  929                FFE6                 Vtpm2ch0            next      :temp,2             ;TPM1 Channel 0
  930                FFE8                 Vtpm1ovf            next      :temp,2             ;TPM1 overflow
  931                FFEA                 Vtpm1ch5            next      :temp,2             ;TPM1 Channel 5
  932                FFEC                 Vtpm1ch4            next      :temp,2             ;TPM1 Channel 4
  933                FFEE                 Vtpm1ch3            next      :temp,2             ;TPM1 Channel 3
  934                FFF0                 Vtpm1ch2            next      :temp,2             ;TPM1 Channel 2
  935                FFF2                 Vtpm1ch1            next      :temp,2             ;TPM1 Channel 1
  936                FFF4                 Vtpm1ch0            next      :temp,2             ;TPM1 Channel 0
  937                FFF6                 Vlol                next      :temp,2
  938                FFF8                 Vlvd                next      :temp,2             ;Low voltage detect
  939                FFFA                 Virq                next      :temp,2             ;IRQ vector
  940                FFFC                 Vswi                next      :temp,2             ;SWI vector
  941                FFFE                 Vreset              next      :temp,2             ;Reset vector
  942                                     
  943                FFE8                 Vtpmovf             equ       Vtpm1ovf,2
  944                FFF0                 Vtpmch2             equ       Vtpm1ch2,2
  945                FFF2                 Vtpmch1             equ       Vtpm1ch1,2
  946                FFF4                 Vtpmch0             equ       Vtpm1ch0,2
  947                                     
  948                0000                 FLASH_DATA_SIZE     align     FLASH_PAGE_SIZE*2   ;round up to double block
  949                1900                 TRUE_ROM            equ       $1900               ;start of 60K Flash
  950                                     
  951                1400                 EEPROM              def       $1400               ;only half of the EEPROM is
  952                17FF                 EEPROM_END          equ       $17FF               ;visible through this window
  953                                     
  954                                     #ifdef BOOTROM
  958                                     #endif
  959                                     
  960                1900                 ROM                 def       TRUE_ROM
  961                FF9F                 ROM_END             equ       $FF9F               ;end of all flash (before NV registers and fixed vectors)
  962                                     
  963                                     #ifdef BOOT&BOOTROM
  965                                     #endif
  966                                     
  967                1080                 XROM                equ       $00001080
  968                13FF                 XROM_END            equ       $000013FF
  969                                     
  970                                     ?                   macro
  971                                                         #temp     $10000              ;;count down from 64K
  972                                                         mdo
  973                                               #if ROM < :temp
  974                                                         #temp     :temp-{FLASH_PAGE_SIZE*2} ;;back-up 1.5KB
  975                                                         mloop     64/2
  976                                               #endif
  977                                     ?NVPROT_MASK        def       $3F-{:mloop*2-2/2}|%11000000  ;EEPROM always unprotected
  978                                                         endm
  979                                     
  980  M                                                      @?                            ;calculate NVPROT_MASK value
  980  M                                                      #temp     $10000
  980  M                                                      mdo
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #if ROM < :temp
  980  M                                                      #temp     :temp-1536
  980  M                                                      mloop     64/2
  980  M                                            #endif
  980  M             00E0                 ?NVPROT_MASK        def       $3F-31|%11000000  ;EEPROM always unprotected
  980                                                         endm
  981                                     
  982                0080                 RAM                 def       $0080               ;start of 2KB RAM
  983                00FF                 RAM_END             equ       $00FF               ;last zero-page RAM location
  984                                     
  985                0100                 XRAM                equ       $0100
  986                107F                 XRAM_END            equ       $107F               ;last RAM location
  987                                     
  988                                     #ifdef BOOTRAM_END
  990                                     #endif
  991                                     
  992                1900                 FLASH_START         equ       TRUE_ROM
  993                FF9F                 FLASH_END           equ       ROM_END
  994                                     
  995                                               #ifdef BOOT&BOOTROM
  997                                               #endif
  998                                     
  999                FFA0                 SERIAL_NUMBER       equ       $FFA0               ;start of optional S/N (FFA0-FFAD)
 1000                                     
 1001                                     #ifndef MHZ
 1002                                       #ifndef KHZ
 1003                01E84800             HZ                  def       32000000            ;Cyclone 31250*1024
 1004                                       #endif
 1005                                     #endif
 1006                                     
 1007                                     ;-------------------------------------------------------------------------------
 1008                                                         #Uses     common.inc
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/common.inc ***
    1                                     ;*******************************************************************************
    2                                     ;*           COMMON EQUATES -- MCU INDEPENDENT -- FOR ASM8 ASSEMBLER           *
    3                                     ;*******************************************************************************
    4                                     ;* Language  : Motorola/Freescale/NXP HC08/9S08 Assembly Language (aspisys.com/ASM8)
    5                                     ;*******************************************************************************
    6                                     ; FREEWARE, Copyright (c) Tony G. Papadimitriou <tonyp@acm.org>
    7                                     ;*******************************************************************************
    8                                     ; General naming conventions (older code may not yet follow precisely):
    9                                     ;-------------------------------------------------------------------------------
   10                                     ; Dot-ending names (XXX.) indicate a unique bit by position number (7 thru 0)
   11                                     ; Underscore-ending names (XXX_) indicate a bit mask (possibly multiple bits)
   12                                     ; Underscore surrounded names (_XXX_) indicate special system symbols such as
   13                                     ; CCR offsets, etc.
   14                                     ; Constants use uppercase (XXX)
   15                                     ; Variables use lowercase and underscores as needed (my_var).
   16                                     ; Pointers begin with a point/dot (.xxx).
   17                                     ; Code labels use CamelCase
   18                                     ; Local labels end with @@ (although ASM8 allows @@ to be anywhere inside label)
   19                                     ;*******************************************************************************
   20                                     
   21                                     #ifmain ;-----------------------------------------------------------------------
   23                                     #endif ;------------------------------------------------------------------------
   24                                     
   25                FFFFFFFF             NOT                 def       -1                  ;Used with XOR to get NOT result
   26                                     
   27                                     ;*******************************************************************************
   28                                     ; Symbol to the left of macro call (if present) and :MEXIT internal variable
   29                                     ; are SET to the integer Log2 (log base two) of the given expression.
   30                                     ; Quick-n-dirty calculation of integer part of log2(n) for values upto 2^31-1
   31                                     ; Useful to get power from value (e.g., as when used with various prescalers.)
   32                                     ; With the optional ShiftLeftBits parameter, one can shift the result into the
   33                                     ; expected bit positions (e.g., within a larger bitmap).
   34                                     
   35                                     #ifnomdef Log2
   50                                     #endif
   51                                     
   52                                     ;*******************************************************************************
   53                                     ; Restrict the value of a constant label between a minimum and a maximum
   54                                     ; printing a warning if the value is outside the allowed range
   55                                     
   56                                     ConstMinMax         macro     Symbol[,MinValue][,MaxValue][,Message]
   57                                                         mreq      1:Symbol[,MinValue][,MaxValue]
   58                                                         mdef      4,~2~ <= ~1,~ <= ~3~ [not {~1,~}]
   59                                                         mset      0,~4~
   60                                               #ifb ~2~~3~
   61                                                         merror    No MinValue or MaxValue given
   62                                               #endif
   63                                               #ifnb ~2~
   64                                                 #if ~1,~ < ~2~
   65                                                         #Warning  ~text~
   66                                                 #endif
   67                                               #endif
   68                                               #ifnb ~3~
   69                                                 #if ~1,~ > ~3~
   70                                                         #Warning  ~text~
   71                                                 #endif
   72                                               #endif
   73                                                         endm
   74                                     
   75                                     ;*******************************************************************************
   76                                     ; Restrict the value of a constant label to one of the specified values
   77                                     ; printing a warning if the value is not in the given set
   78                                     
   79                                     ConstValues         macro     Symbol,Value[,Value]*
   80                                                         mreq      1,2:Symbol,Value[,Value]*
   81                                               #ifndef ~1,~
   82                                                         mexit     ;;mstop     ~1,~ not yet defined
   83                                               #endif
   84                                                         mdo       2
   85                                               #if ~1,~ = ~{:mloop}.~
   86                                                         mexit
   87                                               #endif
   88                                                         mloop     :n
   89                                                         mset      0,~1,~
   90                                                         mdel      1
   91                                                         mset      #
   92                                                         #Warning  ~text~ ({~text~}) not in [~1~]
   93                                                         endm
   94                                     
   95                                     ;*******************************************************************************
   96                                     
   97                0CE4                 VDD                 def       3300                ;MCU voltage in mV
   98                                     
   99                                     ;===============================================================================
  100                                     
  101                                     ?max                macro     CONST,UpperLimit
  102                                               #if ~1~ > ~2~
  103                                                         merror    ~1~ ({~1~}) > ~2~ not allowed
  104                                               #endif
  105                                                         endm
  106                                     
  107                                     ;-------------------------------------------------------------------------------
  108                                     
  109                0001                 BDIV                def       2                   ;default bus divider (9S08)
  110  M                                  BDIV_               @Log2     BDIV,6              ;move BDIV bits to Bit7..Bit6
  110  M                                                      mreq      1:Usage: Label @Log2 Expression[,ShiftLeftBits]
  110  M                                                      mdef      2,0
  110  M                                                      #temp     :loop-2
  110  M                                  #ifz BDIV
  110  M                                  #endif
  110  M                                                      mset      1,0
  110  M                                                      mtop
  110  M                                                      mreq      1:Usage: Label @Log2 Expression[,ShiftLeftBits]
  110  M                                                      mdef      2,0
  110  M                                                      #temp     :loop-2
  110  M                                  #ifz 0
  110  M                                                      #temp     :temp<6
  110  M                                            #ifparm BDIV_
  110  M             0000                 BDIV_             set       :temp
  110  M                                            #endif
  110                                                         mexit     :temp
  111  M                                                      @?max     BDIV,8
  111  M                                            #if BDIV > 8
  111  M                                            #endif
  111                                                         endm
  112                                     
  113                                     ;===============================================================================
  114                                     
  115                                     ?hz                 macro     FromHz,ToHz
  116                                                         mreq      1,2:FromHz,ToHz
  117                                     #ifdef BUS_~1~
  118                                                         mset      1,BUS_~1~
  119                                                         mset      2,BUS_~2~
  120                                     #endif
  121                                     #ifdef ~1~
  122                                               #if ~1~\1000 >= 500
  123                                     ~2~                 set       ~1~/1000+1
  124                                               #else
  125                                     ~2~                 set       ~1~/1000
  126                                               #endif
  127                                     #endif
  128                                     #ifparm ~1.1.4~ = BUS_
  129                                               #ifhcs
  130                                     ~1.5~               set       ~1~*2*BDIV
  131                                               #else
  132                                     ~1.5~               set       ~1~*4
  133                                               #endif
  134                                     #endif
  135                                                         endm
  136                                     
  137                                     ;-------------------------------------------------------------------------------
  138                                     
  139                                     #ifdef BUS_MHZ
  142                                     #endif
  143  M                                                      @?hz      HZ,KHZ
  143  M                                                      mreq      1,2:FromHz,ToHz
  143  M                                  #ifdef BUS_HZ
  143  M                                  #endif
  143  M                                  #ifdef HZ
  143  M                                            #if HZ\1000 >= 500
  143  M                                            #else
  143  M             7D00                 KHZ                 set       HZ/1000
  143  M                                            #endif
  143  M                                  #endif
  143  M                                  #ifparm HZ = BUS_
  143  M                                  #endif
  143                                                         endm
  144  M                                                      @?hz      KHZ,MHZ
  144  M                                                      mreq      1,2:FromHz,ToHz
  144  M                                  #ifdef BUS_KHZ
  144  M                                  #endif
  144  M                                  #ifdef KHZ
  144  M                                            #if KHZ\1000 >= 500
  144  M                                            #else
  144  M             0020                 MHZ                 set       KHZ/1000
  144  M                                            #endif
  144  M                                  #endif
  144  M                                  #ifparm KHZ = BUS_
  144  M                                  #endif
  144                                                         endm
  145                                     
  146                0020                 MHZ                 def       16                  ;default crystal speed
  147                7D00                 KHZ                 def       MHZ*1000
  148                01E84800             HZ                  def       KHZ*1000
  149                                               #ifhcs
  150                00F42400             BUS_HZ              def       HZ/2/BDIV
  153                                               #endif
  154                3E80                 BUS_KHZ             def       BUS_HZ/1000
  155                0010                 BUS_MHZ             def       BUS_KHZ/1000
  156                                     
  157                                     ;===============================================================================
  158                                     
  159                                     #ifhcs
  160                                     ?calc_fll_factor    macro
  161                                               #ifdef _FL_
  162                                     CHOICES$$$          equ       2
  163                                                         mset      0,512,608
  164                                               #else ifdef _PA_
  165                                     CHOICES$$$          equ       1
  166                                                         mset      0,512
  167                                               #else
  168                                     CHOICES$$$          equ       6
  169                                                         mset      0,512,1024,1536,608,1216,1824
  170                                               #endif
  171                                                         mdo
  172                                                         #temp     ~text[,]{:mloop}~
  173                                               #ifz HZ*10\:temp
  174                                               #if HZ*10/:temp >= 312500
  175                                               #if HZ*10/:temp <= 390625
  176                                     FLL_FACTOR          def       :temp
  177                                               #endif
  178                                               #endif
  179                                               #endif
  180                                                         mloop     CHOICES$$$
  181                                                         endm
  182  M                                                      @?calc_fll_factor
  182  M                                            #ifdef _FL_
  182  M                                            #else ifdef _PA_
  182  M                                            #else
  182  M             0006                 CHOICES$$$          equ       6
  182  M                                                      mset      0,512,1024,1536,608,1216,1824
  182  M                                            #endif
  182  M                                                      mdo
  182  M                                                      #temp     512
  182  M                                            #ifz HZ*10\:temp
  182  M                                            #if HZ*10/:temp >= 312500
  182  M                                            #if HZ*10/:temp <= 390625
  182  M                                            #endif
  182  M                                            #endif
  182  M                                            #endif
  182  M                                                      mloop     CHOICES$$$
  182  M                                                      #temp     1024
  182  M                                            #ifz HZ*10\:temp
  182  M                                            #if HZ*10/:temp >= 312500
  182  M                                            #if HZ*10/:temp <= 390625
  182  M             0400                 FLL_FACTOR          def       :temp
  182  M                                            #endif
  182  M                                            #endif
  182  M                                            #endif
  182  M                                                      mloop     CHOICES$$$
  182  M                                                      #temp     1536
  182  M                                            #ifz HZ*10\:temp
  182  M                                            #endif
  182  M                                                      mloop     CHOICES$$$
  182  M                                                      #temp     608
  182  M                                            #ifz HZ*10\:temp
  182  M                                            #endif
  182  M                                                      mloop     CHOICES$$$
  182  M                                                      #temp     1216
  182  M                                            #ifz HZ*10\:temp
  182  M                                            #endif
  182  M                                                      mloop     CHOICES$$$
  182  M                                                      #temp     1824
  182  M                                            #ifz HZ*10\:temp
  182  M                                            #endif
  182  M                                                      mloop     CHOICES$$$
  182                                                         endm
  183                0400                 FLL_FACTOR          def       512
  184  M                                                      @?max     FLL_FACTOR,1824
  184  M                                            #if FLL_FACTOR > 1824
  184  M                                            #endif
  184                                                         endm
  185                                     
  186                                                         #temp                         ;assume low RANGE
  187                                               #ifdef TCXO
  194                                               #else !if XTAL >= 1000000
  195                                                         #temp     1                   ;high RANGE
  196                                                 #ifdef RDIV
  197  M                                                      @ConstMinMax XTAL/RDIV,31250,39063
  197  M                                                      mreq      1:Symbol[,MinValue][,MaxValue]
  197  M                                                      mdef      4,31250 <= XTAL/RDIV <= 39063 [not 31250]
  197  M                                                      mset      0,31250 <= XTAL/RDIV <= 39063 [not 31250]
  197  M                                            #ifb 3125039063
  197  M                                            #endif
  197  M                                            #ifnb 31250
  197  M                                              #if XTAL/RDIV < 31250
  197  M                                              #endif
  197  M                                            #endif
  197  M                                            #ifnb 39063
  197  M                                              #if XTAL/RDIV > 39063
  197  M                                              #endif
  197  M                                            #endif
  197                                                         endm
  198                                                 #endif
  199                                               #endif
  200                                               #!if RDIV > 128
  202                                               #endif
  203                0001                 RANGE               def       :temp               ;default divider range (0,1)
  204                                     
  205                                               #ifdef RDIV
  206                                                 #ifz RANGE
  209                                                 #else
  210  M                                                      @ConstValues RDIV,32,64,128,256,512,1024
  210  M                                                      mreq      1,2:Symbol,Value[,Value]*
  210  M                                            #ifndef RDIV
  210  M                                            #endif
  210  M                                                      mdo       2
  210  M                                            #if RDIV = 32
  210  M                                            #endif
  210  M                                                      mloop     :n
  210  M                                            #if RDIV = 64
  210  M                                            #endif
  210  M                                                      mloop     :n
  210  M                                            #if RDIV = 128
  210                                                         mexit
  211  M                                  RDIV_               @Log2     RDIV/32,3           ;move RDIV bits to Bit5..Bit3
  211  M                                                      mreq      1:Usage: Label @Log2 Expression[,ShiftLeftBits]
  211  M                                                      mdef      2,0
  211  M                                                      #temp     :loop-2
  211  M                                  #ifz RDIV/32
  211  M                                  #endif
  211  M                                                      mset      1,2
  211  M                                                      mtop
  211  M                                                      mreq      1:Usage: Label @Log2 Expression[,ShiftLeftBits]
  211  M                                                      mdef      2,0
  211  M                                                      #temp     :loop-2
  211  M                                  #ifz 2
  211  M                                  #endif
  211  M                                                      mset      1,1
  211  M                                                      mtop
  211  M                                                      mreq      1:Usage: Label @Log2 Expression[,ShiftLeftBits]
  211  M                                                      mdef      2,0
  211  M                                                      #temp     :loop-2
  211  M                                  #ifz 1
  211  M                                  #endif
  211  M                                                      mset      1,0
  211  M                                                      mtop
  211  M                                                      mreq      1:Usage: Label @Log2 Expression[,ShiftLeftBits]
  211  M                                                      mdef      2,0
  211  M                                                      #temp     :loop-2
  211  M                                  #ifz 0
  211  M                                                      #temp     :temp<3
  211  M                                            #ifparm RDIV_
  211  M             0010                 RDIV_             set       :temp
  211  M                                            #endif
  211                                                         mexit     :temp
  212                                                 #endif
  215                                               #endif
  216                0020                 RANGE_              equ       RANGE<RANGE_SEL.    ;move RANGE bit to correct bit
  217  M                                                      @?max     RANGE,1
  217  M                                            #if RANGE > 1
  217  M                                            #endif
  217                                                         endm
  218                                     #endif
  219                                     ;===============================================================================
  220                                               #ifhcs
  221                                                 #ifnz FLL_FACTOR
  222                                                         #temp     HZ*10/FLL_FACTOR
  223                                                 #ifz HZ*10\FLL_FACTOR
  224                                                         #Message  Trim to IRCLK {:temp(1)} Hz (FLL_FACTOR={FLL_FACTOR})
  227                                                 #endif
  228                                                 #if :temp < 312500
  230                                                 #else if :temp > 390625
  232                                                 #endif
  233                                                 #endif
  234                                               #endif
  235                                     
  236                3E80                 MSEC_CYCLES         def       BUS_KHZ             ;rough number of cycles per millisecond
  237                                     
  238                                     ;-------------------------------------------------------------------------------
  239                                     
  240                                     ?                   macro
  241                                                         #temp     :index-1
  242                                     Bit{:temp}.         equ       {:temp}
  243                                     Bit{:temp}_         equ       1<{:temp}
  244                                                         mtop      16
  245                                                         endm
  246                                     
  247  M                                                      @?                            ;Define Bit0 .. Bit15
  247  M                                                      #temp     :index-1
  247  M             0000                 Bit0.         equ       0
  247  M             0001                 Bit0_         equ       1<0
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             0001                 Bit1.         equ       1
  247  M             0002                 Bit1_         equ       1<1
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             0002                 Bit2.         equ       2
  247  M             0004                 Bit2_         equ       1<2
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             0003                 Bit3.         equ       3
  247  M             0008                 Bit3_         equ       1<3
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             0004                 Bit4.         equ       4
  247  M             0010                 Bit4_         equ       1<4
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             0005                 Bit5.         equ       5
  247  M             0020                 Bit5_         equ       1<5
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             0006                 Bit6.         equ       6
  247  M             0040                 Bit6_         equ       1<6
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             0007                 Bit7.         equ       7
  247  M             0080                 Bit7_         equ       1<7
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             0008                 Bit8.         equ       8
  247  M             0100                 Bit8_         equ       1<8
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             0009                 Bit9.         equ       9
  247  M             0200                 Bit9_         equ       1<9
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             000A                 Bit10.         equ       10
  247  M             0400                 Bit10_         equ       1<10
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             000B                 Bit11.         equ       11
  247  M             0800                 Bit11_         equ       1<11
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             000C                 Bit12.         equ       12
  247  M             1000                 Bit12_         equ       1<12
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             000D                 Bit13.         equ       13
  247  M             2000                 Bit13_         equ       1<13
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             000E                 Bit14.         equ       14
  247  M             4000                 Bit14_         equ       1<14
  247  M                                                      mtop      16
  247  M                                                      #temp     :index-1
  247  M             000F                 Bit15.         equ       15
  247  M             8000                 Bit15_         equ       1<15
  247  M                                                      mtop      16
  247                                                         endm
  248                                     
  249                                     ;-------------------------------------------------------------------------------
  250                                     ; CCR bits (by position)
  251                                     ;-------------------------------------------------------------------------------
  252                                     
  253                0007                 V.                  equ       7                   ;Overflow flag in CCR
  254                0006                 U1.                 equ       6                   ;--Undefined
  255                0005                 U0.                 equ       5                   ;--Undefined
  256                0004                 H.                  equ       4                   ;Half-Carry flag in CCR
  257                0003                 I.                  equ       3                   ;Interrupts flag in CCR
  258                0002                 N.                  equ       2                   ;Negative flag in CCR
  259                0001                 Z.                  equ       1                   ;Zero flag in CCR
  260                0000                 C.                  equ       0                   ;Carry flag in CCR
  261                                     
  262                                     ;-------------------------------------------------------------------------------
  263                                     ; CCR bits (masks)
  264                                     ;-------------------------------------------------------------------------------
  265                                     
  266                0080                 V_                  equ       1<V.                ;Overflow flag in CCR
  267                0040                 U1_                 equ       1<U1.               ;--Undefined
  268                0020                 U0_                 equ       1<U0.               ;--Undefined
  269                0010                 H_                  equ       1<H.                ;Half-Carry flag in CCR
  270                0008                 I_                  equ       1<I.                ;Interrupts flag in CCR
  271                0004                 N_                  equ       1<N.                ;Negative flag in CCR
  272                0002                 Z_                  equ       1<Z.                ;Zero flag in CCR
  273                0001                 C_                  equ       1<C.                ;Carry flag in CCR
  274                                     
  275                                     ;-------------------------------------------------------------------------------
  276                                     ; SP (one-based) offsets account for the return address of OS8 dispatcher's CALL
  277                                     ;-------------------------------------------------------------------------------
  278                                     
  279                                                         #temp     1+:ab               ;start of stacked data, if any
  280                0003                 _H_                 setn      :temp               ;stacked by OS8 SWI ISR
  281                0004                 _CCR_               setn      :temp               ;stacked by HC[S]08 interrupt
  282                0005                 _A_                 setn      :temp               ;         -//-
  283                0006                 _X_                 setn      :temp               ;         -//-
  284                0007                 _PCH_               setn      :temp               ;         -//-
  285                0008                 _PCL_               setn      :temp               ;         -//-
  286                0009                 _DATA_              setn      :temp               ;offset to caller's TOS data
  287                                     
  288                0007                 _PC_                set       _PCH_,2             ;alias for full PC word
  289                                     
  290                0006                 _INT_FRAME_SIZE_    set       _DATA_-_H_
  291                                     
  292                                     ;*******************************************************************************
  293                                     ; Displays an error message if the assembly-time condition is false
  294                                     ; (The condition should be written as to be compatible with the #IF directive)
  295                                     
  296                                     assert              macro     Condition[,message]
  297                                                         mset      #','
  298                                               #if ~1~
  299                                                         mexit
  300                                               #endif
  301                                                         mdel      1                   ;;get rid of condition
  302                                                         mset      #                   ;;unify string message
  303                                                         mdef      1,Assertion failed (~1~) ;;default message
  304                                                         merror    ~1~
  305                                                         endm
  306                                     
  307                                     ;*******************************************************************************
  308                                     ; Macro to test if a symbol is at TOS, and issue an error if not
  309                                     
  310                                     tos                 macro     Symbol
  311                                                         mset      #
  312                                               #iftos ~1,~
  313                                                         mexit
  314                                               #endif
  315                                                         merror    ~1,~ is expected at TOS
  316                                                         endm
  317                                     
  318                                     ;*******************************************************************************
  319                                     ; For each defined port letter, repeat the given instruction.
  320                                     ; Use * as the wildcard that will be replaced with the corresponding letter.
  321                                     ; * may appear once both in the CmdToDo and the Mask to match.
  322                                     ; If LetterList exists, it will be used instead of the full letter list.
  323                                     
  324                                     ForEachPort         macro     [@]CmdToDo,Mask*[,LetterList]
  325                                                         mset      #','
  326                                                         mreq      1,2:[@]CmdToDo,Mask* (where * will be replaced by the letter)
  327                                                         mset      0,~3~
  328                                                         mdef      0,ABCDEFGHIJKLMNOPQRSTUVWXYZ
  329                                               #ifparm ~1.1.1~ = @
  330                                                         mset      1,@~1~              ;;make macro a @@ call
  331                                               #endif
  332                                                         mdo
  333                                               #ifdef ~2'*'~~text.{:mloop}.1~~2'*'2~
  334                                                         ~1'*'~~text.{:mloop}.1~~1'*'2~
  335                                               #endif
  336                                                         mloop     :text
  337                                                         endm
  338                                     
  339                                     ;*******************************************************************************
  340                                     ; Macro to dynamically execute another macro or instruction as one atomic
  341                                     ; operation (i.e., with interrupts temporarily disabled).
  342                                     ; When done with the operation, it restores interrupts to their original status.
  343                                     ; You could use with any macro.  For example, using an ADD.L (add longs) macro
  344                                     ; you could perform the addition with interrupts disabled, even if the original
  345                                     ; macro does not provide for atomicity of operation(s).  Example:
  346                                     ;                   @atomic   add.l,Number1,Number2,Answer
  347                                     
  348                                     Atomic              macro     [@]CmdToDo[,Parameter]*
  349                                                         mreq      1:[@]CmdToDo[,Parameter]*
  350                                               #ifparm ~1.1.1~ = @
  351                                                         mset      1,@~1~              ;;make macro a @@ call
  352                                               #endif
  353                                                         mswap     0,1
  354                                                         mdel      1
  355                                                         mset      #
  356                                                         #push
  357                                                         #spauto   :sp
  358                                                         pshcc
  359                                                         sei
  360                                     
  361                                                         ~text~    ~1~
  362                                     
  363                                                         pulcc
  364                                               #if :sp <> :spcheck
  365                                                         #Warning  Macro \@~text~\@ resizes stack, ~0~ may fail
  366                                               #endif
  367                                                         #pull
  368                                                         endm
  369                                     
  370                                     ;*******************************************************************************
  371                                     ; Find a character in the string pointed to by HX, and point right past it.
  372                                     ; The user's original RegA is not destroyed.
  373                                     ; CCR[Z] = 1 if end of string reached while searching
  374                                     
  375                                     SkipChar            macro     [[#]Character]
  376                                                         mset      #
  377                                               #ifnb ~1~
  378                                                         psha
  379                                                         @@_lda_   ~1~
  380                                               #endif
  381                                     Loop$$$
  382                                                         tst       ,x                  ;;is it end of ASCIZ string?
  383                                                         cbeq      x+,Done$$$          ;;char found, done
  384                                                         bne       Loop$$$             ;;repeat until end of ASCIZ string
  385                                     Done$$$
  386                                               #ifnb ~1~
  387                                                         pula
  388                                               #endif
  389                                                         endm
  390                                     
  391                                     ;*******************************************************************************
  392                                     ; Skip over the current and following characters as long as they match the target
  393                                     ; On completion, HX -> first non-target character
  394                                     ; The user's original RegA is not destroyed
  395                                     
  396                                     EatChar             macro     [[#]Character]
  397                                                         mset      #
  398                                               #ifnb ~1~
  399                                                         psha
  400                                                         @@_lda_   ~1~
  401                                               #endif
  402                                                         cbeq      x+,*                ;;eat up matching chars
  403                                                         aix       #-1                 ;;went too far, back up one
  404                                               #ifnb ~1~
  405                                                         pula
  406                                               #endif
  407                                                         endm
  408                                     
  409                                     ;*******************************************************************************
  410                                     ; Find (in RegA) the minimum between RegA and operand
  411                                     
  412                                     MinA                macro     Operand
  413                                                         mset      #
  414                                                         mreq      1:Operand
  415                                                         cmpa      ~1~
  416                                                         bls       Done$$$
  417                                                         lda       ~1~
  418                                     Done$$$
  419                                                         endm
  420                                     
  421                                     ;*******************************************************************************
  422                                     ; Find (in RegA) the maximum between RegA and operand
  423                                     
  424                                     MaxA                macro     Operand
  425                                                         mset      #
  426                                                         mreq      1:Operand
  427                                                         cmpa      ~1~
  428                                                         bhs       Done$$$
  429                                                         lda       ~1~
  430                                     Done$$$
  431                                                         endm
  432                                     
  433                                     ;*******************************************************************************
  434                                     ; Long version of CBEQA
  435                                     
  436                                     cjeqa               macro     #operand,target
  437                                               #ifparm ~2~ = *
  438                                                         mset      2,{*}
  439                                               #endif
  440                                                         cbeqa     ~1~,Go$$$
  441                                                         bra       Done$$$
  442                                     Go$$$
  443                                                         jmp       ~2~
  444                                     Done$$$
  445                                                         endm
  446                                     
  447                                     ;*******************************************************************************
  448                                     ; Long version of CBEQX
  449                                     
  450                                     cjeqx               macro     #operand,target
  451                                               #ifparm ~2~ = *
  452                                                         mset      2,{*}
  453                                               #endif
  454                                                         cbeqx     ~1~,Go$$$
  455                                                         bra       Done$$$
  456                                     Go$$$
  457                                                         jmp       ~2~
  458                                     Done$$$
  459                                                         endm
  460                                     
  461                                     ;*******************************************************************************
  462                                     ; Point HX to a TableEntry given its zero-based index, table address, and
  463                                     ; TableEntry bytesize.  Index is optional (in case it is already loaded in RegA)
  464                                     
  465                                     TblOfs              macro     [[#]Index],[#]Table,[#]TableEntrySize
  466                                                         mreq      2,3:[[#]Index],[#]Table,[#]TableEntrySize
  467                                               #ifnb ~1~
  468                                                         @@_size_, ~1~ 1
  469                                               #endif
  470                                                         @@_size_, ~3~ 1
  471                                                         @@_not_x_ ~2~
  472                                                         #push
  473                                                         #spauto   :sp
  474                                                         psha
  475                                                         @@_lda_   ~1~                 ;A = index
  476                                                         #temp
  477                                               #ifparm ~3.1.1~ = #                     ;;special case optimization
  478                                                 #!if ~#3~ = 1                         ;;for defined immediate of size 1
  479                                                         #temp     1                   ;mark action taken
  480                                                 #endif
  481                                                 #ifnum ~#3~                           ;;for numeric immediate
  482                                                   #if ~#3~ = 1                        ;;of size 1
  483                                                         #temp     1                   ;mark action taken
  484                                                   #endif
  485                                                 #endif
  486                                               #endif
  487                                               #ifz :temp
  488                                                         ldx       ~3~                 ;X = bytesize of TableEntry
  489                                                         mul                           ;XA = offset into table
  490                                                         add       ~[2.-2]~
  491                                                         xgax
  492                                               #else
  493                                                         add       ~[2.-2]~            ;XA = offset into table
  494                                                         tax
  495                                                         clra
  496                                               #endif
  497                                                         adc       ~[2.-1]~
  498                                                         tah                           ;HX -> TableEntry
  499                                                         pula
  500                                                         #pull
  501                                                         endm
  502                                     
  503                                     ;*******************************************************************************
  504                                     ; Macro to use XRAM if XRAM has been defined, RAM otherwise
  505                                     
  506                                     XRAM                macro
  507                                                         #RAM
  508                                               #ifdef XRAM
  509                                                         #XRAM
  510                                               #endif
  511                                                         endm
  512                                     
  513                                     ;*******************************************************************************
  514                                     ; Macro to define TASK_STACK_SIZE based on which RAM is used for stack
  515                                     
  516                                     FixTaskStackSize    macro     MinimumTaskStackSizeConstant
  517                                               #ifndef _MTOS_
  518                                                         #Hint     ~0~ only useful under MTOS, ignored
  519                                                         mexit
  520                                               #endif
  521                                                         mdef      1,REQUIRED_STACK
  522                                                         #temp     MAXTASKS
  523                                               #ifdef MY_MAXTASKS
  524                                                         #temp     MY_MAXTASKS
  525                                               #endif
  526                                               #!if STACKTOP > XRAM
  527                                     TASK_STACK_SIZE     def       XRAM_END-:XRAM/:temp
  528                                               #endif
  529                                     TASK_STACK_SIZE     def       RAM_END-:RAM/:temp
  530                                                         #Message  TASK_STACK_SIZE = {TASK_STACK_SIZE} byte(s) per task
  531                                               #!if TASK_STACK_SIZE < ~1~
  532                                                         #Warning  TASK_STACK_SIZE ({TASK_STACK_SIZE}) too low (<{~1~})
  533                                               #endif
  534                                                         endm
  535                                     
  536                                     ;*******************************************************************************
  537                                     ; EQU but it also copies the size of the original label
  538                                     ; (a single label is expected as parameter, no expressions)
  539                                     
  540                                     equ                 macro     Label
  541                                                         mset      #
  542                                                         mreq      1:Label @~0~ Label
  543                                                         mset      0,Label expected, found
  544                                               #ifnum ~1~
  545                                                         mstop     ~text~ number (~1~)
  546                                               #endif
  547                                               #ifstr ~1~
  548                                                         mstop     ~text~ string (~1~)
  549                                               #endif
  550                                               #ifnb ~'()[]+-*/\,<>^&|'2~
  551                                                         mstop     ~text~ expr (~1~)
  552                                               #endif
  553                                     ~label~             set       ~1~,::~1~
  554                                                         endm
  555                                     
  556                                     ;*******************************************************************************
  557                                     ; Macro to allocate a variable to #RAM or #XRAM (if XRAM defined) based on size
  558                                     ; [Smaller variables (upto LONG size) go into #RAM, everything else into #XRAM]
  559                                     
  560                                     Var                 macro     Size[,MaxSizeForRAM]
  561                                               #ifnb ~2~
  562                                                         mset      0,~2~               ;;set new MaxSizeForRAM default
  563                                                 #ifb ~1~
  564                                                         mexit                         ;;special case only to define MaxSizeForRAM
  565                                                 #endif
  566                                               #endif
  567                                                         mdef      0,4                 ;;startup MaxSizeForRAM default
  568                                                         #push
  569                                                         #RAM
  570                                               #ifdef XRAM                             ;;when XRAM is defined
  571                                                 #if ~#1~ > ~text~                     ;;anything above ~TEXT~ goes to XRAM
  572                                                         #XRAM
  573                                                 #else if :RAM+~#1~ > RAM_END          ;;if RAM is full or not enough, use XRAM
  574                                                         #XRAM
  575                                                 #endif
  576                                               #endif
  577                                     ~label~             set       *,~1~
  578                                                         rmb       ~1~
  579                                                         #pull
  580                                                         endm
  581                                     
  582                                     ;*******************************************************************************
  583                                     ; Repeat a number of instructions a constant number of times
  584                                     ; Example:          @rep      2,lsla,rolx         ;shift left XA twice
  585                                     
  586                                     Rep                 macro     Times,Instruction1[,Instruction2]*
  587                                         #if :n = 1                                    ;;block follows macro
  588                                                         mset      #
  589                                                         mreq      1:Times
  590                                                         #push
  591                                                         #spauto   :sp
  592                                               #if ::~1,~ <= 1
  593                                                         psha                          ;;protect user's A
  594                                                         lda       ~1~                 ;;A = counter value
  595                                     Loop$$$             psha                          ;;save current counter
  596                                                         lda       2,asp               ;;A = user's A
  597                                                         msuspend                      ;;run user code
  598                                                         sta       2,asp               ;;save user's A for later
  599                                                         pula                          ;;restore current counter
  600                                                         dbnza     Loop$$$             ;;one less iteration to go
  601                                                         pula                          ;;restore user's A
  602                                               #else if ::~1,~ = 2
  603                                                         pshhx                         ;;protect user's A
  604                                                         ldhx      ~1~                 ;;HX = counter value
  605                                     Loop$$$             pshhx                         ;;save current counter
  606                                                         ldhx      3,asp               ;;HX = user's HX
  607                                                         msuspend                      ;;run user code
  608                                                         sthx      3,asp               ;;save user's HX for later
  609                                                         pulhx                         ;;restore current counter
  610                                                         aix       #-1                 ;;one less iteration to go
  611                                                         cphx      #0
  612                                                         bne       Loop$$$
  613                                                         pulhx                         ;;restore user's HX
  614                                               #else
  615                                                         merror    Unsupported control variable size (~1~: {::~1,~})
  616                                               #endif
  617                                                         #pull
  618                                                         mexit
  619                                         #endif
  620                                                         mreq      1,2:Times,Instruction1[,Instruction2]*
  621                                               #ifz ~1~
  622                                                         mexit                         ;;nothing to do
  623                                               #endif
  624                                                         mdo       2
  625                                               #ifparm ~{:mloop}.1.2~ = @@             ;;convert @@macro to @macro
  626                                                         mset      :mloop,~{:mloop}.2~
  627                                               #endif
  628                                               #ifparm ~{:mloop}.1.1~ = @              ;;convert @macro to @@macro
  629                                                         mset      :mloop,@~{:mloop}.~
  630                                               #endif
  631                                                         ~{:mloop}.~
  632                                                         mloop     :n
  633                                                         mtop      ~1~
  634                                                         endm
  635                                     
  636                                     ;*******************************************************************************
  637                                     ; Macro to define local variables (var@@) for an SPAUTO based subroutine
  638                                     ; Format is name[space]bytesize
  639                                     ; (If bytesize not present, size ONE is assumed for all except for pointers.
  640                                     ; By my convention pointer names begin with a point/dot [e.g., .buffer is a
  641                                     ; pointer to 'buffer'].  In this case, the default bytesize is TWO)
  642                                     
  643                                     Local               macro
  644                                                         mreq      1:Name n[,Name n]*
  645                                                         @@_needs_spauto_
  646                                               ;;--------------------------------------------------------------------
  647                                               ;;count total parameters size while formatting as Label<space>Size
  648                                               ;;--------------------------------------------------------------------
  649                                                         #temp
  650                                                         mdo
  651                                               #ifb ~{:mloop}' '2~
  652                                                 #ifparm ~{:mloop}.1.1~ = .
  653                                                         mset      :mloop,~{:mloop}.~ 2          ;;append default pointer size of two
  654                                                 #else
  655                                                         mset      :mloop,~{:mloop}.~ 1          ;;append default data size of one
  656                                                 #endif
  657                                               #endif
  658                                               #ifnonum ~{:mloop}' '2~
  659                                                 #ifndef ~{:mloop}' '2~
  660                                                         merror    Parm {:mloop} \@~{:mloop}' '2~\@ not label[ size]
  661                                                 #endif
  662                                               #endif
  663                                                         #temp     :temp+~{:mloop}' '2~
  664                                               #if :temp > 127
  665                                                         merror    Too much RAM ({:temp}) for locals @{:mloop}
  666                                               #endif
  667                                                         mloop     :n
  668                                               ;;--------------------------------------------------------------------
  669                                               ;;create local structure
  670                                               ;;--------------------------------------------------------------------
  671                                                         #push
  672                                                         ais       #-{:temp}
  673                                                         #pull
  674                                                         #spadd    :temp
  675                                                         #temp     ::
  676                                                         mdo
  677                                               #ifparm ~{:mloop}.1.1~ = ?
  678                                     ~{:mloop}' '~       next      :temp,~{:mloop}' '2~  ;;define file local variable
  679                                               #else
  680                                     ~{:mloop}' '~@@     next      :temp,~{:mloop}' '2~  ;;define proc local variable
  681                                               #endif
  682                                                         mloop     :n
  683                                                         mexit     :ais                ;;return size in :MEXIT
  684                                                         endm
  685                                     
  686                                     ;*******************************************************************************
  687                                     ; Macro to define parameters (var@@) passed into an SPAUTO based subroutine
  688                                     ; Format is name[space]bytesize
  689                                     ; (If bytesize not present, size ONE is assumed for all except for pointers.
  690                                     ; By my convention pointer names begin with a point/dot [e.g., .buffer is a
  691                                     ; pointer to 'buffer'].  In this case, the default bytesize is TWO)
  692                                     
  693                                     Parms               macro
  694                                                         mreq      1:Name n[,Name n]*
  695                                                         @@_needs_spauto_
  696                                               ;;--------------------------------------------------------------------
  697                                               ;;Format parameter(s) as Label<space>Size
  698                                               ;;--------------------------------------------------------------------
  699                                                         mdo
  700                                               #ifb ~{:mloop}' '2~
  701                                                 #ifparm ~{:mloop}.1.1~ = .
  702                                                         mset      :mloop,~{:mloop}.~ 2          ;;append default pointer size of two
  703                                                 #else
  704                                                         mset      :mloop,~{:mloop}.~ 1          ;;append default data size of one
  705                                                 #endif
  706                                               #endif
  707                                               #ifnonum ~{:mloop}' '2~
  708                                                 #ifndef ~{:mloop}' '2~
  709                                                         merror    Parm {:mloop} \@~{:mloop}' '2~\@ not label[ size]
  710                                                 #endif
  711                                               #endif
  712                                                         mloop     :n
  713                                               ;;--------------------------------------------------------------------
  714                                               ;;define structure
  715                                               ;;--------------------------------------------------------------------
  716                                                         #temp     1
  717                                                         mdo
  718                                               #ifparm ~{:mloop}.1.1~ = ?
  719                                     ~{:mloop}' '~       next      :temp,~{:mloop}' '2~  ;;define user parameter (file-local)
  720                                               #else
  721                                     ~{:mloop}' '~@@     next      :temp,~{:mloop}' '2~  ;;define user parameter (proc-local)
  722                                               #endif
  723                                                         mloop     :n
  724                                                         mexit     :temp-1             ;;return size in :MEXIT
  725                                                         endm
  726                                     
  727                                     ;*******************************************************************************
  728                                     ; Check if we're in SPAUTO mode, and issue a warning if not
  729                                     
  730                                     _needs_spauto_      macro
  731                                               #ifspauto
  732                                                         mexit
  733                                               #endif
  734                                                         mstop     #SPAUTO mode required
  735                                                         endm
  736                                     
  737                                     ;*******************************************************************************
  738                                     ; Checks the passed parameter and issues an error if it is X-indexed
  739                                     ; (This is meant to be called from other macros -- not to be called directly)
  740                                     
  741                                     _not_x_             macro
  742                                                         mset      #
  743                                               #ifb ~1~
  744                                                         mexit                         ;;nothing to do
  745                                               #endif
  746                                               #ifparm ~'~,1~'.{:1}~ = x
  747                                                         mstop     X-index not allowed (~1~)
  748                                               #endif
  749                                                         endm
  750                                     
  751                                     ;*******************************************************************************
  752                                     ; Checks the passed parameter and issues an error if it is immediate mode
  753                                     ; (This is meant to be called from other macros -- not to be called directly)
  754                                     
  755                                     _not_#_             macro
  756                                               #ifb ~1~
  757                                                         mexit                         ;;nothing to do
  758                                               #endif
  759                                               #ifparm ~#~
  760                                                         mstop     Immediate mode not allowed (~1~)
  761                                               #endif
  762                                                         endm
  763                                     
  764                                     ;*******************************************************************************
  765                                     ; Checks the passed parameter and issues an error if it is NOT immediate mode
  766                                     ; (This is meant to be called from other macros -- not to be called directly)
  767                                     
  768                                     _#_                 macro
  769                                               #ifb ~1~
  770                                                         mexit                         ;;nothing to do
  771                                               #endif
  772                                               #ifb ~#~
  773                                                         mstop     Immediate mode expected (~1~)
  774                                               #endif
  775                                                         endm
  776                                     
  777                                     ;*******************************************************************************
  778                                     ; Check if no size info exists for give symbol (parameter)
  779                                     
  780                                     _nosize_            macro
  781                                                         mset      #
  782                                                         mset      0,mstop [~00~] No size (~1~)
  783                                               #ifnb ~#~
  784                                                         ~text~ [immediate]
  785                                               #endif
  786                                               #ifb ~1,~
  787                                                         ~text~ [blank]
  788                                               #endif
  789                                               #ifnum ~1,~
  790                                                         ~text~ [numeric]
  791                                               #endif
  792                                               #ifndef ~1,~
  793                                                         ~text~ [undefined]
  794                                               #endif
  795                                               #ifz ::~1,~
  796                                                         ~text~ [constant]
  797                                               #endif
  798                                                         endm
  799                                     
  800                                     ;*******************************************************************************
  801                                     ; Check if all given non-immediate mode operands have the same size
  802                                     ; (Skip immediate mode ones, and constants -- labels with size zero)
  803                                     ; (This is meant to be called from other macros -- not to be called directly)
  804                                     
  805                                     _samesize_          macro     Operand1,Operand2[,Operand]*
  806                                                         mreq      1,2:Operand1,Operand2[,Operand]*
  807                                                         mset      0
  808                                                         mdo
  809                                                         mswap     1,{:mloop}
  810                                               #ifb ~#~
  811                                                 #ifnb ~1,~
  812                                                         @@_nosize_ ~1~
  813                                                   #ifb ~text~
  814                                                         mset      0,~1~
  815                                                   #endif
  816                                                   #if ::~text,~ <> ::~1,~
  817                                                         mstop     \@~text~\@ ({::~text,~}) size <> \@~1~\@ ({::~1,~})
  818                                                   #endif
  819                                                 #endif
  820                                               #endif
  821                                                         mloop     :n
  822                                                         endm
  823                                     
  824                                     ;*******************************************************************************
  825                                     ; Check if size exists, and optionally if it is one of the expected ones
  826                                     ; (This is meant to be called from other macros -- not to be called directly)
  827                                     
  828                                     _size_              macro     Label[,ExpectedSize]*
  829                                               #ifparm ~#~
  830                                                         mexit                         ;;ignore for immediate mode
  831                                               #endif
  832                                                         @@_nosize_ ~1~
  833                                                         mdo       2
  834                                               #ifnb ~{:mloop}.~
  835                                                 #if ::~1,~ = ~{:mloop}.~
  836                                                         mexit
  837                                                 #endif
  838                                               #endif
  839                                                         mloop     :n
  840                                                         mswap     0,1
  841                                                         mdel      1
  842                                                         mset      #
  843                                               #ifnb ~1~
  844                                                         mstop     \@~text,~\@ size is {::~text,~}, expected ~1~
  845                                               #endif
  846                                                         endm
  847                                     
  848                                     ;*******************************************************************************
  849                                     ; Reload HX from RegHx location if the parm specified is X-indexed
  850                                     ; If RegHX location is not specified, the previous one will be used (or error).
  851                                     ; Finally, load HX from the referenced location, regardless of addressing mode.
  852                                     ; (This is meant to be called from other macros -- not to be called directly)
  853                                     
  854                                     _ldhx_              macro     Parm[,RegHX]
  855                                                         mreq      1:Parm[,RegHX]
  856                                                         mdef      2,~text~
  857                                                         mset      0,~2~               ;;use this as new default
  858                                               #ifb ~2~
  859                                                         merror    RegHX location is needed 1st time
  860                                               #endif
  861                                               #ifnoparm ~,1~ = ,spx                   ;except for SPX mode ...
  862                                               #ifparm ~'~,1~'.{:1}~ = x               ;for any X-indexed mode
  863                                                         ldhx      ~2~                 ;reload original HX
  864                                               #endif
  865                                               #endif
  866                                                         @lea      ~1~                 ;load actual parameter
  867                                                         endm
  868                                     
  869                                     ;*******************************************************************************
  870                                     ; Optional LDA: Do a LDA instruction but only if the parameter is non-blank
  871                                     ; (This is meant to be called from other macros -- not to be called directly)
  872                                     
  873                                     _lda_               macro
  874                                                         mset      #
  875                                               #ifb ~1~
  876                                                         mexit
  877                                               #endif
  878                                               #ifparm ~#~
  879                                                 #!ifz ~#1~
  880                                                         clra
  881                                                         mexit
  882                                                 #endif
  883                                               #endif
  884                                                         lda       ~1~
  885                                                         endm
  886                                     
  887                                     ;*******************************************************************************
  888                                     ; Optional STA: Do a STA instruction but only if the parameter is non-blank
  889                                     ; (This is meant to be called from other macros -- not to be called directly)
  890                                     
  891                                     _sta_               macro
  892                                               #ifnb ~@~
  893                                                         sta       ~@~
  894                                               #endif
  895                                                         endm
  896                                     
  897                                     ;*******************************************************************************
  898                                     ; LDA & CMP combo but it optimizes LDA to CLRA
  899                                     ; (This is meant to be called from other macros, but it may be called directly)
  900                                     
  901                                     _ldacmp_            macro     [#]Operand1,[#]Operand2
  902                                               #ifparm ~#~
  903                                               #ifdef ~#1~
  904                                                         mset      1,~#~{~#1~}
  905                                               #endif
  906                                               #endif
  907                                               #ifparm ~1~ = #0
  908                                                         clra
  909                                               #else
  910                                                         lda       ~1~
  911                                               #endif
  912                                                         mswap     1,2
  913                                               #ifparm ~#~
  914                                               #ifdef ~#1~
  915                                                         mset      1,~#~{~#1~}
  916                                               #endif
  917                                               #endif
  918                                                         cmpa      ~1~                 ;;needed even when #0 to adjust Carry
  919                                                         endm
  920                                     
  921                                     ;*******************************************************************************
  922                                     ; Swap two byte-size variables (does not protect RegA) - Primitive macro
  923                                     ; (This is meant to be called from other macros, but it may be called directly)
  924                                     
  925                                     _swap_              macro     Variable1 Variable2
  926                                                         mset      #' '
  927                                                         #push
  928                                                         #spauto   :sp
  929                                                         lda       ~1~
  930                                                         psha
  931                                                         lda       ~2~
  932                                                         sta       ~1~
  933                                                         pula
  934                                                         sta       ~2~
  935                                                         #pull
  936                                                         endm
  937                                     
  938                                     ;*******************************************************************************
  939                                     ; Swap two same-size variables
  940                                     
  941                                     swap.s              macro     Variable1 Variable2
  942                                                         mset      #' '
  943                                                         mreq      1,2:Variable1 Variable2
  944                                                         @@_samesize_ ~@~
  945                                                         #push
  946                                                         #spauto   :sp
  947                                                         psha
  948                                                         mdo
  949                                                         @@_swap_  ~1,~+{:mloop-1}~,1~ ~2,~+{:mloop-1}~,2~
  950                                                         mloop     ::~1,~
  951                                                         pula
  952                                                         #pull
  953                                                         endm
  954                                     
  955                                     ;*******************************************************************************
  956                                     ; Defines the PullUp Enable label to the left for the given port parameter
  957                                     
  958                                     PUE                 macro     PortLabel
  959                                                         mdef      0,ABCDEFGHIJKLMNOPQRSTUVWXYZ
  960                                               #!if PORT~text.{:loop}.1~ = ~1~
  961                                     ~label~             set       PT~text.{:loop}.1~PUE
  962                                                         mexit
  963                                               #endif
  964                                                         mtop      :text
  965                                                         #Undef    ~label~
  966                                                         merror    \@~1~\@ does not match any port
  967                                                         endm
  968                                     
  969                                     ;*******************************************************************************
  970                                     ; Get A from the location pointed to by the parm, while bumping up that pointer
  971                                     
  972                                     GetNextA            macro     Pointer
  973                                                         mreq      1:Pointer
  974                                               #ifparm ~#~
  975                                                         mstop     Pointer (~1~) must be a word variable
  976                                               #endif
  977                                                         @@_not_x_ ~@~
  978                                               #ifhcs
  979                                                         ldhx      ~@~
  980                                                         lda       ,x
  981                                                         aix       #1
  982                                                         sthx      ~@~
  983                                               #else
  984                                                         #push
  985                                                         #spauto   :sp
  986                                                         ldx       ~@~
  987                                                         pshx
  988                                                         ldx       ~1,~+1~,1~,~2~
  989                                                         pulh
  990                                                         lda       ,x
  991                                                         aix       #1
  992                                                         stx       ~1,~+1~,1~,~2~
  993                                                         pshx
  994                                                         thx
  995                                                         stx       ~@~
  996                                                         pulx
  997                                                         #pull
  998                                               #endif
  999                                                         endm
 1000                                     
 1001                                     ;*******************************************************************************
 1002                                     ; Put A into the location pointed to by the parm, while bumping up that pointer
 1003                                     
 1004                                     PutNextA            macro     Pointer
 1005                                                         mreq      1:Pointer
 1006                                               #ifparm ~#~
 1007                                                         mstop     Pointer (~1~) must be a word variable
 1008                                               #endif
 1009                                                         @@_not_x_ ~@~
 1010                                               #ifhcs
 1011                                                         ldhx      ~@~
 1012                                                         sta       ,x
 1013                                                         aix       #1
 1014                                                         sthx      ~@~
 1015                                               #else
 1016                                                         #push
 1017                                                         #spauto   :sp
 1018                                                         ldx       ~@~
 1019                                                         pshx
 1020                                                         ldx       ~1,~+1~,1~,~2~
 1021                                                         pulh
 1022                                                         sta       ,x
 1023                                                         aix       #1
 1024                                                         stx       ~1,~+1~,1~,~2~
 1025                                                         pshx
 1026                                                         thx
 1027                                                         stx       ~@~
 1028                                                         pulx
 1029                                                         #pull
 1030                                               #endif
 1031                                                         endm
 1032                                     
 1033                                     ;*******************************************************************************
 1034                                     ; AIX but only for non-zero values.  Transparent in #MCF mode.
 1035                                     ; Automatically splits offset into as many AIX as needed.  If the number of
 1036                                     ; bytes required is bigger than ADDHX size, it uses a single ADDHX instead.
 1037                                     
 1038                                     aix                 macro   #OffsetConstant
 1039                                               #ifz ~#1~
 1040                                                         mexit
 1041                                               #endif
 1042                                          #if ~#1~ < 0
 1043                                               #if ~#1~ >= -768
 1044                                               #ifnz ~#1~/128
 1045                                                         !aix:{~#1~/128^$FF+1&$FF} #-128  ;same as aix:-(~1~/128) #-128
 1046                                               #endif
 1047                                               #ifnz ~#1~\128
 1048                                                         !aix      #{~#1~\128}
 1049                                               #endif
 1050                                                         mexit
 1051                                               #endif
 1052                                                         addhx     #~#1~
 1053                                                         mexit
 1054                                          #endif
 1055                                               #if ~#1~ <= 762
 1056                                               #ifnz ~#1~/127
 1057                                                         !aix:{~#1~/127} #127
 1058                                               #endif
 1059                                               #ifnz ~#1~\127
 1060                                                         !aix      #{~#1~\127}
 1061                                               #endif
 1062                                                         mexit
 1063                                               #endif
 1064                                                         addhx     #~#1~
 1065                                                         endm
 1066                                     
 1067                                     ;*******************************************************************************
 1068                                     ; Make HX point to given stack element (only when in #SP[AUTO] modes)
 1069                                     
 1070                                     StackPtr            macro     StackLabel
 1071                                                         mreq      1:StackLabel
 1072                                               #ifnz ~#1~+:tsx
 1073                                                         !aix      #~#1~+:tsx
 1074                                               #endif
 1075                                                         endm
 1076                                     
 1077                                     ;*******************************************************************************
 1078                                     ; Load Effective Address in RegHX
 1079                                     
 1080                                     lea                 macro
 1081                                                         mset      #
 1082                                               #ifb ~1~
 1083                                                         mexit                         ;;no parm, nothing to do
 1084                                               #endif
 1085                                               #ifparm ~#~
 1086                                                         ldhx      ~1~                 ;;immediate value load as is
 1087                                                         mexit
 1088                                               #endif
 1089                                               #ifparm ~1.1.1~ = .                     ;;dot-beginning symbols treat as pointers
 1090                                                 #ifhcs
 1091                                                         ldhx      ~1~
 1092                                                 #else
 1093                                                         psha
 1094                                                         lda       ~[1.-1]~
 1095                                                         psha
 1096                                                         ldx       ~[1.-2]~
 1097                                                         pulh
 1098                                                         pula
 1099                                                 #endif
 1100                                                         mexit
 1101                                               #endif
 1102                                               #ifparm ~1.1.2~ = ?.                    ;;dot-beginning file-local symbols treat as pointers
 1103                                                 #ifhcs
 1104                                                         ldhx      ~1~
 1105                                                 #else
 1106                                                         psha
 1107                                                         lda       ~[1.-1]~
 1108                                                         psha
 1109                                                         ldx       ~[1.-2]~
 1110                                                         pulh
 1111                                                         pula
 1112                                                 #endif
 1113                                                         mexit
 1114                                               #endif
 1115                                         #ifparm ~,1~                                  ;;indexed modes
 1116                                               #ifparm ~,1~ = ,sp                      ;;SP case treat specially
 1117                                                         tsx
 1118                                                   #ifnz ~1,~+:tsx
 1119                                                         !aix      #~1,~+:tsx
 1120                                                   #endif
 1121                                                         mexit
 1122                                               #endif
 1123                                               #ifparm ~,1~ = ,spx                     ;;SPX case treat specially
 1124                                                         tsx
 1125                                                   #ifnz ~1,~+:tsx
 1126                                                         !aix      #~1,~+:tsx
 1127                                                   #endif
 1128                                                         mexit
 1129                                               #endif
 1130                                               #ifparm ~,1~ = ,psp                     ;;PSP case treat specially
 1131                                                         tsx
 1132                                                   #ifnz ~1,~+{:psp-1}
 1133                                                         !aix      #~1,~+{:psp-1}
 1134                                                   #endif
 1135                                                         mexit
 1136                                               #endif
 1137                                               #ifparm ~,1~ = ,x
 1138                                                 #ifnb ~1,~
 1139                                                         @aix      #~1,~               ;;X-indexed add possible offset
 1140                                                 #endif
 1141                                                         mexit
 1142                                               #endif
 1143                                               #ifparm ~,1~ = ,ax
 1144                                                 #ifnb ~1,~
 1145                                                         @aix      #~1,~               ;;X-indexed add possible offset
 1146                                                 #endif
 1147                                                         mexit
 1148                                               #endif
 1149                                                 #ifhcs
 1150                                                         ldhx      ~1~                 ;;any other index treat as pointer (regardless of name convention)
 1151                                                 #else
 1152                                                         psha
 1153                                                         lda       ~[1.-1]~
 1154                                                         psha
 1155                                                         ldx       ~[1.-2]~
 1156                                                         pulh
 1157                                                         pula
 1158                                                 #endif
 1159                                                         mexit
 1160                                         #endif
 1161                                                         ldhx      #~1~                ;;everything else is fixed RAM
 1162                                                         endm
 1163                                     
 1164                                     ;*******************************************************************************
 1165                                     ; Find the Greatest Common Divisor (GCD) of two constants.
 1166                                     ; Answer is placed in LABEL (if present) and :MEXIT variable
 1167                                     
 1168                                     gcd                 macro     a,b
 1169                                               #ifz ~1~
 1170                                                         mexit     1
 1171                                               #endif
 1172                                               #ifz ~2~
 1173                                                         mexit     1
 1174                                               #endif
 1175                                               #if ~1~ = ~2~
 1176                                                   #ifparm ~label~
 1177                                     ~label~             set       ~1~
 1178                                                   #endif
 1179                                                         mexit     ~1~
 1180                                               #endif
 1181                                               #if ~1~ > ~2~
 1182                                                         mset      1,{~1~-{~2~}}
 1183                                                         mtop
 1184                                               #endif
 1185                                                         mset      2,{~2~-{~1~}}
 1186                                                         mtop
 1187                                                         endm
 1188                                     
 1189                                     ;*******************************************************************************
 1190                                     ; Find the Least Common Multiple (LCM) of two constants. Prerequisite macro: GCD
 1191                                     ; Note: To avoid overflow, first divides, then multiplies. GCD certainly divides
 1192                                     ;       both numbers, so no problem doing so, and it's more efficient.
 1193                                     ;       Answer is placed in LABEL (if present) and :MEXIT variable
 1194                                     
 1195                                     lcm                 macro     a,b
 1196                                                         @@gcd     ~@~
 1197                                               #ifparm ~label~
 1198                                     ~label~             set       {~1~}/:mexit*{~2~}
 1199                                               #endif
 1200                                                         mexit     {~1~}/:mexit*{~2~}
 1201                                                         endm
 1202                                     
 1203                                     ;*******************************************************************************
 1204                                     ; Allows easy marking of any incomplete sections of code to be looked after at
 1205                                     ; a later time (usually, during development)
 1206                                     ; Define the symbol '...' to have hints display for each use of the macro
 1207                                     
 1208                                     ...                 macro     Optional message
 1209                                                         nop                           ;;avoids branch warnings
 1210                                                         #Memory   *-1                 ;;and removes possible warning
 1211                                               #ifdef ...
 1212                                                         mset      #
 1213                                                 #ifb ~1~
 1214                                                         mset      1,\@~procname~\@ is incomplete
 1215                                                 #else
 1216                                                         mset      1,\@~procname~\@: ~1~
 1217                                                 #endif
 1218                                                         #Hint     ~1~
 1219                                               #endif
 1220                                                         endm
 1221                                     
 1222                                     ;*******************************************************************************
 1223                                     ; Vector assignment
 1224                                     ; (Places vector in #VECTORS segment, then returns to current segment)
 1225                                     
 1226                                     Vector              macro     Vvector,ISR_Address
 1227                                               #ifb ~2~
 1228                                                 #ifndef ~1~
 1229                                                         mexit                         ;avoids error on empty but undefined vectors
 1230                                                 #endif
 1231                                               #endif
 1232                                                         mdef      2,AnRTI
 1233                                                         #push
 1234                                                         #VECTORS
 1235                                                         #ppc
 1236                                               #ifdef OS8PRELOADED&RVECTORS
 1237                                                         org       ~1~-VECTORS+RVECTORS
 1238                                               #else
 1239                                                         org       ~1~
 1240                                               #endif
 1241                                                         dw        ~2~
 1242                                                         org       :ppc
 1243                                                         #pull
 1244                                                         endm
 1245                                     
 1246                                     ;*******************************************************************************
 1247                                     ; PUSH any variable onto the stack. If 'newname' given the variable will then be
 1248                                     ; assigned the name inside the string.
 1249                                     ; Constants require a size as it cannot be determined automatically.
 1250                                     ; (All registers may be destroyed)
 1251                                     
 1252                                     PushV               macro     variable[ SizeOf(var)][ 'newname']
 1253                                                         mset      #' '
 1254                                                         mset      0                   ;;cancel any stack names
 1255                                                         mreq      1:variable[ SizeOf(var)][ 'newname']
 1256                                               #ifstr ~{:nn}.~                         ;;if last parm is a string
 1257                                                         mset      0,~{:nn}.~          ;;it is the stack name
 1258                                                         mset      0,~text.2.{:text-2}~ ;;after removing quotes
 1259                                                         mdel      :nn                 ;;parm no longer needed
 1260                                               #endif
 1261                                               #ifnb ~#~                               ;;immediate mode
 1262                                                         mreq      1,2:Constant SizeOf(Constant)
 1263                                                 #if ~2~ < 0
 1264                                                         merror    Negative size (~1~): ~2~
 1265                                                 #endif
 1266                                                         #ifnb ~text~
 1267                                                         mset      0,~text~,~2~
 1268                                                         #endif
 1269                                                         #temp
 1270                                                         mdo
 1271                                                 #ifz ~#1~>{:mloop-1*8}&$FF
 1272                                                   #ifz :temp
 1273                                                         #temp     1
 1274                                                         clra
 1275                                                   #endif
 1276                                                 #else
 1277                                                         #temp
 1278                                                         lda       ~1~>{:mloop-1*8}&$FF
 1279                                                 #endif
 1280                                                 #if :mloop = ~2~
 1281                                                         psha      ~text~
 1282                                                 #else
 1283                                                         psha
 1284                                                 #endif
 1285                                                         mloop     ~2~
 1286                                                 #if ~#1~ >= 0
 1287                                                   #ifnz ~#1~>{:mloop*8}
 1288                                                         merror    Constant ~#1~ ({~#1~}) bigger than ~2~ byte(s)
 1289                                                   #endif
 1290                                                 #else
 1291                                                   #ifnz -{~#1~(h)}>{:mloop*8-1}
 1292                                                         merror    Constant ~#1~ ({~#1~}) bigger than ~2~ byte(s)
 1293                                                   #endif
 1294                                                 #endif
 1295                                                         #Message  ~0~ ~1~ ({~2~*8}-bit)
 1296                                                         mexit
 1297                                               #endif
 1298                                               #ifnb ~1,~
 1299                                                 #ifnz ::~1,~
 1300                                                         mdef      2,{::~1,~}
 1301                                                 #endif
 1302                                               #endif
 1303                                                         mdef      2,1
 1304                                               #if ~2~ < 0
 1305                                                         merror    Negative size (~1~): ~2~
 1306                                               #endif
 1307                                                         #Message  ~0~ ~1~ ({~2~*8}-bit)
 1308                                                         #ifnb ~text~
 1309                                                         mset      0,~text~,~2~
 1310                                                         #endif
 1311                                               #if ~2~ = 1                             ;;single-byte variable case
 1312                                               #ifb ~1.1.1~ = .                        ;;but not for pointers
 1313                                                 #ifparm ~'~,1~'.1.3~ = ,sp            ;;for SP and SPX only
 1314                                                   #iftos ~1,~                         ;;if at TOS, special case
 1315                                                         pula                          ;;A = TOS value
 1316                                                         psha                          ;;put it back the way it was
 1317                                                         psha      ~text~
 1318                                                         mexit
 1319                                                   #endif
 1320                                                 #endif
 1321                                                         lda       ~1~
 1322                                                         psha      ~text~
 1323                                                         mexit
 1324                                               #endif
 1325                                               #endif
 1326                                                         #push                         ;;save current X offset etc.
 1327                                               #ifb ~,1~ = ,x                          ;;only if not X-indexed
 1328                                                         @@lea     ~1~                 ;;HX -> variable
 1329                                                         #x                            ;;zero X offsets
 1330                                               #else
 1331                                                         #x        ~1,~                ;;make use of offset
 1332                                               #endif
 1333                                                         mdo
 1334                                                         lda       {~2~-:mloop},x
 1335                                               #if :mloop = ~2~
 1336                                                         psha      ~text~
 1337                                               #else
 1338                                                         psha
 1339                                               #endif
 1340                                                         mloop     ~2~
 1341                                                         #pull                         ;;restore current X offset etc.
 1342                                               #ifspauto
 1343                                                         #spadd    ~2~                 ;;needed because of #PUSH/#PULL
 1344                                               #endif
 1345                                                         endm
 1346                                     
 1347                                     ;*******************************************************************************
 1348                                     ; PULL any variable from the stack. If size is missing, size one is assumed.
 1349                                     ; (All registers may be destroyed)
 1350                                     
 1351                                     PullV               macro     Variable[ SizeOf(Variable)]
 1352                                                         mset      #' '
 1353                                                         mreq      1:Variable[ SizeOf(Variable)]
 1354                                                         @@_not_#_ ~1~
 1355                                               #ifnz ::~1,~
 1356                                                         mdef      2,{::~1,~}
 1357                                               #endif
 1358                                                         mdef      2,1
 1359                                               #if ~2~ < 0
 1360                                                         merror    Negative size (~1~): ~2~
 1361                                               #endif
 1362                                                         #Message  ~0~ ~1~ ({~2~*8}-bit)
 1363                                               #if ~2~ = 1                             ;;single-byte variable case
 1364                                               #ifb ~1.1.1~ = .                        ;;but not for pointers
 1365                                                 #ifparm ~'~,1~'.1.3~ = ,sp            ;;for SP and SPX only
 1366                                                   #iftos ~1,~                         ;;if at TOS, special case
 1367                                                         mstop     ~0~ to same stack location!
 1368                                                   #endif
 1369                                                 #endif
 1370                                                         pula
 1371                                                         sta       ~1~
 1372                                                         mexit
 1373                                               #endif
 1374                                               #endif
 1375                                                         #push                         ;;save current X offset etc.
 1376                                               #ifb ~,1~ = ,x                          ;;only if not X-indexed
 1377                                                         @@lea     ~1~                 ;;HX -> variable
 1378                                                         #x                            ;;zero X offsets
 1379                                               #else
 1380                                                         #x        ~1,~                ;;make use of offset
 1381                                               #endif
 1382                                                         mdo
 1383                                                         pula
 1384                                                         sta       {:mloop-1},x
 1385                                                         mloop     ~2~
 1386                                                         #pull                         ;;restore current X offset etc.
 1387                                               #ifspauto
 1388                                                         #spadd    -~2~                ;;needed because of #PUSH/#PULL
 1389                                               #endif
 1390                                                         endm
 1391                                     
 1392                                     ;*******************************************************************************
 1393                                     ; A group of macros for use with any sized variable
 1394                                     ;*******************************************************************************
 1395                                     
 1396                                     ;*******************************************************************************
 1397                                     ; Clear any sized variable up to 256 bytes without preserving HX
 1398                                     
 1399                                     _ClrVar_            macro     Variable
 1400                                                         clrh
 1401                                                         ldx       #::~1~
 1402                                     Loop$$$             clr       ~1~-1,ax
 1403                                                         dbnzx     Loop$$$
 1404                                                         endm
 1405                                     
 1406                                     ;*******************************************************************************
 1407                                     ; Clear any sized variable
 1408                                     
 1409                                     ClrVar              macro     Variable
 1410                                                         mset      #
 1411                                                         mreq      1
 1412                                                         @@_nosize_ ~1~
 1413                                               #ifb ~,1~
 1414                                                         mset      1,~#1~
 1415                                                 #if ::~1,~ < 256
 1416                                                   #ifz ]{~1~-1}
 1417                                                         pshhx
 1418                                                         @@_ClrVar_ ~1~
 1419                                                         pulhx
 1420                                                         mexit
 1421                                                   #endif
 1422                                                         push
 1423                                                         clra
 1424                                                         ldhx      #::~1~
 1425                                     Loop$$$
 1426                                                         sta       ~1~-1,ax
 1427                                                         dbnzx     Loop$$$
 1428                                                         pull
 1429                                                         mexit
 1430                                                 #endif
 1431                                               #endif
 1432                                               #if ::~1,~ <= 8
 1433                                                 #ifnb ~,1~
 1434                                                         @clr.s    ~1~
 1435                                                         mexit
 1436                                                 #endif
 1437                                               #endif
 1438                                                         #push
 1439                                                         #spauto   :sp
 1440                                                         push
 1441                                                         lda       #::~1,~
 1442                                                         @@lea     ~1~
 1443                                     Loop$$$
 1444                                                         clr       ,ax
 1445                                                         aix       #1
 1446                                                         dbnza     Loop$$$
 1447                                                         pull
 1448                                                         #pull
 1449                                                         endm
 1450                                     
 1451                                     ;*******************************************************************************
 1452                                     ; Test for zero for any sized variable
 1453                                     
 1454                                     zero?.s             macro     Variable
 1455                                                         mset      #
 1456                                                         mreq      1
 1457                                                         @@_nosize_ ~1~
 1458                                                         mdo
 1459                                               #if :mloop = 1
 1460                                                         lda       ~1,~+{:mloop-1}~,1~
 1461                                               #else
 1462                                                         ora       ~1,~+{:mloop-1}~,1~
 1463                                               #endif
 1464                                                         mloop     ::~1,~
 1465                                                         endm
 1466                                     
 1467                                     ;*******************************************************************************
 1468                                     ; CLR for any sized variable
 1469                                     
 1470                                     clr.s               macro     Variable
 1471                                                         mset      #
 1472                                                         mreq      1
 1473                                                         @@_nosize_ ~1~
 1474                                               #ifb ~,1~
 1475                                               #ifnz ]~1~
 1476                                                         #push
 1477                                                         #spauto   :sp
 1478                                                         psha
 1479                                                         clra
 1480                                                         mdo
 1481                                                         sta       ~1,~+{:mloop-1}~,1~
 1482                                                         mloop     {::~1,~}
 1483                                                         pula
 1484                                                         #pull
 1485                                                         mexit
 1486                                               #endif
 1487                                               #endif
 1488                                                         mdo
 1489                                                         clr       ~1,~+{:mloop-1}~,1~
 1490                                                         mloop     ::~1,~
 1491                                                         endm
 1492                                     
 1493                                     ;*******************************************************************************
 1494                                     ; INC for any sized variable
 1495                                     
 1496                                     inc.s               macro     Variable
 1497                                                         mset      #
 1498                                                         mreq      1
 1499                                                         @@_nosize_ ~1~
 1500                                                         mdo
 1501                                                         inc       ~1,~+{::~1,~-:mloop}~,1~
 1502                                               #if :mloop <> ::~1,~
 1503                                                         bne       Done$$$
 1504                                               #endif
 1505                                                         mloop     ::~1,~
 1506                                     Done$$$
 1507                                                         endm
 1508                                     
 1509                                     ;*******************************************************************************
 1510                                     ; DEC (simulation) for any sized variable.
 1511                                     
 1512                                     dec.s               macro     Variable
 1513                                                         mset      #
 1514                                                         mreq      1
 1515                                                         @@_nosize_ ~1~
 1516                                                         #push
 1517                                                         #spauto   :sp
 1518                                                         psha
 1519                                                         @@sub.s   ~1~ #1 ~1~
 1520                                                         @@cmp.s   ~1~ #0
 1521                                                         pula
 1522                                                         #pull
 1523                                                         endm
 1524                                     
 1525                                     ;*******************************************************************************
 1526                                     ; COM for any sized variable
 1527                                     
 1528                                     com.s               macro     Variable
 1529                                                         mset      #
 1530                                                         mreq      1
 1531                                                         @@_nosize_ ~1~
 1532                                               #ifb ~,1~
 1533                                               #ifnz ]~1~
 1534                                                         #push
 1535                                                         #spauto   :sp
 1536                                                         psha
 1537                                                         mdo
 1538                                                         lda       ~1,~+{:mloop-1}~,1~
 1539                                                         coma
 1540                                                         sta       ~1,~+{:mloop-1}~,1~
 1541                                                         mloop     {::~1,~}
 1542                                                         pula
 1543                                                         #pull
 1544                                                         mexit
 1545                                               #endif
 1546                                               #endif
 1547                                                         mdo
 1548                                                         com       ~1,~+{:mloop-1}~,1~
 1549                                                         mloop     ::~1,~
 1550                                                         endm
 1551                                     
 1552                                     ;*******************************************************************************
 1553                                     ; ABS for any sized variable
 1554                                     
 1555                                     abs.s               macro     Variable
 1556                                                         mset      #
 1557                                                         mreq      1:Variable
 1558                                                         @@tst.b   ~1~
 1559                                                         bpl       Done$$$
 1560                                                         @@neg.s   ~1~
 1561                                     Done$$$
 1562                                                         endm
 1563                                     
 1564                                     ;*******************************************************************************
 1565                                     ; NEG for any sized variable
 1566                                     
 1567                                     neg.s               macro     Variable
 1568                                                         mset      #
 1569                                                         mreq      1
 1570                                                         @@_nosize_ ~1~
 1571                                               #if ::~1,~ > 1
 1572                                                         mdo
 1573                                                         com       ~1,~+{:mloop-1}~,1~
 1574                                                         mloop     ::~1,~-1
 1575                                               #endif
 1576                                                         neg       ~1,~+{::~1,~-1}~,1~
 1577                                               #if ::~1,~ > 1
 1578                                                         mdo
 1579                                                         bne       Done$$$
 1580                                                         inc       ~1,~+{::~1,~-:mloop-1}~,1~
 1581                                                         mloop     ::~1,~-1
 1582                                     Done$$$
 1583                                               #endif
 1584                                                         endm
 1585                                     
 1586                                     ;*******************************************************************************
 1587                                     ; MOV for any sized variable (simpler version that does not test MSB)
 1588                                     
 1589                                     move.s              macro     [#]Source Destination
 1590                                                         mset      #' '
 1591                                                         mreq      1,2:[#]Source Destination
 1592                                               #ifnb ~2~ = x+
 1593                                                         @@_nosize_ ~1~
 1594                                                         #temp     ::~1,~
 1595                                               #else
 1596                                                         @@_nosize_ ~2~
 1597                                                         #temp     ::~2,~
 1598                                               #endif
 1599                                                         mdo
 1600                                               #ifnb ~#~
 1601                                                         mov       ~1~>{:temp-:mloop*8}&$FF,~2~+{:mloop-1}
 1602                                               #else ifnb ~1~ = x+
 1603                                                         mov       x+,~2~+{:mloop-1}             ;;special X+, case
 1604                                               #else ifnb ~2~ = x+
 1605                                                         mov       ~1~+{:mloop-1},x+             ;;special ,X+ case
 1606                                               #else
 1607                                                   #if :mloop = 1
 1608                                                         @@_samesize_ ~@~
 1609                                                   #endif
 1610                                                         mov       ~1~+{:mloop-1},~2~+{:mloop-1}
 1611                                               #endif
 1612                                                         mloop     :temp
 1613                                                         endm
 1614                                     
 1615                                     ;*******************************************************************************
 1616                                     ; MOV for any sized variable (but also tests MSB for negative)
 1617                                     
 1618                                     mov.s               macro     [#]Source Destination
 1619                                                         mset      #' '
 1620                                                         @@move.s  ~@~
 1621                                               #ifnb ~2~ = x+
 1622                                                 #if ::~1,~ < 2
 1623                                                         mexit                         ;;single byte var, no need for TST
 1624                                                 #endif
 1625                                                         tst       ~1~                 ;;var,x+ case
 1626                                                         mexit
 1627                                               #endif
 1628                                               #if ::~2,~ < 2
 1629                                                         mexit                         ;;single byte var, no need for TST
 1630                                               #endif
 1631                                                         tst       ~2~                 ;;all other cases
 1632                                                         endm
 1633                                     
 1634                                     ;*******************************************************************************
 1635                                     ; MOVA for any sized variable
 1636                                     
 1637                                     mova.s              macro     [#]Source Destination
 1638                                                         mset      #' '
 1639                                                         mreq      1,2:Source Destination
 1640                                               #ifb ~#~
 1641                                                         @@_samesize_ ~@~
 1642                                               #else
 1643                                                         @@_nosize_ ~2~
 1644                                               #endif
 1645                                                         mset      0                   ;;no CLRA used
 1646                                                         mdo
 1647                                               #ifnb ~#~
 1648                                                         #temp                         ;;no optimization
 1649                                                 #!ifz ~#1~>{::~2,~-:mloop*8}&$FF
 1650                                                     #ifb ~text~
 1651                                                         clra
 1652                                                     #endif
 1653                                                         mset      0,clra              ;;CLRA used
 1654                                                         #temp     1                   ;;optimization
 1655                                                 #endif
 1656                                                 #ifz :temp                            ;;if no optimization
 1657                                                         lda       ~1~>{::~2,~-:mloop*8}&$FF
 1658                                                         mset      0                   ;;no CLRA used
 1659                                                 #endif
 1660                                               #else
 1661                                                         lda       ~1,~+{:mloop-1}~,1~
 1662                                               #endif
 1663                                                         sta       ~2,~+{:mloop-1}~,2~
 1664                                                         mloop     ::~2,~
 1665                                                         endm
 1666                                     
 1667                                     ;*******************************************************************************
 1668                                     ; Copy for any sized variable
 1669                                     
 1670                                     copy.s              macro
 1671                                                         mset      #' '
 1672                                                         #push
 1673                                                         #spauto   :sp
 1674                                                         psha
 1675                                                         @@mova.s  ~@~
 1676                                                         pula
 1677                                                         #pull
 1678                                                         endm
 1679                                     
 1680                                     ;*******************************************************************************
 1681                                     ; LSL for any sized variable
 1682                                     
 1683                                     lsl.s               macro     Variable
 1684                                                         mset      #
 1685                                                         mreq      1
 1686                                                         @@_nosize_ ~1~
 1687                                                         mdo
 1688                                               #if :mloop = 1
 1689                                                         lsl       ~1,~+{::~1,~-:mloop}~,1~
 1690                                               #else
 1691                                                         rol       ~1,~+{::~1,~-:mloop}~,1~
 1692                                               #endif
 1693                                                         mloop     ::~1,~
 1694                                                         endm
 1695                                     
 1696                                     ;*******************************************************************************
 1697                                     ; LSR for any sized variable
 1698                                     
 1699                                     lsr.s               macro     Variable
 1700                                                         mset      #
 1701                                                         mreq      1
 1702                                                         @@_nosize_ ~1~
 1703                                                         mdo
 1704                                               #if :mloop = 1
 1705                                                         lsr       ~1,~+{:mloop-1}~,1~
 1706                                               #else
 1707                                                         ror       ~1,~+{:mloop-1}~,1~
 1708                                               #endif
 1709                                                         mloop     ::~1,~
 1710                                                         endm
 1711                                     
 1712                                     ;*******************************************************************************
 1713                                     ; ASR for any sized variable
 1714                                     
 1715                                     asr.s               macro     Variable
 1716                                                         mset      #
 1717                                                         mreq      1
 1718                                                         @@_nosize_ ~1~
 1719                                                         mdo
 1720                                               #if :mloop = 1
 1721                                                         asr       ~1,~+{:mloop-1}~,1~
 1722                                               #else
 1723                                                         ror       ~1,~+{:mloop-1}~,1~
 1724                                               #endif
 1725                                                         mloop     ::~1,~
 1726                                                         endm
 1727                                     
 1728                                     ;*******************************************************************************
 1729                                     ; ROR for any sized variable
 1730                                     
 1731                                     ror.s               macro     Variable
 1732                                                         mset      #
 1733                                                         mreq      1
 1734                                                         @@_nosize_ ~1~
 1735                                                         mdo
 1736                                                         ror       ~1,~+{:mloop-1}~,1~
 1737                                                         mloop     ::~1,~
 1738                                                         endm
 1739                                     
 1740                                     ;*******************************************************************************
 1741                                     ; ROL for any sized variable
 1742                                     
 1743                                     rol.s               macro     Variable
 1744                                                         mset      #
 1745                                                         mreq      1
 1746                                                         @@_nosize_ ~1~
 1747                                                         mdo
 1748                                                         rol       ~1,~+{::~1,~-:mloop}~,1~
 1749                                                         mloop     ::~1,~
 1750                                                         endm
 1751                                     
 1752                                     ;*******************************************************************************
 1753                                     ; ADD bytes
 1754                                     ; Note: No destination required if you only need to add in RegA
 1755                                     
 1756                                     add.b               macro     [#]Operand1,[#]Operand2[,Destination]
 1757                                               #ifparm ~#~
 1758                                                 #ifdef ~#1~
 1759                                                         mset      1,~#~{~#1~}
 1760                                                 #endif
 1761                                               #endif
 1762                                                         mswap     1,2
 1763                                               #ifparm ~#~
 1764                                                 #ifdef ~#1~
 1765                                                         mset      1,~#~{~#1~}
 1766                                                 #endif
 1767                                               #endif
 1768                                                         mswap     1,2
 1769                                               #ifparm ~1~~2~ = #0#0
 1770                                                         clra
 1771                                                         @_sta_    ~3~
 1772                                                         mexit
 1773                                               #endif
 1774                                               #ifparm ~1~ = #0
 1775                                                         lda       ~2~
 1776                                                         @_sta_    ~3~
 1777                                                         mexit
 1778                                               #endif
 1779                                               #ifparm ~2~ = #0
 1780                                                         lda       ~1~
 1781                                                         @_sta_    ~3~
 1782                                                         mexit
 1783                                               #endif
 1784                                                         lda       ~1~
 1785                                                         add       ~2~
 1786                                                         @_sta_    ~3~
 1787                                                         endm
 1788                                     
 1789                                     ;*******************************************************************************
 1790                                     ; ADD bytes with Carry
 1791                                     ; Note: No destination required if you only interested in the Carry flag
 1792                                     
 1793                                     adc.b               macro     [#]Operand1,[#]Operand2[,Destination]
 1794                                               #ifparm ~#~
 1795                                                 #ifdef ~#1~
 1796                                                         mset      1,~#~{~#1~}
 1797                                                 #endif
 1798                                               #endif
 1799                                                         mswap     1,2
 1800                                               #ifparm ~#~
 1801                                                 #ifdef ~#1~
 1802                                                         mset      1,~#~{~#1~}
 1803                                                 #endif
 1804                                               #endif
 1805                                                         mswap     1,2
 1806                                               #ifparm ~1~ = #0
 1807                                                         clra
 1808                                                         adc       ~2~
 1809                                                         @_sta_    ~3~
 1810                                                         mexit
 1811                                               #endif
 1812                                               #ifparm ~2~ = #0
 1813                                                         clra
 1814                                                         adc       ~1~
 1815                                                         @_sta_    ~3~
 1816                                                         mexit
 1817                                               #endif
 1818                                                         lda       ~1~
 1819                                                         adc       ~2~
 1820                                                         @_sta_    ~3~
 1821                                                         endm
 1822                                     
 1823                                     ;*******************************************************************************
 1824                                     ; ADD for any sized variable
 1825                                     
 1826                                     add.s               macro     [#]Operand1 [#]Operand2 Destination
 1827                                                         mset      #' '
 1828                                                         mreq      1,2,3:[#]Operand1 [#]Operand2 Destination
 1829                                                         @@_samesize_ ~@~
 1830                                                         mset      0,@@add.b,          ;;first time, do an ADD
 1831                                                         mdo
 1832                                               #ifparm ~#~
 1833                                                         mset      0,~text~ ~1~>{:mloop-1*8}&$FF
 1834                                               #else
 1835                                                         mset      0,~text~ ~1,~+{::~3,~-:mloop}~,1~
 1836                                               #endif
 1837                                               #ifparm ~2.1.1~ = #
 1838                                                         mset      0,~text~ ~2~>{:mloop-1*8}&$FF
 1839                                               #else
 1840                                                         mset      0,~text~ ~2,~+{::~3,~-:mloop}~,2~
 1841                                               #endif
 1842                                                         mset      0,~text~ ~3,~+{::~3,~-:mloop}~,3~
 1843                                                         ~text~
 1844                                                         mset      0,@@adc.b,          ;;next time(s), do an ADC
 1845                                                         mloop     ::~3,~
 1846                                                         endm
 1847                                     
 1848                                     ;*******************************************************************************
 1849                                     ; SUB for any sized variable
 1850                                     
 1851                                     sub.s               macro     [#]Operand1 [#]Operand2 Destination
 1852                                                         mset      #' '
 1853                                                         mreq      1,2:[#]Operand1 [#]Operand2 Destination
 1854                                                         @@_samesize_ ~@~
 1855                                                         #temp
 1856                                               #ifb ~3~
 1857                                                         @@_nosize_ ~1~
 1858                                                         #temp     ::~1,~
 1859                                               #else
 1860                                                         @@_nosize_ ~3~
 1861                                                         #temp     ::~3,~
 1862                                               #endif
 1863                                                         mset      0,sub               ;;first time, do a SUB
 1864                                                         mdo
 1865                                               #ifparm ~#~
 1866                                                         lda       ~1~>{:mloop-1*8}&$FF
 1867                                               #else
 1868                                                         lda       ~1,~+{:temp-:mloop}~,1~
 1869                                               #endif
 1870                                               #ifparm ~2.1.1~ = #
 1871                                                         ~text~    ~2~>{:mloop-1*8}&$FF
 1872                                               #else
 1873                                                         ~text~    ~2,~+{:temp-:mloop}~,2~
 1874                                               #endif
 1875                                               #ifnb ~3~
 1876                                                         sta       ~3,~+{:temp-:mloop}~,3~
 1877                                               #endif
 1878                                                         mset      0,sbc               ;;next time(s), do a SBC
 1879                                                         mloop     :temp
 1880                                                         endm
 1881                                     
 1882                                     ;*******************************************************************************
 1883                                     ; AND for any sized variable
 1884                                     
 1885                                     and.s               macro     [#]Operand1 [#]Operand2 Destination
 1886                                                         mset      #' '
 1887                                                         mreq      1,2,3:[#]Operand1 [#]Operand2 Destination
 1888                                                         @@_samesize_ ~@~
 1889                                                         mdo
 1890                                               #ifnb ~#~
 1891                                                         @@_lda_   ~1~>{::~3,~-:mloop*8}&$FF
 1892                                               #else
 1893                                                         lda       ~1,~+{:mloop-1}~,1~
 1894                                               #endif
 1895                                               #ifnb ~2.1.1~ = #
 1896                                                         and       ~2~>{::~3,~-:mloop*8}&$FF
 1897                                               #else
 1898                                                         and       ~2,~+{:mloop-1}~,2~
 1899                                               #endif
 1900                                                         sta       ~3,~+{:mloop-1}~,3~
 1901                                                         mloop     ::~3,~
 1902                                                         endm
 1903                                     
 1904                                     ;*******************************************************************************
 1905                                     ; OR for any sized variable
 1906                                     
 1907                                     ora.s               macro     [#]Operand1 [#]Operand2 Destination
 1908                                                         mset      #' '
 1909                                                         mreq      1,2,3:[#]Operand1 [#]Operand2 Destination
 1910                                                         @@_samesize_ ~@~
 1911                                                         mdo
 1912                                               #ifnb ~#~
 1913                                                         @@_lda_   ~1~>{::~3,~-:mloop*8}&$FF
 1914                                               #else
 1915                                                         lda       ~1,~+{:mloop-1}~,1~
 1916                                               #endif
 1917                                               #ifnb ~2.1.1~ = #
 1918                                                         ora       ~2~>{::~3,~-:mloop*8}&$FF
 1919                                               #else
 1920                                                         ora       ~2,~+{:mloop-1}~,2~
 1921                                               #endif
 1922                                                         sta       ~3,~+{:mloop-1}~,3~
 1923                                                         mloop     ::~3,~
 1924                                                         endm
 1925                                     
 1926                                     ;*******************************************************************************
 1927                                     ; XOR for any sized variable
 1928                                     
 1929                                     eor.s               macro     [#]Operand1 [#]Operand2 Destination
 1930                                                         mset      #' '
 1931                                                         mreq      1,2,3:[#]Operand1 [#]Operand2 Destination
 1932                                                         @@_samesize_ ~@~
 1933                                                         mdo
 1934                                               #ifnb ~#~
 1935                                                         @@_lda_   ~1~>{::~3,~-:mloop*8}&$FF
 1936                                               #else
 1937                                                         lda       ~1,~+{:mloop-1}~,1~
 1938                                               #endif
 1939                                               #ifnb ~2.1.1~ = #
 1940                                                         eor       ~2~>{::~3,~-:mloop*8}&$FF
 1941                                               #else
 1942                                                         eor       ~2,~+{:mloop-1}~,2~
 1943                                               #endif
 1944                                                         sta       ~3,~+{:mloop-1}~,3~
 1945                                                         mloop     ::~3,~
 1946                                                         endm
 1947                                     
 1948                                     ;*******************************************************************************
 1949                                     ; CMP for any sized variable (without protecting RegA)
 1950                                     ; (This is meant to be called from other macros, but it may be called directly)
 1951                                     
 1952                                     _cmp_.s             macro     [#]Operand1 [#]Operand2
 1953                                                         mset      #' '
 1954                                                         mreq      1,2:[#]Operand1 [#]Operand2
 1955                                                         @@_samesize_ ~@~
 1956                                               #ifparm ~1.1.1~~2.1.1~ = ##
 1957                                                         mset      #
 1958                                                         mstop     Both operands are immediate! \@~1~\@
 1959                                               #endif
 1960                                                         #temp     1
 1961                                               #ifb ~#~
 1962                                                         #temp     ::~1,~
 1963                                               #endif
 1964                                               #ifb ~2.1.1~ = #
 1965                                                         #temp     ::~2,~
 1966                                               #endif
 1967                                                         mdo
 1968                                               #ifnb ~#~
 1969                                                         @@_lda_   ~1~>{:temp-:mloop*8}&$FF
 1970                                               #else
 1971                                                         lda       ~1,~+{:mloop-1}~,1~
 1972                                               #endif
 1973                                               #ifnb ~2.1.1~ = #
 1974                                                         cmpa      ~2~>{:temp-:mloop*8}&$FF      ;;needed even if #0 to adjust Carry
 1975                                               #else
 1976                                                         cmpa      ~2,~+{:mloop-1}~,2~
 1977                                               #endif
 1978                                               #if :mloop <> :temp
 1979                                                         bne       Done$$$
 1980                                               #endif
 1981                                                         mloop     :temp
 1982                                     Done$$$
 1983                                                         endm
 1984                                     
 1985                                     ;*******************************************************************************
 1986                                     ; CMP for any sized variable
 1987                                     
 1988                                     cmp.s               macro     [#]Operand1 [#]Operand2
 1989                                                         mset      #' '
 1990                                                         #push
 1991                                                         #spauto   :sp
 1992                                                         psha
 1993                                                         @@_cmp_.s ~@~
 1994                                                         pula
 1995                                                         #pull
 1996                                                         endm
 1997                                     
 1998                                     ;*******************************************************************************
 1999                                     ; DIV for any sized variable (HX assumed already set with appropriate values)
 2000                                     
 2001                                     div.s               macro     Variable
 2002                                                         mset      #
 2003                                                         mreq      1
 2004                                                         @@_not_x_ ~1~
 2005                                                         @@_nosize_ ~1~
 2006                                                         #temp     1
 2007                                               #ifnb ~'~,1~'.1.3~ = ,sp                ;;sees SP or SPX index
 2008                                                 #iftos ~1,~
 2009                                                         #temp     2
 2010                                                         pula
 2011                                                         div
 2012                                                         psha
 2013                                                   #if ::~1,~ = 1
 2014                                                         mexit
 2015                                                   #endif
 2016                                                 #endif
 2017                                               #endif
 2018                                                         mdo       {:temp}
 2019                                                         lda       ~1,~+{:mloop-1}~,1~
 2020                                                         div
 2021                                                         sta       ~1,~+{:mloop-1}~,1~
 2022                                                         mloop     ::~1,~
 2023                                                         endm
 2024                                     
 2025                                     ;*******************************************************************************
 2026                                     ; A general-purpose FOR loop wrapper
 2027                                     ; Limits : Start, Stop and Step (if not immediate) have to match size of
 2028                                     ;        : ControlVar (or you will get an error)
 2029                                     ; Note(s): Use FORS for signed version
 2030                                     ;        : Negative steps not allowed (will be treated as positive)
 2031                                     ; Example: FOR i 1 5 ... MRESUME (where i is any variable declared earlier)
 2032                                     
 2033                                     fors                macro     ControlVar [#]Start [#]Stop[ [#]PositiveStep]
 2034                                                         mset      #
 2035                                                         @for      ~1~
 2036                                                         endm
 2037                                     ;-------------------------------------------------------------------------------
 2038                                     for                 macro     ControlVar [#]Start [#]Stop[ [#]PositiveStep]
 2039                                                         mset      #' '
 2040                                                         mreq      1,2,3:ControlVar [#]Start [#]Stop[ [#]PositiveStep]
 2041                                                         mdef      4,#1                ;;default step is one
 2042                                                         @@_nosize_  ~1~               ;;need sized control variable
 2043                                                         #temp     ::~1,~
 2044                                                         mdo       2
 2045                                               #ifnum ~{:mloop}.~
 2046                                                         mset      :mloop,#~{:mloop}.~
 2047                                               #endif
 2048                                                         mloop     4
 2049                                                         @@_samesize_ ~@~
 2050                                                         @@copy.s  ~2~ ~1~
 2051                                     Loop$$$
 2052                                                         @@cmp.s   ~1~ ~3~
 2053                                               #ifparm ~00~ = fors
 2054                                                         !jgt      Done$$$             ;;signed version (FORS)
 2055                                               #else
 2056                                                         !jhi      Done$$$             ;;unsigned version (FOR)
 2057                                               #endif
 2058                                                         msuspend
 2059                                                         #push
 2060                                                         #spauto   :sp
 2061                                                         psha
 2062                                                         @@add.s   ~1~ ~4~ ~1~
 2063                                                         pula
 2064                                                         #pull
 2065                                                         !jmp      Loop$$$
 2066                                     Done$$$
 2067                                                         endm
 2068                                     
 2069                                     ;*******************************************************************************
 2070                                     ; Math-related
 2071                                     
 2072                                     _FindStkMth_        macro     BitVersion
 2073                                                         #temp
 2074                                                         mdo       ~1~/8               ;;find the next highest bit version included (but not less than requested)
 2075                                                 #ifdef _STKMTH{:mloop*8}_
 2076                                                   #ifz :temp
 2077                                                         #temp     :mloop*8            ;;found
 2078                                                   #endif
 2079                                                 #endif
 2080                                                         mloop     8                   ;;highest possible is 64 (8x8)
 2081                                                 #ifz :temp
 2082                                                         mstop     Include STKMTH{~1~}.SUB (or higher)
 2083                                                 #endif
 2084                                                         mexit     :temp
 2085                                                         endm
 2086                                     ;-------------------------------------------------------------------------------
 2087                                     _StkMthMax_         macro     Expression
 2088                                                         mset      #
 2089                                                         mtrim     1
 2090                                                         #temp
 2091                                                         mdo
 2092                                                         mset      0,~'=()+-*\/&|^><'{:mloop}~
 2093                                                         mtrim     0
 2094                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2095                                               #ifparm ~text.1.1~~text.{:text}~ = []
 2096                                                         mset      0,~text.2.{:text-2}~
 2097                                               #endif
 2098                                                         mset      0,~text,~           ;;remove possible index
 2099                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2100                                               #ifparm ~text.1.1~ = #
 2101                                                         mset      0,~text.2~          ;;remove # from number
 2102                                               #endif
 2103                                               #ifnb ~text~
 2104                                                 #ifnb ~text.1.1~ = .
 2105                                                         #Warning  Pointers (~text~) have unknown size
 2106                                                 #endif
 2107                                                 #ifnum ~text~                         ;estimate byte size for numeric constant
 2108                                                   #ifnz ~text~>16
 2109                                                     #if 3 > :temp
 2110                                                         #temp     3
 2111                                                     #endif
 2112                                                   #endif
 2113                                                   #ifnz ~text~>24
 2114                                                     #if 4 > :temp
 2115                                                         #temp     4
 2116                                                     #endif
 2117                                                   #endif
 2118                                                 #endif
 2119                                                 #ifb ~text.1.1~ = :
 2120                                                   #ifnonum ~text~
 2121                                                     #ifdef ~text~
 2122                                                       #if {::~text~} > :temp
 2123                                                         #temp     ::~text~
 2124                                                       #endif
 2125                                                     #endif
 2126                                                   #endif
 2127                                                 #endif
 2128                                               #endif
 2129                                                         mloop     {:1/2}              ;;max term/factor estimate
 2130                                               #ifz :temp
 2131                                                         #Warning  Undetermined bit-size (using 32-bit)
 2132                                                         #temp     4
 2133                                               #endif
 2134                                     ;         #ifb \@~'*'~\@ = \@~1~\@                ;if any multiplication is present
 2135                                     ;           #if :temp < 4
 2136                                     ;                   #temp     :temp+1             ;give some more bits (normally double, but on average this is OK)
 2137                                     ;           #endif
 2138                                     ;         #endif
 2139                                               #if :temp > 8                           ;for exceptional cases, enforce
 2140                                                         #temp     8                   ;maximum available bit-size
 2141                                               #endif
 2142                                                         @_FindStkMth_ {:temp*8}
 2143                                                         endm
 2144                                     
 2145                                     ;-------------------------------------------------------------------------------
 2146                                     ; Default version -- works with signed/unsigned operands
 2147                                     ; (In :MEXIT, it returns the actual bit-size used)
 2148                                     
 2149                                     Eval                macro     Expression
 2150                                                         #push
 2151                                                         #HideMacros
 2152                                                         mset      #
 2153                                                         mtrim     1
 2154                                                         @@_StkMthMax_ ~1~
 2155                                                         #temp      :mexit
 2156                                                         @@_FindStkMth_ {:temp}
 2157                                                         #temp     :mexit
 2158                                                         @@Eval{:temp} ~1~
 2159                                                         mset      0,{:spcheck},{:spfree-:ais},{:ais}
 2160                                                         #pull
 2161                                               #ifspauto
 2162                                                         #spauto   ~text,~
 2163                                                         #spadd    ~text','2~
 2164                                                         #ais
 2165                                                         #spadd    ~text','3~
 2166                                               #endif
 2167                                                         mexit     {:temp}
 2168                                                         endm
 2169                                     
 2170                                     ;-------------------------------------------------------------------------------
 2171                                     ; Signed version -- gives warning to alert you if SIGNED was not defined
 2172                                     ; (In :MEXIT, it returns the actual bit-size used)
 2173                                     
 2174                                     EvalS               macro     Expression
 2175                                                         mset      #
 2176                                                         @@_signed_
 2177                                                         @Eval     ~1~
 2178                                                         endm
 2179                                     
 2180                                     ;-------------------------------------------------------------------------------
 2181                                     
 2182                                     _Eval_              macro     [BitSize,]Expression (eg. [ans=](a+b)*(a-b)/2)
 2183                                               #if :macronest = 1
 2184                                                         mstop     Macro not to be called directly (eg. use @Eval32)
 2185                                               #endif
 2186                                               #ifb ~00~ = ~0~
 2187                                                         @@_needs_spauto_
 2188                                                         mdef      1,32
 2189                                                         mswap     0,1                 ;;bitsize now in ~ text ~
 2190                                                         mdel      1
 2191                                                         mset      #
 2192                                                         #Message  --------------------------------------------------
 2193                                                         #Message  Expr: ~1~
 2194                                                         #Message  --------------------------------------------------
 2195                                                         @@_FindStkMth_ ~text~
 2196                                                         mset      0,{:mexit},~text~   ;;(bitsize to use, actual bitsize)
 2197                                               #endif
 2198                                                         mset      #
 2199                                                         mreq      1:Expression (eg. [ans=](a+b)*(a-b)/2 -- spaces OK)
 2200                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2201                                               #ifb ~00~ = ~0~
 2202                                                         mtrim     1                   ;;remove all spaces
 2203                                                         mset      #'='                ;;split on assignment (if any)
 2204                                                 #if :nn > 2
 2205                                                         mstop     Too many assignment operators
 2206                                                 #endif
 2207                                                 #if :nn > 1
 2208                                                         @@~0~     ~2~
 2209                                               ;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-
 2210                                                         mset      9                   ;;assume signed (when SIGNED)
 2211                                                   #ifparm ~1.1.1~~1.{:1}~ = []
 2212                                                         mset      9,unsigned
 2213                                                         mset      1,~1.2.{:1-2}~
 2214                                                   #endif
 2215                                               ;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-;-
 2216                                                   #ifparm ~1.1.1~ = .                 ;;pointers ...
 2217                                                     #if ~text,~/8 <> ~text','2~/8
 2218                                                         @@ResizeTOS #~text,~/8\,#~text','2~/8\,\,~9~
 2219                                                         @@lea     ~1~
 2220                                                         @@_?sei_  ~1~
 2221                                                         @@pullv   ~1~ ~text','2~/8    ;;are resized and then pulled
 2222                                                         @_?cli_   ~1~
 2223                                                         mexit
 2224                                                     #endif
 2225                                                   #endif
 2226                                                   #ifdef ~1,~                         ;;if assignment var defined
 2227                                                         @Save~text,~ ~1~              ;;save to it
 2228                                                         mexit
 2229                                                   #endif
 2230                                                   #ifparm ~,1~ = ,spx                 ;;SPX is SP-equivalent in EVAL
 2231                                                         mset      1,~1,~,sp           ;;change to SP-index
 2232                                                   #endif
 2233                                                   #ifparm ~,1~ = ,sp                  ;;else, if SP-indexed
 2234                                     ~1,~                equ       ::,~text,~/8        ;;leave on stack with this name
 2235                                                         #Message  Saved to TOS (~1,~)
 2236                                                         mexit
 2237                                                   #endif
 2238                                                         merror    Unknown variable \@~1~\@
 2239                                                 #endif
 2240                                               #endif
 2241                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2242                                               #ifstr ~1~
 2243                                                 #if :1-2 > 4
 2244                                                         mstop     String constant (~1~) too long
 2245                                                 #endif
 2246                                                         @Load~text,~ #~1~
 2247                                                         mexit
 2248                                               #endif
 2249                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2250                                               #ifparm ~1.1.1~ = -                     ;;process leading negative
 2251                                                 #ifnum ~1~
 2252                                                         @Load~text,~ #~1~             ;;numerics use immediate mode
 2253                                                         mexit
 2254                                                 #endif
 2255                                                 #ifdef ~1.2~
 2256                                                   #ifz ::~1.2~
 2257                                                         @Load~text,~ #~1~             ;;named constants use immediate mode
 2258                                                         mexit
 2259                                                   #endif
 2260                                                 #endif
 2261                                                         @~0~      #0~1~               ;;anything else, subtract from zero
 2262                                                         mexit
 2263                                               #endif
 2264                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2265                                                         mset      #'+-|^'             ;;split terms
 2266                                               #if :nn > 1
 2267                                                         mdo       2
 2268                                                         @@~0~     ~{:nn-:mloop+2}.2~  ;;process terms right to left
 2269                                                         mloop     :nn
 2270                                                         @@~0~     ~1~                 ;;the first term without operator
 2271                                                         mdo       2
 2272                                                 #ifparm ~{:mloop}.1.1~ = +
 2273                                                         #Message  Add~text,~
 2274                                                         call      StackAdd~text,~
 2275                                                         #spadd    -{~text,~/8}
 2276                                                 #endif
 2277                                                 #ifparm ~{:mloop}.1.1~ = -
 2278                                                         #Message  Sub~text,~
 2279                                                         call      StackSub~text,~
 2280                                                         #spadd    -{~text,~/8}
 2281                                                 #endif
 2282                                                 #ifparm ~{:mloop}.1.1~ = |
 2283                                                         #Message  Or~text,~
 2284                                                         call      StackOr~text,~
 2285                                                         #spadd    -{~text,~/8}
 2286                                                 #endif
 2287                                                 #ifparm ~{:mloop}.1.1~ = ^
 2288                                                         #Message  Xor~text,~
 2289                                                         call      StackXor~text,~
 2290                                                         #spadd    -{~text,~/8}
 2291                                                 #endif
 2292                                                         mloop     :nn
 2293                                                         mexit
 2294                                               #endif
 2295                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2296                                                         mset      #'*\/&><'           ;;split factors
 2297                                               #if :nn > 1
 2298                                                         mdo       2
 2299                                                         @@~0~     ~{:nn-:mloop+2}.2~  ;;process factors right to left
 2300                                                         mloop     :nn
 2301                                                         @@~0~     ~1~                 ;;the first factor without operator
 2302                                                         mdo       2
 2303                                                 #ifparm ~{:mloop}.1.1~ = *
 2304                                                         #Message  Mul~text,~
 2305                                                         call      StackMul~text,~
 2306                                                         #spadd    -{~text,~/8}
 2307                                                 #endif
 2308                                                 #ifparm ~{:mloop}.1.1~ = /
 2309                                                         #Message  Div~text,~
 2310                                                         call      StackDiv~text,~
 2311                                                         #spadd    -{~text,~/8}
 2312                                                 #endif
 2313                                                 #ifparm ~{:mloop}.1.1~ = \
 2314                                                         #Message  Mod~text,~
 2315                                                         call      StackMod~text,~
 2316                                                         #spadd    -{~text,~/8}
 2317                                                 #endif
 2318                                                 #ifparm ~{:mloop}.1.1~ = &
 2319                                                         #Message  And~text,~
 2320                                                         call      StackAnd~text,~
 2321                                                         #spadd    -{~text,~/8}
 2322                                                 #endif
 2323                                                 #ifparm ~{:mloop}.1.1~ = >
 2324                                                         #Message  Shr~text,~
 2325                                                         call      StackShr~text,~
 2326                                                         #spadd    -{~text,~/8}
 2327                                                 #endif
 2328                                                 #ifparm ~{:mloop}.1.1~ = <
 2329                                                         #Message  Shl~text,~
 2330                                                         call      StackShl~text,~
 2331                                                         #spadd    -{~text,~/8}
 2332                                                 #endif
 2333                                                         mloop     :nn
 2334                                                         mexit
 2335                                               #endif
 2336                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2337                                               #ifparm ~1.1.4~~1.{:1}~ = NEG()         ;;do NEG(ate) function
 2338                                                         @@~0~     ~1.5.{:1-5}~
 2339                                                         #Message  Neg~text,~
 2340                                                         call      StackNegate~text,~
 2341                                                         mexit
 2342                                               #endif
 2343                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2344                                               #ifparm ~1.1.4~~1.{:1}~ = ABS()         ;;do ABS(olute) function
 2345                                                         @@~0~     ~1.5.{:1-5}~
 2346                                                         #Message  Abs~text,~
 2347                                                         call      StackAbs~text,~
 2348                                                         mexit
 2349                                               #endif
 2350                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2351                                               #ifparm ~1.1.4~~1.{:1}~ = SQR()         ;;do SQR() function -- square
 2352                                                         @@~0~     ~1.5.{:1-5}~
 2353                                                         #Message  Sqr~text,~(TOS)
 2354                                                         tsx
 2355                                                         call      StackLoad~text,~
 2356                                                         call      StackMul~text,~
 2357                                                         mexit
 2358                                               #endif
 2359                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2360                                               #ifparm ~1.1.1~~1.{:1}~ = ()            ;;process parenthesized sub-expression
 2361                                                         @~0~      ~1.2.{:1-2}~
 2362                                                         mexit
 2363                                               #endif
 2364                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2365                                                         mset      9                   ;;assume signed (when SIGNED)
 2366                                               #ifparm ~1.1.1~~1.{:1}~ = []
 2367                                                         mset      9,unsigned
 2368                                                         mset      1,~1.2.{:1-2}~
 2369                                               #endif
 2370                                     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 2371                                               #ifnum ~#1~
 2372                                                         mset      1,#~#1~             ;;numerics use immediate mode
 2373                                               #endif
 2374                                               #ifparm ~1.1.2~ = -:
 2375                                                         mset      1,#~1~              ;;negative internal symbol use immediate
 2376                                               #endif
 2377                                               #ifparm ~1.1.1~ = :
 2378                                                         mset      1,#~1~              ;;positive internal symbol use immediate
 2379                                               #endif
 2380                                               #ifb ~,1~
 2381                                                 #ifdef ~#1~
 2382                                                   #ifz ::~#1~
 2383                                                         mset      1,#~#1~             ;;named constants use immediate
 2384                                                   #endif
 2385                                                 #endif
 2386                                               #endif
 2387                                               #ifparm ~,1~ = ,spx                     ;;SPX is SP-equivalent in EVAL
 2388                                                         mset      1,~1,~,sp           ;;change to SP-index
 2389                                               #endif
 2390                                               #ifparm ~1.1.1~ = .                     ;;pointers ...
 2391                                                 #if ~text','2~/8 <> ~text,~/8
 2392                                                         @@_?sei_  ~1~
 2393                                                         @@pushv   ~1~ ~text','2~/8    ;;are pushed and then resized
 2394                                                         @@_?cli_  ~1~
 2395                                                         @ResizeTOS #~text','2~/8\,#~text,~/8\,\,~9~
 2396                                                         mexit
 2397                                                 #endif
 2398                                               #endif
 2399                                               #ifnb ~9~
 2400                                                         mset      1,[~1~]
 2401                                               #endif
 2402                                                         @Load~text,~ ~1~              ;;anything else, load as is
 2403                                                         endm
 2404                                     ;-------------------------------------------------------------------------------
 2405                                     Comp                macro     Exp1 Exp2
 2406                                                         mset      #' '
 2407                                                         mreq      1,2:Exp1 Exp2
 2408                                                         #push
 2409                                                         #spauto   :sp
 2410                                                         push
 2411                                                         #ais
 2412                                                         @@Eval    a$$$,sp = ~1~
 2413                                                         @@Eval    b$$$,sp = ~2~
 2414                                                         @@_cmp_.s a$$$,sp b$$$,sp
 2415                                                         ais       #:ais
 2416                                                         pull
 2417                                                         #pull
 2418                                                         endm
 2419                                     ;-------------------------------------------------------------------------------
 2420                                     Eval8               macro
 2421                                                         mset      #
 2422                                                         @_Eval_   ~0.5~\,~1~
 2423                                                         endm
 2424                                     ;-------------------------------------------------------------------------------
 2425                                     Eval16              macro
 2426                                                         mset      #
 2427                                                         @_Eval_   ~0.5~\,~1~
 2428                                                         endm
 2429                                     ;-------------------------------------------------------------------------------
 2430                                     Eval24              macro
 2431                                                         mset      #
 2432                                                         @_Eval_   ~0.5~\,~1~
 2433                                                         endm
 2434                                     ;-------------------------------------------------------------------------------
 2435                                     Eval32              macro
 2436                                                         mset      #
 2437                                                         @_Eval_   ~0.5~\,~1~
 2438                                                         endm
 2439                                     ;-------------------------------------------------------------------------------
 2440                                     Eval40              macro
 2441                                                         mset      #
 2442                                                         @_Eval_   ~0.5~\,~1~
 2443                                                         endm
 2444                                     ;-------------------------------------------------------------------------------
 2445                                     Eval48              macro
 2446                                                         mset      #
 2447                                                         @_Eval_   ~0.5~\,~1~
 2448                                                         endm
 2449                                     ;-------------------------------------------------------------------------------
 2450                                     Eval56              macro
 2451                                                         mset      #
 2452                                                         @_Eval_   ~0.5~\,~1~
 2453                                                         endm
 2454                                     ;-------------------------------------------------------------------------------
 2455                                     Eval64              macro
 2456                                                         mset      #
 2457                                                         @_Eval_   ~0.5~\,~1~
 2458                                                         endm
 2459                                     ;-------------------------------------------------------------------------------
 2460                                     StrMath             macro
 2461                                               #ifnb ~1~
 2462                                                 #ifdef ~1,~
 2463                                                   #ifnz ::~1,~
 2464                                                         @_DoStr   {::~1,~*8}\,~1~\,~2~
 2465                                                         mexit
 2466                                                   #endif
 2467                                                 #endif
 2468                                               #endif
 2469                                                         mset      #
 2470                                                         mtrim     1
 2471                                                         @@_StkMthMax_ ~1,~
 2472                                                         #temp     :mexit
 2473                                                         @_DoStr   {:temp}\,~1~\,~2~
 2474                                                         endm
 2475                                     ;-------------------------------------------------------------------------------
 2476                                     Str16               macro     [Number],[ResultString]
 2477                                                         @_DoStr   16\,~1~\,~2~
 2478                                                         endm
 2479                                     ;-------------------------------------------------------------------------------
 2480                                     Str24               macro     [Number],[ResultString]
 2481                                                         @_DoStr   24\,~1~\,~2~
 2482                                                         endm
 2483                                     ;-------------------------------------------------------------------------------
 2484                                     Str32               macro     [Number],[ResultString]
 2485                                                         @_DoStr   32\,~1~\,~2~
 2486                                                         endm
 2487                                     ;-------------------------------------------------------------------------------
 2488                                     Str40               macro     [Number],[ResultString]
 2489                                                         @_DoStr   40\,~1~\,~2~
 2490                                                         endm
 2491                                     ;-------------------------------------------------------------------------------
 2492                                     Str48               macro     [Number],[ResultString]
 2493                                                         @_DoStr   48\,~1~\,~2~
 2494                                                         endm
 2495                                     ;-------------------------------------------------------------------------------
 2496                                     Str56               macro     [Number],[ResultString]
 2497                                                         @_DoStr   56\,~1~\,~2~
 2498                                                         endm
 2499                                     ;-------------------------------------------------------------------------------
 2500                                     Str64               macro     [Number],[ResultString]
 2501                                                         @_DoStr   64\,~1~\,~2~
 2502                                                         endm
 2503                                     
 2504                                     ;*******************************************************************************
 2505                                     ; Show the current value and size of the specified symbols
 2506                                     
 2507                                     ShowSym             macro     Symbol[,Symbol]*
 2508                                                         #Message  --------------------------------------------------
 2509                                                         mdo
 2510                                                         mswap     1,:mloop
 2511                                               #ifdef ~1~
 2512                                                         #Message  Symbol \@~1~\@~'...................'.1.{20-:1}~ {~1~} (size: {::~1~})
 2513                                               #endif
 2514                                                         mloop     :n
 2515                                                         endm
 2516                                     
 2517                                     ;*******************************************************************************
 2518                                     ; Find the minimum value of the given symbols
 2519                                     
 2520                                     _MinSymbolValue_    macro     ConstExpr[,ConstExpr]*
 2521                                                         mreq      1:ConstExpr[,ConstExpr]*
 2522                                                         #temp     -1
 2523                                                         mdo
 2524                                                         mswap     1,:mloop
 2525                                               #ifdef ~1~
 2526                                                 #if :mloop = 1
 2527                                                         #temp     ~1~
 2528                                                 #endif
 2529                                                 #if ~1~ < :temp
 2530                                                         #temp     ~1~
 2531                                                 #endif
 2532                                               #endif
 2533                                                         mloop     :n
 2534                                                         mexit     :temp
 2535                                                         endm
 2536                                     
 2537                                     ;*******************************************************************************
 2538                                     ; BSET for Pin names without protection of RegA
 2539                                     
 2540                                     _bset_              macro     PinName
 2541                                                         mset      #','
 2542                                               #ifparm ~2~
 2543                                                 #!ifnz ]~2~
 2544                                                         lda       ~2~
 2545                                                   #ifnum ~1~
 2546                                                         ora       #1<~1~
 2547                                                   #else
 2548                                                         ora       #~1'.'~_
 2549                                                   #endif
 2550                                                         sta       ~2~
 2551                                                         mexit
 2552                                                 #endif
 2553                                                         !bset     ~@~
 2554                                                         mexit
 2555                                               #endif
 2556                                               #ifz ~1~&$FFFFFF00
 2557                                                         !bset     ~1~.,~1~
 2558                                                         mexit
 2559                                               #endif
 2560                                                         lda       ~1~
 2561                                                         ora       #~1~_
 2562                                                         sta       ~1~
 2563                                                         endm
 2564                                     
 2565                                     ;*******************************************************************************
 2566                                     ; BCLR for Pin names without protection of RegA
 2567                                     
 2568                                     _bclr_              macro     PinName
 2569                                                         mset      #','
 2570                                               #ifparm ~2~
 2571                                                 #!ifnz ]~2~
 2572                                                         lda       ~2~
 2573                                                   #ifnum ~1~
 2574                                                         and       #1<~1~^$FF
 2575                                                   #else
 2576                                                         and       #~1'.'~_^$FF
 2577                                                   #endif
 2578                                                         sta       ~2~
 2579                                                         mexit
 2580                                                 #endif
 2581                                                         !bclr     ~@~
 2582                                                         mexit
 2583                                               #endif
 2584                                               #ifz ~1~&$FFFFFF00
 2585                                                         !bclr     ~1~.,~1~
 2586                                                         mexit
 2587                                               #endif
 2588                                                         lda       ~1~
 2589                                                         and       #~1~_^$FF
 2590                                                         sta       ~1~
 2591                                                         endm
 2592                                     
 2593                                     ;*******************************************************************************
 2594                                     ; BSET for Pin names
 2595                                     
 2596                                     bset                macro     PinName
 2597                                                         mset      #','
 2598                                               #ifparm ~2~
 2599                                                 #!ifnz ]~2~
 2600                                                         psha
 2601                                                         lda       ~2~
 2602                                                   #ifnum ~1~
 2603                                                         ora       #1<~1~
 2604                                                   #else
 2605                                                         ora       #~1'.'~_
 2606                                                   #endif
 2607                                                         sta       ~2~
 2608                                                         pula
 2609                                                         mexit
 2610                                                 #endif
 2611                                                         !bset     ~@~
 2612                                                         mexit
 2613                                               #endif
 2614                                               #ifz ~1~&$FFFFFF00
 2615                                                         !bset     ~1~.,~1~
 2616                                                         mexit
 2617                                               #endif
 2618                                                         psha
 2619                                                         lda       ~1~
 2620                                                         ora       #~1~_
 2621                                                         sta       ~1~
 2622                                                         pula
 2623                                                         endm
 2624                                     
 2625                                     ;*******************************************************************************
 2626                                     ; BCLR for Pin names
 2627                                     
 2628                                     bclr                macro     PinName
 2629                                                         mset      #','
 2630                                               #ifparm ~2~
 2631                                                 #!ifnz ]~2~
 2632                                                         psha
 2633                                                         lda       ~2~
 2634                                                   #ifnum ~1~
 2635                                                         and       #1<~1~^$FF
 2636                                                   #else
 2637                                                         and       #~1'.'~_^$FF
 2638                                                   #endif
 2639                                                         sta       ~2~
 2640                                                         pula
 2641                                                         mexit
 2642                                                 #endif
 2643                                                         !bclr     ~@~
 2644                                                         mexit
 2645                                               #endif
 2646                                               #ifz ~1~&$FFFFFF00
 2647                                                         !bclr     ~1~.,~1~
 2648                                                         mexit
 2649                                               #endif
 2650                                                         psha
 2651                                                         lda       ~1~
 2652                                                         and       #~1~_^$FF
 2653                                                         sta       ~1~
 2654                                                         pula
 2655                                                         endm
 2656                                     
 2657                                     ;*******************************************************************************
 2658                                     ;BRSET for Pin names
 2659                                     
 2660                                     brset               macro     PinName,Address
 2661                                                         mset      #','
 2662                                               #ifparm ~3~
 2663                                                         !brset    ~@~
 2664                                                         mexit
 2665                                               #endif
 2666                                               #ifz ~1~&$FFFFFF00
 2667                                                         !brset    ~1~.,~1~,~2~
 2668                                                         mexit
 2669                                               #endif
 2670                                               #ifparm ~2~ = *
 2671                                                         mset      2,{*}
 2672                                               #endif
 2673                                                         psha
 2674                                                         lda       ~1~
 2675                                                         and       #~1~_
 2676                                                         pula
 2677                                                         bne       ~2~
 2678                                                         endm
 2679                                     
 2680                                     ;*******************************************************************************
 2681                                     ; BRCLR for Pin names
 2682                                     
 2683                                     brclr               macro     PinName,Address
 2684                                                         mset      #','
 2685                                               #ifparm ~3~
 2686                                                         !brclr    ~@~
 2687                                                         mexit
 2688                                               #endif
 2689                                               #ifz ~1~&$FFFFFF00
 2690                                                         !brclr    ~1~.,~1~,~2~
 2691                                                         mexit
 2692                                               #endif
 2693                                               #ifparm ~2~ = *
 2694                                                         mset      2,{*}
 2695                                               #endif
 2696                                                         psha
 2697                                                         lda       ~1~
 2698                                                         and       #~1~_
 2699                                                         pula
 2700                                                         beq       ~2~
 2701                                                         endm
 2702                                     
 2703                                     ;*******************************************************************************
 2704                                     ; Adds a new OS call to table
 2705                                     
 2706                                     AddOS               macro     Name[,AlternateLocalName]
 2707                                                         #temp     :index
 2708                                                         mdef      2,?~1~
 2709                                                         #push
 2710                                                         #ROM
 2711                                               #ifdef HighRegs&HighRegs_End
 2712                                                 #if :pc >= HighRegs
 2713                                                   #if :pc <= HighRegs_End
 2714                                                         org       HighRegs_End+1
 2715                                                   #endif
 2716                                                 #endif
 2717                                               #endif
 2718                                                         mdef      0,{:pc}
 2719                                               #if :temp = 1
 2720                                                         org       :pc+{MAX_OS_CALLS*:ab} ;;make room for so many OS calls
 2721                                               #endif
 2722                                                         #ppc
 2723                                                         org       ~text~
 2724                                     #ifndef OSCommands
 2725                                     OSCommands          exp       *
 2726                                     #endif
 2727                                     f~1~                exp       :temp-1
 2728                                                         far       ~2~
 2729                                                         mset      0,{:pc}
 2730                                     NUMBER_OF_OS_CALLS  set       :temp               ;Number of opcodes defined (so far)
 2731                                                         org       :ppc
 2732                                               #if :temp > MAX_OS_CALLS
 2733                                                         merror    {MAX_OS_CALLS} MAX_OS_CALLS, need {:temp} (+{:temp-MAX_OS_CALLS})
 2734                                               #endif
 2735                                               #if :temp > 256
 2736                                                         #Warning  Double byte opcodes, OS => OSW
 2737                                               #endif
 2738                                                         #pull
 2739                                     ;-------------------------------------------------------------------------------
 2740                                                         endm
 2741                                     
 2742                                     ;*******************************************************************************
 2743                                     ; Define FLAG names (FLAG for port, FLAG. for pin number, and FLAG_ for mask)
 2744                                     ; to be used for defining bit (boolean) flags.
 2745                                     
 2746                                     Flag                macro     [FlagBaseName (needed first time or to change name)]
 2747                                               #ifb ~text~
 2748                                                 #ifb ~1~
 2749                                                         mreq      1:[FlagBaseName (needed first time or to change name)]
 2750                                                 #endif
 2751                                               #endif
 2752                                               #ifnb ~1~
 2753                                                         mset      0,~1~,1,0           ;;flag base name definition (starts with suffix 1)
 2754                                                 #ifb ~label~
 2755                                                         mexit                         ;;exit if no label with flag name definition
 2756                                                 #endif
 2757                                               #endif
 2758                                                         #temp     ~text','3~
 2759                                               #ifndef ~text,~~text','2~
 2760                                                         #push
 2761                                                         #RAM
 2762                                     ~text,~~text','2~   rmb       1
 2763                                                         #pull
 2764                                               #endif
 2765                                     ~label~             set       ~text,~~text','2~
 2766                                     ~label~.            equ       ~text','3~
 2767                                     ~label~_            equ       1<~text','3~
 2768                                                         #temp     :temp+1
 2769                                               #if :temp < 8
 2770                                                         mset      0,~text,~,~text','2~,{:temp}
 2771                                               #else
 2772                                                         #temp     ~text','2~+1
 2773                                                         mset      0,~text,~,{:temp},0
 2774                                               #endif
 2775                                                         endm
 2776                                     
 2777                                     ;*******************************************************************************
 2778                                     
 2779                                     aax                 macro     [count]
 2780                                                         mdef      1,1
 2781                                               #ifdef AAX
 2782                                                         call      AAX
 2783                                               #else
 2784                                                         !aax
 2785                                               #endif
 2786                                                         mtop      ~1~
 2787                                                         endm
 2788                                     
 2789                                     ;*******************************************************************************
 2790                                     ; In-place multiply a byte by ten. If no parameter is given then do so in RegA
 2791                                     
 2792                                     ByteX10             macro     Variable
 2793                                                         mset      #
 2794                                               #ifb ~1~
 2795                                                 #ifdef RegAx10
 2796                                                         call      RegAx10
 2797                                                         mexit
 2798                                                 #endif
 2799                                                         pshx
 2800                                                         ldx       #10
 2801                                                         mul
 2802                                                         pulx
 2803                                                         mexit
 2804                                               #endif
 2805                                               #ifnb ~#~
 2806                                                         merror    Variable expected (~1~)
 2807                                               #endif
 2808                                                         #push
 2809                                                         #spauto   :sp
 2810                                                         psha
 2811                                                         lda       ~1~
 2812                                                         pshx
 2813                                                         ldx       #10
 2814                                                         mul
 2815                                                         pulx
 2816                                                         sta       ~1~
 2817                                                         pula
 2818                                                         #pull
 2819                                                         endm
 2820                                     
 2821                                     ;*******************************************************************************
 2822                                     ; ASCII CONTROL CODES
 2823                                     
 2824                0000                 NULL                def        0                  ;null
 2825                0000                 NUL                 def        0                  ;alternate spelling for NULL
 2826                0001                 ASCII_SOH           def        1                  ;Start of Heading
 2827                0002                 ASCII_STX           def        2                  ;Start of Text
 2828                0003                 ASCII_ETX           def        3                  ;End of Text
 2829                0004                 EOT                 def        4                  ;End of Transmission
 2830                0005                 ASCII_ENQ           def        5                  ;Enquiry
 2831                0006                 ACK                 def        6                  ;Acknowledge
 2832                0007                 BELL                def        7                  ;Bell
 2833                0008                 BS                  def        8                  ;Backspace
 2834                0009                 TAB                 def        9                  ;Horizontal Tab
 2835                000A                 LF                  def       10                  ;Line Feed
 2836                000B                 ASCII_VT            def       11                  ;Vertical Tab
 2837                000C                 ASCII_FF            def       12                  ;Form Feed
 2838                000D                 CR                  def       13                  ;Carriage Return
 2839                000E                 ASCII_SO            def       14                  ;Shift Out
 2840                000F                 ASCII_SI            def       15                  ;Shift In
 2841                0010                 ASCII_DLE           def       16                  ;Data Link Escape
 2842                0011                 ASCII_DC1           def       17                  ;Device Control 1
 2843                0011                 XON                 def       17                  ;XON
 2844                0012                 ASCII_DC2           def       18                  ;Device Control 2
 2845                0013                 ASCII_DC3           def       19                  ;Device Control 3
 2846                0013                 XOFF                def       19                  ;XOFF
 2847                0014                 ASCII_DC4           def       20                  ;Device Control 4
 2848                0015                 ASCII_NAK           def       21                  ;Negative acknowledge
 2849                0016                 ASCII_SYN           def       22                  ;Synchronous idle
 2850                0017                 ASCII_ETB           def       23                  ;End of Transmission Block
 2851                0018                 ASCII_CAN           def       24                  ;Cancel
 2852                0019                 ASCII_EM            def       25                  ;End of Medium
 2853                001A                 ASCII_SUB           def       26                  ;CTRL-Z
 2854                001A                 CTRL_Z              def       26                  ; -//-
 2855                001B                 ESC                 def       27                  ;Escape
 2856                001C                 ASCII_FS            def       28                  ;File Separator
 2857                001D                 ASCII_GS            def       29                  ;Group Separator
 2858                001E                 ASCII_RS            def       30                  ;Record Separator
 2859                001F                 ASCII_US            def       31                  ;Unit Separator
 2860                                     
 2861                                     #ifdef PORTA&DDRA
 2863                                     #else ifdef PORTA&PORT_PTAIE&PORT_PTAOE
 2866                                     #endif
 2867                                     ;---------------------------- Miscellaneous ------------------------------------
 2868                                     
 2869                0002                 SPEED_SIZE          def       2                   ;1 = SPEED, 2 = SIZE optimization
 2870  M                                                      @ConstMinMax SPEED_SIZE,1,2
 2870  M                                                      mreq      1:Symbol[,MinValue][,MaxValue]
 2870  M                                                      mdef      4,1 <= SPEED_SIZE <= 2 [not 2]
 2870  M                                                      mset      0,1 <= SPEED_SIZE <= 2 [not 2]
 2870  M                                            #ifb 12
 2870  M                                            #endif
 2870  M                                            #ifnb 1
 2870  M                                              #if SPEED_SIZE < 1
 2870  M                                              #endif
 2870  M                                            #endif
 2870  M                                            #ifnb 2
 2870  M                                              #if SPEED_SIZE > 2
 2870  M                                              #endif
 2870  M                                            #endif
 2870                                                         endm
 2871                                     
 2872                0001                 BYTE                def       1                   ;8-bit quantity
 2873                0002                 WORD                def       2                   ;16-bit quantity
 2874                0003                 POINTER             def       3                   ;24-bit (paged) pointer
 2875                0004                 DWORD               def       4                   ;32-bit quantity
 2876                0008                 QWORD               def       8                   ;64-bit quantity
 2877                                     
 2878                0000                 S_BYTE              def       0,1                 ;size of 8-bit quantity
 2879                0000                 S_WORD              def       0,2                 ;size of 16-bit quantity
 2880                0000                 S_POINTER           def       0,:ab               ;size of pointer: 16-bit (normal), 24-bit (paged)
 2881                0000                 S_DWORD             def       0,4                 ;size of 32-bit quantity
 2882                0000                 S_QWORD             def       0,8                 ;size of 64-bit quantity
 2883                                     
 2884                0000                 MAXERROR            def       0                   ;used for error codes
 2885                FFFFFFFF             ERASED_STATE        def       -1                  ;default [E]EPROM/Flash Erased State
 2886                                               #ifndef STACK_IN_LOW_RAM
 2887                                                 #ifdef XRAM
 2888                1080                 STACKTOP            def       XRAM_END+1          ;top-of-stack plus one for use with LDHX, TXS
 2889                                                 #endif
 2890                                               #endif
 2891                1080                 STACKTOP            def       RAM_END+1           ;top-of-stack plus one for use with LDHX, TXS
 2892                0032                 REQUIRED_STACK      def       50                  ;minimum required stack in bytes
 2893                                               #ifhcs
 2894                0064                 MAX_OS_CALLS        def       100                 ;default room for OS calls (9S08)
 2895                                               #endif
 2896                0064                 MAX_OS_CALLS        def       64                  ;default room for OS calls (68HC08)
 2897  M                                                      @ConstMinMax MAX_OS_CALLS,1,256
 2897  M                                                      mreq      1:Symbol[,MinValue][,MaxValue]
 2897  M                                                      mdef      4,1 <= MAX_OS_CALLS <= 256 [not 100]
 2897  M                                                      mset      0,1 <= MAX_OS_CALLS <= 256 [not 100]
 2897  M                                            #ifb 1256
 2897  M                                            #endif
 2897  M                                            #ifnb 1
 2897  M                                              #if MAX_OS_CALLS < 1
 2897  M                                              #endif
 2897  M                                            #endif
 2897  M                                            #ifnb 256
 2897  M                                              #if MAX_OS_CALLS > 256
 2897  M                                              #endif
 2897  M                                            #endif
 2897                                                         endm
 2898                                     
 2899                                               #ifdef VERSION
 2901                                               #endif
 2902                                                         #Message  MCU Operating Voltage (VDD): {VDD(3)}V
 2903                                     
 2904                                     ?                   macro
 2905                                                         #Message  ~1~: {~1~} Hz ({~1~/RDIV} Hz IRCLK, RDIV={RDIV})
 2906                                                         endm
 2907                                     
 2908                                               #ifdef TCXO
 2910                                               #endif
 2911                                               #ifdef XTAL
 2912  M                                                      @?        XTAL
 2912  M                                                      #Message  XTAL: 4000000 Hz (31250 Hz IRCLK, RDIV=128)
 2912                                                         endm
 2913                                               #endif
 2914                                               #ifz KHZ\1000
 2915                                                         #Message  {KHZ/100(1)} MHz ({BUS_KHZ/100(1)} MHz bus, BDIV={BDIV}) Cycle: {10000000/BUS_KHZ(1)} nsec
 2918                                               #endif
 2919                                     
 2920                                     ?                   macro
 2921                                                         mswap     1,:loop
 2922                                               #ifdef ~1~&~1~_END
 2923                                                         #Message  ~1~~'..........:'.1.{10-:1}~ {~1~(h)}-{~1~_END(h)} ({~1~_END-~1~+1} bytes)
 2924                                               #endif
 2925                                                         mtop      :n
 2926                                                         endm
 2927                                     
 2928  M                                                      @?        RAM,XRAM,EEPROM,ROM,XROM
 2928  M                                                      mswap     1,:loop
 2928  M                                            #ifdef RAM&RAM_END
 2928  M                                                      #Message  RAM....... $0080-$00FF (128 bytes)
 2928  M                                            #endif
 2928  M                                                      mtop      :n
 2928  M                                                      mswap     1,:loop
 2928  M                                            #ifdef XRAM&XRAM_END
 2928  M                                                      #Message  XRAM...... $0100-$107F (3968 bytes)
 2928  M                                            #endif
 2928  M                                                      mtop      :n
 2928  M                                                      mswap     1,:loop
 2928  M                                            #ifdef EEPROM&EEPROM_END
 2928  M                                                      #Message  EEPROM.... $1400-$17FF (1024 bytes)
 2928  M                                            #endif
 2928  M                                                      mtop      :n
 2928  M                                                      mswap     1,:loop
 2928  M                                            #ifdef ROM&ROM_END
 2928  M                                                      #Message  ROM....... $1900-$FF9F (59040 bytes)
 2928  M                                            #endif
 2928  M                                                      mtop      :n
 2928  M                                                      mswap     1,:loop
 2928  M                                            #ifdef XROM&XROM_END
 2928  M                                                      #Message  XROM...... $1080-$13FF (896 bytes)
 2928  M                                            #endif
 2928  M                                                      mtop      :n
 2928                                                         endm
 2929                                                         #Message  DataFlash: {FLASH_DATA_SIZE} bytes
 2930                                     
 2931                                               #ifnz REQUIRED_STACK
 2932                                                 #ifdef MAXTASKS
 2934                                                 #else
 2935                                                         #temp     REQUIRED_STACK
 2936                                                 #endif
 2937                                                         #Message  STACK: {STACKTOP-:temp(h)}-{STACKTOP-1(h)} [REQUIRED_STACK: {:temp} bytes]
 2940                                               #endif
 2941                                     
 2942                                     ;--- Allocate variable space (accounting for required stack)
 2943                                     
 2944                                     ?                   macro     FromAddress,ToAddress
 2945                                               #ifdef MAXTASKS
 2946                                                         mdef      2,STACKTOP-{REQUIRED_STACK*MAXTASKS}-1
 2947                                               #endif
 2948                                                         mdef      2,STACKTOP-REQUIRED_STACK-1
 2949                                                         #VARIABLE ~1~ ~2~
 2950                                                         #Message  Variable space in ~1~~' :'.{:1-2}~ {~1~(h)}-{~2~(h)} ({~2~-~1~+1} bytes)
 2951                                                         endm
 2952                                     #ifdef XRAM
 2953                                               #if STACKTOP > XRAM
 2954  M                                                      @?        RAM,RAM_END
 2954  M                                            #ifdef MAXTASKS
 2954  M                                            #endif
 2954  M                                                      mdef      2,STACKTOP-REQUIRED_STACK-1
 2954  M                                                      #VARIABLE RAM RAM_END
 2954  M                                                      #Message  Variable space in RAM : $0080-$00FF (128 bytes)
 2954                                                         endm
 2955  M                                                      @?        XRAM
 2955  M                                            #ifdef MAXTASKS
 2955  M                                            #endif
 2955  M                                                      mdef      2,STACKTOP-REQUIRED_STACK-1
 2955  M                                                      #VARIABLE XRAM STACKTOP-REQUIRED_STACK-1
 2955  M                                                      #Message  Variable space in XRAM: $0100-$104D (3918 bytes)
 2955                                                         endm
 2959                                               #endif
 2962                                     #endif
 2963                                               ;--- Flash page mask
 2964                                     #ifdef FLASH_PAGE_SIZE
 2965                FD00                 FLASH_PAGE_MASK     def       FLASH_PAGE_SIZE-1^$FFFF
 2966                                                         #Message  FLASH_PAGE_SIZE = {FLASH_PAGE_SIZE} (FLASH_PAGE_MASK = {FLASH_PAGE_MASK(h)})
 2967                                     #endif
 2968                                     ;------------------- Flash Clock calculation based on bus KHZ ------------------
 2969                                     #ifhcs
 2970                0096                 MIN_FLASH_KHZ       def       150
 2971                00C8                 MAX_FLASH_KHZ       def       200
 2972                                     
 2973                                     ?                   macro     [TargetFlashKHZ]
 2974                                                         mdef      1,MAX_FLASH_KHZ     ;ideal Flash clock is MAX_FLASH_KHZ
 2975                                                         #temp     BUS_KHZ/~1~-1       ;divide bus by 1
 2976                                                         mset      2,:temp&$3F+1
 2977                                               #ifdef PRDIV8_
 2978                                                 #if BUS_KHZ/~1~-1 > 63                ;divide bus by 8
 2979                                                         #temp     BUS_KHZ/8/~1~-1|PRDIV8_
 2980                                                         mset      2,:temp&$3F+1*8
 2981                                                 #endif
 2982                                               #endif
 2983                                                         mset      2,BUS_KHZ/{~2~}
 2984                                               #if ~2~ > MAX_FLASH_KHZ
 2985                                                         mset      1,{~1~-1}
 2986                                                         mtop
 2987                                               #else if ~2~ < MIN_FLASH_KHZ
 2988                                                         merror    No suitable FLASH_CLK_VALUE @ {KHZ(3)} MHz
 2989                                               #endif
 2990                                     FLASH_CLK_VALUE     equ       :temp
 2991                                                         #Message  FLASH @ {~2~} KHz (use FCDIV := FLASH_CLK_VALUE [{FLASH_CLK_VALUE}])
 2992                                                         endm
 2993                                     
 2994  M                                                      @?                            ;Calc Flash Clock Value
 2994  M                                                      mdef      1,MAX_FLASH_KHZ     ;ideal Flash clock is MAX_FLASH_KHZ
 2994  M                                                      #temp     BUS_KHZ/MAX_FLASH_KHZ-1       ;divide bus by 1
 2994  M                                                      mset      2,:temp&$3F+1
 2994  M                                            #ifdef PRDIV8_
 2994  M                                              #if BUS_KHZ/MAX_FLASH_KHZ-1 > 63                ;divide bus by 8
 2994  M                                                      #temp     BUS_KHZ/8/MAX_FLASH_KHZ-1|PRDIV8_
 2994  M                                                      mset      2,:temp&$3F+1*8
 2994  M                                              #endif
 2994  M                                            #endif
 2994  M                                                      mset      2,BUS_KHZ/80
 2994  M                                            #if BUS_KHZ/80 > MAX_FLASH_KHZ
 2994  M                                            #else if BUS_KHZ/80 < MIN_FLASH_KHZ
 2994  M                                            #endif
 2994  M             0049                 FLASH_CLK_VALUE     equ       :temp
 2994  M                                                      #Message  FLASH @ 200 KHz (use FCDIV := FLASH_CLK_VALUE [73])
 2994                                                         endm
 2995                                     #endif
 2996                                     ;-------------------------------------------------------------------------------
 2997                                     ;-------------------------------------------------------------------------------
 2998                                               #ifdef SIMHCS
 3000                                               #else ifdef DEBUG
 3002                                               #endif
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/common.inc *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/dz60.inc)
 1009                                     ;-------------------------------------------------------------------------------
 1010                                     
 1011                                                         #EEPROM
 1012                1400                                     org       EEPROM
 1013                                     
 1014                                                         #DATA
 1015                                     
 1016                                     
 1017                                               #ifndef BOOT
 1018                FFBD                                     org       NVPROT              ;NV flash protection byte
 1019    [FFBD] FFBD.E0                                       fcb       ?NVPROT_MASK        ;NVPROT transfers to FPROT on reset
 1020                                     
 1021                                               #ifndef NVOPT_VALUE
 1022                                                         #Message  Using default NVOPT_VALUE (no vector redirection)
 1023                                               #endif
 1024                                     
 1025                00E2                 NVOPT_VALUE         def       %11100010           ;NVFEOPT transfers to FOPT on reset
 1026                                                                  ; |||||||+----------- SEC00 \ 00:secure  10:unsecure
 1027                                                                  ; ||||||+------------ SEC01 / 01:secure  11:secure
 1028                                                                  ; |||+++------------- Not Used (Always 0)
 1029                                                                  ; ||+---------------- EPGMOD - EEPROM Sector Mode (0=4-byte, 1=8-byte)
 1030                                                                  ; |+----------------- FNORED - Vector Redirection Disable (No Redirection)
 1031                                                                  ; +------------------ KEYEN - Backdoor key mechanism enable
 1032                                     
 1033                FFBF                                     org       NVOPT               ;NV flash options byte
 1034    [FFBF] FFBF.E2                                       fcb       NVOPT_VALUE         ;NVFEOPT transfers to FOPT on reset
 1035                                               #endif
 1036                                     ;                   org       NVICSTRIM           ;NV ICS Trim Setting
 1037                                     ;                   fcb       ??                  ;ICG trim value measured during factory test. User software optionally
 1038                                     ;                                                 ;copies to ICGTRM during initialization.
 1039                                                         #VECTORS
 1040                FFC0                                     org       VECTORS
 1041                                     
 1042                                                         #RAM
 1043                0080                                     org       RAM
 1044                                     
 1045                                                         #XRAM
 1046                0100                                     org       XRAM
 1047                                     
 1048                                                         #ROM
 1049                1900                                     org       ROM
 1050                                     
 1051                                                         #MEMORY   ROM       ROM_END
 1052                                                         #MEMORY   NVBACKKEY NVBACKKEY+7
 1053                                                         #MEMORY   NVPROT
 1054                                                         #MEMORY   NVOPT
 1055                                                         #MEMORY   VECTORS   VECTORS|$00FF
 1056                                                         #MEMORY   EEPROM    EEPROM_END
 1057                                               #ifdef CRC_LOCATION
 1059                                               #endif
 1060                                     
 1061                                     ;*******************************************************************************
 1062                                     
 1063                                     ;*******************************************************************************
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/dz60.inc *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   11                                     ; ===================== CONFIG =================================================
   12                                     
   13                0001                 IS_DISPLAY      equ     1       ; Define if display is available for debug purpose in IIC
   14                                     
   15                001E                 ST_TRESHHOLD    equ     30      ; Switch Time Threshold in 10ms. Short pulse: state<ST_TRESHHOLD, Long pulse: state>ST_TRESHHOLD
   16                000A                 FILT_MAX        equ     10      ; Switch input filter time in 10ms.
   17                                     
   18                0000                 LEVEL_OFF       equ     0       ; Level in Off state
   19                0004                 LEVEL_LOW_1     equ     4       ; Level when Low comes from Off
   20                0006                 LEVEL_LOW_2     equ     6       ; Level when Low comes from High (original low level was 60%)
   21                0009                 LEVEL_HIGH      equ     9       ; Level in High state
   22                                     
   23                00D5                 ADC_CAL_U       equ     213     ; Voltage measured during calibration in 0.1V resolution
   24                0066                 ADC_CAL_V       equ     102     ; ADC value when measuring ADC_CAL_U voltage
   25                                     
   26                006E                 UNDERVOLTAGE    equ     110     ; PWM inhibit voltage level in 0.1V resolution
   27                                     
   28                                     ; uC port definitions with line names in schematic
   29  M                                  LED2            @pin    PTA,6   ; Status LED
   29  M                                            #ifb PTA,6
   29  M                                            #endif
   29  M                                            #ifb LED2
   29  M                                            #else ifnb PTA,6
   29  M                                                      mreq      1:PORT[,BitNumber]
   29  M                                                      mdef      2,0
   29  M                                                      mset      0,LED2
   29  M                                                      #temp     6
   29  M             0000                 LED2             set       PTA
   29  M             0006                 LED2.            equ       6
   29  M             0040                 LED2_            equ       1<LED2.
   29  M                                            #endif
   29  M                                            #if :temp > 7
   29  M                                            #endif
   29                                                         endm
   30  M                                  CANRX           @pin    PTE,7
   30  M                                            #ifb PTE,7
   30  M                                            #endif
   30  M                                            #ifb CANRX
   30  M                                            #else ifnb PTE,7
   30  M                                                      mreq      1:PORT[,BitNumber]
   30  M                                                      mdef      2,0
   30  M                                                      mset      0,CANRX
   30  M                                                      #temp     7
   30  M             0008                 CANRX             set       PTE
   30  M             0007                 CANRX.            equ       7
   30  M             0080                 CANRX_            equ       1<CANRX.
   30  M                                            #endif
   30  M                                            #if :temp > 7
   30  M                                            #endif
   30                                                         endm
   31  M                                  CANTX           @pin    PTE,6
   31  M                                            #ifb PTE,6
   31  M                                            #endif
   31  M                                            #ifb CANTX
   31  M                                            #else ifnb PTE,6
   31  M                                                      mreq      1:PORT[,BitNumber]
   31  M                                                      mdef      2,0
   31  M                                                      mset      0,CANTX
   31  M                                                      #temp     6
   31  M             0008                 CANTX             set       PTE
   31  M             0006                 CANTX.            equ       6
   31  M             0040                 CANTX_            equ       1<CANTX.
   31  M                                            #endif
   31  M                                            #if :temp > 7
   31  M                                            #endif
   31                                                         endm
   32  M                                  RxD1            @pin    PTE,1   ; Same circuit as IN1
   32  M                                            #ifb PTE,1
   32  M                                            #endif
   32  M                                            #ifb RxD1
   32  M                                            #else ifnb PTE,1
   32  M                                                      mreq      1:PORT[,BitNumber]
   32  M                                                      mdef      2,0
   32  M                                                      mset      0,RxD1
   32  M                                                      #temp     1
   32  M             0008                 RxD1             set       PTE
   32  M             0001                 RxD1.            equ       1
   32  M             0002                 RxD1_            equ       1<RxD1.
   32  M                                            #endif
   32  M                                            #if :temp > 7
   32  M                                            #endif
   32                                                         endm
   33  M                                  RxD1_2          @pin    PTA,0 ; Same circuit as RxD1
   33  M                                            #ifb PTA,0
   33  M                                            #endif
   33  M                                            #ifb RxD1_2
   33  M                                            #else ifnb PTA,0
   33  M                                                      mreq      1:PORT[,BitNumber]
   33  M                                                      mdef      2,0
   33  M                                                      mset      0,RxD1_2
   33  M                                                      #temp     0
   33  M             0000                 RxD1_2             set       PTA
   33  M             0000                 RxD1_2.            equ       0
   33  M             0001                 RxD1_2_            equ       1<RxD1_2.
   33  M                                            #endif
   33  M                                            #if :temp > 7
   33  M                                            #endif
   33                                                         endm
   34  M                                  IN2             @pin    PTA,1
   34  M                                            #ifb PTA,1
   34  M                                            #endif
   34  M                                            #ifb IN2
   34  M                                            #else ifnb PTA,1
   34  M                                                      mreq      1:PORT[,BitNumber]
   34  M                                                      mdef      2,0
   34  M                                                      mset      0,IN2
   34  M                                                      #temp     1
   34  M             0000                 IN2             set       PTA
   34  M             0001                 IN2.            equ       1
   34  M             0002                 IN2_            equ       1<IN2.
   34  M                                            #endif
   34  M                                            #if :temp > 7
   34  M                                            #endif
   34                                                         endm
   35  M                                  FET1            @pin    PTD,2   ; PWM output port
   35  M                                            #ifb PTD,2
   35  M                                            #endif
   35  M                                            #ifb FET1
   35  M                                            #else ifnb PTD,2
   35  M                                                      mreq      1:PORT[,BitNumber]
   35  M                                                      mdef      2,0
   35  M                                                      mset      0,FET1
   35  M                                                      #temp     2
   35  M             0006                 FET1             set       PTD
   35  M             0002                 FET1.            equ       2
   35  M             0004                 FET1_            equ       1<FET1.
   35  M                                            #endif
   35  M                                            #if :temp > 7
   35  M                                            #endif
   35                                                         endm
   36  M                                  FET             @pin    PTD,3   ; PWM output port
   36  M                                            #ifb PTD,3
   36  M                                            #endif
   36  M                                            #ifb FET
   36  M                                            #else ifnb PTD,3
   36  M                                                      mreq      1:PORT[,BitNumber]
   36  M                                                      mdef      2,0
   36  M                                                      mset      0,FET
   36  M                                                      #temp     3
   36  M             0006                 FET             set       PTD
   36  M             0003                 FET.            equ       3
   36  M             0008                 FET_            equ       1<FET.
   36  M                                            #endif
   36  M                                            #if :temp > 7
   36  M                                            #endif
   36                                                         endm
   37  M                                  SW_L            @pin    PTE,3   ; Left developer board button
   37  M                                            #ifb PTE,3
   37  M                                            #endif
   37  M                                            #ifb SW_L
   37  M                                            #else ifnb PTE,3
   37  M                                                      mreq      1:PORT[,BitNumber]
   37  M                                                      mdef      2,0
   37  M                                                      mset      0,SW_L
   37  M                                                      #temp     3
   37  M             0008                 SW_L             set       PTE
   37  M             0003                 SW_L.            equ       3
   37  M             0008                 SW_L_            equ       1<SW_L.
   37  M                                            #endif
   37  M                                            #if :temp > 7
   37  M                                            #endif
   37                                                         endm
   38  M                                  SW_R            @pin    PTE,2   ; Right developer board button
   38  M                                            #ifb PTE,2
   38  M                                            #endif
   38  M                                            #ifb SW_R
   38  M                                            #else ifnb PTE,2
   38  M                                                      mreq      1:PORT[,BitNumber]
   38  M                                                      mdef      2,0
   38  M                                                      mset      0,SW_R
   38  M                                                      #temp     2
   38  M             0008                 SW_R             set       PTE
   38  M             0002                 SW_R.            equ       2
   38  M             0004                 SW_R_            equ       1<SW_R.
   38  M                                            #endif
   38  M                                            #if :temp > 7
   38  M                                            #endif
   38                                                         endm
   39                                     
   40                                     ; ===================== INCLUDE FILES ==========================================
   41                                     
   42                                     #include "cop.a08"              ; Watchdog module functions
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/cop.a08 ***
    1                                     ; ===================== Sub-Routines ==========================================
    2                                     #ROM
    3                                     
    4                                     ; ------------------------------------------------------------------------------
    5                                     ; Computer Operating Properly (COP) Watchdog
    6                1900                 COP_Init
    7                                             ; System Options Register 2
    8                                             ; COPCLKS = 0 (1kHz)
    9                                             ; COPW = 0 (No COP Window)
   10                                             ; ADHTS = 0 (ADC Hardware Trigger from RTC overflow)
   11                                             ; MCSEL = 0 (MCLK output on PTA0 is disabled)
   12                                             ; -> So, no change needed for SOPT2
   13                                     
   14                                             ; System Options Register 1
   15                                             ; COPT = 01b (2^5 cycles, 1kHz) ~= 32ms
   16                                             ; STOPE = 0 (Stop mode disabled)
   17                                             ; SCI2PS = 0 (TxD2 on PTF0, RxD2 on PTF1.)
   18                                             ; IICPS = 0 (SCL on PTF2, SDA on PTF3)
   19    [1900] 1900:A648            [ 2]         lda     #COPT0_|IICPS_
   20    [1902] 1902:C718 02         [ 4]         sta     SOPT1
   21    [1905] 1905:81              [ 6]         rts
   22                                     
   23                                             ; Refresh Watchdog
   24                1906                 KickCop
   25    [1906] 1906:87              [ 2]         psha                    ; Save A, because function will change it
   26    [1907] 1907:A655            [ 2]         lda       #$55          ; First pattern $55
   27    [1909] 1909:C718 00         [ 4]         sta       COP
   28    [190C] 190C:43              [ 1]         coma                    ; Second pattern $AA
   29    [190D] 190D:C718 00         [ 4]         sta       COP
   30    [1910] 1910:86              [ 3]         pula                    ; Restore original content of A
   31    [1911] 1911:81              [ 6]         rts
   32                                     
   33                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/cop.a08 *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   43                                     #include "mcg.a08"              ; Clock Generator functions
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/mcg.a08 ***
    1                                     ; ===================== Sub-Routines ==========================================
    2                                     #ROM
    3                                     ; ------------------------------------------------------------------------------
    4                                     ; Using DZ60, the function will switch to PEE Mode (based on AN3499)
    5                                     ;  Fext = 4MHz (crystal)
    6                                     ;  Fmcgout = ((Fext/R)*M/B) - for PEE mode
    7                                     ;  Fbus = Fmcgout/2 (8MHz)
    8                1912                 MCG_Init
    9                                             ; -- First, FEI must transition to FBE mode
   10                                     
   11                                             ; MCG Control Register 2 (MCGC2)
   12                                             ;  BDIV = 00 - Set clock to divide by 1
   13                                             ;  RANGE_SEL = 1 - High Freq range selected (i.e. 4MHz in high freq range)
   14                                             ;  HGO = 1 - Ext Osc configured for high gain
   15                                             ;  LP = 0 - FLL or PLL is not disabled in bypass modes
   16                                             ;  EREFS = 1 - Oscillator requested
   17                                             ;  ERCLKEN = 1 - MCGERCLK active
   18                                             ;  EREFSTEN = 0 - Ext Reference clock is disabled in stop
   19    [1912] 1912:6E26 49         [ 4]         mov     #RANGE_SEL_|EREFS_|ERCLKEN_,MCGC2 ; HGO_|
   20                                     
   21                                             ; Loop until OSCINIT = 1 - indicates crystal selected by EREFS bit has been initalised
   22                1915                 imcg1
   23    [1915] 1915:034B FD         [ 5]         brclr   OSCINIT.,MCGSC,imcg1
   24                                     
   25                                             ; MCG Control Register 1 (MCGC1)
   26                                             ;  CLKSx    = 10    Select Ext reference clk as clock source
   27                                             ;  RDIVx    = 111   Set to divide by 128 (i.e. 4MHz/128 = 31.25kHz - in range required by FLL)
   28                                             ;  IREFS    = 0     Ext Ref clock selected
   29                                             ;  IRCLKEN  = 0     MCGIRCLK inactive
   30                                             ;  IREFSTEN = 0     Internal ref clock disabled in stop
   31    [1918] 1918:6EB8 48         [ 4]         mov     #CLKS1_|RDIV2_|RDIV1_|RDIV0_,MCGC1
   32                                     
   33                                             ; Loop until IREFST = 0 - indicates ext ref is current source
   34                191B                 imcg2
   35    [191B] 191B:084B FD         [ 5]         brset  IREFST.,MCGSC,imcg2
   36                                     
   37                                             ; Loop until CLKST = 10 - indiates ext ref clk selected to feed MCGOUT
   38                191E                 imcg3
   39    [191E] 191E:B64B            [ 3]         lda     MCGSC
   40    [1920] 1920:A40C            [ 2]         and     #CLKST1_|CLKST0_        ; mask CLKST bits
   41    [1922] 1922:A108            [ 2]         cmp     #CLKST1_
   42    [1924] 1924:26F8 (191E)     [ 3]         bne     imcg3
   43                                     
   44                                             ; -- Next FBE must transition to PBE mode
   45                                     
   46                                             ; MCG Control Register 1 (MCGC1)
   47                                             ;  CLKSx    = 10    Select Ext reference clk as clock source
   48                                             ;  RDIVx    = 010   Set to divide by 4 (i.e. 4MHz/4 = 1 MHz - in range required by FLL)
   49                                             ;  IREFS    = 0     Ext Ref clock selected
   50                                             ;  IRCLKEN  = 0     MCGIRCLK inactive
   51                                             ;  IREFSTEN = 0     Internal ref clock disabled in stop
   52    [1926] 1926:6E90 48         [ 4]         mov     #CLKS1_|RDIV1_,MCGC1
   53                                     
   54                                             ; MCG Control Register 3 (MCGC3)
   55                                             ;  LOLIE = 0    No request on loss of lock
   56                                             ;  PLLS  = 1    PLL selected
   57                                             ;  CME   = 0    Clock monitor is disabled
   58                                             ;  VDIV  = 0100 Set to multiply by 16 (1Mhz ref x 16 = 16MHz)
   59    [1929] 1929:6E44 4C         [ 4]         mov     #PLLS_|4,MCGC3
   60                                     
   61                                             ; Loop until PLLST = 1 - indicates current source for PLLS is PLL
   62                192C                 imcg4
   63    [192C] 192C:0B4B FD         [ 5]         brclr   PLLST.,MCGSC,imcg4
   64                                     
   65                                             ; Loop until LOCK = 1 - indicates PLL has aquired lock
   66                192F                 imcg5
   67    [192F] 192F:0D4B FD         [ 5]         brclr   LOCK.,MCGSC,imcg5
   68                                     
   69                                             ; -- Last, PBE mode transitions into PEE mode
   70                                     
   71                                             ; MCG Control Register 1 (MCGC1)
   72                                             ;  CLKS     = 00    Select PLL clock source
   73                                             ;  RDIV     = 010   Set to divide by 4 (i.e. 4MHz/4 = 1 MHz - in range required by PLL)
   74                                             ;  IREFS    = 0     Ext Ref clock selected
   75                                             ;  IRCLKEN  = 0     MCGIRCLK inactive
   76                                             ;  IREFSTEN = 0     Internal ref clock disabled in stop
   77    [1932] 1932:6E10 48         [ 4]         mov     #RDIV1_,MCGC1
   78                                     
   79                                             ; Loop until CLKST = 11 - PLL O/P selected to feed MCGOUT in current clk mode
   80                1935                 imcg6
   81    [1935] 1935:B64B            [ 3]         lda     MCGSC
   82    [1937] 1937:A40C            [ 2]         and     #CLKST1_|CLKST0_        ; mask CLKST bits
   83    [1939] 1939:A10C            [ 2]         cmp     #CLKST1_|CLKST0_
   84    [193B] 193B:26F8 (1935)     [ 3]         bne     imcg6
   85                                     
   86                                             ; ABOVE CODE ALLOWS ENTRY FROM PBE TO PEE MODE
   87                                     
   88                                             ; Since RDIV = 4, BDIV = 1, VDIV = 16
   89                                             ; Now
   90                                             ;  Fmcgout = ((4MHz/4)*16)/1 = 16MHz
   91                                             ;  Fbus = Fmcgout/2 = 8MHz
   92                                     
   93    [193D] 193D:81              [ 6]         rts
   94                                     
   95                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/mcg.a08 *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   44                                     #include "rtc.a08"              ; Real-Time Counter functions
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/rtc.a08 ***
    1                                     ; ====================  VARIABLES  =============================================
    2                                     #RAM
    3                                     
    4                0032                 NORMAL_PERIOD   equ     50      ; Normal status led toggle time in 10ms
    5                                     
    6           0080+0001                 led_timer       ds      1       ; Timer for flash status LED
    7           0081+0001                 led_period      ds      1       ; Period for flash status LED in 10ms
    8                                     
    9                0082                 cntdwntimers                    ; pointer to first timer
   10           0082+0001                 timeout         ds      1       ; Timeout timer for loops.
   11           0083+0001                 canrxto         ds      1       ; Timeout timer for CAN reception
   12           0084+0001                 cantxhb         ds      1       ; Timeer for send heartbit message
   13                0003                 cntdwntimcnt    equ     $-cntdwntimers  ; Calculate number of timers
   14                                     
   15           0085+0001                 timeevents      ds      1       ; Time related cyclic event bits
   16  M                                                  @bitnum EVERY10MS,7
   16  M             0007                 EVERY10MS.                equ       7
   16  M             0080                 EVERY10MS_                equ       1<EVERY10MS.
   16                                                         endm
   17                                     
   18                                     
   19                                     ; ===================== Sub-Routines ==========================================
   20                                     #ROM
   21                                     
   22                                     ; ------------------------------------------------------------------------------
   23                                     ; Real-Time Counter (S08RTCV1)
   24                                     ; This is periodic timer. (Like PIT in AZ60, TBM in GZ60 in the past)
   25                                     ;  - Use interrupt to handle software timer variables (RTIE = 1)
   26                                     ;  - Select external clock (RTCLKS = 1)
   27                                     ;  - RTCPS = 11 (10^4 means 4MHz/10000 = 400Hz)
   28                                     ;  - RTCMOD = 3 (400Hz/4 = 100Hz -> 10ms)
   29                                     ; This will result 1s periodic interrupt.
   30                193E                 RTC_Init
   31                                             ; Set up registers
   32    [193E] 193E:6E3B 6C         [ 4]         mov     #RTIE_|RTCLKS0_|11,RTCSC
   33    [1941] 1941:6E03 6E         [ 4]         mov     #3,RTCMOD
   34                                     
   35    [1944] 1944:3F80            [ 5]         clr     led_timer
   36    [1946] 1946:3F85            [ 5]         clr     timeevents
   37                                     
   38                                             ; foreach(timers as timer)timer=0;
   39    [1948] 1948:8C              [ 1]         clrh
   40    [1949] 1949:AE03            [ 2]         ldx     #cntdwntimcnt
   41                194B                 RTC_I_timloop
   42    [194B] 194B:6F81            [ 5]         clr     cntdwntimers-1,x ; Clear timer
   43    [194D] 194D:5BFC (194B)     [ 4]         dbnzx   RTC_I_timloop
   44                                     
   45    [194F] 194F:6E32 81         [ 4]         mov     #NORMAL_PERIOD,led_period
   46                                     
   47    [1952] 1952:81              [ 6]         rts
   48                                     
   49                                     ; RTC periodic interrupt service routine, hits in every 10ms
   50                                     ; This is used only to flash status LED.
   51                1953                 RTC_IT
   52    [1953] 1953:1E6C            [ 5]         bset    RTIF.,RTCSC     ; Clear flag
   53    [1955] 1955:8B              [ 2]         pshh                            ; Save H, because ISR will use it
   54                                     
   55                                             ; Handle Status LED
   56    [1956] 1956:3C80            [ 5]         inc     led_timer
   57    [1958] 1958:B680            [ 3]         lda     led_timer
   58    [195A] 195A:B181            [ 3]         cmp     led_period
   59    [195C] 195C:2508 (1966)     [ 3]         blo     RTC_IT_noledtoggle
   60    [195E] 195E:3F80            [ 5]         clr     led_timer
   61    [1960] 1960:B600            [ 3]         lda     LED2            ; |
   62    [1962] 1962:A840            [ 2]         eor     #LED2_          ; + Toggle status LED
   63    [1964] 1964:B700            [ 3]         sta     LED2            ; |
   64                1966                 RTC_IT_noledtoggle
   65                                     
   66                                             ; foreach(timers as timer)if(timer)timer--;
   67    [1966] 1966:8C              [ 1]         clrh
   68    [1967] 1967:AE03            [ 2]         ldx     #cntdwntimcnt
   69                1969                 RTC_IT_timloop
   70    [1969] 1969:E681            [ 3]         lda     cntdwntimers-1,x ; Check timer
   71    [196B] 196B:2703 (1970)     [ 3]         beq     RTC_IT_nodec    ; If already null, no dec needed, jump
   72    [196D] 196D:4A              [ 1]         deca                    ; Decrement
   73    [196E] 196E:E781            [ 3]         sta     cntdwntimers-1,x ; Save timer
   74                1970                 RTC_IT_nodec
   75    [1970] 1970:5BF7 (1969)     [ 4]         dbnzx   RTC_IT_timloop
   76                                     
   77                                     
   78    [1972] 1972:CD23 12         [ 6]         jsr     meas_uz
   79    [1975] 1975:CD23 60         [ 6]         jsr     read_switch
   80    [1978] 1978:CD24 36         [ 6]         jsr     calc_motor
   81    [197B] 197B:CD24 BA         [ 6]         jsr     write_pwm
   82                                     
   83    [197E] 197E:8A              [ 3]         pulh                            ; Restore H
   84    [197F] 197F:80              [ 9]         rti
   85                                     
   86                                     
   87                                     ; ===================== IT VECTORS ==========================================
   88                                     #VECTORS
   89                                     
   90                FFCC                         org     Vrtc
   91    [FFCC] FFCC.1953                         dw      RTC_IT
   92                                     
   93                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/rtc.a08 *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   45                                     #ifdef IS_DISPLAY
   46                                       #include "iic.a08"            ; I2C communication functions
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/iic.a08 ***
    1                                     ; =============================================================================
    2                                     ; IIC module for 9S08DZ60 microcontroller
    3                                     ; =============================================================================
    4                                     ; Module only supports master operation. But both Tx and Rx.
    5                                     ; Module shall be initialized by call of init function.
    6                                     ; Communication is managed by interrupt service routine.
    7                                     ; User must only define a so called "action list", which describes what to do.
    8                                     ; Action list can be any in ROM or RAM, depends on the needs. When action
    9                                     ; list is prepared, its address shall be load into HX register, device slave
   10                                     ; address to be loaded into register IICA and call function to start execution
   11                                     ; of actions.
   12                                     ; When device slave address is written into IICA, LSB bit shall always be zero.
   13                                     ;  This bit will handled automatic by the IIC engine according to action list.
   14                                     ; Action list consists of actions. Structure of an action is:
   15                                     ; - Command byte.
   16                                     ;   - Bit7 means direction. Read(1) or write(0).
   17                                     ;   - Bit6-bit0 means number of data bytes of action.
   18                                     ; If action is write, next bytes are data bytes to be sent. Number of bytes
   19                                     ;  defined in command byte.
   20                                     ; If action is read, next two bytes are RAM address where received data to be
   21                                     ;  read. Please ensure to reserve enough long buffer for read data.
   22                                     ; Zero command value has special meaning, that there is no more action.
   23                                     ; Some examples:
   24                                     ;  $01 $55 - write one byte data is $55
   25                                     ;  $03 $55 $AA $CC - write three bytes, data are $55 $AA $CC
   26                                     ;  $81 $00 $80 - read one byte into RAM address $0080
   27                                     ;  $84 $01 $10 - read four bytes from RAM address $0110 ($0110-$0113)
   28                                     
   29                                     ;
   30                                     ;#include "dz60.inc"
   31                                     ; ====================  VARIABLES  ============================================
   32                                     
   33                                     #RAM
   34                                     
   35                                     ; IIC module variables
   36           0086+0001                 IIC_dl          ds      1       ; Data lenght
   37           0087+0002                 IIC_alp         ds      2       ; Action list pointer
   38           0089+0002                 IIC_rbp         ds      2       ; Read buffer pointer
   39                                     
   40                                     ; Variables of example
   41                                     ;IIC_rb          ds      2       ; Read buffer
   42                                     
   43                                     ; ====================  EQUATES ===============================================
   44                                     
   45                                     ; Only for example
   46                                     ;IIC_rba         equ     IIC_rb  ; This is just to be usable IIC_rb after dw
   47                                     
   48                                     ; ====================  USING EXAMPLE  ========================================
   49                                     ; Call init before enable global interrupt (cli)
   50                                     ;        jsr     IIC_Init
   51                                     ; Do not forget to adjust speed for your device and cable length.
   52                                     
   53                                     ; Load action list address into HX and call IIC Execute Command function
   54                                     ;        mov     #$90,IICA               ; Device byte of slave IC
   55                                     ;        ldhx    #IIC_cmds               ; Address of action list
   56                                     ;        jsr     IIC_ec                  ; Start execution of command
   57                                     ; The communication will be managed by interrupt, so result will be available
   58                                     ; only later, not right after call of IIC_ec.
   59                                     
   60                                     ; Action list for configuration of AD7416 temp sensor chip and read temperature
   61                                     ; value from the sensor.
   62                                     ;IIC_cmds
   63                                     ;        db      $02     ; C: Write, 2 bytes (init config register)
   64                                     ;        db      $01     ; D: Select Configuration register (address #1)
   65                                     ;        db      $00     ; D: Write into register (all bits to be zero)
   66                                     ;        db      $01     ; C: Write, 1 byte (Select register to read)
   67                                     ;        db      $00     ; D: Select temperature value register (address #0)
   68                                     ;        db      $82     ; C: Read, 2 bytes temperature value (mask $FFC0)
   69                                     ;        dw      IIC_rba ; A: Read data into this variable
   70                                     ;        db      $00     ; C: Final Stop (no more task to do)
   71                                     
   72                                     ; ===================== Sub-Routines ==========================================
   73                                     #ROM
   74                1980                 IIC_beg
   75                                     ; ------------------------------------------------------------------------------
   76                                     ; IIC initalization and for waiting for call IIC_ec to start in Master mode
   77                1980                 IIC_Init
   78    [1980] 1980:6E80 5A         [ 4]         mov     #IICEN_,IICC            ; Switch ON IIC
   79    [1983] 1983:6E40 59         [ 4]         mov     #MULTBY2,IICF           ; 8MHz / (2*20) ~= 200kHz (See manual page 205 why 0 means 20) For very short cable
   80                                     ;        mov     #MULTBY4|$07,IICF       ; 8MHz / (4*40) ~= 50kHz (See manual page 205 why 7 means 40) For short cable
   81                                     ;        mov     #MULTBY4|$1E,IICF       ; 8MHz / (4*192) ~= 10kHz (See manual page 205 why 1E means 192)
   82                                     ;        mov     #MULTBY4|$33,IICF       ; 8MHz / (4*1024) ~= 2kHz (See manual page 205 why 33 means 1024) For long cable
   83    [1986] 1986:6E04 5B         [ 4]         mov     #SRW_,IICS              ; R/W bit = 0
   84    [1989] 1989:81              [ 6]         rts
   85                                     
   86                                     ; ------------------------------------------------------------------------------
   87                                     ; Execute Command. Parameter: address of action list in HX
   88                198A                 IIC_ec
   89    [198A] 198A:6EF0 5A         [ 4]         mov     #IICEN_|IICIE_|MST_|TX_,IICC    ; Start in Master and Tx
   90                                     
   91                198D                 IIC_sfb                                 ; Send First Byte subfunction
   92    [198D] 198D:B658            [ 3]         lda     IICA                    ; Device select from IICA
   93    [198F] 198F:7D              [ 3]         tst     ,x                      ; Load dir+len byte from action list
   94    [1990] 1990:2A02 (1994)     [ 3]         bpl     IIC_sfb_w               ; Branch if write
   95    [1992] 1992:AA01            [ 2]         ora     #1                      ; Set read bit for read
   96                1994                 IIC_sfb_w
   97    [1994] 1994:B75C            [ 3]         sta     IICD                    ; Initiate send of chip address
   98                                     
   99    [1996] 1996:F6              [ 3]         lda     ,x                      ; Load command byte
  100    [1997] 1997:B786            [ 3]         sta     IIC_dl                  ; Store command byte for interrupt
  101                                     
  102    [1999] 1999:AF01            [ 2]         aix     #1                      ; Point to next byte
  103    [199B] 199B:3587            [ 4]         sthx    IIC_alp                 ; Store pointer in action list
  104                                     
  105    [199D] 199D:81              [ 6]         rts
  106                                     
  107                                     ; ------------------------------------------------------------------------------
  108                                     ; IIC Interrupt Service Routine
  109                                     ;  See Figure 11-12 in datasheet. "Typical IIC Interrupt Routine"
  110                                     ;  Length is 106us now, on 10kHz IIC it is 10%. On 1kHz 1%.
  111                199E                 IIC_IT
  112                                             ;bset    PIN7.,PTD
  113    [199E] 199E:125B            [ 5]         bset    IICIF.,IICS             ; Clear the interrupt event flag
  114    [19A0] 19A0:8B              [ 2]         pshh                            ; Save H, because ISR will use it
  115                                     
  116    [19A1] 19A1:095B 04         [ 5]         brclr   ARBL.,IICS,IIC_IT_narb  ; Check if arbitration lost
  117    [19A4] 19A4:185B            [ 5]         bset    ARBL.,IICS              ; If yes, clear its flag
  118                                             ;Here return status of action list is ARBITRATION LOST ERROR
  119    [19A6] 19A6:205A (1A02)     [ 3]         bra     IIC_IT_ed               ; Stop action list execution
  120                19A8                 IIC_IT_narb                             ; Not ARBitration error label
  121    [19A8] 19A8:095A 39         [ 5]         brclr   TX.,IICC,IIC_IT_rx      ; Jump to Rx path if TX bit is zero
  122    [19AB] 19AB:5587            [ 4]         ldhx    IIC_alp                 ; Address of next byte in action list
  123                                     
  124                                             ; Tx path
  125    [19AD] 19AD:015B 02         [ 5]         brclr   RXAK.,IICS,IIC_IT_rxackok       ; Check ACK by slave
  126                                             ;Here return status of command list is NO ACK ERROR
  127    [19B0] 19B0:2050 (1A02)     [ 3]         bra     IIC_IT_ed               ; Stop action list execution
  128                19B2                 IIC_IT_rxackok                          ; Rx ACK is OK label
  129                                     
  130    [19B2] 19B2:B686            [ 3]         lda     IIC_dl                  ; Load command
  131    [19B4] 19B4:2B0F (19C5)     [ 3]         bmi     IIC_IT_srx              ; Branch Rx bit (mask $80) is set
  132    [19B6] 19B6:A47F            [ 2]         and     #$7F                    ; Mask len part only
  133    [19B8] 19B8:2743 (19FD)     [ 3]         beq     IIC_IT_nmd              ; Branch if len is zero (No More Data)
  134    [19BA] 19BA:3A86            [ 5]         dec     IIC_dl                  ; Decrease remaining length counter
  135                                     
  136    [19BC] 19BC:F6              [ 3]         lda     ,x                      ; Load next data to be sent
  137    [19BD] 19BD:B75C            [ 3]         sta     IICD                    ; Send data byte
  138    [19BF] 19BF:AF01            [ 2]         aix     #1                      ; Jump to next byte in action list
  139    [19C1] 19C1:3587            [ 4]         sthx    IIC_alp                 ; Save pointer
  140                                     
  141    [19C3] 19C3:2040 (1A05)     [ 3]         bra     IIC_IT_e                ; End of interrupt
  142                                     
  143                                             ; Switch to RX activities. (Left side of Figure 11-12.)
  144                19C5                 IIC_IT_srx
  145    [19C5] 19C5:1F86            [ 5]         bclr    7,IIC_dl                ; Clear Rx bit, not needed any more
  146    [19C7] 19C7:1D86            [ 5]         bclr    6,IIC_dl                ; Clear Repeat bit, not needed in Rx
  147    [19C9] 19C9:195A            [ 5]         bclr    TX.,IICC                ; Switch IIC to Rx mode
  148                                     
  149                                             ; Save address where bytes to be received
  150    [19CB] 19CB:F6              [ 3]         lda     ,x                      ; Load high byte of RAM address
  151    [19CC] 19CC:B789            [ 3]         sta     IIC_rbp                 ; and save where received data copied
  152    [19CE] 19CE:AF01            [ 2]         aix     #1                      ; Jump to low buffer address byte
  153    [19D0] 19D0:F6              [ 3]         lda     ,x                      ; Load low byte of RAM address
  154    [19D1] 19D1:B78A            [ 3]         sta     IIC_rbp+1               ; and save where received data copied
  155    [19D3] 19D3:AF01            [ 2]         aix     #1                      ; Jump to next command byte
  156    [19D5] 19D5:3587            [ 4]         sthx    IIC_alp                 ; Save pointer
  157    [19D7] 19D7:AD2E (1A07)     [ 5]         bsr     IIC_set_ack             ; Ensure do not ack last received byte
  158                                     
  159    [19D9] 19D9:B65C            [ 3]         lda     IICD                    ; Dummy read to generate 8 bits clock
  160    [19DB] 19DB:2028 (1A05)     [ 3]         bra     IIC_IT_e                ; End of interrupt
  161                                     
  162                19DD                 IIC_IT_na                               ; Start next action
  163    [19DD] 19DD:6EF4 5A         [ 4]         mov     #IICEN_|IICIE_|MST_|TX_|RSTA_,IICC ; Start in Master and Tx
  164    [19E0] 19E0:ADAB (198D)     [ 5]         bsr     IIC_sfb                 ; send first byte of package
  165    [19E2] 19E2:2021 (1A05)     [ 3]         bra     IIC_IT_e                ; End of interrupt
  166                                     
  167                                             ; Rx path
  168                19E4                 IIC_IT_rx
  169    [19E4] 19E4:3A86            [ 5]         dec     IIC_dl                  ; Decrease remaining length counter
  170    [19E6] 19E6:3D86            [ 4]         tst     IIC_dl                  ; Test length counter
  171    [19E8] 19E8:2602 (19EC)     [ 3]         bne     IIC_IT_eor              ; Check if End Of Reception
  172    [19EA] 19EA:185A            [ 5]         bset    TX.,IICC                ; To prevent extra byte clock
  173                19EC                 IIC_IT_eor
  174    [19EC] 19EC:5589            [ 4]         ldhx    IIC_rbp                 ; Load buffer address
  175    [19EE] 19EE:B65C            [ 3]         lda     IICD                    ; Load received byte
  176    [19F0] 19F0:F7              [ 2]         sta     ,x                      ; Save received byte into address
  177    [19F1] 19F1:AF01            [ 2]         aix     #1                      ; Point to next byte
  178    [19F3] 19F3:3589            [ 4]         sthx    IIC_rbp                 ; Save next buffer address
  179                                     
  180    [19F5] 19F5:3D86            [ 4]         tst     IIC_dl                  ; Test length counter
  181    [19F7] 19F7:2704 (19FD)     [ 3]         beq     IIC_IT_nmd              ; Branch to No More Data
  182    [19F9] 19F9:AD0C (1A07)     [ 5]         bsr     IIC_set_ack             ; Ensure do not ack last received byte
  183    [19FB] 19FB:2008 (1A05)     [ 3]         bra     IIC_IT_e                ; End of interrupt
  184                                     
  185                                             ; No More Data
  186                19FD                 IIC_IT_nmd
  187    [19FD] 19FD:5587            [ 4]         ldhx    IIC_alp                 ; Address of command of next action
  188    [19FF] 19FF:F6              [ 3]         lda     ,x                      ; Load next command
  189    [1A00] 1A00:26DB (19DD)     [ 3]         bne     IIC_IT_na               ; Branch to next action handling
  190                                     
  191                                             ; End of interrupt
  192                1A02                 IIC_IT_ed
  193    [1A02] 1A02:6E80 5A         [ 4]         mov     #IICEN_,IICC            ; Stop and Disable interrupt
  194                                             ;Here return status of command list is OK
  195                1A05                 IIC_IT_e                                ; End of interrupt
  196    [1A05] 1A05:8A              [ 3]         pulh                            ; Restore H
  197                                             ;bclr    PIN7.,PTD
  198    [1A06] 1A06:80              [ 9]         rti
  199                                     
  200                                     ; IIC subrutine to disable sent ack of master for last received byte
  201                1A07                 IIC_set_ack
  202    [1A07] 1A07:B686            [ 3]         lda     IIC_dl                  ; Check if last rx byte
  203    [1A09] 1A09:A101            [ 2]         cmp     #1
  204    [1A0B] 1A0B:2602 (1A0F)     [ 3]         bne     IIC_sa_nl               ; Not the last
  205    [1A0D] 1A0D:165A            [ 5]         bset    TXAK.,IICC              ; Last, do not ack last byte
  206                1A0F                 IIC_sa_nl
  207    [1A0F] 1A0F:81              [ 6]         rts
  208                                     
  209                                     ; Wait for end of execution of action list
  210                1A10                 IIC_wfe
  211    [1A10] 1A10:6E0A 82         [ 4]         mov     #10,timeout             ; pull up timer (100ms)
  212                1A13                 IIC_wfe_l
  213    [1A13] 1A13:CD19 06         [ 6]         jsr     KickCop
  214    [1A16] 1A16:3D82            [ 4]         tst     timeout                 ; Check timeout
  215    [1A18] 1A18:2707 (1A21)     [ 3]         beq     IIC_wfe_r               ; Timeout happend, reset
  216    [1A1A] 1A1A:0C5A F6         [ 5]         brset   IICIE.,IICC,IIC_wfe_l
  217    [1A1D] 1A1D:0A5B F3         [ 5]         brset   BUSY.,IICS,IIC_wfe_l
  218    [1A20] 1A20:81              [ 6]         rts
  219                1A21                 IIC_wfe_r
  220    [1A21] 1A21:20FE (1A21)     [ 3]         bra     IIC_wfe_r               ; Endless loop to force immediate reset
  221                                     
  222                00A3                 IIC_len         equ     $-IIC_beg
  223                                     
  224                                     ; ===================== IT VECTORS ==========================================
  225                                     #VECTORS
  226                                     
  227                FFCE                         org     Viic
  228    [FFCE] FFCE.199E                         dw      IIC_IT
  229                                     
  230                                     
  231                                     
  232                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/iic.a08 *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   47                                       #include "ssd1780.a08"        ; 0.96" 128x64 OLED display driver
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/ssd1780.a08 ***
    1                                     ; =============================================================================
    2                                     ; 0.96" OLED display with SSD1780 driver IC
    3                                     ; =============================================================================
    4                                     #include "fonttab.inc"
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/fonttab.inc ***
    1                                     ; -----------------------------------------------------------
    2                                     ; Assambly font definitions. Generated from font_visual.php.
    3                                     ; These are already in I2C command format. Jump to [ascii*11]
    4                                     ; -----------------------------------------------------------
    5                                     #ROM
    6                                     
    7                1A23                 fonttab
    8                                     
    9                                             ;       Command of action (Write 9 bytes to IIC)
   10                                             ;       |   Co=0 (continuous), D/C#=1 (next bytes are data)
   11                                             ;       |   |   First (most left) column of character
   12                                             ;       |   |   |   Last (most right) column of character
   13                                             ;       |   |   |   +-----------------------+   End of action
   14                                             ;       |   |   |     (LSB:Top MSB:bottom)  |   |
   15    [1A23] 1A23.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 0 = 0x00
   15    [1A24] 1A24.40                   
   15    [1A25] 1A25.00                   
   15    [1A26] 1A26.00                   
   15    [1A27] 1A27.00                   
   15    [1A28] 1A28.00                   
   15    [1A29] 1A29.00                   
   15    [1A2A] 1A2A.00                   
   15    [1A2B] 1A2B.00                   
   15    [1A2C] 1A2C.00                   
   15    [1A2D] 1A2D.00                   
   16    [1A2E] 1A2E.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 1 = 0x01
   16    [1A2F] 1A2F.40                   
   16    [1A30] 1A30.00                   
   16    [1A31] 1A31.00                   
   16    [1A32] 1A32.00                   
   16    [1A33] 1A33.00                   
   16    [1A34] 1A34.00                   
   16    [1A35] 1A35.00                   
   16    [1A36] 1A36.00                   
   16    [1A37] 1A37.00                   
   16    [1A38] 1A38.00                   
   17    [1A39] 1A39.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 2 = 0x02
   17    [1A3A] 1A3A.40                   
   17    [1A3B] 1A3B.00                   
   17    [1A3C] 1A3C.00                   
   17    [1A3D] 1A3D.00                   
   17    [1A3E] 1A3E.00                   
   17    [1A3F] 1A3F.00                   
   17    [1A40] 1A40.00                   
   17    [1A41] 1A41.00                   
   17    [1A42] 1A42.00                   
   17    [1A43] 1A43.00                   
   18    [1A44] 1A44.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 3 = 0x03
   18    [1A45] 1A45.40                   
   18    [1A46] 1A46.00                   
   18    [1A47] 1A47.00                   
   18    [1A48] 1A48.00                   
   18    [1A49] 1A49.00                   
   18    [1A4A] 1A4A.00                   
   18    [1A4B] 1A4B.00                   
   18    [1A4C] 1A4C.00                   
   18    [1A4D] 1A4D.00                   
   18    [1A4E] 1A4E.00                   
   19    [1A4F] 1A4F.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 4 = 0x04
   19    [1A50] 1A50.40                   
   19    [1A51] 1A51.00                   
   19    [1A52] 1A52.00                   
   19    [1A53] 1A53.00                   
   19    [1A54] 1A54.00                   
   19    [1A55] 1A55.00                   
   19    [1A56] 1A56.00                   
   19    [1A57] 1A57.00                   
   19    [1A58] 1A58.00                   
   19    [1A59] 1A59.00                   
   20    [1A5A] 1A5A.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 5 = 0x05
   20    [1A5B] 1A5B.40                   
   20    [1A5C] 1A5C.00                   
   20    [1A5D] 1A5D.00                   
   20    [1A5E] 1A5E.00                   
   20    [1A5F] 1A5F.00                   
   20    [1A60] 1A60.00                   
   20    [1A61] 1A61.00                   
   20    [1A62] 1A62.00                   
   20    [1A63] 1A63.00                   
   20    [1A64] 1A64.00                   
   21    [1A65] 1A65.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 6 = 0x06
   21    [1A66] 1A66.40                   
   21    [1A67] 1A67.00                   
   21    [1A68] 1A68.00                   
   21    [1A69] 1A69.00                   
   21    [1A6A] 1A6A.00                   
   21    [1A6B] 1A6B.00                   
   21    [1A6C] 1A6C.00                   
   21    [1A6D] 1A6D.00                   
   21    [1A6E] 1A6E.00                   
   21    [1A6F] 1A6F.00                   
   22    [1A70] 1A70.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 7 = 0x07
   22    [1A71] 1A71.40                   
   22    [1A72] 1A72.00                   
   22    [1A73] 1A73.00                   
   22    [1A74] 1A74.00                   
   22    [1A75] 1A75.00                   
   22    [1A76] 1A76.00                   
   22    [1A77] 1A77.00                   
   22    [1A78] 1A78.00                   
   22    [1A79] 1A79.00                   
   22    [1A7A] 1A7A.00                   
   23    [1A7B] 1A7B.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 8 = 0x08
   23    [1A7C] 1A7C.40                   
   23    [1A7D] 1A7D.00                   
   23    [1A7E] 1A7E.00                   
   23    [1A7F] 1A7F.00                   
   23    [1A80] 1A80.00                   
   23    [1A81] 1A81.00                   
   23    [1A82] 1A82.00                   
   23    [1A83] 1A83.00                   
   23    [1A84] 1A84.00                   
   23    [1A85] 1A85.00                   
   24    [1A86] 1A86.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 9 = 0x09
   24    [1A87] 1A87.40                   
   24    [1A88] 1A88.00                   
   24    [1A89] 1A89.00                   
   24    [1A8A] 1A8A.00                   
   24    [1A8B] 1A8B.00                   
   24    [1A8C] 1A8C.00                   
   24    [1A8D] 1A8D.00                   
   24    [1A8E] 1A8E.00                   
   24    [1A8F] 1A8F.00                   
   24    [1A90] 1A90.00                   
   25    [1A91] 1A91.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 10 = 0x0A
   25    [1A92] 1A92.40                   
   25    [1A93] 1A93.00                   
   25    [1A94] 1A94.00                   
   25    [1A95] 1A95.00                   
   25    [1A96] 1A96.00                   
   25    [1A97] 1A97.00                   
   25    [1A98] 1A98.00                   
   25    [1A99] 1A99.00                   
   25    [1A9A] 1A9A.00                   
   25    [1A9B] 1A9B.00                   
   26    [1A9C] 1A9C.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 11 = 0x0B
   26    [1A9D] 1A9D.40                   
   26    [1A9E] 1A9E.00                   
   26    [1A9F] 1A9F.00                   
   26    [1AA0] 1AA0.00                   
   26    [1AA1] 1AA1.00                   
   26    [1AA2] 1AA2.00                   
   26    [1AA3] 1AA3.00                   
   26    [1AA4] 1AA4.00                   
   26    [1AA5] 1AA5.00                   
   26    [1AA6] 1AA6.00                   
   27    [1AA7] 1AA7.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 12 = 0x0C
   27    [1AA8] 1AA8.40                   
   27    [1AA9] 1AA9.00                   
   27    [1AAA] 1AAA.00                   
   27    [1AAB] 1AAB.00                   
   27    [1AAC] 1AAC.00                   
   27    [1AAD] 1AAD.00                   
   27    [1AAE] 1AAE.00                   
   27    [1AAF] 1AAF.00                   
   27    [1AB0] 1AB0.00                   
   27    [1AB1] 1AB1.00                   
   28    [1AB2] 1AB2.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 13 = 0x0D
   28    [1AB3] 1AB3.40                   
   28    [1AB4] 1AB4.00                   
   28    [1AB5] 1AB5.00                   
   28    [1AB6] 1AB6.00                   
   28    [1AB7] 1AB7.00                   
   28    [1AB8] 1AB8.00                   
   28    [1AB9] 1AB9.00                   
   28    [1ABA] 1ABA.00                   
   28    [1ABB] 1ABB.00                   
   28    [1ABC] 1ABC.00                   
   29    [1ABD] 1ABD.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 14 = 0x0E
   29    [1ABE] 1ABE.40                   
   29    [1ABF] 1ABF.00                   
   29    [1AC0] 1AC0.00                   
   29    [1AC1] 1AC1.00                   
   29    [1AC2] 1AC2.00                   
   29    [1AC3] 1AC3.00                   
   29    [1AC4] 1AC4.00                   
   29    [1AC5] 1AC5.00                   
   29    [1AC6] 1AC6.00                   
   29    [1AC7] 1AC7.00                   
   30    [1AC8] 1AC8.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 15 = 0x0F
   30    [1AC9] 1AC9.40                   
   30    [1ACA] 1ACA.00                   
   30    [1ACB] 1ACB.00                   
   30    [1ACC] 1ACC.00                   
   30    [1ACD] 1ACD.00                   
   30    [1ACE] 1ACE.00                   
   30    [1ACF] 1ACF.00                   
   30    [1AD0] 1AD0.00                   
   30    [1AD1] 1AD1.00                   
   30    [1AD2] 1AD2.00                   
   31    [1AD3] 1AD3.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 16 = 0x10
   31    [1AD4] 1AD4.40                   
   31    [1AD5] 1AD5.00                   
   31    [1AD6] 1AD6.00                   
   31    [1AD7] 1AD7.00                   
   31    [1AD8] 1AD8.00                   
   31    [1AD9] 1AD9.00                   
   31    [1ADA] 1ADA.00                   
   31    [1ADB] 1ADB.00                   
   31    [1ADC] 1ADC.00                   
   31    [1ADD] 1ADD.00                   
   32    [1ADE] 1ADE.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 17 = 0x11
   32    [1ADF] 1ADF.40                   
   32    [1AE0] 1AE0.00                   
   32    [1AE1] 1AE1.00                   
   32    [1AE2] 1AE2.00                   
   32    [1AE3] 1AE3.00                   
   32    [1AE4] 1AE4.00                   
   32    [1AE5] 1AE5.00                   
   32    [1AE6] 1AE6.00                   
   32    [1AE7] 1AE7.00                   
   32    [1AE8] 1AE8.00                   
   33    [1AE9] 1AE9.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 18 = 0x12
   33    [1AEA] 1AEA.40                   
   33    [1AEB] 1AEB.00                   
   33    [1AEC] 1AEC.00                   
   33    [1AED] 1AED.00                   
   33    [1AEE] 1AEE.00                   
   33    [1AEF] 1AEF.00                   
   33    [1AF0] 1AF0.00                   
   33    [1AF1] 1AF1.00                   
   33    [1AF2] 1AF2.00                   
   33    [1AF3] 1AF3.00                   
   34    [1AF4] 1AF4.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 19 = 0x13
   34    [1AF5] 1AF5.40                   
   34    [1AF6] 1AF6.00                   
   34    [1AF7] 1AF7.00                   
   34    [1AF8] 1AF8.00                   
   34    [1AF9] 1AF9.00                   
   34    [1AFA] 1AFA.00                   
   34    [1AFB] 1AFB.00                   
   34    [1AFC] 1AFC.00                   
   34    [1AFD] 1AFD.00                   
   34    [1AFE] 1AFE.00                   
   35    [1AFF] 1AFF.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 20 = 0x14
   35    [1B00] 1B00.40                   
   35    [1B01] 1B01.00                   
   35    [1B02] 1B02.00                   
   35    [1B03] 1B03.00                   
   35    [1B04] 1B04.00                   
   35    [1B05] 1B05.00                   
   35    [1B06] 1B06.00                   
   35    [1B07] 1B07.00                   
   35    [1B08] 1B08.00                   
   35    [1B09] 1B09.00                   
   36    [1B0A] 1B0A.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 21 = 0x15
   36    [1B0B] 1B0B.40                   
   36    [1B0C] 1B0C.00                   
   36    [1B0D] 1B0D.00                   
   36    [1B0E] 1B0E.00                   
   36    [1B0F] 1B0F.00                   
   36    [1B10] 1B10.00                   
   36    [1B11] 1B11.00                   
   36    [1B12] 1B12.00                   
   36    [1B13] 1B13.00                   
   36    [1B14] 1B14.00                   
   37    [1B15] 1B15.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 22 = 0x16
   37    [1B16] 1B16.40                   
   37    [1B17] 1B17.00                   
   37    [1B18] 1B18.00                   
   37    [1B19] 1B19.00                   
   37    [1B1A] 1B1A.00                   
   37    [1B1B] 1B1B.00                   
   37    [1B1C] 1B1C.00                   
   37    [1B1D] 1B1D.00                   
   37    [1B1E] 1B1E.00                   
   37    [1B1F] 1B1F.00                   
   38    [1B20] 1B20.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 23 = 0x17
   38    [1B21] 1B21.40                   
   38    [1B22] 1B22.00                   
   38    [1B23] 1B23.00                   
   38    [1B24] 1B24.00                   
   38    [1B25] 1B25.00                   
   38    [1B26] 1B26.00                   
   38    [1B27] 1B27.00                   
   38    [1B28] 1B28.00                   
   38    [1B29] 1B29.00                   
   38    [1B2A] 1B2A.00                   
   39    [1B2B] 1B2B.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 24 = 0x18
   39    [1B2C] 1B2C.40                   
   39    [1B2D] 1B2D.00                   
   39    [1B2E] 1B2E.00                   
   39    [1B2F] 1B2F.00                   
   39    [1B30] 1B30.00                   
   39    [1B31] 1B31.00                   
   39    [1B32] 1B32.00                   
   39    [1B33] 1B33.00                   
   39    [1B34] 1B34.00                   
   39    [1B35] 1B35.00                   
   40    [1B36] 1B36.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 25 = 0x19
   40    [1B37] 1B37.40                   
   40    [1B38] 1B38.00                   
   40    [1B39] 1B39.00                   
   40    [1B3A] 1B3A.00                   
   40    [1B3B] 1B3B.00                   
   40    [1B3C] 1B3C.00                   
   40    [1B3D] 1B3D.00                   
   40    [1B3E] 1B3E.00                   
   40    [1B3F] 1B3F.00                   
   40    [1B40] 1B40.00                   
   41    [1B41] 1B41.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 26 = 0x1A
   41    [1B42] 1B42.40                   
   41    [1B43] 1B43.00                   
   41    [1B44] 1B44.00                   
   41    [1B45] 1B45.00                   
   41    [1B46] 1B46.00                   
   41    [1B47] 1B47.00                   
   41    [1B48] 1B48.00                   
   41    [1B49] 1B49.00                   
   41    [1B4A] 1B4A.00                   
   41    [1B4B] 1B4B.00                   
   42    [1B4C] 1B4C.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 27 = 0x1B
   42    [1B4D] 1B4D.40                   
   42    [1B4E] 1B4E.00                   
   42    [1B4F] 1B4F.00                   
   42    [1B50] 1B50.00                   
   42    [1B51] 1B51.00                   
   42    [1B52] 1B52.00                   
   42    [1B53] 1B53.00                   
   42    [1B54] 1B54.00                   
   42    [1B55] 1B55.00                   
   42    [1B56] 1B56.00                   
   43    [1B57] 1B57.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 28 = 0x1C
   43    [1B58] 1B58.40                   
   43    [1B59] 1B59.00                   
   43    [1B5A] 1B5A.00                   
   43    [1B5B] 1B5B.00                   
   43    [1B5C] 1B5C.00                   
   43    [1B5D] 1B5D.00                   
   43    [1B5E] 1B5E.00                   
   43    [1B5F] 1B5F.00                   
   43    [1B60] 1B60.00                   
   43    [1B61] 1B61.00                   
   44    [1B62] 1B62.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 29 = 0x1D
   44    [1B63] 1B63.40                   
   44    [1B64] 1B64.00                   
   44    [1B65] 1B65.00                   
   44    [1B66] 1B66.00                   
   44    [1B67] 1B67.00                   
   44    [1B68] 1B68.00                   
   44    [1B69] 1B69.00                   
   44    [1B6A] 1B6A.00                   
   44    [1B6B] 1B6B.00                   
   44    [1B6C] 1B6C.00                   
   45    [1B6D] 1B6D.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 30 = 0x1E
   45    [1B6E] 1B6E.40                   
   45    [1B6F] 1B6F.00                   
   45    [1B70] 1B70.00                   
   45    [1B71] 1B71.00                   
   45    [1B72] 1B72.00                   
   45    [1B73] 1B73.00                   
   45    [1B74] 1B74.00                   
   45    [1B75] 1B75.00                   
   45    [1B76] 1B76.00                   
   45    [1B77] 1B77.00                   
   46    [1B78] 1B78.09                           db      $09,$40,$10,$30,$60,$60,$78,$1E,$07,$00,$00 ; ' ' 31 = 0x1F
   46    [1B79] 1B79.40                   
   46    [1B7A] 1B7A.10                   
   46    [1B7B] 1B7B.30                   
   46    [1B7C] 1B7C.60                   
   46    [1B7D] 1B7D.60                   
   46    [1B7E] 1B7E.78                   
   46    [1B7F] 1B7F.1E                   
   46    [1B80] 1B80.07                   
   46    [1B81] 1B81.00                   
   46    [1B82] 1B82.00                   
   47    [1B83] 1B83.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; ' ' 32 = 0x20
   47    [1B84] 1B84.40                   
   47    [1B85] 1B85.00                   
   47    [1B86] 1B86.00                   
   47    [1B87] 1B87.00                   
   47    [1B88] 1B88.00                   
   47    [1B89] 1B89.00                   
   47    [1B8A] 1B8A.00                   
   47    [1B8B] 1B8B.00                   
   47    [1B8C] 1B8C.00                   
   47    [1B8D] 1B8D.00                   
   48    [1B8E] 1B8E.09                           db      $09,$40,$00,$00,$06,$5F,$5F,$06,$00,$00,$00 ; '!' 33 = 0x21
   48    [1B8F] 1B8F.40                   
   48    [1B90] 1B90.00                   
   48    [1B91] 1B91.00                   
   48    [1B92] 1B92.06                   
   48    [1B93] 1B93.5F                   
   48    [1B94] 1B94.5F                   
   48    [1B95] 1B95.06                   
   48    [1B96] 1B96.00                   
   48    [1B97] 1B97.00                   
   48    [1B98] 1B98.00                   
   49    [1B99] 1B99.09                           db      $09,$40,$00,$03,$03,$00,$03,$03,$00,$00,$00 ; '"' 34 = 0x22
   49    [1B9A] 1B9A.40                   
   49    [1B9B] 1B9B.00                   
   49    [1B9C] 1B9C.03                   
   49    [1B9D] 1B9D.03                   
   49    [1B9E] 1B9E.00                   
   49    [1B9F] 1B9F.03                   
   49    [1BA0] 1BA0.03                   
   49    [1BA1] 1BA1.00                   
   49    [1BA2] 1BA2.00                   
   49    [1BA3] 1BA3.00                   
   50    [1BA4] 1BA4.09                           db      $09,$40,$14,$7F,$7F,$14,$7F,$7F,$14,$00,$00 ; '#' 35 = 0x23
   50    [1BA5] 1BA5.40                   
   50    [1BA6] 1BA6.14                   
   50    [1BA7] 1BA7.7F                   
   50    [1BA8] 1BA8.7F                   
   50    [1BA9] 1BA9.14                   
   50    [1BAA] 1BAA.7F                   
   50    [1BAB] 1BAB.7F                   
   50    [1BAC] 1BAC.14                   
   50    [1BAD] 1BAD.00                   
   50    [1BAE] 1BAE.00                   
   51    [1BAF] 1BAF.09                           db      $09,$40,$24,$2E,$6B,$6B,$3A,$12,$00,$00,$00 ; '$' 36 = 0x24
   51    [1BB0] 1BB0.40                   
   51    [1BB1] 1BB1.24                   
   51    [1BB2] 1BB2.2E                   
   51    [1BB3] 1BB3.6B                   
   51    [1BB4] 1BB4.6B                   
   51    [1BB5] 1BB5.3A                   
   51    [1BB6] 1BB6.12                   
   51    [1BB7] 1BB7.00                   
   51    [1BB8] 1BB8.00                   
   51    [1BB9] 1BB9.00                   
   52    [1BBA] 1BBA.09                           db      $09,$40,$46,$66,$30,$18,$0C,$66,$62,$00,$00 ; '%' 37 = 0x25
   52    [1BBB] 1BBB.40                   
   52    [1BBC] 1BBC.46                   
   52    [1BBD] 1BBD.66                   
   52    [1BBE] 1BBE.30                   
   52    [1BBF] 1BBF.18                   
   52    [1BC0] 1BC0.0C                   
   52    [1BC1] 1BC1.66                   
   52    [1BC2] 1BC2.62                   
   52    [1BC3] 1BC3.00                   
   52    [1BC4] 1BC4.00                   
   53    [1BC5] 1BC5.09                           db      $09,$40,$30,$7A,$4F,$5D,$37,$7A,$48,$00,$00 ; '&' 38 = 0x26
   53    [1BC6] 1BC6.40                   
   53    [1BC7] 1BC7.30                   
   53    [1BC8] 1BC8.7A                   
   53    [1BC9] 1BC9.4F                   
   53    [1BCA] 1BCA.5D                   
   53    [1BCB] 1BCB.37                   
   53    [1BCC] 1BCC.7A                   
   53    [1BCD] 1BCD.48                   
   53    [1BCE] 1BCE.00                   
   53    [1BCF] 1BCF.00                   
   54    [1BD0] 1BD0.09                           db      $09,$40,$04,$07,$03,$00,$00,$00,$00,$00,$00 ; ''' 39 = 0x27
   54    [1BD1] 1BD1.40                   
   54    [1BD2] 1BD2.04                   
   54    [1BD3] 1BD3.07                   
   54    [1BD4] 1BD4.03                   
   54    [1BD5] 1BD5.00                   
   54    [1BD6] 1BD6.00                   
   54    [1BD7] 1BD7.00                   
   54    [1BD8] 1BD8.00                   
   54    [1BD9] 1BD9.00                   
   54    [1BDA] 1BDA.00                   
   55    [1BDB] 1BDB.09                           db      $09,$40,$00,$1C,$3E,$63,$41,$00,$00,$00,$00 ; '(' 40 = 0x28
   55    [1BDC] 1BDC.40                   
   55    [1BDD] 1BDD.00                   
   55    [1BDE] 1BDE.1C                   
   55    [1BDF] 1BDF.3E                   
   55    [1BE0] 1BE0.63                   
   55    [1BE1] 1BE1.41                   
   55    [1BE2] 1BE2.00                   
   55    [1BE3] 1BE3.00                   
   55    [1BE4] 1BE4.00                   
   55    [1BE5] 1BE5.00                   
   56    [1BE6] 1BE6.09                           db      $09,$40,$00,$41,$63,$3E,$1C,$00,$00,$00,$00 ; ')' 41 = 0x29
   56    [1BE7] 1BE7.40                   
   56    [1BE8] 1BE8.00                   
   56    [1BE9] 1BE9.41                   
   56    [1BEA] 1BEA.63                   
   56    [1BEB] 1BEB.3E                   
   56    [1BEC] 1BEC.1C                   
   56    [1BED] 1BED.00                   
   56    [1BEE] 1BEE.00                   
   56    [1BEF] 1BEF.00                   
   56    [1BF0] 1BF0.00                   
   57    [1BF1] 1BF1.09                           db      $09,$40,$08,$2A,$3E,$1C,$1C,$3E,$2A,$08,$00 ; '*' 42 = 0x2A
   57    [1BF2] 1BF2.40                   
   57    [1BF3] 1BF3.08                   
   57    [1BF4] 1BF4.2A                   
   57    [1BF5] 1BF5.3E                   
   57    [1BF6] 1BF6.1C                   
   57    [1BF7] 1BF7.1C                   
   57    [1BF8] 1BF8.3E                   
   57    [1BF9] 1BF9.2A                   
   57    [1BFA] 1BFA.08                   
   57    [1BFB] 1BFB.00                   
   58    [1BFC] 1BFC.09                           db      $09,$40,$08,$08,$3E,$3E,$08,$08,$00,$00,$00 ; '+' 43 = 0x2B
   58    [1BFD] 1BFD.40                   
   58    [1BFE] 1BFE.08                   
   58    [1BFF] 1BFF.08                   
   58    [1C00] 1C00.3E                   
   58    [1C01] 1C01.3E                   
   58    [1C02] 1C02.08                   
   58    [1C03] 1C03.08                   
   58    [1C04] 1C04.00                   
   58    [1C05] 1C05.00                   
   58    [1C06] 1C06.00                   
   59    [1C07] 1C07.09                           db      $09,$40,$00,$80,$E0,$60,$00,$00,$00,$00,$00 ; ',' 44 = 0x2C
   59    [1C08] 1C08.40                   
   59    [1C09] 1C09.00                   
   59    [1C0A] 1C0A.80                   
   59    [1C0B] 1C0B.E0                   
   59    [1C0C] 1C0C.60                   
   59    [1C0D] 1C0D.00                   
   59    [1C0E] 1C0E.00                   
   59    [1C0F] 1C0F.00                   
   59    [1C10] 1C10.00                   
   59    [1C11] 1C11.00                   
   60    [1C12] 1C12.09                           db      $09,$40,$08,$08,$08,$08,$08,$08,$00,$00,$00 ; '-' 45 = 0x2D
   60    [1C13] 1C13.40                   
   60    [1C14] 1C14.08                   
   60    [1C15] 1C15.08                   
   60    [1C16] 1C16.08                   
   60    [1C17] 1C17.08                   
   60    [1C18] 1C18.08                   
   60    [1C19] 1C19.08                   
   60    [1C1A] 1C1A.00                   
   60    [1C1B] 1C1B.00                   
   60    [1C1C] 1C1C.00                   
   61    [1C1D] 1C1D.09                           db      $09,$40,$00,$00,$60,$60,$00,$00,$00,$00,$00 ; '.' 46 = 0x2E
   61    [1C1E] 1C1E.40                   
   61    [1C1F] 1C1F.00                   
   61    [1C20] 1C20.00                   
   61    [1C21] 1C21.60                   
   61    [1C22] 1C22.60                   
   61    [1C23] 1C23.00                   
   61    [1C24] 1C24.00                   
   61    [1C25] 1C25.00                   
   61    [1C26] 1C26.00                   
   61    [1C27] 1C27.00                   
   62    [1C28] 1C28.09                           db      $09,$40,$60,$30,$18,$0C,$06,$03,$01,$00,$00 ; '/' 47 = 0x2F
   62    [1C29] 1C29.40                   
   62    [1C2A] 1C2A.60                   
   62    [1C2B] 1C2B.30                   
   62    [1C2C] 1C2C.18                   
   62    [1C2D] 1C2D.0C                   
   62    [1C2E] 1C2E.06                   
   62    [1C2F] 1C2F.03                   
   62    [1C30] 1C30.01                   
   62    [1C31] 1C31.00                   
   62    [1C32] 1C32.00                   
   63    [1C33] 1C33.09                           db      $09,$40,$3E,$7F,$71,$59,$4D,$7F,$3E,$00,$00 ; '0' 48 = 0x30
   63    [1C34] 1C34.40                   
   63    [1C35] 1C35.3E                   
   63    [1C36] 1C36.7F                   
   63    [1C37] 1C37.71                   
   63    [1C38] 1C38.59                   
   63    [1C39] 1C39.4D                   
   63    [1C3A] 1C3A.7F                   
   63    [1C3B] 1C3B.3E                   
   63    [1C3C] 1C3C.00                   
   63    [1C3D] 1C3D.00                   
   64    [1C3E] 1C3E.09                           db      $09,$40,$40,$42,$7F,$7F,$40,$40,$00,$00,$00 ; '1' 49 = 0x31
   64    [1C3F] 1C3F.40                   
   64    [1C40] 1C40.40                   
   64    [1C41] 1C41.42                   
   64    [1C42] 1C42.7F                   
   64    [1C43] 1C43.7F                   
   64    [1C44] 1C44.40                   
   64    [1C45] 1C45.40                   
   64    [1C46] 1C46.00                   
   64    [1C47] 1C47.00                   
   64    [1C48] 1C48.00                   
   65    [1C49] 1C49.09                           db      $09,$40,$62,$73,$59,$49,$6F,$66,$00,$00,$00 ; '2' 50 = 0x32
   65    [1C4A] 1C4A.40                   
   65    [1C4B] 1C4B.62                   
   65    [1C4C] 1C4C.73                   
   65    [1C4D] 1C4D.59                   
   65    [1C4E] 1C4E.49                   
   65    [1C4F] 1C4F.6F                   
   65    [1C50] 1C50.66                   
   65    [1C51] 1C51.00                   
   65    [1C52] 1C52.00                   
   65    [1C53] 1C53.00                   
   66    [1C54] 1C54.09                           db      $09,$40,$22,$63,$49,$49,$7F,$36,$00,$00,$00 ; '3' 51 = 0x33
   66    [1C55] 1C55.40                   
   66    [1C56] 1C56.22                   
   66    [1C57] 1C57.63                   
   66    [1C58] 1C58.49                   
   66    [1C59] 1C59.49                   
   66    [1C5A] 1C5A.7F                   
   66    [1C5B] 1C5B.36                   
   66    [1C5C] 1C5C.00                   
   66    [1C5D] 1C5D.00                   
   66    [1C5E] 1C5E.00                   
   67    [1C5F] 1C5F.09                           db      $09,$40,$18,$1C,$16,$53,$7F,$7F,$50,$00,$00 ; '4' 52 = 0x34
   67    [1C60] 1C60.40                   
   67    [1C61] 1C61.18                   
   67    [1C62] 1C62.1C                   
   67    [1C63] 1C63.16                   
   67    [1C64] 1C64.53                   
   67    [1C65] 1C65.7F                   
   67    [1C66] 1C66.7F                   
   67    [1C67] 1C67.50                   
   67    [1C68] 1C68.00                   
   67    [1C69] 1C69.00                   
   68    [1C6A] 1C6A.09                           db      $09,$40,$27,$67,$45,$45,$7D,$39,$00,$00,$00 ; '5' 53 = 0x35
   68    [1C6B] 1C6B.40                   
   68    [1C6C] 1C6C.27                   
   68    [1C6D] 1C6D.67                   
   68    [1C6E] 1C6E.45                   
   68    [1C6F] 1C6F.45                   
   68    [1C70] 1C70.7D                   
   68    [1C71] 1C71.39                   
   68    [1C72] 1C72.00                   
   68    [1C73] 1C73.00                   
   68    [1C74] 1C74.00                   
   69    [1C75] 1C75.09                           db      $09,$40,$3C,$7E,$4B,$49,$79,$30,$00,$00,$00 ; '6' 54 = 0x36
   69    [1C76] 1C76.40                   
   69    [1C77] 1C77.3C                   
   69    [1C78] 1C78.7E                   
   69    [1C79] 1C79.4B                   
   69    [1C7A] 1C7A.49                   
   69    [1C7B] 1C7B.79                   
   69    [1C7C] 1C7C.30                   
   69    [1C7D] 1C7D.00                   
   69    [1C7E] 1C7E.00                   
   69    [1C7F] 1C7F.00                   
   70    [1C80] 1C80.09                           db      $09,$40,$03,$03,$71,$79,$0F,$07,$00,$00,$00 ; '7' 55 = 0x37
   70    [1C81] 1C81.40                   
   70    [1C82] 1C82.03                   
   70    [1C83] 1C83.03                   
   70    [1C84] 1C84.71                   
   70    [1C85] 1C85.79                   
   70    [1C86] 1C86.0F                   
   70    [1C87] 1C87.07                   
   70    [1C88] 1C88.00                   
   70    [1C89] 1C89.00                   
   70    [1C8A] 1C8A.00                   
   71    [1C8B] 1C8B.09                           db      $09,$40,$36,$7F,$49,$49,$7F,$36,$00,$00,$00 ; '8' 56 = 0x38
   71    [1C8C] 1C8C.40                   
   71    [1C8D] 1C8D.36                   
   71    [1C8E] 1C8E.7F                   
   71    [1C8F] 1C8F.49                   
   71    [1C90] 1C90.49                   
   71    [1C91] 1C91.7F                   
   71    [1C92] 1C92.36                   
   71    [1C93] 1C93.00                   
   71    [1C94] 1C94.00                   
   71    [1C95] 1C95.00                   
   72    [1C96] 1C96.09                           db      $09,$40,$06,$4F,$49,$69,$3F,$1E,$00,$00,$00 ; '9' 57 = 0x39
   72    [1C97] 1C97.40                   
   72    [1C98] 1C98.06                   
   72    [1C99] 1C99.4F                   
   72    [1C9A] 1C9A.49                   
   72    [1C9B] 1C9B.69                   
   72    [1C9C] 1C9C.3F                   
   72    [1C9D] 1C9D.1E                   
   72    [1C9E] 1C9E.00                   
   72    [1C9F] 1C9F.00                   
   72    [1CA0] 1CA0.00                   
   73    [1CA1] 1CA1.09                           db      $09,$40,$00,$00,$66,$66,$00,$00,$00,$00,$00 ; ':' 58 = 0x3A
   73    [1CA2] 1CA2.40                   
   73    [1CA3] 1CA3.00                   
   73    [1CA4] 1CA4.00                   
   73    [1CA5] 1CA5.66                   
   73    [1CA6] 1CA6.66                   
   73    [1CA7] 1CA7.00                   
   73    [1CA8] 1CA8.00                   
   73    [1CA9] 1CA9.00                   
   73    [1CAA] 1CAA.00                   
   73    [1CAB] 1CAB.00                   
   74    [1CAC] 1CAC.09                           db      $09,$40,$00,$80,$E6,$66,$00,$00,$00,$00,$00 ; ';' 59 = 0x3B
   74    [1CAD] 1CAD.40                   
   74    [1CAE] 1CAE.00                   
   74    [1CAF] 1CAF.80                   
   74    [1CB0] 1CB0.E6                   
   74    [1CB1] 1CB1.66                   
   74    [1CB2] 1CB2.00                   
   74    [1CB3] 1CB3.00                   
   74    [1CB4] 1CB4.00                   
   74    [1CB5] 1CB5.00                   
   74    [1CB6] 1CB6.00                   
   75    [1CB7] 1CB7.09                           db      $09,$40,$08,$1C,$36,$63,$41,$00,$00,$00,$00 ; '<' 60 = 0x3C
   75    [1CB8] 1CB8.40                   
   75    [1CB9] 1CB9.08                   
   75    [1CBA] 1CBA.1C                   
   75    [1CBB] 1CBB.36                   
   75    [1CBC] 1CBC.63                   
   75    [1CBD] 1CBD.41                   
   75    [1CBE] 1CBE.00                   
   75    [1CBF] 1CBF.00                   
   75    [1CC0] 1CC0.00                   
   75    [1CC1] 1CC1.00                   
   76    [1CC2] 1CC2.09                           db      $09,$40,$24,$24,$24,$24,$24,$24,$00,$00,$00 ; '=' 61 = 0x3D
   76    [1CC3] 1CC3.40                   
   76    [1CC4] 1CC4.24                   
   76    [1CC5] 1CC5.24                   
   76    [1CC6] 1CC6.24                   
   76    [1CC7] 1CC7.24                   
   76    [1CC8] 1CC8.24                   
   76    [1CC9] 1CC9.24                   
   76    [1CCA] 1CCA.00                   
   76    [1CCB] 1CCB.00                   
   76    [1CCC] 1CCC.00                   
   77    [1CCD] 1CCD.09                           db      $09,$40,$00,$41,$63,$36,$1C,$08,$00,$00,$00 ; '>' 62 = 0x3E
   77    [1CCE] 1CCE.40                   
   77    [1CCF] 1CCF.00                   
   77    [1CD0] 1CD0.41                   
   77    [1CD1] 1CD1.63                   
   77    [1CD2] 1CD2.36                   
   77    [1CD3] 1CD3.1C                   
   77    [1CD4] 1CD4.08                   
   77    [1CD5] 1CD5.00                   
   77    [1CD6] 1CD6.00                   
   77    [1CD7] 1CD7.00                   
   78    [1CD8] 1CD8.09                           db      $09,$40,$02,$03,$51,$59,$0F,$06,$00,$00,$00 ; '?' 63 = 0x3F
   78    [1CD9] 1CD9.40                   
   78    [1CDA] 1CDA.02                   
   78    [1CDB] 1CDB.03                   
   78    [1CDC] 1CDC.51                   
   78    [1CDD] 1CDD.59                   
   78    [1CDE] 1CDE.0F                   
   78    [1CDF] 1CDF.06                   
   78    [1CE0] 1CE0.00                   
   78    [1CE1] 1CE1.00                   
   78    [1CE2] 1CE2.00                   
   79    [1CE3] 1CE3.09                           db      $09,$40,$3E,$7F,$41,$5D,$5D,$1F,$1E,$00,$00 ; '@' 64 = 0x40
   79    [1CE4] 1CE4.40                   
   79    [1CE5] 1CE5.3E                   
   79    [1CE6] 1CE6.7F                   
   79    [1CE7] 1CE7.41                   
   79    [1CE8] 1CE8.5D                   
   79    [1CE9] 1CE9.5D                   
   79    [1CEA] 1CEA.1F                   
   79    [1CEB] 1CEB.1E                   
   79    [1CEC] 1CEC.00                   
   79    [1CED] 1CED.00                   
   80    [1CEE] 1CEE.09                           db      $09,$40,$7C,$7E,$13,$13,$7E,$7C,$00,$00,$00 ; 'A' 65 = 0x41
   80    [1CEF] 1CEF.40                   
   80    [1CF0] 1CF0.7C                   
   80    [1CF1] 1CF1.7E                   
   80    [1CF2] 1CF2.13                   
   80    [1CF3] 1CF3.13                   
   80    [1CF4] 1CF4.7E                   
   80    [1CF5] 1CF5.7C                   
   80    [1CF6] 1CF6.00                   
   80    [1CF7] 1CF7.00                   
   80    [1CF8] 1CF8.00                   
   81    [1CF9] 1CF9.09                           db      $09,$40,$41,$7F,$7F,$49,$49,$7F,$36,$00,$00 ; 'B' 66 = 0x42
   81    [1CFA] 1CFA.40                   
   81    [1CFB] 1CFB.41                   
   81    [1CFC] 1CFC.7F                   
   81    [1CFD] 1CFD.7F                   
   81    [1CFE] 1CFE.49                   
   81    [1CFF] 1CFF.49                   
   81    [1D00] 1D00.7F                   
   81    [1D01] 1D01.36                   
   81    [1D02] 1D02.00                   
   81    [1D03] 1D03.00                   
   82    [1D04] 1D04.09                           db      $09,$40,$1C,$3E,$63,$41,$41,$63,$22,$00,$00 ; 'C' 67 = 0x43
   82    [1D05] 1D05.40                   
   82    [1D06] 1D06.1C                   
   82    [1D07] 1D07.3E                   
   82    [1D08] 1D08.63                   
   82    [1D09] 1D09.41                   
   82    [1D0A] 1D0A.41                   
   82    [1D0B] 1D0B.63                   
   82    [1D0C] 1D0C.22                   
   82    [1D0D] 1D0D.00                   
   82    [1D0E] 1D0E.00                   
   83    [1D0F] 1D0F.09                           db      $09,$40,$41,$7F,$7F,$41,$63,$3E,$1C,$00,$00 ; 'D' 68 = 0x44
   83    [1D10] 1D10.40                   
   83    [1D11] 1D11.41                   
   83    [1D12] 1D12.7F                   
   83    [1D13] 1D13.7F                   
   83    [1D14] 1D14.41                   
   83    [1D15] 1D15.63                   
   83    [1D16] 1D16.3E                   
   83    [1D17] 1D17.1C                   
   83    [1D18] 1D18.00                   
   83    [1D19] 1D19.00                   
   84    [1D1A] 1D1A.09                           db      $09,$40,$41,$7F,$7F,$49,$5D,$41,$63,$00,$00 ; 'E' 69 = 0x45
   84    [1D1B] 1D1B.40                   
   84    [1D1C] 1D1C.41                   
   84    [1D1D] 1D1D.7F                   
   84    [1D1E] 1D1E.7F                   
   84    [1D1F] 1D1F.49                   
   84    [1D20] 1D20.5D                   
   84    [1D21] 1D21.41                   
   84    [1D22] 1D22.63                   
   84    [1D23] 1D23.00                   
   84    [1D24] 1D24.00                   
   85    [1D25] 1D25.09                           db      $09,$40,$41,$7F,$7F,$49,$1D,$01,$03,$00,$00 ; 'F' 70 = 0x46
   85    [1D26] 1D26.40                   
   85    [1D27] 1D27.41                   
   85    [1D28] 1D28.7F                   
   85    [1D29] 1D29.7F                   
   85    [1D2A] 1D2A.49                   
   85    [1D2B] 1D2B.1D                   
   85    [1D2C] 1D2C.01                   
   85    [1D2D] 1D2D.03                   
   85    [1D2E] 1D2E.00                   
   85    [1D2F] 1D2F.00                   
   86    [1D30] 1D30.09                           db      $09,$40,$1C,$3E,$63,$41,$51,$73,$72,$00,$00 ; 'G' 71 = 0x47
   86    [1D31] 1D31.40                   
   86    [1D32] 1D32.1C                   
   86    [1D33] 1D33.3E                   
   86    [1D34] 1D34.63                   
   86    [1D35] 1D35.41                   
   86    [1D36] 1D36.51                   
   86    [1D37] 1D37.73                   
   86    [1D38] 1D38.72                   
   86    [1D39] 1D39.00                   
   86    [1D3A] 1D3A.00                   
   87    [1D3B] 1D3B.09                           db      $09,$40,$7F,$7F,$08,$08,$7F,$7F,$00,$00,$00 ; 'H' 72 = 0x48
   87    [1D3C] 1D3C.40                   
   87    [1D3D] 1D3D.7F                   
   87    [1D3E] 1D3E.7F                   
   87    [1D3F] 1D3F.08                   
   87    [1D40] 1D40.08                   
   87    [1D41] 1D41.7F                   
   87    [1D42] 1D42.7F                   
   87    [1D43] 1D43.00                   
   87    [1D44] 1D44.00                   
   87    [1D45] 1D45.00                   
   88    [1D46] 1D46.09                           db      $09,$40,$00,$41,$7F,$7F,$41,$00,$00,$00,$00 ; 'I' 73 = 0x49
   88    [1D47] 1D47.40                   
   88    [1D48] 1D48.00                   
   88    [1D49] 1D49.41                   
   88    [1D4A] 1D4A.7F                   
   88    [1D4B] 1D4B.7F                   
   88    [1D4C] 1D4C.41                   
   88    [1D4D] 1D4D.00                   
   88    [1D4E] 1D4E.00                   
   88    [1D4F] 1D4F.00                   
   88    [1D50] 1D50.00                   
   89    [1D51] 1D51.09                           db      $09,$40,$30,$70,$40,$41,$7F,$3F,$01,$00,$00 ; 'J' 74 = 0x4A
   89    [1D52] 1D52.40                   
   89    [1D53] 1D53.30                   
   89    [1D54] 1D54.70                   
   89    [1D55] 1D55.40                   
   89    [1D56] 1D56.41                   
   89    [1D57] 1D57.7F                   
   89    [1D58] 1D58.3F                   
   89    [1D59] 1D59.01                   
   89    [1D5A] 1D5A.00                   
   89    [1D5B] 1D5B.00                   
   90    [1D5C] 1D5C.09                           db      $09,$40,$41,$7F,$7F,$08,$1C,$77,$63,$00,$00 ; 'K' 75 = 0x4B
   90    [1D5D] 1D5D.40                   
   90    [1D5E] 1D5E.41                   
   90    [1D5F] 1D5F.7F                   
   90    [1D60] 1D60.7F                   
   90    [1D61] 1D61.08                   
   90    [1D62] 1D62.1C                   
   90    [1D63] 1D63.77                   
   90    [1D64] 1D64.63                   
   90    [1D65] 1D65.00                   
   90    [1D66] 1D66.00                   
   91    [1D67] 1D67.09                           db      $09,$40,$41,$7F,$7F,$41,$40,$60,$70,$00,$00 ; 'L' 76 = 0x4C
   91    [1D68] 1D68.40                   
   91    [1D69] 1D69.41                   
   91    [1D6A] 1D6A.7F                   
   91    [1D6B] 1D6B.7F                   
   91    [1D6C] 1D6C.41                   
   91    [1D6D] 1D6D.40                   
   91    [1D6E] 1D6E.60                   
   91    [1D6F] 1D6F.70                   
   91    [1D70] 1D70.00                   
   91    [1D71] 1D71.00                   
   92    [1D72] 1D72.09                           db      $09,$40,$7F,$7F,$0E,$1C,$0E,$7F,$7F,$00,$00 ; 'M' 77 = 0x4D
   92    [1D73] 1D73.40                   
   92    [1D74] 1D74.7F                   
   92    [1D75] 1D75.7F                   
   92    [1D76] 1D76.0E                   
   92    [1D77] 1D77.1C                   
   92    [1D78] 1D78.0E                   
   92    [1D79] 1D79.7F                   
   92    [1D7A] 1D7A.7F                   
   92    [1D7B] 1D7B.00                   
   92    [1D7C] 1D7C.00                   
   93    [1D7D] 1D7D.09                           db      $09,$40,$7F,$7F,$06,$0C,$18,$7F,$7F,$00,$00 ; 'N' 78 = 0x4E
   93    [1D7E] 1D7E.40                   
   93    [1D7F] 1D7F.7F                   
   93    [1D80] 1D80.7F                   
   93    [1D81] 1D81.06                   
   93    [1D82] 1D82.0C                   
   93    [1D83] 1D83.18                   
   93    [1D84] 1D84.7F                   
   93    [1D85] 1D85.7F                   
   93    [1D86] 1D86.00                   
   93    [1D87] 1D87.00                   
   94    [1D88] 1D88.09                           db      $09,$40,$1C,$3E,$63,$41,$63,$3E,$1C,$00,$00 ; 'O' 79 = 0x4F
   94    [1D89] 1D89.40                   
   94    [1D8A] 1D8A.1C                   
   94    [1D8B] 1D8B.3E                   
   94    [1D8C] 1D8C.63                   
   94    [1D8D] 1D8D.41                   
   94    [1D8E] 1D8E.63                   
   94    [1D8F] 1D8F.3E                   
   94    [1D90] 1D90.1C                   
   94    [1D91] 1D91.00                   
   94    [1D92] 1D92.00                   
   95    [1D93] 1D93.09                           db      $09,$40,$41,$7F,$7F,$49,$09,$0F,$06,$00,$00 ; 'P' 80 = 0x50
   95    [1D94] 1D94.40                   
   95    [1D95] 1D95.41                   
   95    [1D96] 1D96.7F                   
   95    [1D97] 1D97.7F                   
   95    [1D98] 1D98.49                   
   95    [1D99] 1D99.09                   
   95    [1D9A] 1D9A.0F                   
   95    [1D9B] 1D9B.06                   
   95    [1D9C] 1D9C.00                   
   95    [1D9D] 1D9D.00                   
   96    [1D9E] 1D9E.09                           db      $09,$40,$1E,$3F,$21,$71,$7F,$5E,$00,$00,$00 ; 'Q' 81 = 0x51
   96    [1D9F] 1D9F.40                   
   96    [1DA0] 1DA0.1E                   
   96    [1DA1] 1DA1.3F                   
   96    [1DA2] 1DA2.21                   
   96    [1DA3] 1DA3.71                   
   96    [1DA4] 1DA4.7F                   
   96    [1DA5] 1DA5.5E                   
   96    [1DA6] 1DA6.00                   
   96    [1DA7] 1DA7.00                   
   96    [1DA8] 1DA8.00                   
   97    [1DA9] 1DA9.09                           db      $09,$40,$41,$7F,$7F,$09,$19,$7F,$66,$00,$00 ; 'R' 82 = 0x52
   97    [1DAA] 1DAA.40                   
   97    [1DAB] 1DAB.41                   
   97    [1DAC] 1DAC.7F                   
   97    [1DAD] 1DAD.7F                   
   97    [1DAE] 1DAE.09                   
   97    [1DAF] 1DAF.19                   
   97    [1DB0] 1DB0.7F                   
   97    [1DB1] 1DB1.66                   
   97    [1DB2] 1DB2.00                   
   97    [1DB3] 1DB3.00                   
   98    [1DB4] 1DB4.09                           db      $09,$40,$26,$6F,$4D,$59,$73,$32,$00,$00,$00 ; 'S' 83 = 0x53
   98    [1DB5] 1DB5.40                   
   98    [1DB6] 1DB6.26                   
   98    [1DB7] 1DB7.6F                   
   98    [1DB8] 1DB8.4D                   
   98    [1DB9] 1DB9.59                   
   98    [1DBA] 1DBA.73                   
   98    [1DBB] 1DBB.32                   
   98    [1DBC] 1DBC.00                   
   98    [1DBD] 1DBD.00                   
   98    [1DBE] 1DBE.00                   
   99    [1DBF] 1DBF.09                           db      $09,$40,$03,$41,$7F,$7F,$41,$03,$00,$00,$00 ; 'T' 84 = 0x54
   99    [1DC0] 1DC0.40                   
   99    [1DC1] 1DC1.03                   
   99    [1DC2] 1DC2.41                   
   99    [1DC3] 1DC3.7F                   
   99    [1DC4] 1DC4.7F                   
   99    [1DC5] 1DC5.41                   
   99    [1DC6] 1DC6.03                   
   99    [1DC7] 1DC7.00                   
   99    [1DC8] 1DC8.00                   
   99    [1DC9] 1DC9.00                   
  100    [1DCA] 1DCA.09                           db      $09,$40,$7F,$7F,$40,$40,$7F,$7F,$00,$00,$00 ; 'U' 85 = 0x55
  100    [1DCB] 1DCB.40                   
  100    [1DCC] 1DCC.7F                   
  100    [1DCD] 1DCD.7F                   
  100    [1DCE] 1DCE.40                   
  100    [1DCF] 1DCF.40                   
  100    [1DD0] 1DD0.7F                   
  100    [1DD1] 1DD1.7F                   
  100    [1DD2] 1DD2.00                   
  100    [1DD3] 1DD3.00                   
  100    [1DD4] 1DD4.00                   
  101    [1DD5] 1DD5.09                           db      $09,$40,$1F,$3F,$60,$60,$3F,$1F,$00,$00,$00 ; 'V' 86 = 0x56
  101    [1DD6] 1DD6.40                   
  101    [1DD7] 1DD7.1F                   
  101    [1DD8] 1DD8.3F                   
  101    [1DD9] 1DD9.60                   
  101    [1DDA] 1DDA.60                   
  101    [1DDB] 1DDB.3F                   
  101    [1DDC] 1DDC.1F                   
  101    [1DDD] 1DDD.00                   
  101    [1DDE] 1DDE.00                   
  101    [1DDF] 1DDF.00                   
  102    [1DE0] 1DE0.09                           db      $09,$40,$7F,$7F,$30,$18,$30,$7F,$7F,$00,$00 ; 'W' 87 = 0x57
  102    [1DE1] 1DE1.40                   
  102    [1DE2] 1DE2.7F                   
  102    [1DE3] 1DE3.7F                   
  102    [1DE4] 1DE4.30                   
  102    [1DE5] 1DE5.18                   
  102    [1DE6] 1DE6.30                   
  102    [1DE7] 1DE7.7F                   
  102    [1DE8] 1DE8.7F                   
  102    [1DE9] 1DE9.00                   
  102    [1DEA] 1DEA.00                   
  103    [1DEB] 1DEB.09                           db      $09,$40,$43,$67,$3C,$18,$3C,$67,$43,$00,$00 ; 'X' 88 = 0x58
  103    [1DEC] 1DEC.40                   
  103    [1DED] 1DED.43                   
  103    [1DEE] 1DEE.67                   
  103    [1DEF] 1DEF.3C                   
  103    [1DF0] 1DF0.18                   
  103    [1DF1] 1DF1.3C                   
  103    [1DF2] 1DF2.67                   
  103    [1DF3] 1DF3.43                   
  103    [1DF4] 1DF4.00                   
  103    [1DF5] 1DF5.00                   
  104    [1DF6] 1DF6.09                           db      $09,$40,$07,$4F,$78,$78,$4F,$07,$00,$00,$00 ; 'Y' 89 = 0x59
  104    [1DF7] 1DF7.40                   
  104    [1DF8] 1DF8.07                   
  104    [1DF9] 1DF9.4F                   
  104    [1DFA] 1DFA.78                   
  104    [1DFB] 1DFB.78                   
  104    [1DFC] 1DFC.4F                   
  104    [1DFD] 1DFD.07                   
  104    [1DFE] 1DFE.00                   
  104    [1DFF] 1DFF.00                   
  104    [1E00] 1E00.00                   
  105    [1E01] 1E01.09                           db      $09,$40,$47,$63,$71,$59,$4D,$67,$73,$00,$00 ; 'Z' 90 = 0x5A
  105    [1E02] 1E02.40                   
  105    [1E03] 1E03.47                   
  105    [1E04] 1E04.63                   
  105    [1E05] 1E05.71                   
  105    [1E06] 1E06.59                   
  105    [1E07] 1E07.4D                   
  105    [1E08] 1E08.67                   
  105    [1E09] 1E09.73                   
  105    [1E0A] 1E0A.00                   
  105    [1E0B] 1E0B.00                   
  106    [1E0C] 1E0C.09                           db      $09,$40,$00,$7F,$7F,$41,$41,$00,$00,$00,$00 ; '[' 91 = 0x5B
  106    [1E0D] 1E0D.40                   
  106    [1E0E] 1E0E.00                   
  106    [1E0F] 1E0F.7F                   
  106    [1E10] 1E10.7F                   
  106    [1E11] 1E11.41                   
  106    [1E12] 1E12.41                   
  106    [1E13] 1E13.00                   
  106    [1E14] 1E14.00                   
  106    [1E15] 1E15.00                   
  106    [1E16] 1E16.00                   
  107    [1E17] 1E17.09                           db      $09,$40,$01,$03,$06,$0C,$18,$30,$60,$00,$00 ; '\' 92 = 0x5C
  107    [1E18] 1E18.40                   
  107    [1E19] 1E19.01                   
  107    [1E1A] 1E1A.03                   
  107    [1E1B] 1E1B.06                   
  107    [1E1C] 1E1C.0C                   
  107    [1E1D] 1E1D.18                   
  107    [1E1E] 1E1E.30                   
  107    [1E1F] 1E1F.60                   
  107    [1E20] 1E20.00                   
  107    [1E21] 1E21.00                   
  108    [1E22] 1E22.09                           db      $09,$40,$00,$41,$41,$7F,$7F,$00,$00,$00,$00 ; ']' 93 = 0x5D
  108    [1E23] 1E23.40                   
  108    [1E24] 1E24.00                   
  108    [1E25] 1E25.41                   
  108    [1E26] 1E26.41                   
  108    [1E27] 1E27.7F                   
  108    [1E28] 1E28.7F                   
  108    [1E29] 1E29.00                   
  108    [1E2A] 1E2A.00                   
  108    [1E2B] 1E2B.00                   
  108    [1E2C] 1E2C.00                   
  109    [1E2D] 1E2D.09                           db      $09,$40,$08,$0C,$06,$03,$06,$0C,$08,$00,$00 ; '^' 94 = 0x5E
  109    [1E2E] 1E2E.40                   
  109    [1E2F] 1E2F.08                   
  109    [1E30] 1E30.0C                   
  109    [1E31] 1E31.06                   
  109    [1E32] 1E32.03                   
  109    [1E33] 1E33.06                   
  109    [1E34] 1E34.0C                   
  109    [1E35] 1E35.08                   
  109    [1E36] 1E36.00                   
  109    [1E37] 1E37.00                   
  110    [1E38] 1E38.09                           db      $09,$40,$80,$80,$80,$80,$80,$80,$80,$80,$00 ; '_' 95 = 0x5F
  110    [1E39] 1E39.40                   
  110    [1E3A] 1E3A.80                   
  110    [1E3B] 1E3B.80                   
  110    [1E3C] 1E3C.80                   
  110    [1E3D] 1E3D.80                   
  110    [1E3E] 1E3E.80                   
  110    [1E3F] 1E3F.80                   
  110    [1E40] 1E40.80                   
  110    [1E41] 1E41.80                   
  110    [1E42] 1E42.00                   
  111    [1E43] 1E43.09                           db      $09,$40,$00,$00,$03,$07,$04,$00,$00,$00,$00 ; '`' 96 = 0x60
  111    [1E44] 1E44.40                   
  111    [1E45] 1E45.00                   
  111    [1E46] 1E46.00                   
  111    [1E47] 1E47.03                   
  111    [1E48] 1E48.07                   
  111    [1E49] 1E49.04                   
  111    [1E4A] 1E4A.00                   
  111    [1E4B] 1E4B.00                   
  111    [1E4C] 1E4C.00                   
  111    [1E4D] 1E4D.00                   
  112    [1E4E] 1E4E.09                           db      $09,$40,$20,$74,$54,$54,$3C,$78,$40,$00,$00 ; 'a' 97 = 0x61
  112    [1E4F] 1E4F.40                   
  112    [1E50] 1E50.20                   
  112    [1E51] 1E51.74                   
  112    [1E52] 1E52.54                   
  112    [1E53] 1E53.54                   
  112    [1E54] 1E54.3C                   
  112    [1E55] 1E55.78                   
  112    [1E56] 1E56.40                   
  112    [1E57] 1E57.00                   
  112    [1E58] 1E58.00                   
  113    [1E59] 1E59.09                           db      $09,$40,$41,$7F,$3F,$48,$48,$78,$30,$00,$00 ; 'b' 98 = 0x62
  113    [1E5A] 1E5A.40                   
  113    [1E5B] 1E5B.41                   
  113    [1E5C] 1E5C.7F                   
  113    [1E5D] 1E5D.3F                   
  113    [1E5E] 1E5E.48                   
  113    [1E5F] 1E5F.48                   
  113    [1E60] 1E60.78                   
  113    [1E61] 1E61.30                   
  113    [1E62] 1E62.00                   
  113    [1E63] 1E63.00                   
  114    [1E64] 1E64.09                           db      $09,$40,$38,$7C,$44,$44,$6C,$28,$00,$00,$00 ; 'c' 99 = 0x63
  114    [1E65] 1E65.40                   
  114    [1E66] 1E66.38                   
  114    [1E67] 1E67.7C                   
  114    [1E68] 1E68.44                   
  114    [1E69] 1E69.44                   
  114    [1E6A] 1E6A.6C                   
  114    [1E6B] 1E6B.28                   
  114    [1E6C] 1E6C.00                   
  114    [1E6D] 1E6D.00                   
  114    [1E6E] 1E6E.00                   
  115    [1E6F] 1E6F.09                           db      $09,$40,$30,$78,$48,$49,$3F,$7F,$40,$00,$00 ; 'd' 100 = 0x64
  115    [1E70] 1E70.40                   
  115    [1E71] 1E71.30                   
  115    [1E72] 1E72.78                   
  115    [1E73] 1E73.48                   
  115    [1E74] 1E74.49                   
  115    [1E75] 1E75.3F                   
  115    [1E76] 1E76.7F                   
  115    [1E77] 1E77.40                   
  115    [1E78] 1E78.00                   
  115    [1E79] 1E79.00                   
  116    [1E7A] 1E7A.09                           db      $09,$40,$38,$7C,$54,$54,$5C,$18,$00,$00,$00 ; 'e' 101 = 0x65
  116    [1E7B] 1E7B.40                   
  116    [1E7C] 1E7C.38                   
  116    [1E7D] 1E7D.7C                   
  116    [1E7E] 1E7E.54                   
  116    [1E7F] 1E7F.54                   
  116    [1E80] 1E80.5C                   
  116    [1E81] 1E81.18                   
  116    [1E82] 1E82.00                   
  116    [1E83] 1E83.00                   
  116    [1E84] 1E84.00                   
  117    [1E85] 1E85.09                           db      $09,$40,$48,$7E,$7F,$49,$03,$02,$00,$00,$00 ; 'f' 102 = 0x66
  117    [1E86] 1E86.40                   
  117    [1E87] 1E87.48                   
  117    [1E88] 1E88.7E                   
  117    [1E89] 1E89.7F                   
  117    [1E8A] 1E8A.49                   
  117    [1E8B] 1E8B.03                   
  117    [1E8C] 1E8C.02                   
  117    [1E8D] 1E8D.00                   
  117    [1E8E] 1E8E.00                   
  117    [1E8F] 1E8F.00                   
  118    [1E90] 1E90.09                           db      $09,$40,$98,$BC,$A4,$A4,$F8,$7C,$04,$00,$00 ; 'g' 103 = 0x67
  118    [1E91] 1E91.40                   
  118    [1E92] 1E92.98                   
  118    [1E93] 1E93.BC                   
  118    [1E94] 1E94.A4                   
  118    [1E95] 1E95.A4                   
  118    [1E96] 1E96.F8                   
  118    [1E97] 1E97.7C                   
  118    [1E98] 1E98.04                   
  118    [1E99] 1E99.00                   
  118    [1E9A] 1E9A.00                   
  119    [1E9B] 1E9B.09                           db      $09,$40,$41,$7F,$7F,$08,$04,$7C,$78,$00,$00 ; 'h' 104 = 0x68
  119    [1E9C] 1E9C.40                   
  119    [1E9D] 1E9D.41                   
  119    [1E9E] 1E9E.7F                   
  119    [1E9F] 1E9F.7F                   
  119    [1EA0] 1EA0.08                   
  119    [1EA1] 1EA1.04                   
  119    [1EA2] 1EA2.7C                   
  119    [1EA3] 1EA3.78                   
  119    [1EA4] 1EA4.00                   
  119    [1EA5] 1EA5.00                   
  120    [1EA6] 1EA6.09                           db      $09,$40,$00,$44,$7D,$7D,$40,$00,$00,$00,$00 ; 'i' 105 = 0x69
  120    [1EA7] 1EA7.40                   
  120    [1EA8] 1EA8.00                   
  120    [1EA9] 1EA9.44                   
  120    [1EAA] 1EAA.7D                   
  120    [1EAB] 1EAB.7D                   
  120    [1EAC] 1EAC.40                   
  120    [1EAD] 1EAD.00                   
  120    [1EAE] 1EAE.00                   
  120    [1EAF] 1EAF.00                   
  120    [1EB0] 1EB0.00                   
  121    [1EB1] 1EB1.09                           db      $09,$40,$60,$E0,$80,$80,$FD,$7D,$00,$00,$00 ; 'j' 106 = 0x6A
  121    [1EB2] 1EB2.40                   
  121    [1EB3] 1EB3.60                   
  121    [1EB4] 1EB4.E0                   
  121    [1EB5] 1EB5.80                   
  121    [1EB6] 1EB6.80                   
  121    [1EB7] 1EB7.FD                   
  121    [1EB8] 1EB8.7D                   
  121    [1EB9] 1EB9.00                   
  121    [1EBA] 1EBA.00                   
  121    [1EBB] 1EBB.00                   
  122    [1EBC] 1EBC.09                           db      $09,$40,$41,$7F,$7F,$10,$38,$6C,$44,$00,$00 ; 'k' 107 = 0x6B
  122    [1EBD] 1EBD.40                   
  122    [1EBE] 1EBE.41                   
  122    [1EBF] 1EBF.7F                   
  122    [1EC0] 1EC0.7F                   
  122    [1EC1] 1EC1.10                   
  122    [1EC2] 1EC2.38                   
  122    [1EC3] 1EC3.6C                   
  122    [1EC4] 1EC4.44                   
  122    [1EC5] 1EC5.00                   
  122    [1EC6] 1EC6.00                   
  123    [1EC7] 1EC7.09                           db      $09,$40,$00,$41,$7F,$7F,$40,$00,$00,$00,$00 ; 'l' 108 = 0x6C
  123    [1EC8] 1EC8.40                   
  123    [1EC9] 1EC9.00                   
  123    [1ECA] 1ECA.41                   
  123    [1ECB] 1ECB.7F                   
  123    [1ECC] 1ECC.7F                   
  123    [1ECD] 1ECD.40                   
  123    [1ECE] 1ECE.00                   
  123    [1ECF] 1ECF.00                   
  123    [1ED0] 1ED0.00                   
  123    [1ED1] 1ED1.00                   
  124    [1ED2] 1ED2.09                           db      $09,$40,$7C,$7C,$18,$38,$1C,$7C,$78,$00,$00 ; 'm' 109 = 0x6D
  124    [1ED3] 1ED3.40                   
  124    [1ED4] 1ED4.7C                   
  124    [1ED5] 1ED5.7C                   
  124    [1ED6] 1ED6.18                   
  124    [1ED7] 1ED7.38                   
  124    [1ED8] 1ED8.1C                   
  124    [1ED9] 1ED9.7C                   
  124    [1EDA] 1EDA.78                   
  124    [1EDB] 1EDB.00                   
  124    [1EDC] 1EDC.00                   
  125    [1EDD] 1EDD.09                           db      $09,$40,$7C,$7C,$04,$04,$7C,$78,$00,$00,$00 ; 'n' 110 = 0x6E
  125    [1EDE] 1EDE.40                   
  125    [1EDF] 1EDF.7C                   
  125    [1EE0] 1EE0.7C                   
  125    [1EE1] 1EE1.04                   
  125    [1EE2] 1EE2.04                   
  125    [1EE3] 1EE3.7C                   
  125    [1EE4] 1EE4.78                   
  125    [1EE5] 1EE5.00                   
  125    [1EE6] 1EE6.00                   
  125    [1EE7] 1EE7.00                   
  126    [1EE8] 1EE8.09                           db      $09,$40,$38,$7C,$44,$44,$7C,$38,$00,$00,$00 ; 'o' 111 = 0x6F
  126    [1EE9] 1EE9.40                   
  126    [1EEA] 1EEA.38                   
  126    [1EEB] 1EEB.7C                   
  126    [1EEC] 1EEC.44                   
  126    [1EED] 1EED.44                   
  126    [1EEE] 1EEE.7C                   
  126    [1EEF] 1EEF.38                   
  126    [1EF0] 1EF0.00                   
  126    [1EF1] 1EF1.00                   
  126    [1EF2] 1EF2.00                   
  127    [1EF3] 1EF3.09                           db      $09,$40,$84,$FC,$F8,$A4,$24,$3C,$18,$00,$00 ; 'p' 112 = 0x70
  127    [1EF4] 1EF4.40                   
  127    [1EF5] 1EF5.84                   
  127    [1EF6] 1EF6.FC                   
  127    [1EF7] 1EF7.F8                   
  127    [1EF8] 1EF8.A4                   
  127    [1EF9] 1EF9.24                   
  127    [1EFA] 1EFA.3C                   
  127    [1EFB] 1EFB.18                   
  127    [1EFC] 1EFC.00                   
  127    [1EFD] 1EFD.00                   
  128    [1EFE] 1EFE.09                           db      $09,$40,$18,$3C,$24,$A4,$F8,$FC,$84,$00,$00 ; 'q' 113 = 0x71
  128    [1EFF] 1EFF.40                   
  128    [1F00] 1F00.18                   
  128    [1F01] 1F01.3C                   
  128    [1F02] 1F02.24                   
  128    [1F03] 1F03.A4                   
  128    [1F04] 1F04.F8                   
  128    [1F05] 1F05.FC                   
  128    [1F06] 1F06.84                   
  128    [1F07] 1F07.00                   
  128    [1F08] 1F08.00                   
  129    [1F09] 1F09.09                           db      $09,$40,$44,$7C,$78,$4C,$04,$1C,$18,$00,$00 ; 'r' 114 = 0x72
  129    [1F0A] 1F0A.40                   
  129    [1F0B] 1F0B.44                   
  129    [1F0C] 1F0C.7C                   
  129    [1F0D] 1F0D.78                   
  129    [1F0E] 1F0E.4C                   
  129    [1F0F] 1F0F.04                   
  129    [1F10] 1F10.1C                   
  129    [1F11] 1F11.18                   
  129    [1F12] 1F12.00                   
  129    [1F13] 1F13.00                   
  130    [1F14] 1F14.09                           db      $09,$40,$48,$5C,$54,$54,$74,$24,$00,$00,$00 ; 's' 115 = 0x73
  130    [1F15] 1F15.40                   
  130    [1F16] 1F16.48                   
  130    [1F17] 1F17.5C                   
  130    [1F18] 1F18.54                   
  130    [1F19] 1F19.54                   
  130    [1F1A] 1F1A.74                   
  130    [1F1B] 1F1B.24                   
  130    [1F1C] 1F1C.00                   
  130    [1F1D] 1F1D.00                   
  130    [1F1E] 1F1E.00                   
  131    [1F1F] 1F1F.09                           db      $09,$40,$00,$04,$3E,$7F,$44,$24,$00,$00,$00 ; 't' 116 = 0x74
  131    [1F20] 1F20.40                   
  131    [1F21] 1F21.00                   
  131    [1F22] 1F22.04                   
  131    [1F23] 1F23.3E                   
  131    [1F24] 1F24.7F                   
  131    [1F25] 1F25.44                   
  131    [1F26] 1F26.24                   
  131    [1F27] 1F27.00                   
  131    [1F28] 1F28.00                   
  131    [1F29] 1F29.00                   
  132    [1F2A] 1F2A.09                           db      $09,$40,$3C,$7C,$40,$40,$3C,$7C,$40,$00,$00 ; 'u' 117 = 0x75
  132    [1F2B] 1F2B.40                   
  132    [1F2C] 1F2C.3C                   
  132    [1F2D] 1F2D.7C                   
  132    [1F2E] 1F2E.40                   
  132    [1F2F] 1F2F.40                   
  132    [1F30] 1F30.3C                   
  132    [1F31] 1F31.7C                   
  132    [1F32] 1F32.40                   
  132    [1F33] 1F33.00                   
  132    [1F34] 1F34.00                   
  133    [1F35] 1F35.09                           db      $09,$40,$1C,$3C,$60,$60,$3C,$1C,$00,$00,$00 ; 'v' 118 = 0x76
  133    [1F36] 1F36.40                   
  133    [1F37] 1F37.1C                   
  133    [1F38] 1F38.3C                   
  133    [1F39] 1F39.60                   
  133    [1F3A] 1F3A.60                   
  133    [1F3B] 1F3B.3C                   
  133    [1F3C] 1F3C.1C                   
  133    [1F3D] 1F3D.00                   
  133    [1F3E] 1F3E.00                   
  133    [1F3F] 1F3F.00                   
  134    [1F40] 1F40.09                           db      $09,$40,$3C,$7C,$70,$38,$70,$7C,$3C,$00,$00 ; 'w' 119 = 0x77
  134    [1F41] 1F41.40                   
  134    [1F42] 1F42.3C                   
  134    [1F43] 1F43.7C                   
  134    [1F44] 1F44.70                   
  134    [1F45] 1F45.38                   
  134    [1F46] 1F46.70                   
  134    [1F47] 1F47.7C                   
  134    [1F48] 1F48.3C                   
  134    [1F49] 1F49.00                   
  134    [1F4A] 1F4A.00                   
  135    [1F4B] 1F4B.09                           db      $09,$40,$44,$6C,$38,$10,$38,$6C,$44,$00,$00 ; 'x' 120 = 0x78
  135    [1F4C] 1F4C.40                   
  135    [1F4D] 1F4D.44                   
  135    [1F4E] 1F4E.6C                   
  135    [1F4F] 1F4F.38                   
  135    [1F50] 1F50.10                   
  135    [1F51] 1F51.38                   
  135    [1F52] 1F52.6C                   
  135    [1F53] 1F53.44                   
  135    [1F54] 1F54.00                   
  135    [1F55] 1F55.00                   
  136    [1F56] 1F56.09                           db      $09,$40,$9C,$BC,$A0,$A0,$FC,$7C,$00,$00,$00 ; 'y' 121 = 0x79
  136    [1F57] 1F57.40                   
  136    [1F58] 1F58.9C                   
  136    [1F59] 1F59.BC                   
  136    [1F5A] 1F5A.A0                   
  136    [1F5B] 1F5B.A0                   
  136    [1F5C] 1F5C.FC                   
  136    [1F5D] 1F5D.7C                   
  136    [1F5E] 1F5E.00                   
  136    [1F5F] 1F5F.00                   
  136    [1F60] 1F60.00                   
  137    [1F61] 1F61.09                           db      $09,$40,$4C,$64,$74,$5C,$4C,$64,$00,$00,$00 ; 'z' 122 = 0x7A
  137    [1F62] 1F62.40                   
  137    [1F63] 1F63.4C                   
  137    [1F64] 1F64.64                   
  137    [1F65] 1F65.74                   
  137    [1F66] 1F66.5C                   
  137    [1F67] 1F67.4C                   
  137    [1F68] 1F68.64                   
  137    [1F69] 1F69.00                   
  137    [1F6A] 1F6A.00                   
  137    [1F6B] 1F6B.00                   
  138    [1F6C] 1F6C.09                           db      $09,$40,$08,$08,$3E,$77,$41,$41,$00,$00,$00 ; '{' 123 = 0x7B
  138    [1F6D] 1F6D.40                   
  138    [1F6E] 1F6E.08                   
  138    [1F6F] 1F6F.08                   
  138    [1F70] 1F70.3E                   
  138    [1F71] 1F71.77                   
  138    [1F72] 1F72.41                   
  138    [1F73] 1F73.41                   
  138    [1F74] 1F74.00                   
  138    [1F75] 1F75.00                   
  138    [1F76] 1F76.00                   
  139    [1F77] 1F77.09                           db      $09,$40,$00,$00,$00,$77,$77,$00,$00,$00,$00 ; '|' 124 = 0x7C
  139    [1F78] 1F78.40                   
  139    [1F79] 1F79.00                   
  139    [1F7A] 1F7A.00                   
  139    [1F7B] 1F7B.00                   
  139    [1F7C] 1F7C.77                   
  139    [1F7D] 1F7D.77                   
  139    [1F7E] 1F7E.00                   
  139    [1F7F] 1F7F.00                   
  139    [1F80] 1F80.00                   
  139    [1F81] 1F81.00                   
  140    [1F82] 1F82.09                           db      $09,$40,$41,$41,$77,$3E,$08,$08,$00,$00,$00 ; '}' 125 = 0x7D
  140    [1F83] 1F83.40                   
  140    [1F84] 1F84.41                   
  140    [1F85] 1F85.41                   
  140    [1F86] 1F86.77                   
  140    [1F87] 1F87.3E                   
  140    [1F88] 1F88.08                   
  140    [1F89] 1F89.08                   
  140    [1F8A] 1F8A.00                   
  140    [1F8B] 1F8B.00                   
  140    [1F8C] 1F8C.00                   
  141    [1F8D] 1F8D.09                           db      $09,$40,$02,$03,$01,$03,$02,$03,$01,$00,$00 ; '~' 126 = 0x7E
  141    [1F8E] 1F8E.40                   
  141    [1F8F] 1F8F.02                   
  141    [1F90] 1F90.03                   
  141    [1F91] 1F91.01                   
  141    [1F92] 1F92.03                   
  141    [1F93] 1F93.02                   
  141    [1F94] 1F94.03                   
  141    [1F95] 1F95.01                   
  141    [1F96] 1F96.00                   
  141    [1F97] 1F97.00                   
  142    [1F98] 1F98.09                           db      $09,$40,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; '' 127 = 0x7F
  142    [1F99] 1F99.40                   
  142    [1F9A] 1F9A.00                   
  142    [1F9B] 1F9B.00                   
  142    [1F9C] 1F9C.00                   
  142    [1F9D] 1F9D.00                   
  142    [1F9E] 1F9E.00                   
  142    [1F9F] 1F9F.00                   
  142    [1FA0] 1FA0.00                   
  142    [1FA1] 1FA1.00                   
  142    [1FA2] 1FA2.00                   
  143                                     
  144                0580                 fonttab_len     equ     $-fonttab
  145                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/fonttab.inc *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/ssd1780.a08)
    5                                     
    6                                     #XRAM
    7           0100+000A                 DISP_buff       ds      10
    8                                     
    9                                     ; ===================== Sub-Routines ==========================================
   10                                     #ROM
   11                1FA3                 ssd1780_beg
   12                                     ; ------------------------------------------------------------------------------
   13                                     ; Initialize display
   14                1FA3                 DISP_init
   15    [1FA3] 1FA3:6E78 58         [ 4]         mov     #$78,IICA       ; Device byte of slave IC (Addr=100b)
   16    [1FA6] 1FA6:4520 15         [ 3]         ldhx    #DISP_init_al   ; Load address of action list
   17    [1FA9] 1FA9:CD19 8A         [ 6]         jsr     IIC_ec          ; Execute action list
   18    [1FAC] 1FAC:CD1A 10         [ 6]         jsr     IIC_wfe         ; Wait for end of action list
   19    [1FAF] 1FAF:81              [ 6]         rts
   20                                     
   21                                     
   22                                     ; Set display memory pointer to defined character position
   23                                     ;  Position is in A. Low nibble: Column (0-15), High nobble: Row (0-7)
   24                1FB0                 DISP_pos
   25    [1FB0] 1FB0:87              [ 2]         psha
   26    [1FB1] 1FB1:A607            [ 2]         lda     #$07    ; Write, 7 bytes
   27    [1FB3] 1FB3:C701 00         [ 4]         sta     DISP_buff
   28    [1FB6] 1FB6:4F              [ 1]         clra            ; Co=0 (continuous), D/C#=0 (next bytes are commands)
   29    [1FB7] 1FB7:C701 01         [ 4]         sta     DISP_buff+1
   30    [1FBA] 1FBA:A621            [ 2]         lda     #$21    ; Set Column Address (x)
   31    [1FBC] 1FBC:C701 02         [ 4]         sta     DISP_buff+2
   32    [1FBF] 1FBF:9EE6 01         [ 4]         lda     1,sp    ; X pos calculation
   33    [1FC2] 1FC2:A40F            [ 2]         and     #$0F    ; Mask column number
   34    [1FC4] 1FC4:48              [ 1]         lsla
   35    [1FC5] 1FC5:48              [ 1]         lsla
   36    [1FC6] 1FC6:48              [ 1]         lsla            ; *8 to convert character pos to pixel pos
   37    [1FC7] 1FC7:C701 03         [ 4]         sta     DISP_buff+3
   38    [1FCA] 1FCA:A67F            [ 2]         lda     #$7F    ; end X pos (end of line)
   39    [1FCC] 1FCC:C701 04         [ 4]         sta     DISP_buff+4
   40    [1FCF] 1FCF:A622            [ 2]         lda     #$22    ; Set Page Address (y)
   41    [1FD1] 1FD1:C701 05         [ 4]         sta     DISP_buff+5
   42    [1FD4] 1FD4:86              [ 3]         pula            ; Y pos calculation
   43    [1FD5] 1FD5:A470            [ 2]         and     #$70    ; Mask row number
   44    [1FD7] 1FD7:62              [ 1]         nsa             ; /16 to convert character pos to pixel pos
   45    [1FD8] 1FD8:C701 06         [ 4]         sta     DISP_buff+6
   46    [1FDB] 1FDB:A607            [ 2]         lda     #$07    ; end page
   47    [1FDD] 1FDD:C701 07         [ 4]         sta     DISP_buff+7
   48    [1FE0] 1FE0:A600            [ 2]         lda     #$00    ; end action list
   49    [1FE2] 1FE2:C701 08         [ 4]         sta     DISP_buff+8
   50    [1FE5] 1FE5:8B              [ 2]         pshh
   51    [1FE6] 1FE6:89              [ 2]         pshx
   52    [1FE7] 1FE7:4501 00         [ 3]         ldhx    #DISP_buff
   53    [1FEA] 1FEA:CD19 8A         [ 6]         jsr     IIC_ec          ; Execute action list
   54    [1FED] 1FED:CD1A 10         [ 6]         jsr     IIC_wfe         ; Wait for end of action list
   55    [1FF0] 1FF0:88              [ 3]         pulx
   56    [1FF1] 1FF1:8A              [ 3]         pulh
   57    [1FF2] 1FF2:81              [ 6]         rts
   58                                     
   59                                     ; Prints a text from the defined character position
   60                                     ; Parameters:
   61                                     ;  Position in A. Low nibble: High nobble: Row (0-7), Column (0-15)
   62                                     ;  String address in HX
   63                1FF3                 DISP_print
   64    [1FF3] 1FF3:ADBB (1FB0)     [ 5]         bsr     DISP_pos        ; Go to character position
   65                1FF5                 DISP_p_nc                       ; Convert string letters to actions (Next Char)
   66    [1FF5] 1FF5:F6              [ 3]         lda     ,x              ; load letter
   67    [1FF6] 1FF6:271C (2014)     [ 3]         beq     DISP_p_exit     ; Exit when end of string
   68    [1FF8] 1FF8:8B              [ 2]         pshh
   69    [1FF9] 1FF9:89              [ 2]         pshx
   70    [1FFA] 1FFA:A47F            [ 2]         and     #$7F            ; Mask only printable characters
   71    [1FFC] 1FFC:AE0B            [ 2]         ldx     #11
   72    [1FFE] 1FFE:42              [ 5]         mul                     ; Now XA contains offset in fonttab
   73    [1FFF] 1FFF:89              [ 2]         pshx                    ; Save offset high byte
   74    [2000] 2000:AB23            [ 2]         add     #fonttab&255    ; Add low byte of address of fonttab
   75    [2002] 2002:97              [ 1]         tax                     ; Address low into X
   76    [2003] 2003:86              [ 3]         pula                    ; Get offset high byte
   77    [2004] 2004:A91A            [ 2]         adc     #fonttab/256    ; Add high byte of address of fonttab
   78    [2006] 2006:87              [ 2]         psha
   79    [2007] 2007:8A              [ 3]         pulh                    ; Address high into H
   80    [2008] 2008:CD19 8A         [ 6]         jsr     IIC_ec          ; Execute action list (print string)
   81    [200B] 200B:CD1A 10         [ 6]         jsr     IIC_wfe         ; Wait for end of action list
   82    [200E] 200E:88              [ 3]         pulx
   83    [200F] 200F:8A              [ 3]         pulh
   84    [2010] 2010:AF01            [ 2]         aix     #1              ; Point to next character
   85    [2012] 2012:20E1 (1FF5)     [ 3]         bra     DISP_p_nc
   86                2014                 DISP_p_exit
   87    [2014] 2014:81              [ 6]         rts
   88                                     
   89                                     
   90                                     ; ------------------------------------------------------------------------------
   91                                     ; Initialize display action list. See SSD1306.pdf page 64 about details.
   92                2015                 DISP_init_al
   93    [2015] 2015.1A                           db      $1A     ; Write, 27 bytes
   94    [2016] 2016.00                           db      $00     ; Co=0 (continuous), D/C#=0 (next bytes are commands)
   95    [2017] 2017.AE                           db      $AE     ; Turn off oled panel
   96    [2018] 2018.00                           db      $00     ; Set low column address
   97    [2019] 2019.10                           db      $10     ; Set high column address
   98    [201A] 201A.20                           db      $20     ; Set Memory Addressing Mode
   99    [201B] 201B.00                           db      $00     ; Memory Addressing Mode = Horizontal Addressing Mode
  100    [201C] 201C.B0                           db      $B0     ; Set Page Start Address for Page Addressing Mode (P0)
  101    [201D] 201D.A8                           db      $A8     ; Set multiplex ratio(1 to 64)
  102    [201E] 201E.3F                           db      $3F     ; Multiplex ratio = 64
  103    [201F] 201F.D3                           db      $D3     ; Set display offset
  104    [2020] 2020.00                           db      $00     ; Not offset
  105    [2021] 2021.40                           db      $40     ; Set display start line 0
  106    [2022] 2022.A1                           db      $A1     ; Column address 0 is mapped to SEG N-1
  107    [2023] 2023.C8                           db      $C8     ; Scan direction: Remapped (to be connector at top)
  108    [2024] 2024.DA                           db      $DA     ; Set com pins hardware configuration
  109    [2025] 2025.12                           db      $12     ; Alternative COM pin config, Disable COM L/R remap
  110    [2026] 2026.81                           db      $81     ; Set contrast control register
  111    [2027] 2027.7F                           db      $7F     ; Contrast value
  112    [2028] 2028.A4                           db      $A4     ; Disable Entire Display On
  113    [2029] 2029.A6                           db      $A6     ; Set non-inverse display
  114    [202A] 202A.D5                           db      $D5     ; Set display clock divide ratio/oscillator frequency
  115    [202B] 202B.80                           db      $80     ; The ratio
  116    [202C] 202C.8D                           db      $8D     ; Set Charge Pump enable/disable
  117    [202D] 202D.14                           db      $14     ; Set enable
  118    [202E] 202E.2E                           db      $2E     ; Stop scroll
  119    [202F] 202F.AF                           db      $AF     ; Turn on oled panel
  120                                     
  121    [2030] 2030.00                           db      $00     ; Final Stop (no more task to do)
  122                                     
  123                008E                 ssd1780_len     equ     $-ssd1780_beg
  124                                     
  125                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/ssd1780.a08 *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   48                                     #endif
   49                                     #include "lib.a08"              ; General helper functions
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/lib.a08 ***
    1                                     ; ===================== CONFIG =================================================
    2                                     
    3                0008                 STRBUFFLEN      equ     8       ; Length of string manipulation buffer
    4                                     
    5                                     ; ====================  VARIABLES  =============================================
    6                                     #RAM
    7                                     
    8           008B+0001                 str_bufidx      ds      1       ; Index of String manipulation buffer
    9                                     
   10                                     
   11           008C+0004                 arit32          ds      4       ; Variables for 32bit calculations
   12           0090+0004                 yy              ds      4
   13           0094+0004                 zz              ds      4
   14           0098+0004                 ww              ds      4
   15                                     
   16                                     #XRAM
   17                                     
   18           010A+0008                 str_buffer      ds      STRBUFFLEN ; String manipulation buffer
   19                                     
   20                                     ; ===================== SUB-ROUTINES ===========================================
   21                                     #ROM
   22                                     
   23                                     ; Convert value to decimal string
   24                                     ;   HA is dividend. Maximum value is 2559 !
   25                                     ;   X is length of fractional part. (0:no f.p., 1: 1 digit f.p., ...)
   26                                     ;   Result is sting pointer in HX whoch can be printed immediately
   27                                     ; Example call:
   28                                     ;       mov     #5,str_bufidx   ; Define length of string
   29                                     ;       ldhx    #2559           ; Value in A to be printed
   30                                     ;       txa                     ; Move X to A to be value in HA
   31                                     ;       ldx     #1              ; Define length of fractional part
   32                                     ;       jsr     str_val         ; String will be "255.9"
   33                                     ;       lda     #$27            ; Screen position
   34                                     ;       jsr     DISP_print      ; Print string
   35                2031                 str_val
   36    [2031] 2031:8B              [ 2]         pshh                    ; Save dividend high byte
   37    [2032] 2032:89              [ 2]         pshx                    ; Save length of fractional part
   38    [2033] 2033:87              [ 2]         psha                    ; Save dividend low byte
   39    [2034] 2034:B68B            [ 3]         lda     str_bufidx      ; Check string length
   40    [2036] 2036:A108            [ 2]         cmp     #STRBUFFLEN     ; Compare with length of buffer
   41    [2038] 2038:243C (2076)     [ 3]         bhs     str_val_end     ; End if buffer is not enough long
   42    [203A] 203A:8C              [ 1]         clrh                    ; Clear H for indexing
   43    [203B] 203B:BE8B            [ 3]         ldx     str_bufidx      ; Start from end of buffer
   44    [203D] 203D:4F              [ 1]         clra                    ; Prepare terminator zero
   45    [203E] 203E:D701 0A         [ 4]         sta     str_buffer,x    ; Save string terminator zero
   46    [2041] 2041:A620            [ 2]         lda     #' '            ; Space character into A
   47                2043                 str_val_clrstr                  ; Loop to init the whole string with space
   48    [2043] 2043:D701 09         [ 4]         sta     str_buffer-1,x  ; Init string with space
   49    [2046] 2046:5BFB (2043)     [ 4]         dbnzx   str_val_clrstr  ; Repeat fill up till start of string
   50    [2048] 2048:9EE6 03         [ 4]         lda     3,sp            ; Load dividend high byte
   51    [204B] 204B:87              [ 2]         psha
   52    [204C] 204C:8A              [ 3]         pulh                    ; Move it to H
   53                                     
   54                204D                 str_val_loop
   55    [204D] 204D:9EE6 01         [ 4]         lda     1,sp            ; Load dividend low byte
   56    [2050] 2050:AE0A            [ 2]         ldx     #10             ; Divider is 10 of course
   57    [2052] 2052:52              [ 6]         div                     ; Divide itself
   58    [2053] 2053:9EE7 01         [ 4]         sta     1,sp            ; Save integer part
   59    [2056] 2056:8B              [ 2]         pshh                    ; Transfer H (remainder) to A, step 1/2
   60    [2057] 2057:8C              [ 1]         clrh                    ; Clear H for indexing
   61    [2058] 2058:86              [ 3]         pula                    ; Transfer H (remainder) to A, step 2/2
   62    [2059] 2059:AB30            [ 2]         add     #'0'            ; Convert to ASCII number
   63    [205B] 205B:3A8B            [ 5]         dec     str_bufidx      ; Step back string pointer
   64    [205D] 205D:BE8B            [ 3]         ldx     str_bufidx      ; Load string pointer for indexing
   65    [205F] 205F:D701 0A         [ 4]         sta     str_buffer,x    ; Put remainder into the string
   66    [2062] 2062:9E6A 02         [ 6]         dec     2,sp            ; Decrease length of fractional part
   67    [2065] 2065:2609 (2070)     [ 3]         bne     str_val_np      ; When not zero, jump through its print
   68    [2067] 2067:A62E            [ 2]         lda     #'.'            ; Here when zero, print the point
   69    [2069] 2069:3A8B            [ 5]         dec     str_bufidx      ; Step back string pointer
   70    [206B] 206B:BE8B            [ 3]         ldx     str_bufidx      ; Load string pointer into X for indexing
   71    [206D] 206D:D701 0A         [ 4]         sta     str_buffer,x    ; Put the point into the string
   72                2070                 str_val_np                      ; Target label when no point needed
   73    [2070] 2070:3D8B            [ 4]         tst     str_bufidx      ; Test string pointer
   74    [2072] 2072:2702 (2076)     [ 3]         beq     str_val_end     ; When it is zero, finished
   75    [2074] 2074:20D7 (204D)     [ 3]         bra     str_val_loop    ; When integer part is not zero, continue
   76                2076                 str_val_end                     ; Target label when string is prepared
   77    [2076] 2076:A703            [ 2]         ais     #3              ; Drop out first three push
   78    [2078] 2078:8C              [ 1]         clrh                    ; Start in string from left side character
   79    [2079] 2079:5F              [ 1]         clrx                    ; Start in string from left side character
   80                207A                 str_rn_loop                     ; Loop to change header '0' to ' '
   81                                     ;        lda     str_buffer,x    ; Load character
   82                                     ;        cmp     #'0'            ; Check if null
   83                                     ;        bne     str_rn_end      ; If not null, it is 1..9, exit from loop
   84                                     ;        lda     str_buffer+1,x  ; Load next character
   85                                     ;        cmp     #'.'            ; Check if dot
   86                                     ;        beq     str_rn_end      ; If dot, exit loop, '0' is needed before dot
   87                                     ;        lda     #' '            ; Prepare A to replace
   88                                     ;        sta     str_buffer,x    ; Replace '0' to ' '
   89                                     ;        incx                    ; Go to next character
   90                                     ;        bra     str_rn_loop     ; Continue
   91                207A                 str_rn_end                      ; Exit point of loop to change '0' to ' '
   92    [207A] 207A:4501 0A         [ 3]         ldhx    #str_buffer     ; Load buffer address
   93    [207D] 207D:81              [ 6]         rts                     ; Ready
   94                                     
   95                                     ; HX = HX + A
   96                                     ; Example call:
   97                                     ;       lda     #10
   98                                     ;       ldhx    #$3A8C
   99                                     ;       jsr     addhxanda
  100                207E                 addhxanda
  101    [207E] 207E:87              [ 2]         psha                    ; Save A
  102    [207F] 207F:9F              [ 1]         txa                     ; X (op1 lo)
  103    [2080] 2080:9EEB 01         [ 4]         add     1,sp            ; + (op2 lo)
  104    [2083] 2083:97              [ 1]         tax                     ; Store to X (op1 lo)
  105                                     
  106    [2084] 2084:8B              [ 2]         pshh                    ; H (op1 hi)
  107    [2085] 2085:86              [ 3]         pula                    ; ----||----
  108    [2086] 2086:A900            [ 2]         adc     #0              ; Add carry
  109    [2088] 2088:87              [ 2]         psha                    ; Store to H (op1 hi)
  110    [2089] 2089:8A              [ 3]         pulh                    ; ----||----
  111    [208A] 208A:A701            [ 2]         ais     #1              ; Drop out saved A from stack
  112                                     
  113    [208C] 208C:81              [ 6]         rts
  114                                     
  115                                     
  116                                     
  117                                     ; arit32[16] * yy[16] = arit32[32]
  118                208D                 szor16bit
  119    [208D] 208D:3F8C            [ 5]         clr     arit32
  120    [208F] 208F:3F8D            [ 5]         clr     arit32+1
  121    [2091] 2091:AE10            [ 2]         ldx     #16
  122                2093                 m_c
  123    [2093] 2093:98              [ 1]         clc
  124    [2094] 2094:018F 0C         [ 5]         brclr   0,arit32+3,m_2
  125                                     
  126    [2097] 2097:B68D            [ 3]         lda     arit32+1
  127    [2099] 2099:BB93            [ 3]         add     yy+3
  128    [209B] 209B:B78D            [ 3]         sta     arit32+1
  129    [209D] 209D:B68C            [ 3]         lda     arit32
  130    [209F] 209F:B992            [ 3]         adc     yy+2
  131    [20A1] 20A1:B78C            [ 3]         sta     arit32
  132                20A3                 m_2
  133    [20A3] 20A3:368C            [ 5]         ror     arit32
  134    [20A5] 20A5:368D            [ 5]         ror     arit32+1
  135    [20A7] 20A7:368E            [ 5]         ror     arit32+2
  136    [20A9] 20A9:368F            [ 5]         ror     arit32+3
  137                                     
  138    [20AB] 20AB:5BE6 (2093)     [ 4]         dbnzx   m_c
  139                                     
  140                                     
  141    [20AD] 20AD:81              [ 6]         rts
  142                                     
  143                                     
  144                                     
  145                                     
  146                                     ;Osztas
  147                                     ; arit32(32) / y(32) ==> arit32(32)
  148                                     ; arit32(msb)...arit32+3(lsb), y3...y0, z3...z0
  149                                     
  150                                     ;#macro divhx par16        // arit32 / par16 = HX
  151                                     ;        clr     yy
  152                                     ;        clr     yy+1
  153                                     ;        mov     par16,yy+2
  154                                     ;        mov     par16+1,yy+3
  155                                     ;        jsr     oszt32bit
  156                                     ;        ldhx    arit32+2
  157                                     ;#endm
  158                                     
  159                                     ; arit32[32] / yy[32] = arit32[32]
  160                20AE                 oszt32bit
  161    [20AE] 20AE:B693            [ 3]         lda     yy+3      ;$00 0
  162    [20B0] 20B0:A8FF            [ 2]         eor     #$FF      ;$FF 0
  163    [20B2] 20B2:AB01            [ 2]         add     #1        ;$00 1
  164    [20B4] 20B4:B793            [ 3]         sta     yy+3      ;$00 1   !
  165                                     
  166    [20B6] 20B6:B692            [ 3]         lda     yy+2      ;$03 1
  167    [20B8] 20B8:A8FF            [ 2]         eor     #$FF      ;$FC 1
  168    [20BA] 20BA:A900            [ 2]         adc     #0        ;$FD 0
  169    [20BC] 20BC:B792            [ 3]         sta     yy+2      ;$FD 0   !
  170                                     
  171    [20BE] 20BE:B691            [ 3]         lda     yy+1      ;$00 0
  172    [20C0] 20C0:A8FF            [ 2]         eor     #$FF      ;$FF 0
  173    [20C2] 20C2:A900            [ 2]         adc     #0        ;$FF 0
  174    [20C4] 20C4:B791            [ 3]         sta     yy+1      ;$FF 0   !
  175                                     
  176    [20C6] 20C6:B690            [ 3]         lda     yy        ;$00 0
  177    [20C8] 20C8:A8FF            [ 2]         eor     #$FF      ;$FF 0
  178    [20CA] 20CA:A900            [ 2]         adc     #0        ;$FF 0
  179    [20CC] 20CC:B790            [ 3]         sta     yy        ;$FF 0   !
  180                                     
  181    [20CE] 20CE:3F97            [ 5]         clr     zz+3
  182    [20D0] 20D0:3F96            [ 5]         clr     zz+2
  183    [20D2] 20D2:3F95            [ 5]         clr     zz+1
  184    [20D4] 20D4:3F94            [ 5]         clr     zz
  185                                     
  186    [20D6] 20D6:AE21            [ 2]         ldx     #33
  187                                     
  188    [20D8] 20D8:98              [ 1]         clc
  189    [20D9] 20D9:2023 (20FE)     [ 3]         bra     ud162
  190                                     
  191                20DB                 ud161
  192                                     
  193    [20DB] 20DB:B697            [ 3]         lda     zz+3
  194    [20DD] 20DD:BB93            [ 3]         add     yy+3
  195    [20DF] 20DF:B79B            [ 3]         sta     ww+3
  196    [20E1] 20E1:B696            [ 3]         lda     zz+2
  197    [20E3] 20E3:B992            [ 3]         adc     yy+2
  198    [20E5] 20E5:B79A            [ 3]         sta     ww+2
  199    [20E7] 20E7:B695            [ 3]         lda     zz+1
  200    [20E9] 20E9:B991            [ 3]         adc     yy+1
  201    [20EB] 20EB:B799            [ 3]         sta     ww+1
  202    [20ED] 20ED:B694            [ 3]         lda     zz
  203    [20EF] 20EF:B990            [ 3]         adc     yy
  204                                     
  205    [20F1] 20F1:240B (20FE)     [ 3]         bcc     ud162
  206                                     
  207    [20F3] 20F3:B794            [ 3]         sta     zz
  208    [20F5] 20F5:4E99 95         [ 5]         mov     ww+1,zz+1
  209    [20F8] 20F8:4E9A 96         [ 5]         mov     ww+2,zz+2
  210    [20FB] 20FB:4E9B 97         [ 5]         mov     ww+3,zz+3
  211                                     
  212                20FE                 ud162
  213    [20FE] 20FE:398F            [ 5]         rol     arit32+3      ; C itt az elozo kivonas eredmenye!
  214    [2100] 2100:398E            [ 5]         rol     arit32+2
  215    [2102] 2102:398D            [ 5]         rol     arit32+1
  216    [2104] 2104:398C            [ 5]         rol     arit32
  217                                     
  218    [2106] 2106:3997            [ 5]         rol     zz+3
  219    [2108] 2108:3996            [ 5]         rol     zz+2
  220    [210A] 210A:3995            [ 5]         rol     zz+1
  221    [210C] 210C:3994            [ 5]         rol     zz
  222                                     
  223    [210E] 210E:5BCB (20DB)     [ 4]         dbnzx   ud161
  224                                     
  225    [2110] 2110:81              [ 6]         rts
  226                                     
  227                                     
  228                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/lib.a08 *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   50                                     #include "adc.a08"              ; Analogue-Digital Converter functions
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/adc.a08 ***
    1                                     ; ===================== SUB-ROUTINES ===========================================
    2                                     #ROM
    3                                     
    4                                     ; ADC module initialization
    5                2111                 ADC_Init
    6    [2111] 2111:1A17            [ 5]         bset    PIN5.,APCTL1    ; Set PTA5 as analogue input (not I/O port)
    7                                             ; ADLPC = 0 (High speed config)
    8                                             ; ADIV = 11b (input clock / 8)
    9                                             ; ADLSMP = 1 (Long sample time) maybe filter out noise pulses
   10                                             ; MODE = 00b (8 bit mode)
   11                                             ; ADICLK = 01b (Bus clock divided by 2)
   12    [2113] 2113:6E71 16         [ 4]         mov     #ADIV0_|ADIV1_|ADLSMP_|ADICLK0_,ADCCFG
   13    [2116] 2116:81              [ 6]         rts
   14                                     
   15                                     ; Read ADC value non-interrupt way. A select the channel to be read.
   16                2117                 ADC_read
   17    [2117] 2117:B710            [ 3]         sta     ADCSC1
   18    [2119] 2119:6E0A 82         [ 4]         mov     #10,timeout             ; pull up timer
   19                211C                 ADC_read_loop
   20    [211C] 211C:CD19 06         [ 6]         jsr     KickCop
   21    [211F] 211F:3D82            [ 4]         tst     timeout                 ; Check timeout
   22    [2121] 2121:2706 (2129)     [ 3]         beq     ADC_read_r              ; Timeout happend, reset
   23    [2123] 2123:0F10 F6         [ 5]         brclr   COCO.,ADCSC1,ADC_read_loop
   24    [2126] 2126:B613            [ 3]         lda     ADCRL
   25    [2128] 2128:81              [ 6]         rts                             ; Ready, value is in A
   26                2129                 ADC_read_r
   27    [2129] 2129:20FE (2129)     [ 3]         bra     ADC_read_r              ; Endless loop to force immediate reset
   28                                     
   29                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/adc.a08 *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   51                                     #include "pwm.a08"              ; Timer module functions for PWM output
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/pwm.a08 ***
    1                                     ; ===================== SUB-ROUTINES ===========================================
    2                                     #ROM
    3                                     
    4                                     ; Timer module initialization for PWM output
    5                212B                 PWM_Init
    6    [212B] 212B:6E0A 20         [ 4]         mov     #$0A,TPM1SC     ; TOF=0, TOIE=0, CPWMS=0, CLKS=01(bus), PS=010(/4)
    7    [212E] 212E:3F23            [ 5]         clr     TPM1MODH        ; High byte is not needed due to 0-100 range
    8    [2130] 2130:6E64 24         [ 4]         mov     #100,TPM1MODL   ; (8MHz/4/100=20kHz)
    9    [2133] 2133:6E28 28         [ 4]         mov     #$28,TPM1C1SC   ; CH0F=0, CH0IE=0, MS0B=1, MS0A=0(Dontcare), ELS0B=1, ELS0A=0
   10    [2136] 2136:3F29            [ 5]         clr     TPM1C1VH        ; High byte is not needed due to 0-100 range
   11    [2138] 2138:6E00 2A         [ 4]         mov     #0,TPM1C1VL     ; Set init duty cycle
   12    [213B] 213B:81              [ 6]           rts
   13                                     
   14                213C                 SetPWMpercent
   15    [213C] 213C:3F29            [ 5]         clr     TPM1C1VH        ; High byte is not needed due to 0-100 range
   16    [213E] 213E:B72A            [ 3]           sta     TPM1C1VL        ; Set init duty cycle in percent (0-100)
   17    [2140] 2140:81              [ 6]         rts
   18                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/pwm.a08 *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   52                                     #include "can.a08"              ; Demand can come from CAN
*** BEGIN INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/can.a08 ***
    1                                     ; ===================== CONFIG =================================================
    2                                     
    3                00FF                 CANTIMEOUT      equ     255             ; Message timeout in 10ms
    4                                     
    5                                     ; CAN ID structure
    6                                     ;  11bit ID is used.
    7                                     ;  0000 0000 1111 1xxx, where 0 means CANIDAR0, 1 means CANIDAR1, x means don't care
    8                                     ;  PPDD DDDD MMMR Ixxx, where P is Priority (to be skipped), D is Destination node ID, M is Message of node, R is RTR(0), I is IDE(0), x is don't care
    9                003F                 BCDI            equ     $3F             ; BroadCast Destination Id
   10                0005                 MYDI            equ     $05             ; MY Destination Id (heater control node)
   11                                     
   12                                     ; ====================  CONSTANTS  =============================================
   13                                     
   14                00C0                 PRIO_L          equ     $C0
   15                0080                 PRIO_ML         equ     $80
   16                0040                 PRIO_MH         equ     $40
   17                0000                 PRIO_H          equ     $00
   18                                     
   19                00E0                 MSG_7           equ     $E0
   20                00C0                 MSG_6           equ     $C0
   21                00A0                 MSG_5           equ     $A0
   22                0080                 MSG_4           equ     $80
   23                0060                 MSG_3           equ     $60
   24                0040                 MSG_2           equ     $40
   25                0020                 MSG_1           equ     $20
   26                0000                 MSG_0           equ     $00
   27                                     
   28                                     ; ====================  VARIABLES  =============================================
   29                                     #RAM
   30                                     
   31           009C+0001                 canpwm          ds      1       ; PWM value received from CAN. 255 means SNA (SignalNotAvailable)
   32                                     
   33                                     ; ===================== SUB-ROUTINES ===========================================
   34                                     #ROM
   35                                     
   36                                     ; ------------------------------------------------------------------------------
   37                                     ; Freescale Controller Area Network (S08MSCANV1)
   38                                     ; Set up CAN for 250 kbit/s using 4 MHz external clock
   39                                     ; CAN will use in interrupt mode, but init does not enable interrupt.
   40                                     ; It will be enabled when transmission can be started, so when
   41                                     ; all bytes have been received from SCI.
   42                                     ;
   43                                     ;   Baud = fCANCLK / Prescaler / (1 + Tseg1 + Tseg2) =
   44                                     ;     4MHz / 2 / (1+5+2) = 250k
   45                                     ;   Sample point = 75%
   46                                     ;     (1 + Tseg1)/(1 + Tseg1 + Tseg2) = (1+5)/(1+5+2) = 0.75
   47                2141                 CAN_Init
   48                                             ; MSCAN Enable
   49    [2141] 2141:A680            [ 2]         lda     #CAN_CANE_      ; Auto BusOff recovery
   50    [2143] 2143:C718 81         [ 4]         sta     CANCTL1
   51                                     
   52                                             ; Wait for Initialization Mode Acknowledge
   53                2146                 ican1
   54    [2146] 2146:C618 81         [ 4]         lda     CANCTL1
   55    [2149] 2149:A401            [ 2]         and     #CAN_INITAK_
   56    [214B] 214B:27F9 (2146)     [ 3]         beq     ican1
   57                                     
   58                                             ; SJW = 1 Tq, Prescaler value (P) = 2
   59    [214D] 214D:A601            [ 2]         lda     #1
   60    [214F] 214F:C718 82         [ 4]         sta     CANBTR0
   61                                     
   62                                             ; One sample per bit, Tseg2 = 2, Tseg1 = 5
   63    [2152] 2152:A614            [ 2]         lda     #$14
   64    [2154] 2154:C718 83         [ 4]         sta     CANBTR1
   65                                     
   66                                             ; Acceptance filter for Rx
   67    [2157] 2157:4F              [ 1]         clra
   68    [2158] 2158:C718 8B         [ 4]         sta     CANIDAC         ; Two 32-bit acceptance filters
   69    [215B] 215B:A605            [ 2]         lda     #MYDI
   70    [215D] 215D:C718 90         [ 4]         sta     CANIDAR0
   71    [2160] 2160:A6C0            [ 2]         lda     #$C0            ; Ignore P, match D
   72    [2162] 2162:C718 94         [ 4]         sta     CANIDMR0
   73    [2165] 2165:4F              [ 1]         clra                    ; M(Message)=0, R(RTR)=0, I(IDE)=0, x(don't care)=0
   74    [2166] 2166:C718 91         [ 4]         sta     CANIDAR1
   75    [2169] 2169:A6E7            [ 2]         lda     #$E7            ; Match only R and I
   76    [216B] 216B:C718 95         [ 4]         sta     CANIDMR1
   77                                     
   78    [216E] 216E:4F              [ 1]         clra                    ; 0 (not used for 11bit IDs)
   79    [216F] 216F:C718 92         [ 4]         sta     CANIDAR2
   80    [2172] 2172:C718 93         [ 4]         sta     CANIDAR3
   81    [2175] 2175:43              [ 1]         coma                    ; $FF = ignore all bits
   82    [2176] 2176:C718 96         [ 4]         sta     CANIDMR2
   83    [2179] 2179:C718 97         [ 4]         sta     CANIDMR3
   84                                     
   85                                             ; Leave Initialization Mode
   86    [217C] 217C:4F              [ 1]         clra
   87    [217D] 217D:C718 80         [ 4]         sta     CANCTL0
   88                                     
   89                                             ; Wait for exit Initialization Mode Acknowledge
   90                2180                 ican2
   91    [2180] 2180:C618 81         [ 4]         lda     CANCTL1
   92    [2183] 2183:A401            [ 2]         and     #CAN_INITAK_
   93    [2185] 2185:26F9 (2180)     [ 3]         bne     ican2
   94                                     
   95                                             ; Enable Rx interrupt
   96    [2187] 2187:A601            [ 2]         lda     #CAN_RXFIE_
   97    [2189] 2189:C718 85         [ 4]         sta     CANRIER
   98                                     
   99                                             ; Init module variables
  100    [218C] 218C:6EFF 9C         [ 4]         mov     #255,canpwm     ; Init to SNA
  101                                     
  102    [218F] 218F:81              [ 6]         rts
  103                                     
  104                2190                 CANSendHB
  105                                             ; Send heartbit message
  106                                     
  107                                             ; Select first buffer
  108    [2190] 2190:A601            [ 2]         lda     #1
  109    [2192] 2192:C718 8A         [ 4]         sta     CANTBSEL
  110                                     
  111                                             ; Set ID (P=11b D=111111b M=111b = 7FF)
  112    [2195] 2195:A6FF            [ 2]         lda     #PRIO_L|BCDI
  113    [2197] 2197:C718 B0         [ 4]         sta     CANTIDR0
  114    [219A] 219A:A6E0            [ 2]         lda     #MSG_7
  115    [219C] 219C:C718 B1         [ 4]         sta     CANTIDR1        ; Clear M, R, I
  116                                     
  117                                             ; Set message data
  118    [219F] 219F:A605            [ 2]         lda     #MYDI
  119    [21A1] 21A1:C718 B4         [ 4]         sta     CANTDSR0
  120    [21A4] 21A4:4F              [ 1]         clra                    ; Status
  121    [21A5] 21A5:C718 B5         [ 4]         sta     CANTDSR1
  122                                     
  123                                             ; Set data length
  124    [21A8] 21A8:A602            [ 2]         lda     #2
  125    [21AA] 21AA:C718 BC         [ 4]         sta     CANTDLR
  126                                     
  127                                             ; Transmit the message
  128    [21AD] 21AD:C618 8A         [ 4]         lda     CANTBSEL
  129    [21B0] 21B0:C718 86         [ 4]         sta     CANTFLG
  130                                     
  131    [21B3] 21B3:81              [ 6]         rts
  132                                     
  133                21B4                 CANTask
  134                                             ; check and handle CAN timeout
  135    [21B4] 21B4:3D83            [ 4]         tst     canrxto
  136    [21B6] 21B6:2603 (21BB)     [ 3]         bne     cr_nto          ; Jump if no timeout
  137    [21B8] 21B8:6EFF 9C         [ 4]         mov     #255,canpwm     ; Set SNA
  138                21BB                 cr_nto
  139    [21BB] 21BB:3D84            [ 4]         tst     cantxhb
  140    [21BD] 21BD:2605 (21C4)     [ 3]         bne     cr_nhb          ; Jump if time not yet elapsed
  141    [21BF] 21BF:ADCF (2190)     [ 5]         bsr     CANSendHB
  142    [21C1] 21C1:6E64 84         [ 4]         mov     #100,cantxhb    ; Pull timer again 1s
  143                21C4                 cr_nhb
  144    [21C4] 21C4:81              [ 6]         rts
  145                                     
  146                                     
  147                21C5                 CAN_Rx_IT                       ; If message was received
  148    [21C5] 21C5:8B              [ 2]         pshh
  149                                             ; Check which message is arrived
  150    [21C6] 21C6:C618 A1         [ 4]         lda     CANRIDR1
  151    [21C9] 21C9:A4E0            [ 2]         and     #$E0
  152    [21CB] 21CB:62              [ 1]         nsa
  153    [21CC] 21CC:44              [ 1]         lsra
  154    [21CD] 21CD:2614 (21E3)     [ 3]         bne     cr_dm           ; Jump is MMM != 0
  155                                     
  156                                             ; Check DLC
  157    [21CF] 21CF:C618 AC         [ 4]         lda     CANRDLR
  158    [21D2] 21D2:A102            [ 2]         cmp     #2
  159    [21D4] 21D4:260D (21E3)     [ 3]         bne     cr_dm
  160                                     
  161                                             ; Handle data
  162    [21D6] 21D6:C618 A5         [ 4]         lda     CANRDSR1        ; Byte 1
  163    [21D9] 21D9:A164            [ 2]         cmp     #100            ; Check for maximum percent
  164    [21DB] 21DB:2206 (21E3)     [ 3]         bhi     cr_dm           ; if more than 100% (or SNA), do not use
  165    [21DD] 21DD:B79C            [ 3]         sta     canpwm
  166    [21DF] 21DF:A6FF            [ 2]         lda     #CANTIMEOUT
  167    [21E1] 21E1:B783            [ 3]         sta     canrxto         ; Pull timeout
  168                21E3                 cr_dm
  169                                             ; Mark message as handled
  170    [21E3] 21E3:A601            [ 2]         lda     #CAN_RXF_       ; Write 1 to clear the flag
  171    [21E5] 21E5:C718 84         [ 4]         sta     CANRFLG
  172                                     
  173    [21E8] 21E8:8A              [ 3]         pulh
  174    [21E9] 21E9:80              [ 9]         rti
  175                                     
  176                                     ; ===================== IT VECTORS ==========================================
  177                                     #VECTORS
  178                                     
  179                FFC6                         org     Vcanrx
  180    [FFC6] FFC6.21C5                         dw      CAN_Rx_IT
  181                                     
  182                                     
*** END   INCLUDE FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/can.a08 *** (RESUMING FILE: /home/butyi/sync/private/embedded/hc08/DZ/heaterpwm/prg.a08)
   53                                     
   54                                     ; ====================  VARIABLES  =============================================
   55                                     #RAM
   56                                     
   57           009D+0002                 uz_filt         ds      2       ; Filtered Uz value
   58           009F+0002                 tmp             ds      2       ; General purpose variable
   59           00A1+0001                 uz              ds      1       ; Uz in 0.1 voltage (E.g. 144 = 14.4V)
   60           00A2+0001                 switch          ds      1       ; Rotate switch state (0=Off, 1=Low, 2=high) on low nibble, previous state in high nibble
   61           00A3+0001                 motorlevel      ds      1       ; Level of motor PWM (e.g. 0=0%, 1=10%, 2=20%)
   62           00A4+0001                 pwmpercent      ds      1       ; PWM duty in percent
   63           00A5+0001                 offdur          ds      1       ; Time in 10ms of length of Off switch state (0...2,55s)
   64           00A6+0001                 highdur         ds      1       ; Time in 10ms of length of High switch state (0...2,55s)
   65           00A7+0001                 offdelay        ds      1       ; Time in 10ms after Low is changed to Off (0...2,55s)
   66           00A8+0001                 highdelay       ds      1       ; Time in 10ms after Low is changed to High (0...2,55s)
   67                                     
   68           00A9+0001                 off_filt        ds      1       ; Filter for Off switch state against instable connection and to cover short Off time between Low and High state
   69           00AA+0001                 low_filt        ds      1       ; Filter for Low switch state against instable connection
   70           00AB+0001                 high_filt       ds      1       ; Filter for High switch state against instable connection
   71                                     
   72                                     #ifdef IS_DISPLAY
   73           00AC+0001                 disp_uz         ds      1       ; Currently displayed value to detect change
   74           00AD+0001                 disp_switch     ds      1       ; and update display only if value has been
   75           00AE+0001                 disp_motorlevel ds      1       ; changed.
   76           00AF+0001                 disp_pwmpercent ds      1       ; --||--
   77           00B0+0001                 disp_offdur     ds      1       ; --||--
   78           00B1+0001                 disp_offdelay   ds      1       ; --||--
   79           00B2+0001                 disp_highdur    ds      1       ; --||--
   80           00B3+0001                 disp_highdelay  ds      1       ; --||--
   81                                     #endif
   82                                     
   83                                     ; ====================  PROGRAM START  =========================================
   84                                     #ROM
   85                                     
   86                21EA                 start:
   87    [21EA] 21EA:9B              [ 1]         sei                     ; disable interrupts
   88                                     
   89    [21EB] 21EB:4510 7F         [ 3]         ldhx    #XRAM_END       ; H:X points to SP
   90    [21EE] 21EE:94              [ 2]         txs                     ; Init SP
   91                                     
   92                                     #ifdef IS_DISPLAY
   93    [21EF] 21EF:AEFF            [ 2]         ldx     #255            ; Wait for boot up the display board
   94    [21F1] 21F1:A6FF            [ 2]         lda     #255            ; without this, init is often lost and
   95    [21F3] 21F3:4BFE (21F3)     [ 4]         dbnza   $               ; display remains dark
   96    [21F5] 21F5:5BFA (21F1)     [ 4]         dbnzx   $-4
   97                                     #endif
   98                                     
   99    [21F7] 21F7:CD19 00         [ 6]         jsr     COP_Init        ; Init watchdog
  100    [21FA] 21FA:CD25 6F         [ 6]         jsr     PTX_Init        ; I/O ports initialization
  101    [21FD] 21FD:CD19 12         [ 6]         jsr     MCG_Init        ; Set clock to external 4MHz quarz
  102    [2200] 2200:CD19 3E         [ 6]         jsr     RTC_Init        ; Init periodic interrupt
  103    [2203] 2203:CD21 11         [ 6]         jsr     ADC_Init        ; Init analogue-digital converter
  104    [2206] 2206:CD21 2B         [ 6]         jsr     PWM_Init        ; Init timer for PWM output
  105    [2209] 2209:CD21 41         [ 6]         jsr     CAN_Init        ; Init CAN for receive demand
  106                                     
  107                                     #ifdef IS_DISPLAY
  108    [220C] 220C:CD19 80         [ 6]         jsr     IIC_Init        ; Init IIC
  109                                     
  110                                             ; Init global variables for display to 255 to force an update after startup
  111    [220F] 220F:A6FF            [ 2]           lda       #$FF
  112    [2211] 2211:B7AC            [ 3]           sta     disp_uz
  113    [2213] 2213:B7AD            [ 3]         sta     disp_switch
  114    [2215] 2215:B7AE            [ 3]         sta     disp_motorlevel
  115    [2217] 2217:B7AF            [ 3]         sta     disp_pwmpercent
  116    [2219] 2219:B7B0            [ 3]         sta     disp_offdur
  117    [221B] 221B:B7B1            [ 3]         sta     disp_offdelay
  118    [221D] 221D:B7B2            [ 3]         sta     disp_highdur
  119    [221F] 221F:B7B3            [ 3]         sta     disp_highdelay
  120                                     #endif
  121                                     
  122                                             ; Init global variables
  123    [2221] 2221:3F9D            [ 5]         clr     uz_filt
  124    [2223] 2223:3F9E            [ 5]         clr     uz_filt+1
  125    [2225] 2225:3FA2            [ 5]         clr     switch
  126    [2227] 2227:3FA3            [ 5]         clr     motorlevel
  127    [2229] 2229:3FA4            [ 5]         clr     pwmpercent
  128    [222B] 222B:6E3C A5         [ 4]           mov     #ST_TRESHHOLD*2,offdur ; Reason of not 'clr' is to start Low after power on, if switch remained in Low state
  129    [222E] 222E:3FA7            [ 5]           clr     offdelay
  130    [2230] 2230:3FA6            [ 5]         clr     highdur
  131    [2232] 2232:3FA8            [ 5]           clr     highdelay
  132    [2234] 2234:3FA9            [ 5]         clr     off_filt
  133    [2236] 2236:3FAA            [ 5]         clr     low_filt
  134    [2238] 2238:3FAB            [ 5]         clr     high_filt
  135                                     
  136    [223A] 223A:9A              [ 1]         cli                     ; Enable interrupts
  137                                     
  138                                     #ifdef IS_DISPLAY
  139                                             ; Print display background
  140    [223B] 223B:CD1A 10         [ 6]         jsr     IIC_wfe         ; Wait for end of action list
  141    [223E] 223E:CD1F A3         [ 6]         jsr     DISP_init       ; Initialize display
  142    [2241] 2241:A600            [ 2]         lda     #$00            ; Set position to top-left
  143    [2243] 2243:4524 E3         [ 3]         ldhx    #startscreen    ; Get address of string
  144    [2246] 2246:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  145    [2249] 2249:CD1A 10         [ 6]         jsr     IIC_wfe         ; Wait for end of action list
  146                                     
  147                                     #endif
  148                                     
  149                224C                 main:
  150    [224C] 224C:CD19 06         [ 6]         jsr     KickCop         ; Update watchdog
  151    [224F] 224F:CD21 B4         [ 6]         jsr     CANTask         ; Handle CAN timeout
  152                                     
  153                                     #ifdef IS_DISPLAY
  154                                             ; Print battery voltage
  155    [2252] 2252:B6A1            [ 3]         lda     uz              ; Load current value
  156    [2254] 2254:B1AC            [ 3]         cmp     disp_uz         ; Compare with currently displayed value
  157    [2256] 2256:2710 (2268)     [ 3]         beq     disp1           ; Jump through the display update is no change
  158    [2258] 2258:B7AC            [ 3]         sta     disp_uz         ; Save current value as displayed value
  159    [225A] 225A:8C              [ 1]         clrh                    ; Value has no high byte part
  160    [225B] 225B:AE01            [ 2]         ldx     #1              ; Length of fractional part is 1 digit
  161    [225D] 225D:6E04 8B         [ 4]         mov     #4,str_bufidx   ; Set length of string
  162    [2260] 2260:CD20 31         [ 6]         jsr     str_val         ; Convert value to string
  163    [2263] 2263:A616            [ 2]         lda     #$16            ; Screen position
  164    [2265] 2265:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  165                2268                 disp1
  166                                             ; Print switch state
  167    [2268] 2268:B6A2            [ 3]         lda     switch
  168    [226A] 226A:B1AD            [ 3]         cmp     disp_switch
  169    [226C] 226C:2723 (2291)     [ 3]         beq     disp2
  170    [226E] 226E:B7AD            [ 3]         sta     disp_switch
  171    [2270] 2270:62              [ 1]         nsa
  172    [2271] 2271:A40F            [ 2]         and     #$0F            ; previous state only
  173    [2273] 2273:8C              [ 1]         clrh
  174    [2274] 2274:5F              [ 1]         clrx                    ; No fractional part
  175    [2275] 2275:6E01 8B         [ 4]         mov     #1,str_bufidx   ; Set length of string
  176    [2278] 2278:CD20 31         [ 6]         jsr     str_val         ; Convert value to string
  177    [227B] 227B:A628            [ 2]         lda     #$28            ; Screen position
  178    [227D] 227D:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  179    [2280] 2280:B6A2            [ 3]         lda     switch
  180    [2282] 2282:A40F            [ 2]         and     #$0F            ; current state only
  181    [2284] 2284:8C              [ 1]         clrh
  182    [2285] 2285:5F              [ 1]         clrx                    ; No fractional part
  183    [2286] 2286:6E01 8B         [ 4]         mov     #1,str_bufidx   ; Set length of string
  184    [2289] 2289:CD20 31         [ 6]         jsr     str_val         ; Convert value to string
  185    [228C] 228C:A62A            [ 2]         lda     #$2A            ; Screen position
  186    [228E] 228E:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  187                2291                 disp2
  188                                             ; Print switch state
  189    [2291] 2291:B6A3            [ 3]         lda     motorlevel
  190    [2293] 2293:B1AE            [ 3]         cmp     disp_motorlevel
  191    [2295] 2295:270F (22A6)     [ 3]         beq     disp3
  192    [2297] 2297:B7AE            [ 3]         sta     disp_motorlevel
  193    [2299] 2299:8C              [ 1]         clrh
  194    [229A] 229A:5F              [ 1]         clrx                    ; No fractional part
  195    [229B] 229B:6E01 8B         [ 4]         mov     #1,str_bufidx   ; Set length of string
  196    [229E] 229E:CD20 31         [ 6]         jsr     str_val         ; Convert value to string
  197    [22A1] 22A1:A62E            [ 2]         lda     #$2E            ; Screen position
  198    [22A3] 22A3:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  199                22A6                 disp3
  200                                             ; Print Off duration and delay
  201    [22A6] 22A6:B6A5            [ 3]         lda     offdur
  202    [22A8] 22A8:B1B0            [ 3]         cmp     disp_offdur
  203    [22AA] 22AA:270F (22BB)     [ 3]         beq     disp4
  204    [22AC] 22AC:B7B0            [ 3]         sta     disp_offdur
  205    [22AE] 22AE:8C              [ 1]         clrh
  206    [22AF] 22AF:5F              [ 1]         clrx                    ; No fractional part
  207    [22B0] 22B0:6E03 8B         [ 4]         mov     #3,str_bufidx   ; Set length of string
  208    [22B3] 22B3:CD20 31         [ 6]         jsr     str_val        ; Convert value to string
  209    [22B6] 22B6:A635            [ 2]         lda     #$35            ; Screen position
  210    [22B8] 22B8:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  211                22BB                 disp4
  212    [22BB] 22BB:B6A7            [ 3]         lda     offdelay
  213    [22BD] 22BD:B1B1            [ 3]         cmp     disp_offdelay
  214    [22BF] 22BF:270F (22D0)     [ 3]         beq     disp5
  215    [22C1] 22C1:B7B1            [ 3]         sta     disp_offdelay
  216    [22C3] 22C3:8C              [ 1]         clrh
  217    [22C4] 22C4:5F              [ 1]         clrx                    ; No fractional part
  218    [22C5] 22C5:6E03 8B         [ 4]         mov     #3,str_bufidx   ; Set length of string
  219    [22C8] 22C8:CD20 31         [ 6]         jsr     str_val        ; Convert value to string
  220    [22CB] 22CB:A63B            [ 2]         lda     #$3B            ; Screen position
  221    [22CD] 22CD:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  222                22D0                 disp5
  223                                             ; Print High duration and delay
  224    [22D0] 22D0:B6A6            [ 3]         lda     highdur
  225    [22D2] 22D2:B1B2            [ 3]         cmp     disp_highdur
  226    [22D4] 22D4:270F (22E5)     [ 3]         beq     disp6
  227    [22D6] 22D6:B7B2            [ 3]         sta     disp_highdur
  228    [22D8] 22D8:8C              [ 1]         clrh
  229    [22D9] 22D9:5F              [ 1]         clrx                    ; No fractional part
  230    [22DA] 22DA:6E03 8B         [ 4]         mov     #3,str_bufidx   ; Set length of string
  231    [22DD] 22DD:CD20 31         [ 6]         jsr     str_val         ; Convert value to string
  232    [22E0] 22E0:A645            [ 2]         lda     #$45            ; Screen position
  233    [22E2] 22E2:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  234                22E5                 disp6
  235    [22E5] 22E5:B6A8            [ 3]         lda     highdelay
  236    [22E7] 22E7:B1B3            [ 3]         cmp     disp_highdelay
  237    [22E9] 22E9:270F (22FA)     [ 3]         beq     disp7
  238    [22EB] 22EB:B7B3            [ 3]         sta     disp_highdelay
  239    [22ED] 22ED:8C              [ 1]         clrh
  240    [22EE] 22EE:5F              [ 1]         clrx                    ; No fractional part
  241    [22EF] 22EF:6E03 8B         [ 4]         mov     #3,str_bufidx   ; Set length of string
  242    [22F2] 22F2:CD20 31         [ 6]         jsr     str_val         ; Convert value to string
  243    [22F5] 22F5:A64B            [ 2]         lda     #$4B            ; Screen position
  244    [22F7] 22F7:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  245                22FA                 disp7
  246                                             ; Print PWM percentage
  247    [22FA] 22FA:B6A4            [ 3]         lda     pwmpercent
  248    [22FC] 22FC:B1AF            [ 3]         cmp     disp_pwmpercent
  249    [22FE] 22FE:270F (230F)     [ 3]         beq     disp8
  250    [2300] 2300:B7AF            [ 3]         sta     disp_pwmpercent
  251    [2302] 2302:8C              [ 1]         clrh
  252    [2303] 2303:5F              [ 1]         clrx                    ; No fractional part
  253    [2304] 2304:6E03 8B         [ 4]         mov     #3,str_bufidx   ; Set length of string
  254    [2307] 2307:CD20 31         [ 6]         jsr     str_val         ; Convert value to string
  255    [230A] 230A:A658            [ 2]         lda     #$58            ; Screen position
  256    [230C] 230C:CD1F F3         [ 6]         jsr     DISP_print      ; Print string
  257                230F                 disp8
  258    [230F] 230F:CC22 4C         [ 4]         jmp     main
  261                                     #endif
  262                                     
  263                                     
  264                                     
  265                                     ; -------------------------------------------------------------
  266                                     ; Measure battery voltage and apply low pass filter on that
  267                                     ; Call: 10ms periodic interrupt
  268                                     ; Input: Analogue input port
  269                                     ; Output: filtered uz byte, value in 0.1V (e.g. 144 = 14.4V)
  270                                     ; -------------------------------------------------------------
  271                2312                 meas_uz:
  272                                             ; Read Uz value
  273    [2312] 2312:A605            [ 2]         lda     #PIN5.          ; Select power supply (UZ_MEAS) PTA5
  274                                     #ifdef IS_DISPLAY
  275    [2314] 2314:CD21 17         [ 6]         jsr     ADC_read        ; Read Uz voltage
  278                                     #endif
  279                                             ; Save Uz value into tmp
  280    [2317] 2317:B79F            [ 3]         sta     tmp             ; Save value in Hi byte
  281    [2319] 2319:3FA0            [ 5]         clr     tmp+1           ; Clear Lo byte
  282                                             ; Divide Uz value by 8
  283    [231B] 231B:349F            [ 5]         lsr     tmp             ; Shift 16bits right -> div by 2
  284    [231D] 231D:36A0            [ 5]         ror     tmp+1
  285    [231F] 231F:349F            [ 5]         lsr     tmp             ; Shift 16bits right -> div by 2
  286    [2321] 2321:36A0            [ 5]         ror     tmp+1
  287    [2323] 2323:349F            [ 5]         lsr     tmp             ; Shift 16bits right -> div by 2
  288    [2325] 2325:36A0            [ 5]         ror     tmp+1           ; Div by 8 all together above
  289                                     
  290                                             ; Now comes 32bit long calculations
  291    [2327] 2327:3F8C            [ 5]         clr     arit32          ; Load uz to arit32
  292    [2329] 2329:3F8D            [ 5]         clr     arit32+1
  293    [232B] 232B:4E9D 8E         [ 5]         mov     uz_filt,arit32+2
  294    [232E] 232E:4E9E 8F         [ 5]         mov     uz_filt+1,arit32+3
  295                                     
  296    [2331] 2331:3F90            [ 5]         clr     yy              ; *=7
  297    [2333] 2333:3F91            [ 5]         clr     yy+1
  298    [2335] 2335:3F92            [ 5]         clr     yy+2
  299    [2337] 2337:6E07 93         [ 4]         mov     #7,yy+3
  300                                     
  301    [233A] 233A:CD20 8D         [ 6]         jsr     szor16bit
  302                                     
  303    [233D] 233D:3F90            [ 5]         clr     yy              ; /=8
  304    [233F] 233F:3F91            [ 5]         clr     yy+1
  305    [2341] 2341:3F92            [ 5]         clr     yy+2
  306    [2343] 2343:6E08 93         [ 4]         mov     #8,yy+3
  307                                     
  308    [2346] 2346:CD20 AE         [ 6]         jsr     oszt32bit
  309                                     
  310    [2349] 2349:B68F            [ 3]         lda     arit32+3        ; Add value/8 (tmp) to uz_filt
  311    [234B] 234B:BBA0            [ 3]         add     tmp+1
  312    [234D] 234D:B79E            [ 3]         sta     uz_filt+1
  313    [234F] 234F:B68E            [ 3]         lda     arit32+2
  314    [2351] 2351:B99F            [ 3]         adc     tmp
  315    [2353] 2353:B79D            [ 3]         sta     uz_filt
  316                                     
  317                                             ; Apply scale to have value in voltage (uz_filt is still in A)
  318    [2355] 2355:AED5            [ 2]         ldx     #ADC_CAL_U      ; *=50 (5V)
  319    [2357] 2357:42              [ 5]         mul                     ; (X) * (A) -> X:A
  320    [2358] 2358:89              [ 2]         pshx                    ; Move X
  321    [2359] 2359:8A              [ 3]         pulh                    ;        to H
  322    [235A] 235A:AE66            [ 2]         ldx     #ADC_CAL_V      ; /=23 (ADC value when measuring 5V)
  323    [235C] 235C:52              [ 6]         div                     ; (H:A) / (X) -> A ; Remainder -> H
  324    [235D] 235D:B7A1            [ 3]         sta     uz              ; Save as phisical voltage
  325                                     
  326    [235F] 235F:81              [ 6]         rts
  327                                     
  328                                     ; -------------------------------------------------------------
  329                                     ; Read in switch from digit inputs and filter instability
  330                                     ; Call: 10ms periodic interrupt
  331                                     ; Input: Digit input ports
  332                                     ; Output: switch (0,1,2)
  333                                     ; -------------------------------------------------------------
  334                2360                 read_switch:
  335    [2360] 2360:B600            [ 3]         lda     IN2             ; Read port with switch inputs
  336    [2362] 2362:A403            [ 2]         and     #RxD1_2_|IN2_   ; Check only these bits
  337    [2364] 2364:271E (2384)     [ 3]         beq     rsw_off         ; Off state
  338    [2366] 2366:A101            [ 2]         cmp     #RxD1_2_
  339    [2368] 2368:2734 (239E)     [ 3]         beq     rsw_low         ; Low state only
  340                                     
  341                                             ; Switch is in High state (High or both Low and High)
  342  M                                          @decm   off_filt,0
  342  M [236A] 236A:B6A9            [ 3]         lda     off_filt
  342  M [236C] 236C:A100            [ 2]         cmp     #0
  342  M [236E] 236E:2302 (2372)     [ 3]         bls     Lab$$$
  342  M [2370] 2370:3AA9            [ 5]         dec     off_filt
  342  M             2372                 Lab$$$
  342                                             endm
  343  M                                          @decm   low_filt,0
  343  M [2372] 2372:B6AA            [ 3]         lda     low_filt
  343  M [2374] 2374:A100            [ 2]         cmp     #0
  343  M [2376] 2376:2302 (237A)     [ 3]         bls     Lab$$$
  343  M [2378] 2378:3AAA            [ 5]         dec     low_filt
  343  M             237A                 Lab$$$
  343                                             endm
  344  M                                          @incm   high_filt,FILT_MAX+1
  344  M [237A] 237A:B6AB            [ 3]         lda     high_filt
  344  M [237C] 237C:A10B            [ 2]         cmp     #FILT_MAX+1
  344  M [237E] 237E:2402 (2382)     [ 3]         bhs     Lab$$$
  344  M [2380] 2380:3CAB            [ 5]         inc     high_filt
  344  M             2382                 Lab$$$
  344                                             endm
  345    [2382] 2382:2032 (23B6)     [ 3]         bra     rsw_switch
  346                                     
  347                                             ; Switch is in Off state
  348                2384                 rsw_off
  349  M                                          @incm   off_filt,FILT_MAX+1
  349  M [2384] 2384:B6A9            [ 3]         lda     off_filt
  349  M [2386] 2386:A10B            [ 2]         cmp     #FILT_MAX+1
  349  M [2388] 2388:2402 (238C)     [ 3]         bhs     Lab$$$
  349  M [238A] 238A:3CA9            [ 5]         inc     off_filt
  349  M             238C                 Lab$$$
  349                                             endm
  350  M                                          @decm   low_filt,0
  350  M [238C] 238C:B6AA            [ 3]         lda     low_filt
  350  M [238E] 238E:A100            [ 2]         cmp     #0
  350  M [2390] 2390:2302 (2394)     [ 3]         bls     Lab$$$
  350  M [2392] 2392:3AAA            [ 5]         dec     low_filt
  350  M             2394                 Lab$$$
  350                                             endm
  351  M                                          @decm   high_filt,0
  351  M [2394] 2394:B6AB            [ 3]         lda     high_filt
  351  M [2396] 2396:A100            [ 2]         cmp     #0
  351  M [2398] 2398:2302 (239C)     [ 3]         bls     Lab$$$
  351  M [239A] 239A:3AAB            [ 5]         dec     high_filt
  351  M             239C                 Lab$$$
  351                                             endm
  352    [239C] 239C:2018 (23B6)     [ 3]         bra     rsw_switch
  353                                     
  354                                             ; Switch is in Low state
  355                239E                 rsw_low                          ; Different motor speed depends on which was the switch state previously
  356  M                                          @decm   off_filt,0
  356  M [239E] 239E:B6A9            [ 3]         lda     off_filt
  356  M [23A0] 23A0:A100            [ 2]         cmp     #0
  356  M [23A2] 23A2:2302 (23A6)     [ 3]         bls     Lab$$$
  356  M [23A4] 23A4:3AA9            [ 5]         dec     off_filt
  356  M             23A6                 Lab$$$
  356                                             endm
  357  M                                          @incm   low_filt,FILT_MAX+1
  357  M [23A6] 23A6:B6AA            [ 3]         lda     low_filt
  357  M [23A8] 23A8:A10B            [ 2]         cmp     #FILT_MAX+1
  357  M [23AA] 23AA:2402 (23AE)     [ 3]         bhs     Lab$$$
  357  M [23AC] 23AC:3CAA            [ 5]         inc     low_filt
  357  M             23AE                 Lab$$$
  357                                             endm
  358  M                                          @decm   high_filt,0
  358  M [23AE] 23AE:B6AB            [ 3]         lda     high_filt
  358  M [23B0] 23B0:A100            [ 2]         cmp     #0
  358  M [23B2] 23B2:2302 (23B6)     [ 3]         bls     Lab$$$
  358  M [23B4] 23B4:3AAB            [ 5]         dec     high_filt
  358  M             23B6                 Lab$$$
  358                                             endm
  359                23B6                 rsw_switch
  360                                     
  361                                     
  362                                             ; Check Off state based on filt counters
  363    [23B6] 23B6:B6A9            [ 3]         lda     off_filt
  364    [23B8] 23B8:A10A            [ 2]         cmp     #FILT_MAX
  365    [23BA] 23BA:2523 (23DF)     [ 3]         blo     rsw_n_off       ; Not Off state
  366    [23BC] 23BC:B6AA            [ 3]         lda     low_filt
  367    [23BE] 23BE:A101            [ 2]         cmp     #1
  368    [23C0] 23C0:221D (23DF)     [ 3]         bhi     rsw_n_off       ; Not Off state
  369    [23C2] 23C2:B6AB            [ 3]         lda     high_filt
  370    [23C4] 23C4:A101            [ 2]         cmp     #1
  371    [23C6] 23C6:2217 (23DF)     [ 3]         bhi     rsw_n_off       ; Not Off state
  372  M                                          @incm   offdur,ST_TRESHHOLD*2
  372  M [23C8] 23C8:B6A5            [ 3]         lda     offdur
  372  M [23CA] 23CA:A13C            [ 2]         cmp     #ST_TRESHHOLD*2
  372  M [23CC] 23CC:2402 (23D0)     [ 3]         bhs     Lab$$$
  372  M [23CE] 23CE:3CA5            [ 5]         inc     offdur
  372  M             23D0                 Lab$$$
  372                                             endm
  373  M                                          @decm   highdur,0
  373  M [23D0] 23D0:B6A6            [ 3]         lda     highdur
  373  M [23D2] 23D2:A100            [ 2]         cmp     #0
  373  M [23D4] 23D4:2302 (23D8)     [ 3]         bls     Lab$$$
  373  M [23D6] 23D6:3AA6            [ 5]         dec     highdur
  373  M             23D8                 Lab$$$
  373                                             endm
  374                                             ; Set new switch state to Off
  375    [23D8] 23D8:B6A2            [ 3]         lda     switch
  376    [23DA] 23DA:62              [ 1]         nsa
  377    [23DB] 23DB:A4F0            [ 2]         and     #$F0
  378    [23DD] 23DD:B7A2            [ 3]         sta     switch
  379                23DF                 rsw_n_off
  380                                             ; Check Low state based on filt counters
  381    [23DF] 23DF:B6A9            [ 3]         lda     off_filt
  382    [23E1] 23E1:A101            [ 2]         cmp     #1
  383    [23E3] 23E3:2225 (240A)     [ 3]         bhi     rsw_n_low       ; Not Low state
  384    [23E5] 23E5:B6AA            [ 3]         lda     low_filt
  385    [23E7] 23E7:A10A            [ 2]         cmp     #FILT_MAX
  386    [23E9] 23E9:251F (240A)     [ 3]         blo     rsw_n_low       ; Not Low state
  387    [23EB] 23EB:B6AB            [ 3]         lda     high_filt
  388    [23ED] 23ED:A101            [ 2]         cmp     #1
  389    [23EF] 23EF:2219 (240A)     [ 3]         bhi     rsw_n_low       ; Not Low state
  390  M                                          @decm   offdur,0
  390  M [23F1] 23F1:B6A5            [ 3]         lda     offdur
  390  M [23F3] 23F3:A100            [ 2]         cmp     #0
  390  M [23F5] 23F5:2302 (23F9)     [ 3]         bls     Lab$$$
  390  M [23F7] 23F7:3AA5            [ 5]         dec     offdur
  390  M             23F9                 Lab$$$
  390                                             endm
  391  M                                          @decm   highdur,0
  391  M [23F9] 23F9:B6A6            [ 3]         lda     highdur
  391  M [23FB] 23FB:A100            [ 2]         cmp     #0
  391  M [23FD] 23FD:2302 (2401)     [ 3]         bls     Lab$$$
  391  M [23FF] 23FF:3AA6            [ 5]         dec     highdur
  391  M             2401                 Lab$$$
  391                                             endm
  392                                             ; Set new switch state to Low
  393    [2401] 2401:B6A2            [ 3]         lda     switch
  394    [2403] 2403:62              [ 1]         nsa
  395    [2404] 2404:A4F0            [ 2]         and     #$F0
  396    [2406] 2406:AA01            [ 2]         ora     #1
  397    [2408] 2408:B7A2            [ 3]         sta     switch
  398                240A                 rsw_n_low
  399                                             ; Check High state based on filt counters
  400    [240A] 240A:B6A9            [ 3]         lda     off_filt
  401    [240C] 240C:A101            [ 2]         cmp     #1
  402    [240E] 240E:2225 (2435)     [ 3]         bhi     rsw_n_high      ; Not High state
  403    [2410] 2410:B6AA            [ 3]         lda     low_filt
  404    [2412] 2412:A101            [ 2]         cmp     #1
  405    [2414] 2414:221F (2435)     [ 3]         bhi     rsw_n_high      ; Not High state
  406    [2416] 2416:B6AB            [ 3]         lda     high_filt
  407    [2418] 2418:A10A            [ 2]         cmp     #FILT_MAX
  408    [241A] 241A:2519 (2435)     [ 3]         blo     rsw_n_high      ; Not High state
  409  M                                          @decm   offdur,0
  409  M [241C] 241C:B6A5            [ 3]         lda     offdur
  409  M [241E] 241E:A100            [ 2]         cmp     #0
  409  M [2420] 2420:2302 (2424)     [ 3]         bls     Lab$$$
  409  M [2422] 2422:3AA5            [ 5]         dec     offdur
  409  M             2424                 Lab$$$
  409                                             endm
  410  M                                          @incm   highdur,ST_TRESHHOLD*2
  410  M [2424] 2424:B6A6            [ 3]         lda     highdur
  410  M [2426] 2426:A13C            [ 2]         cmp     #ST_TRESHHOLD*2
  410  M [2428] 2428:2402 (242C)     [ 3]         bhs     Lab$$$
  410  M [242A] 242A:3CA6            [ 5]         inc     highdur
  410  M             242C                 Lab$$$
  410                                             endm
  411                                             ; Set new switch state to High
  412    [242C] 242C:B6A2            [ 3]         lda     switch
  413    [242E] 242E:62              [ 1]         nsa
  414    [242F] 242F:A4F0            [ 2]         and     #$F0
  415    [2431] 2431:AA02            [ 2]         ora     #2
  416    [2433] 2433:B7A2            [ 3]         sta     switch
  417                2435                 rsw_n_high
  418    [2435] 2435:81              [ 6]         rts
  419                                     
  420                                     
  421                                     ; -------------------------------------------------------------
  422                                     ; Calculate motor level from changes of switch
  423                                     ; Call: 10ms periodic interrupt
  424                                     ; Input: switch (0,1,2)
  425                                     ; Output: motorlevel (0...9)
  426                                     ; -------------------------------------------------------------
  427                2436                 calc_motor:
  428    [2436] 2436:B6A2            [ 3]         lda     switch
  429    [2438] 2438:A101            [ 2]         cmp     #$01            ; $01 means previously it was 0, but now it is 1
  430    [243A] 243A:2617 (2453)     [ 3]         bne     cm_1
  431    [243C] 243C:B6A5            [ 3]         lda     offdur
  432    [243E] 243E:A11E            [ 2]         cmp     #ST_TRESHHOLD
  433    [2440] 2440:2505 (2447)     [ 3]         blo     cm_1s
  434    [2442] 2442:6E04 A3         [ 4]         mov     #LEVEL_LOW_1,motorlevel
  435    [2445] 2445:2051 (2498)     [ 3]         bra     cm_e
  436                2447                 cm_1s
  437    [2447] 2447:3FA7            [ 5]         clr     offdelay
  438  M                                          @decm   motorlevel,LEVEL_OFF+1
  438  M [2449] 2449:B6A3            [ 3]         lda     motorlevel
  438  M [244B] 244B:A101            [ 2]         cmp     #LEVEL_OFF+1
  438  M [244D] 244D:2302 (2451)     [ 3]         bls     Lab$$$
  438  M [244F] 244F:3AA3            [ 5]         dec     motorlevel
  438  M             2451                 Lab$$$
  438                                             endm
  439    [2451] 2451:2045 (2498)     [ 3]         bra     cm_e
  440                2453                 cm_1
  441    [2453] 2453:B6A2            [ 3]         lda     switch
  442    [2455] 2455:A121            [ 2]         cmp     #$21
  443    [2457] 2457:2617 (2470)     [ 3]         bne     cm_2
  444    [2459] 2459:B6A6            [ 3]         lda     highdur
  445    [245B] 245B:A11E            [ 2]         cmp     #ST_TRESHHOLD
  446    [245D] 245D:2505 (2464)     [ 3]         blo     cm_2s
  447    [245F] 245F:6E06 A3         [ 4]         mov     #LEVEL_LOW_2,motorlevel
  448    [2462] 2462:2034 (2498)     [ 3]         bra     cm_e
  449                2464                 cm_2s
  450    [2464] 2464:3FA8            [ 5]         clr     highdelay
  451  M                                          @incm   motorlevel,LEVEL_HIGH-1
  451  M [2466] 2466:B6A3            [ 3]         lda     motorlevel
  451  M [2468] 2468:A108            [ 2]         cmp     #LEVEL_HIGH-1
  451  M [246A] 246A:2402 (246E)     [ 3]         bhs     Lab$$$
  451  M [246C] 246C:3CA3            [ 5]         inc     motorlevel
  451  M             246E                 Lab$$$
  451                                             endm
  452    [246E] 246E:2028 (2498)     [ 3]         bra     cm_e
  453                2470                 cm_2
  454    [2470] 2470:B6A2            [ 3]         lda     switch
  455    [2472] 2472:A110            [ 2]         cmp     #$10
  456    [2474] 2474:2605 (247B)     [ 3]         bne     cm_3
  457    [2476] 2476:6E1E A7         [ 4]         mov     #ST_TRESHHOLD,offdelay
  458    [2479] 2479:201D (2498)     [ 3]         bra     cm_e
  459                247B                 cm_3
  460    [247B] 247B:B6A2            [ 3]         lda     switch
  461    [247D] 247D:A120            [ 2]         cmp     #$20
  462    [247F] 247F:2605 (2486)     [ 3]         bne     cm_4
  463    [2481] 2481:6E1E A7         [ 4]         mov     #ST_TRESHHOLD,offdelay
  464    [2484] 2484:2012 (2498)     [ 3]         bra     cm_e
  465                2486                 cm_4
  466    [2486] 2486:B6A2            [ 3]         lda     switch
  467    [2488] 2488:A102            [ 2]         cmp     #$02
  468    [248A] 248A:2605 (2491)     [ 3]         bne     cm_5
  469    [248C] 248C:6E1E A8         [ 4]         mov     #ST_TRESHHOLD,highdelay
  470    [248F] 248F:2007 (2498)     [ 3]         bra     cm_e
  471                2491                 cm_5
  472    [2491] 2491:A112            [ 2]         cmp     #$12
  473    [2493] 2493:2603 (2498)     [ 3]         bne     cm_e
  474    [2495] 2495:6E1E A8         [ 4]         mov     #ST_TRESHHOLD,highdelay
  475                2498                 cm_e
  476                                             ; Delayed Off
  477    [2498] 2498:B6A7            [ 3]         lda     offdelay
  478    [249A] 249A:A101            [ 2]         cmp     #1
  479    [249C] 249C:2602 (24A0)     [ 3]         bne     cm_do
  480    [249E] 249E:3FA3            [ 5]         clr     motorlevel
  481                24A0                 cm_do
  482  M                                          @decm   offdelay,0
  482  M [24A0] 24A0:B6A7            [ 3]         lda     offdelay
  482  M [24A2] 24A2:A100            [ 2]         cmp     #0
  482  M [24A4] 24A4:2302 (24A8)     [ 3]         bls     Lab$$$
  482  M [24A6] 24A6:3AA7            [ 5]         dec     offdelay
  482  M             24A8                 Lab$$$
  482                                             endm
  483                                     
  484                                             ; Delayed High
  485    [24A8] 24A8:B6A8            [ 3]         lda     highdelay
  486    [24AA] 24AA:A101            [ 2]         cmp     #1
  487    [24AC] 24AC:2603 (24B1)     [ 3]         bne     cm_dh
  488    [24AE] 24AE:6E09 A3         [ 4]         mov     #LEVEL_HIGH,motorlevel
  489                24B1                 cm_dh
  490  M                                          @decm   highdelay,0
  490  M [24B1] 24B1:B6A8            [ 3]         lda     highdelay
  490  M [24B3] 24B3:A100            [ 2]         cmp     #0
  490  M [24B5] 24B5:2302 (24B9)     [ 3]         bls     Lab$$$
  490  M [24B7] 24B7:3AA8            [ 5]         dec     highdelay
  490  M             24B9                 Lab$$$
  490                                             endm
  491    [24B9] 24B9:81              [ 6]         rts
  492                                     
  493                                     ; -------------------------------------------------------------
  494                                     ; Update PWM value based on motorlevel and inhibit at low battery voltage
  495                                     ; Call: 10ms periodic interrupt
  496                                     ; Input: motorlevel variable
  497                                     ; Output: PWM percent (0%...100%) for TPM1C1VL
  498                                     ; -------------------------------------------------------------
  499                24BA                 write_pwm:
  500                                             ; Update PWM value from switch
  501    [24BA] 24BA:4525 64         [ 3]         ldhx    #pwmvalues      ; Load PWM value table address
  502    [24BD] 24BD:B6A3            [ 3]         lda     motorlevel      ; motorlevel to be the offset
  503    [24BF] 24BF:CD20 7E         [ 6]         jsr     addhxanda       ; Apply offset
  504    [24C2] 24C2:F6              [ 3]         lda     ,x              ; Load byte from HX address
  505    [24C3] 24C3:B7A4            [ 3]         sta     pwmpercent
  506                                     
  507                                             ; CAN demand has priority over local input
  508    [24C5] 24C5:B69C            [ 3]         lda     canpwm
  509    [24C7] 24C7:A164            [ 2]         cmp     #100            ; Check for maximum percent
  510    [24C9] 24C9:2202 (24CD)     [ 3]         bhi     wp_nocan        ; if more than 100% (or SNA), do not use
  511    [24CB] 24CB:B7A4            [ 3]         sta     pwmpercent
  512                24CD                 wp_nocan
  513                                     
  514                                             ; Supply power inhibit if needed
  515    [24CD] 24CD:B6A1            [ 3]         lda     uz              ; Check supply voltage
  516    [24CF] 24CF:A16E            [ 2]         cmp     #UNDERVOLTAGE
  517    [24D1] 24D1:2207 (24DA)     [ 3]         bhi     voltage_ok      ; Voltage is higher than inhibit
  518    [24D3] 24D3:3FA4            [ 5]         clr     pwmpercent      ; Voltage inhibit, motor off
  519    [24D5] 24D5:6E05 81         [ 4]         mov     #5,led_period   ; Show inhibit by fast status LED
  520    [24D8] 24D8:2003 (24DD)     [ 3]         bra     voltage_end
  521                24DA                 voltage_ok
  522    [24DA] 24DA:6E32 81         [ 4]         mov     #NORMAL_PERIOD,led_period ; No inhibit, normal status LED period
  523                24DD                 voltage_end
  524    [24DD] 24DD:B6A4            [ 3]         lda     pwmpercent      ; Load requested PWM duty
  525    [24DF] 24DF:CD21 3C         [ 6]           jsr       SetPWMpercent       ; Store to PWM register
  526    [24E2] 24E2:81              [ 6]         rts
  527                                     
  528                                     ;------------------------------------------------------------------------------
  529                                     ; ===================== STRINGS ================================================
  530                                     
  531                                     #ifdef IS_DISPLAY
  532                                     ;hexakars
  533                                     ;       db '0123456789ABCDEF'
  534                24E3                 startscreen
  535    [24E3] 24E3.4865 6174 6572               db "Heater Motor PWM"
  535                204D 6F74 6F72  
  535                2050 574D       
  536    [24F3] 24F3.2020 2055 7A20               db "   Uz       V   "
  536                2020 2020 2020  
  536                5620 2020       
  537    [2503] 2503.2053 7769 7463               db " Switch _ _ - _ "
  537                6820 5F20 5F20  
  537                2D20 5F20       
  538    [2513] 2513.204F 6666 205F               db " Off ___ - ___  "   ; duration and delay
  538                5F5F 202D 205F  
  538                5F5F 2020       
  539    [2523] 2523.2048 6967 205F               db " Hig ___ - ___  "   ; duration and delay
  539                5F5F 202D 205F  
  539                5F5F 2020       
  540    [2533] 2533.2020 2050 574D               db "   PWM  ___ %   "
  540                2020 5F5F 5F20  
  540                2520 2020       
  541    [2543] 2543.2020 7777 772E               db "  www.butyi.hu  "
  541                6275 7479 692E  
  541                6875 2020       
  542    [2553] 2553.4275 696C 6420               db "Build {:year-2000}{:month(z)}{:date(z)}{:hour(z)}{:min(z)}"
  542                3232 3036 3239  
  542                3132 3239       
  543    [2563] 2563.00                           db 0
  544                                     #endif
  545                                     
  546                                     ; Convert motorlevel values to PWM values
  547                2564                 pwmvalues
  548                                             ;       0  1  2  3  4  5  6  7  8  9  10     motorlevel
  549    [2564] 2564.00                           db      0,20,30,40,50,60,70,80,90,100,0    ; PWM value
  549    [2565] 2565.14                   
  549    [2566] 2566.1E                   
  549    [2567] 2567.28                   
  549    [2568] 2568.32                   
  549    [2569] 2569.3C                   
  549    [256A] 256A.46                   
  549    [256B] 256B.50                   
  549    [256C] 256C.5A                   
  549    [256D] 256D.64                   
  549    [256E] 256E.00                   
  550                                     ; 10% is not used, because it is not enough to start motor due to friction torque.
  551                                     
  552                                     
  553                                     ; ===================== SUB-ROUTINES ===========================================
  554                                     
  555                                     ; ------------------------------------------------------------------------------
  556                                     ; Parallel Input/Output Control
  557                                     ; To prevent extra current consumption caused by flying not connected input
  558                                     ; ports, all ports shall be configured as output. I have configured ports to
  559                                     ; low level output by default.
  560                                     ; There are only a few exceptions for the used ports, where different
  561                                     ; initialization is needed.
  562                                     ; Default init states are proper for OSCILL_SUPP pins, no exception needed.
  563                256F                 PTX_Init:
  564                                             ; All ports to be low level
  565    [256F] 256F:4F              [ 1]         clra
  566    [2570] 2570:B700            [ 3]         sta     PTA
  567    [2572] 2572:B702            [ 3]         sta     PTB
  568    [2574] 2574:B704            [ 3]         sta     PTC
  569    [2576] 2576:B706            [ 3]         sta     PTD
  570    [2578] 2578:B708            [ 3]         sta     PTE
  571    [257A] 257A:B70A            [ 3]         sta     PTF
  572    [257C] 257C:B70C            [ 3]         sta     PTG
  573    [257E] 257E:1C08            [ 5]         bset    CANTX.,CANTX    ; CANTX to be high
  574    [2580] 2580:1C00            [ 5]         bset    LED2.,LED2      ; LED2 to be On
  575                                     
  576                                             ; All ports to be output
  577    [2582] 2582:A6FF            [ 2]         lda     #$FF
  578    [2584] 2584:B701            [ 3]         sta     DDRA
  579    [2586] 2586:B703            [ 3]         sta     DDRB
  580    [2588] 2588:B705            [ 3]         sta     DDRC
  581    [258A] 258A:B707            [ 3]         sta     DDRD
  582    [258C] 258C:B709            [ 3]         sta     DDRE
  583    [258E] 258E:B70B            [ 3]         sta     DDRF
  584    [2590] 2590:B70D            [ 3]         sta     DDRG
  585    [2592] 2592:1F09            [ 5]         bclr    CANRX.,CANRX+1  ; CANRX to be input
  586    [2594] 2594:1309            [ 5]         bclr    RxD1.,RxD1+1    ; RxD1 to be input
  587    [2596] 2596:1101            [ 5]         bclr    RxD1_2.,RxD1_2+1 ; RxD1_2 to be input
  588    [2598] 2598:1301            [ 5]         bclr    IN2.,IN2+1      ; RxD1_2 to be input
  589                                     
  590    [259A] 259A:81              [ 6]         rts
  591                                     
  592                                     
  593                                     ; ===================== IT VECTORS =============================================
  594                                     #VECTORS
  595                                     
  596                FFFE                         org     Vreset
  597    [FFFE] FFFE.21EA                         dw      start
  598                                     
  599                                     ; ===================== END ====================================================

(Legend: [S19 address] O=Offset active, M=Macro active)
-----------------------------------------------------------

         S E G M E N T   U S A G E   R E P O R T

Segment  Start   End    Size  CodObj  DatObj  TotObj  Lines
-------  -----  -----  -----  ------  ------  ------  -----
RAM      $0080  $00B3  $0034   $0000   $0000   $0000    105
XRAM     $0100  $0111  $0012   $0000   $0000   $0000     12
ROM      $1900  $259A  $0C9B   $0673   $0628   $0C9B   8086
DATA     $FFBD  $FFBF  $0003   $0000   $0002   $0002     25
VECTORS  $FFC6  $FFFF  $003A   $0000   $0008   $0008     73

Summary  $1900  $FFFF  $E700   $0673   $0632   $0CA5   8301

-----------------------------------------------------------

         O V E R A L L   M E M O R Y   U S A G E

Total RAM   size:     70   $0046    0.07 KB
Total CODE  size:   1651   $0673    1.61 KB   (807 instructions)
Total DATA  size:   1586   $0632    1.55 KB
Total IMAGE size:   3237   $0CA5    3.16 KB

Lowest address  :   6400   $1900
Highest address :  65535   $FFFF
Address Range   :  60138   $EAEA   58.73 KB   (Used Range:  5.38%)

Number of INCLUDE files: 14
Number of MACROs called: 349
Number of [#]PROCs used: 0

Assembled 8304 lines (No Errors, Warnings: 0), CRC: $4924

                         *** End of prg.a08 listing ***
